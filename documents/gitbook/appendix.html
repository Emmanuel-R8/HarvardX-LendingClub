<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Appendix | LendingClub Loans Pricing</title>
  <meta name="description" content="HarvardX - PH125.9x Data Science Capstone" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="Appendix | LendingClub Loans Pricing" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="HarvardX - PH125.9x Data Science Capstone" />
  <meta name="github-repo" content="Emmanuel_R8/HarvardX-LendingClub" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Appendix | LendingClub Loans Pricing" />
  
  <meta name="twitter:description" content="HarvardX - PH125.9x Data Science Capstone" />
  

<meta name="author" content="Emmanuel Rialland - https://github.com/Emmanuel_R8" />


<meta name="date" content="2019-12-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="errands-and-post-mortem.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./introduction.html" target="blank>LendingClub Loans Pricing</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html"><i class="fa fa-check"></i><b>1</b> Internal Rate of Return, Credit Margins and Net Present Values</a><ul>
<li class="chapter" data-level="1.1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#important-warning"><i class="fa fa-check"></i><b>1.1</b> Important warning</a></li>
<li class="chapter" data-level="1.2" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#background"><i class="fa fa-check"></i><b>1.2</b> Background</a></li>
<li class="chapter" data-level="1.3" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#internal-rate-of-return"><i class="fa fa-check"></i><b>1.3</b> Internal Rate of Return</a></li>
<li class="chapter" data-level="1.4" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#dataset-calculation"><i class="fa fa-check"></i><b>1.4</b> Dataset calculation</a><ul>
<li class="chapter" data-level="1.4.1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#irr"><i class="fa fa-check"></i><b>1.4.1</b> IRR</a></li>
<li class="chapter" data-level="1.4.2" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#credit-margins"><i class="fa fa-check"></i><b>1.4.2</b> Credit Margins</a></li>
<li class="chapter" data-level="1.4.3" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#npv"><i class="fa fa-check"></i><b>1.4.3</b> NPV</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="dataset.html"><a href="dataset.html"><i class="fa fa-check"></i><b>2</b> Dataset</a><ul>
<li class="chapter" data-level="2.1" data-path="dataset.html"><a href="dataset.html#preamble"><i class="fa fa-check"></i><b>2.1</b> Preamble</a></li>
<li class="chapter" data-level="2.2" data-path="dataset.html"><a href="dataset.html#general-presentation"><i class="fa fa-check"></i><b>2.2</b> General presentation</a><ul>
<li class="chapter" data-level="2.2.1" data-path="dataset.html"><a href="dataset.html#business-volume"><i class="fa fa-check"></i><b>2.2.1</b> Business volume</a></li>
<li class="chapter" data-level="2.2.2" data-path="dataset.html"><a href="dataset.html#loan-lifecyle-and-status"><i class="fa fa-check"></i><b>2.2.2</b> Loan lifecyle and status</a></li>
<li class="chapter" data-level="2.2.3" data-path="dataset.html"><a href="dataset.html#loan-application"><i class="fa fa-check"></i><b>2.2.3</b> Loan application</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="dataset.html"><a href="dataset.html#rates"><i class="fa fa-check"></i><b>2.3</b> Rates</a><ul>
<li class="chapter" data-level="2.3.1" data-path="dataset.html"><a href="dataset.html#irr-and-required-credit-margins"><i class="fa fa-check"></i><b>2.3.1</b> IRR and required credit margins</a></li>
<li class="chapter" data-level="2.3.2" data-path="dataset.html"><a href="dataset.html#dataset-1"><i class="fa fa-check"></i><b>2.3.2</b> Dataset</a></li>
<li class="chapter" data-level="2.3.3" data-path="dataset.html"><a href="dataset.html#interest-rates"><i class="fa fa-check"></i><b>2.3.3</b> Interest rates</a></li>
<li class="chapter" data-level="2.3.4" data-path="dataset.html"><a href="dataset.html#purpose"><i class="fa fa-check"></i><b>2.3.4</b> Purpose</a></li>
<li class="chapter" data-level="2.3.5" data-path="dataset.html"><a href="dataset.html#payments"><i class="fa fa-check"></i><b>2.3.5</b> Payments</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="dataset.html"><a href="dataset.html#net-present-value"><i class="fa fa-check"></i><b>2.4</b> Net present value</a><ul>
<li class="chapter" data-level="2.4.1" data-path="dataset.html"><a href="dataset.html#average-npv-and-credit-margin-by-subgrade"><i class="fa fa-check"></i><b>2.4.1</b> Average NPV and credit margin by subgrade</a></li>
<li class="chapter" data-level="2.4.2" data-path="dataset.html"><a href="dataset.html#principal-losses"><i class="fa fa-check"></i><b>2.4.2</b> Principal losses</a></li>
<li class="chapter" data-level="2.4.3" data-path="dataset.html"><a href="dataset.html#distribution-of-principal-losses-by-rating"><i class="fa fa-check"></i><b>2.4.3</b> Distribution of principal losses by rating</a></li>
<li class="chapter" data-level="2.4.4" data-path="dataset.html"><a href="dataset.html#npv-distribution-by-rating"><i class="fa fa-check"></i><b>2.4.4</b> NPV distribution by rating</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="dataset.html"><a href="dataset.html#loan-decision"><i class="fa fa-check"></i><b>2.5</b> Loan decision</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html"><i class="fa fa-check"></i><b>3</b> Logistic Regression Model and Credit Scorecard</a><ul>
<li class="chapter" data-level="3.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#logistic-regression"><i class="fa fa-check"></i><b>3.2</b> Logistic Regression</a><ul>
<li class="chapter" data-level="3.2.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#data-preparation"><i class="fa fa-check"></i><b>3.2.1</b> Data preparation</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#binning-and-weight-of-evidence"><i class="fa fa-check"></i><b>3.3</b> Binning and Weight of Evidence</a><ul>
<li class="chapter" data-level="3.3.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#background-1"><i class="fa fa-check"></i><b>3.3.1</b> Background</a></li>
<li class="chapter" data-level="3.3.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#binning"><i class="fa fa-check"></i><b>3.3.2</b> Binning</a></li>
<li class="chapter" data-level="3.3.3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#woe-and-iv-definitions"><i class="fa fa-check"></i><b>3.3.3</b> WOE and IV definitions</a></li>
<li class="chapter" data-level="3.3.4" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#modeling"><i class="fa fa-check"></i><b>3.3.4</b> Modeling</a></li>
<li class="chapter" data-level="3.3.5" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#loop-through-all-variables"><i class="fa fa-check"></i><b>3.3.5</b> Loop through all variables</a></li>
<li class="chapter" data-level="3.3.6" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#select-relevant-variables"><i class="fa fa-check"></i><b>3.3.6</b> Select relevant variables</a></li>
<li class="chapter" data-level="3.3.7" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#create-data-table-with-one-hot-encoding"><i class="fa fa-check"></i><b>3.3.7</b> Create data table with one-hot encoding</a></li>
<li class="chapter" data-level="3.3.8" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#comparison-of-individual-characteristics"><i class="fa fa-check"></i><b>3.3.8</b> Comparison of individual characteristics</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#logistic-regression-1"><i class="fa fa-check"></i><b>3.4</b> Logistic Regression</a><ul>
<li class="chapter" data-level="3.4.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#remove-identical-bins"><i class="fa fa-check"></i><b>3.4.1</b> Remove identical bins</a></li>
<li class="chapter" data-level="3.4.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#first-model---complete-dataset"><i class="fa fa-check"></i><b>3.4.2</b> First model - complete dataset</a></li>
<li class="chapter" data-level="3.4.3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#second-training---fitted-model-less-colinear-bins"><i class="fa fa-check"></i><b>3.4.3</b> Second training - fitted model less colinear bins</a></li>
<li class="chapter" data-level="3.4.4" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#third-training---second-fitted-model-less-non-significant-bins"><i class="fa fa-check"></i><b>3.4.4</b> Third training - second fitted model less non-significant bins</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#model-result"><i class="fa fa-check"></i><b>3.5</b> Model result</a><ul>
<li class="chapter" data-level="3.5.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#final-list-of-variables"><i class="fa fa-check"></i><b>3.5.1</b> Final list of variables</a></li>
<li class="chapter" data-level="3.5.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#scoring"><i class="fa fa-check"></i><b>3.5.2</b> Scoring</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#training-set"><i class="fa fa-check"></i><b>3.6</b> Training set</a><ul>
<li class="chapter" data-level="3.6.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#densities-of-the-training-results"><i class="fa fa-check"></i><b>3.6.1</b> Densities of the training results</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#test-set"><i class="fa fa-check"></i><b>3.7</b> Test set</a></li>
<li class="chapter" data-level="3.8" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#confusion-matrix"><i class="fa fa-check"></i><b>3.8</b> Confusion matrix</a></li>
<li class="chapter" data-level="3.9" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#roc-curve"><i class="fa fa-check"></i><b>3.9</b> ROC Curve</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>4</b> Conclusion</a></li>
<li class="chapter" data-level="5" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html"><i class="fa fa-check"></i><b>5</b> Errands and post-mortem</a><ul>
<li class="chapter" data-level="5.1" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#modeling-1"><i class="fa fa-check"></i><b>5.1</b> Modeling</a></li>
<li class="chapter" data-level="5.2" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#geographical-data"><i class="fa fa-check"></i><b>5.2</b> Geographical data</a></li>
<li class="chapter" data-level="5.3" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#stochastic-gradient-descent"><i class="fa fa-check"></i><b>5.3</b> Stochastic Gradient Descent</a><ul>
<li class="chapter" data-level="5.3.1" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#conclusions"><i class="fa fa-check"></i><b>5.3.1</b> Conclusions</a></li>
<li class="chapter" data-level="5.3.2" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#description-of-the-model"><i class="fa fa-check"></i><b>5.3.2</b> Description of the model</a></li>
<li class="chapter" data-level="5.3.3" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#cost-function-for-multi-modal-npv"><i class="fa fa-check"></i><b>5.3.3</b> Cost function for multi-modal NPV</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#final-conclusions"><i class="fa fa-check"></i><b>5.4</b> Final Conclusions</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i>Appendix</a><ul>
<li class="chapter" data-level="5.5" data-path="appendix.html"><a href="appendix.html#sec:list-assumptions"><i class="fa fa-check"></i><b>5.5</b> List of assumptions / limitations regarding the dataset</a></li>
<li class="chapter" data-level="5.6" data-path="appendix.html"><a href="appendix.html#data-preparation-and-formatting"><i class="fa fa-check"></i><b>5.6</b> Data preparation and formatting</a><ul>
<li class="chapter" data-level="5.6.1" data-path="appendix.html"><a href="appendix.html#sec:lendingclub-dataset"><i class="fa fa-check"></i><b>5.6.1</b> LendinClub dataset</a></li>
<li class="chapter" data-level="5.6.2" data-path="appendix.html"><a href="appendix.html#zip-codes-and-fips-codes"><i class="fa fa-check"></i><b>5.6.2</b> Zip codes and FIPS codes</a></li>
<li class="chapter" data-level="5.6.3" data-path="appendix.html"><a href="appendix.html#market-interest-rates"><i class="fa fa-check"></i><b>5.6.3</b> Market interest rates</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="appendix.html"><a href="appendix.html#sec:list-model-variables"><i class="fa fa-check"></i><b>5.7</b> List of variables</a></li>
<li class="chapter" data-level="5.8" data-path="appendix.html"><a href="appendix.html#calculations-of-the-internal-rate-of-returns-and-month-to-default"><i class="fa fa-check"></i><b>5.8</b> Calculations of the internal rate of returns and month-to-default</a><ul>
<li class="chapter" data-level="5.8.1" data-path="appendix.html"><a href="appendix.html#r-code"><i class="fa fa-check"></i><b>5.8.1</b> R code</a></li>
<li class="chapter" data-level="5.8.2" data-path="appendix.html"><a href="appendix.html#julia-code"><i class="fa fa-check"></i><b>5.8.2</b> Julia code</a></li>
<li class="chapter" data-level="5.8.3" data-path="appendix.html"><a href="appendix.html#maxima-derivation-of-the-cost-function"><i class="fa fa-check"></i><b>5.8.3</b> Maxima derivation of the cost function</a></li>
</ul></li>
<li class="chapter" data-level="5.9" data-path="appendix.html"><a href="appendix.html#system-version"><i class="fa fa-check"></i><b>5.9</b> System version</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org/" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">LendingClub Loans Pricing</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="appendix" class="section level1 unnumbered">
<h1>Appendix</h1>


<div id="sec:list-assumptions" class="section level2">
<h2><span class="header-section-number">5.5</span> List of assumptions / limitations regarding the dataset</h2>
<p>As mentioned during this report, we had to make numerous assumptions given the lack of clarity of the variable descriptions.</p>
<ul>
<li><p><em>Dataset quality</em>: Aside from cents rounding issues, the dataset does not contain any flagrant errors that we could see (e.g. minor error of amount or rate, zipcode). Quality of the variable description is a different matter altogether.</p></li>
<li><p><em>Ratings</em>: The day-1 rating is between A1 and (and no lower than) G5. No note is rated lower than E5 after 6 November 2017, and lower than D5 after 30 June 2019.</p></li>
<li><p><em>Credit history</em>: Credit history information for the principal borrower relates to pre-approval and not post-funding. This is clear for the joint applicants, but simply an assumption for the principal borrower.</p></li>
<li><p><em>Recoveries</em>: Recoveries (if any) are assumed to be paid 3 months after the last scheduled payment date (variable <code>last_pymnt_d</code>)</p></li>
<li><p><em>Survival effect</em>: The dataset does not include applications that were rejected by the lender (for whatever reason) or by the borrower (for example because the interest rate quote is too high). It may also be the case that some actual loans were excluded as and when the dataset changed over the years.</p></li>
<li><p>LIBOR funding rate: we use the 3-year and 5-year swap rates. In reality, we should have used average tenor-weighted swap rates (i.e. ca. 1.5 Y and 2.5 Y). This requires a full swap curve and more calculation than necessary for our purpose. The principles of this report should not be significantly affted by this approximation.</p></li>
</ul>
<p>We do hope that LendingClub investors receive information of much better quality!</p>
</div>
<div id="data-preparation-and-formatting" class="section level2">
<h2><span class="header-section-number">5.6</span> Data preparation and formatting</h2>
<p>We used different sources of information:</p>
<ul>
<li><p>The LendingClub dataset made available on Kaggle;</p></li>
<li><p>US geographical data about zip and FIPS codes;</p></li>
<li><p>Market interest rates from the Saint Louis Federal Reserve Bank; and,</p></li>
<li><p>Macro data from the same source.</p></li>
</ul>
<p>We here show the code used to prepare the data. It was automatically formatted by <em>RStudio</em>.</p>
<div id="sec:lendingclub-dataset" class="section level3">
<h3><span class="header-section-number">5.6.1</span> LendinClub dataset</h3>

<div class="sourceCode" id="cb66"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" href="#cb66-1" data-line-number="1"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb66-2" href="#cb66-2" data-line-number="2">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-3" href="#cb66-3" data-line-number="3">  <span class="co"># STEP 1: Download the dataset</span></a>
<a class="sourceLine" id="cb66-4" href="#cb66-4" data-line-number="4">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-5" href="#cb66-5" data-line-number="5">  <span class="co">#   Got to https://www.kaggle.com/wendykan/lending-club-loan-data</span></a>
<a class="sourceLine" id="cb66-6" href="#cb66-6" data-line-number="6">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-7" href="#cb66-7" data-line-number="7">  <span class="co">#   Download into the &#39;datasets&#39; subdirectory</span></a>
<a class="sourceLine" id="cb66-8" href="#cb66-8" data-line-number="8">  <span class="co">#   Unzip the file.</span></a>
<a class="sourceLine" id="cb66-9" href="#cb66-9" data-line-number="9">  <span class="co">#   </span><span class="al">WARNING</span><span class="co">: The unzipping will be about 2.4GB</span></a>
<a class="sourceLine" id="cb66-10" href="#cb66-10" data-line-number="10">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-11" href="#cb66-11" data-line-number="11">  <span class="co">#   Name the sql database &quot;datasets/lending_club.sqlite&quot;</span></a>
<a class="sourceLine" id="cb66-12" href="#cb66-12" data-line-number="12">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-13" href="#cb66-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb66-14" href="#cb66-14" data-line-number="14">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-15" href="#cb66-15" data-line-number="15">  <span class="co"># STEP 2: Prepare the dabase as a tibble</span></a>
<a class="sourceLine" id="cb66-16" href="#cb66-16" data-line-number="16">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-17" href="#cb66-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb66-18" href="#cb66-18" data-line-number="18">  <span class="co">##</span></a>
<a class="sourceLine" id="cb66-19" href="#cb66-19" data-line-number="19">  <span class="co">## </span><span class="al">WARNING</span><span class="co">: THIS ASSUMES A &#39;datasets&#39; DIRECTORY WAS CREATED</span></a>
<a class="sourceLine" id="cb66-20" href="#cb66-20" data-line-number="20">  <span class="co">## </span></a>
<a class="sourceLine" id="cb66-21" href="#cb66-21" data-line-number="21">  <span class="kw">library</span>(RSQLite)</a>
<a class="sourceLine" id="cb66-22" href="#cb66-22" data-line-number="22">  db_conn &lt;-</a>
<a class="sourceLine" id="cb66-23" href="#cb66-23" data-line-number="23"><span class="st">    </span><span class="kw">dbConnect</span>(RSQLite<span class="op">::</span><span class="kw">SQLite</span>(), <span class="st">&quot;datasets/lending_club.sqlite&quot;</span>)</a>
<a class="sourceLine" id="cb66-24" href="#cb66-24" data-line-number="24">  <span class="kw">dbListTables</span>(db_conn)</a>
<a class="sourceLine" id="cb66-25" href="#cb66-25" data-line-number="25">  </a>
<a class="sourceLine" id="cb66-26" href="#cb66-26" data-line-number="26">  <span class="co"># Returns a 2.96GB data frame</span></a>
<a class="sourceLine" id="cb66-27" href="#cb66-27" data-line-number="27">  lending_club &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(db_conn, <span class="st">&quot;SELECT * FROM loan&quot;</span>)</a>
<a class="sourceLine" id="cb66-28" href="#cb66-28" data-line-number="28">  lending_club &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(lending_club)</a>
<a class="sourceLine" id="cb66-29" href="#cb66-29" data-line-number="29">  </a>
<a class="sourceLine" id="cb66-30" href="#cb66-30" data-line-number="30">  <span class="co"># Close the database</span></a>
<a class="sourceLine" id="cb66-31" href="#cb66-31" data-line-number="31">  <span class="kw">dbDisconnect</span>(db_conn)</a>
<a class="sourceLine" id="cb66-32" href="#cb66-32" data-line-number="32">  </a>
<a class="sourceLine" id="cb66-33" href="#cb66-33" data-line-number="33">  <span class="co"># Compressed to ca.285MB on disk</span></a>
<a class="sourceLine" id="cb66-34" href="#cb66-34" data-line-number="34">  <span class="kw">saveRDS</span>(lending_club, <span class="st">&quot;datasets/lending_club.rds&quot;</span>)</a>
<a class="sourceLine" id="cb66-35" href="#cb66-35" data-line-number="35">  </a>
<a class="sourceLine" id="cb66-36" href="#cb66-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb66-37" href="#cb66-37" data-line-number="37">  <span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb66-38" href="#cb66-38" data-line-number="38">  <span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb66-39" href="#cb66-39" data-line-number="39">  <span class="kw">library</span>(hablar)</a>
<a class="sourceLine" id="cb66-40" href="#cb66-40" data-line-number="40">  </a>
<a class="sourceLine" id="cb66-41" href="#cb66-41" data-line-number="41">  <span class="co"># Before reformat in case the previous step was already done</span></a>
<a class="sourceLine" id="cb66-42" href="#cb66-42" data-line-number="42">  <span class="co"># lending_club &lt;- readRDS(&quot;datasets/lending_club.rds&quot;)</span></a>
<a class="sourceLine" id="cb66-43" href="#cb66-43" data-line-number="43">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-44" href="#cb66-44" data-line-number="44">  <span class="co"># str(lending_club)</span></a>
<a class="sourceLine" id="cb66-45" href="#cb66-45" data-line-number="45">  <span class="co">#</span></a>
<a class="sourceLine" id="cb66-46" href="#cb66-46" data-line-number="46">  </a>
<a class="sourceLine" id="cb66-47" href="#cb66-47" data-line-number="47">  <span class="co"># Leave the original dataset untouched and work with a copy.</span></a>
<a class="sourceLine" id="cb66-48" href="#cb66-48" data-line-number="48">  lc &lt;-<span class="st"> </span>lending_club</a>
<a class="sourceLine" id="cb66-49" href="#cb66-49" data-line-number="49">  </a>
<a class="sourceLine" id="cb66-50" href="#cb66-50" data-line-number="50">  lc &lt;-<span class="st"> </span>lc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-51" href="#cb66-51" data-line-number="51"></a>
<a class="sourceLine" id="cb66-52" href="#cb66-52" data-line-number="52"><span class="st">    </span><span class="co"># Add loan identification number to track the loans across calculations</span></a>
<a class="sourceLine" id="cb66-53" href="#cb66-53" data-line-number="53"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">loanID =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-54" href="#cb66-54" data-line-number="54"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-55" href="#cb66-55" data-line-number="55"><span class="st">    </span><span class="co"># Remove useless strings</span></a>
<a class="sourceLine" id="cb66-56" href="#cb66-56" data-line-number="56"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb66-57" href="#cb66-57" data-line-number="57">      <span class="dt">term       =</span> <span class="kw">str_remove</span>(term, <span class="st">&quot; months&quot;</span>),</a>
<a class="sourceLine" id="cb66-58" href="#cb66-58" data-line-number="58">      <span class="dt">emp_length =</span> <span class="kw">str_replace</span>(emp_length, <span class="st">&quot;&lt;1&quot;</span>, <span class="st">&quot;0&quot;</span>),</a>
<a class="sourceLine" id="cb66-59" href="#cb66-59" data-line-number="59">      <span class="dt">emp_length =</span> <span class="kw">str_replace</span>(emp_length, <span class="st">&quot;10+&quot;</span>, <span class="st">&quot;10&quot;</span>),</a>
<a class="sourceLine" id="cb66-60" href="#cb66-60" data-line-number="60">      <span class="dt">emp_length =</span> <span class="kw">str_remove</span>(emp_length, <span class="st">&quot;years&quot;</span>)</a>
<a class="sourceLine" id="cb66-61" href="#cb66-61" data-line-number="61">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-62" href="#cb66-62" data-line-number="62"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-63" href="#cb66-63" data-line-number="63"><span class="st">    </span><span class="co"># Creates dates out of strings - Parse errors will be raised when no dates.</span></a>
<a class="sourceLine" id="cb66-64" href="#cb66-64" data-line-number="64"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb66-65" href="#cb66-65" data-line-number="65">      <span class="dt">debt_settlement_flag_date =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(</a>
<a class="sourceLine" id="cb66-66" href="#cb66-66" data-line-number="66">        <span class="kw">str_c</span>(<span class="st">&quot;1-&quot;</span>, debt_settlement_flag_date)</a>
<a class="sourceLine" id="cb66-67" href="#cb66-67" data-line-number="67">      )),</a>
<a class="sourceLine" id="cb66-68" href="#cb66-68" data-line-number="68">      <span class="dt">earliest_cr_line          =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-69" href="#cb66-69" data-line-number="69">        <span class="st">&quot;1-&quot;</span>, earliest_cr_line</a>
<a class="sourceLine" id="cb66-70" href="#cb66-70" data-line-number="70">      ))),</a>
<a class="sourceLine" id="cb66-71" href="#cb66-71" data-line-number="71">      <span class="dt">hardship_start_date       =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-72" href="#cb66-72" data-line-number="72">        <span class="st">&quot;1-&quot;</span>, hardship_start_date</a>
<a class="sourceLine" id="cb66-73" href="#cb66-73" data-line-number="73">      ))),</a>
<a class="sourceLine" id="cb66-74" href="#cb66-74" data-line-number="74">      <span class="dt">hardship_end_date         =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-75" href="#cb66-75" data-line-number="75">        <span class="st">&quot;1-&quot;</span>, hardship_end_date</a>
<a class="sourceLine" id="cb66-76" href="#cb66-76" data-line-number="76">      ))),</a>
<a class="sourceLine" id="cb66-77" href="#cb66-77" data-line-number="77">      <span class="dt">issue_d                   =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(<span class="st">&quot;1-&quot;</span>, issue_d))),</a>
<a class="sourceLine" id="cb66-78" href="#cb66-78" data-line-number="78">      <span class="dt">last_credit_pull_d        =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-79" href="#cb66-79" data-line-number="79">        <span class="st">&quot;1-&quot;</span>, last_credit_pull_d</a>
<a class="sourceLine" id="cb66-80" href="#cb66-80" data-line-number="80">      ))),</a>
<a class="sourceLine" id="cb66-81" href="#cb66-81" data-line-number="81">      <span class="dt">last_pymnt_d              =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-82" href="#cb66-82" data-line-number="82">        <span class="st">&quot;1-&quot;</span>, last_pymnt_d</a>
<a class="sourceLine" id="cb66-83" href="#cb66-83" data-line-number="83">      ))),</a>
<a class="sourceLine" id="cb66-84" href="#cb66-84" data-line-number="84">      <span class="dt">next_pymnt_d              =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-85" href="#cb66-85" data-line-number="85">        <span class="st">&quot;1-&quot;</span>, next_pymnt_d</a>
<a class="sourceLine" id="cb66-86" href="#cb66-86" data-line-number="86">      ))),</a>
<a class="sourceLine" id="cb66-87" href="#cb66-87" data-line-number="87">      <span class="dt">payment_plan_start_date   =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-88" href="#cb66-88" data-line-number="88">        <span class="st">&quot;1-&quot;</span>, payment_plan_start_date</a>
<a class="sourceLine" id="cb66-89" href="#cb66-89" data-line-number="89">      ))),</a>
<a class="sourceLine" id="cb66-90" href="#cb66-90" data-line-number="90">      <span class="dt">sec_app_earliest_cr_line  =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-91" href="#cb66-91" data-line-number="91">        <span class="st">&quot;1-&quot;</span>, sec_app_earliest_cr_line</a>
<a class="sourceLine" id="cb66-92" href="#cb66-92" data-line-number="92">      ))),</a>
<a class="sourceLine" id="cb66-93" href="#cb66-93" data-line-number="93">      <span class="dt">settlement_date           =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb66-94" href="#cb66-94" data-line-number="94">        <span class="st">&quot;1-&quot;</span>, settlement_date</a>
<a class="sourceLine" id="cb66-95" href="#cb66-95" data-line-number="95">      )))</a>
<a class="sourceLine" id="cb66-96" href="#cb66-96" data-line-number="96">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-97" href="#cb66-97" data-line-number="97"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-98" href="#cb66-98" data-line-number="98"><span class="st">    </span><span class="co"># Bulk type conversion with convert from the `hablar` package</span></a>
<a class="sourceLine" id="cb66-99" href="#cb66-99" data-line-number="99"><span class="st">    </span><span class="kw">convert</span>(</a>
<a class="sourceLine" id="cb66-100" href="#cb66-100" data-line-number="100">      <span class="co"># Strings</span></a>
<a class="sourceLine" id="cb66-101" href="#cb66-101" data-line-number="101">      <span class="kw">chr</span>(emp_title, title, url, zip_code),</a>
<a class="sourceLine" id="cb66-102" href="#cb66-102" data-line-number="102">      </a>
<a class="sourceLine" id="cb66-103" href="#cb66-103" data-line-number="103">      <span class="co"># Factors</span></a>
<a class="sourceLine" id="cb66-104" href="#cb66-104" data-line-number="104">      <span class="kw">fct</span>(</a>
<a class="sourceLine" id="cb66-105" href="#cb66-105" data-line-number="105">        addr_state,</a>
<a class="sourceLine" id="cb66-106" href="#cb66-106" data-line-number="106">        application_type,</a>
<a class="sourceLine" id="cb66-107" href="#cb66-107" data-line-number="107">        debt_settlement_flag,</a>
<a class="sourceLine" id="cb66-108" href="#cb66-108" data-line-number="108">        desc,</a>
<a class="sourceLine" id="cb66-109" href="#cb66-109" data-line-number="109">        disbursement_method,</a>
<a class="sourceLine" id="cb66-110" href="#cb66-110" data-line-number="110">        grade,</a>
<a class="sourceLine" id="cb66-111" href="#cb66-111" data-line-number="111">        hardship_flag,</a>
<a class="sourceLine" id="cb66-112" href="#cb66-112" data-line-number="112">        hardship_loan_status,</a>
<a class="sourceLine" id="cb66-113" href="#cb66-113" data-line-number="113">        hardship_reason,</a>
<a class="sourceLine" id="cb66-114" href="#cb66-114" data-line-number="114">        hardship_status,</a>
<a class="sourceLine" id="cb66-115" href="#cb66-115" data-line-number="115">        hardship_type,</a>
<a class="sourceLine" id="cb66-116" href="#cb66-116" data-line-number="116">        home_ownership,</a>
<a class="sourceLine" id="cb66-117" href="#cb66-117" data-line-number="117">        id,</a>
<a class="sourceLine" id="cb66-118" href="#cb66-118" data-line-number="118">        initial_list_status,</a>
<a class="sourceLine" id="cb66-119" href="#cb66-119" data-line-number="119">        loan_status,</a>
<a class="sourceLine" id="cb66-120" href="#cb66-120" data-line-number="120">        member_id,</a>
<a class="sourceLine" id="cb66-121" href="#cb66-121" data-line-number="121">        policy_code,</a>
<a class="sourceLine" id="cb66-122" href="#cb66-122" data-line-number="122">        purpose,</a>
<a class="sourceLine" id="cb66-123" href="#cb66-123" data-line-number="123">        pymnt_plan,</a>
<a class="sourceLine" id="cb66-124" href="#cb66-124" data-line-number="124">        settlement_status,</a>
<a class="sourceLine" id="cb66-125" href="#cb66-125" data-line-number="125">        sub_grade,</a>
<a class="sourceLine" id="cb66-126" href="#cb66-126" data-line-number="126">        verification_status,</a>
<a class="sourceLine" id="cb66-127" href="#cb66-127" data-line-number="127">        verification_status_joint</a>
<a class="sourceLine" id="cb66-128" href="#cb66-128" data-line-number="128">      ),</a>
<a class="sourceLine" id="cb66-129" href="#cb66-129" data-line-number="129">      </a>
<a class="sourceLine" id="cb66-130" href="#cb66-130" data-line-number="130">      <span class="co"># Integers</span></a>
<a class="sourceLine" id="cb66-131" href="#cb66-131" data-line-number="131">      <span class="kw">int</span>(</a>
<a class="sourceLine" id="cb66-132" href="#cb66-132" data-line-number="132">        acc_now_delinq,</a>
<a class="sourceLine" id="cb66-133" href="#cb66-133" data-line-number="133">        acc_open_past_24mths,</a>
<a class="sourceLine" id="cb66-134" href="#cb66-134" data-line-number="134">        chargeoff_within_<span class="dv">12</span>_mths,</a>
<a class="sourceLine" id="cb66-135" href="#cb66-135" data-line-number="135">        collections_<span class="dv">12</span>_mths_ex_med,</a>
<a class="sourceLine" id="cb66-136" href="#cb66-136" data-line-number="136">        deferral_term,</a>
<a class="sourceLine" id="cb66-137" href="#cb66-137" data-line-number="137">        delinq_2yrs,</a>
<a class="sourceLine" id="cb66-138" href="#cb66-138" data-line-number="138">        emp_length,</a>
<a class="sourceLine" id="cb66-139" href="#cb66-139" data-line-number="139">        hardship_dpd,</a>
<a class="sourceLine" id="cb66-140" href="#cb66-140" data-line-number="140">        hardship_length,</a>
<a class="sourceLine" id="cb66-141" href="#cb66-141" data-line-number="141">        inq_fi,</a>
<a class="sourceLine" id="cb66-142" href="#cb66-142" data-line-number="142">        inq_last_12m,</a>
<a class="sourceLine" id="cb66-143" href="#cb66-143" data-line-number="143">        inq_last_6mths,</a>
<a class="sourceLine" id="cb66-144" href="#cb66-144" data-line-number="144">        mo_sin_old_il_acct,</a>
<a class="sourceLine" id="cb66-145" href="#cb66-145" data-line-number="145">        mo_sin_old_rev_tl_op,</a>
<a class="sourceLine" id="cb66-146" href="#cb66-146" data-line-number="146">        mo_sin_rcnt_rev_tl_op,</a>
<a class="sourceLine" id="cb66-147" href="#cb66-147" data-line-number="147">        mo_sin_rcnt_tl,</a>
<a class="sourceLine" id="cb66-148" href="#cb66-148" data-line-number="148">        mort_acc,</a>
<a class="sourceLine" id="cb66-149" href="#cb66-149" data-line-number="149">        mths_since_last_delinq,</a>
<a class="sourceLine" id="cb66-150" href="#cb66-150" data-line-number="150">        mths_since_last_major_derog,</a>
<a class="sourceLine" id="cb66-151" href="#cb66-151" data-line-number="151">        mths_since_last_record,</a>
<a class="sourceLine" id="cb66-152" href="#cb66-152" data-line-number="152">        mths_since_rcnt_il,</a>
<a class="sourceLine" id="cb66-153" href="#cb66-153" data-line-number="153">        mths_since_recent_bc,</a>
<a class="sourceLine" id="cb66-154" href="#cb66-154" data-line-number="154">        mths_since_recent_bc_dlq,</a>
<a class="sourceLine" id="cb66-155" href="#cb66-155" data-line-number="155">        mths_since_recent_inq,</a>
<a class="sourceLine" id="cb66-156" href="#cb66-156" data-line-number="156">        mths_since_recent_revol_delinq,</a>
<a class="sourceLine" id="cb66-157" href="#cb66-157" data-line-number="157">        num_accts_ever_<span class="dv">120</span>_pd,</a>
<a class="sourceLine" id="cb66-158" href="#cb66-158" data-line-number="158">        num_actv_bc_tl,</a>
<a class="sourceLine" id="cb66-159" href="#cb66-159" data-line-number="159">        num_actv_rev_tl,</a>
<a class="sourceLine" id="cb66-160" href="#cb66-160" data-line-number="160">        num_bc_sats,</a>
<a class="sourceLine" id="cb66-161" href="#cb66-161" data-line-number="161">        num_bc_tl,</a>
<a class="sourceLine" id="cb66-162" href="#cb66-162" data-line-number="162">        num_il_tl,</a>
<a class="sourceLine" id="cb66-163" href="#cb66-163" data-line-number="163">        num_op_rev_tl,</a>
<a class="sourceLine" id="cb66-164" href="#cb66-164" data-line-number="164">        num_rev_accts,</a>
<a class="sourceLine" id="cb66-165" href="#cb66-165" data-line-number="165">        num_rev_tl_bal_gt_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb66-166" href="#cb66-166" data-line-number="166">        num_sats,</a>
<a class="sourceLine" id="cb66-167" href="#cb66-167" data-line-number="167">        num_tl_120dpd_2m,</a>
<a class="sourceLine" id="cb66-168" href="#cb66-168" data-line-number="168">        num_tl_30dpd,</a>
<a class="sourceLine" id="cb66-169" href="#cb66-169" data-line-number="169">        num_tl_90g_dpd_24m,</a>
<a class="sourceLine" id="cb66-170" href="#cb66-170" data-line-number="170">        num_tl_op_past_12m,</a>
<a class="sourceLine" id="cb66-171" href="#cb66-171" data-line-number="171">        open_acc,</a>
<a class="sourceLine" id="cb66-172" href="#cb66-172" data-line-number="172">        open_acc_6m,</a>
<a class="sourceLine" id="cb66-173" href="#cb66-173" data-line-number="173">        open_act_il,</a>
<a class="sourceLine" id="cb66-174" href="#cb66-174" data-line-number="174">        open_il_12m,</a>
<a class="sourceLine" id="cb66-175" href="#cb66-175" data-line-number="175">        open_il_24m,</a>
<a class="sourceLine" id="cb66-176" href="#cb66-176" data-line-number="176">        open_rv_12m,</a>
<a class="sourceLine" id="cb66-177" href="#cb66-177" data-line-number="177">        open_rv_24m,</a>
<a class="sourceLine" id="cb66-178" href="#cb66-178" data-line-number="178">        sec_app_chargeoff_within_<span class="dv">12</span>_mths,</a>
<a class="sourceLine" id="cb66-179" href="#cb66-179" data-line-number="179">        sec_app_collections_<span class="dv">12</span>_mths_ex_med,</a>
<a class="sourceLine" id="cb66-180" href="#cb66-180" data-line-number="180">        sec_app_inq_last_6mths,</a>
<a class="sourceLine" id="cb66-181" href="#cb66-181" data-line-number="181">        sec_app_mort_acc,</a>
<a class="sourceLine" id="cb66-182" href="#cb66-182" data-line-number="182">        sec_app_mths_since_last_major_derog,</a>
<a class="sourceLine" id="cb66-183" href="#cb66-183" data-line-number="183">        sec_app_num_rev_accts,</a>
<a class="sourceLine" id="cb66-184" href="#cb66-184" data-line-number="184">        sec_app_open_acc,</a>
<a class="sourceLine" id="cb66-185" href="#cb66-185" data-line-number="185">        sec_app_open_act_il,</a>
<a class="sourceLine" id="cb66-186" href="#cb66-186" data-line-number="186">        term</a>
<a class="sourceLine" id="cb66-187" href="#cb66-187" data-line-number="187">      ),</a>
<a class="sourceLine" id="cb66-188" href="#cb66-188" data-line-number="188">      </a>
<a class="sourceLine" id="cb66-189" href="#cb66-189" data-line-number="189">      <span class="co"># Floating point</span></a>
<a class="sourceLine" id="cb66-190" href="#cb66-190" data-line-number="190">      <span class="kw">dbl</span>(</a>
<a class="sourceLine" id="cb66-191" href="#cb66-191" data-line-number="191">        all_util,</a>
<a class="sourceLine" id="cb66-192" href="#cb66-192" data-line-number="192">        annual_inc,</a>
<a class="sourceLine" id="cb66-193" href="#cb66-193" data-line-number="193">        annual_inc_joint,</a>
<a class="sourceLine" id="cb66-194" href="#cb66-194" data-line-number="194">        avg_cur_bal,</a>
<a class="sourceLine" id="cb66-195" href="#cb66-195" data-line-number="195">        bc_open_to_buy,</a>
<a class="sourceLine" id="cb66-196" href="#cb66-196" data-line-number="196">        bc_util,</a>
<a class="sourceLine" id="cb66-197" href="#cb66-197" data-line-number="197">        collection_recovery_fee,</a>
<a class="sourceLine" id="cb66-198" href="#cb66-198" data-line-number="198">        delinq_amnt,</a>
<a class="sourceLine" id="cb66-199" href="#cb66-199" data-line-number="199">        dti,</a>
<a class="sourceLine" id="cb66-200" href="#cb66-200" data-line-number="200">        dti_joint,</a>
<a class="sourceLine" id="cb66-201" href="#cb66-201" data-line-number="201">        funded_amnt,</a>
<a class="sourceLine" id="cb66-202" href="#cb66-202" data-line-number="202">        funded_amnt_inv,</a>
<a class="sourceLine" id="cb66-203" href="#cb66-203" data-line-number="203">        hardship_amount,</a>
<a class="sourceLine" id="cb66-204" href="#cb66-204" data-line-number="204">        hardship_last_payment_amount,</a>
<a class="sourceLine" id="cb66-205" href="#cb66-205" data-line-number="205">        hardship_payoff_balance_amount,</a>
<a class="sourceLine" id="cb66-206" href="#cb66-206" data-line-number="206">        il_util,</a>
<a class="sourceLine" id="cb66-207" href="#cb66-207" data-line-number="207">        installment,</a>
<a class="sourceLine" id="cb66-208" href="#cb66-208" data-line-number="208">        int_rate,</a>
<a class="sourceLine" id="cb66-209" href="#cb66-209" data-line-number="209">        last_pymnt_amnt,</a>
<a class="sourceLine" id="cb66-210" href="#cb66-210" data-line-number="210">        loan_amnt,</a>
<a class="sourceLine" id="cb66-211" href="#cb66-211" data-line-number="211">        max_bal_bc,</a>
<a class="sourceLine" id="cb66-212" href="#cb66-212" data-line-number="212">        orig_projected_additional_accrued_interest,</a>
<a class="sourceLine" id="cb66-213" href="#cb66-213" data-line-number="213">        out_prncp,</a>
<a class="sourceLine" id="cb66-214" href="#cb66-214" data-line-number="214">        out_prncp_inv,</a>
<a class="sourceLine" id="cb66-215" href="#cb66-215" data-line-number="215">        pct_tl_nvr_dlq,</a>
<a class="sourceLine" id="cb66-216" href="#cb66-216" data-line-number="216">        percent_bc_gt_<span class="dv">75</span>,</a>
<a class="sourceLine" id="cb66-217" href="#cb66-217" data-line-number="217">        pub_rec,</a>
<a class="sourceLine" id="cb66-218" href="#cb66-218" data-line-number="218">        pub_rec_bankruptcies,</a>
<a class="sourceLine" id="cb66-219" href="#cb66-219" data-line-number="219">        recoveries,</a>
<a class="sourceLine" id="cb66-220" href="#cb66-220" data-line-number="220">        revol_bal,</a>
<a class="sourceLine" id="cb66-221" href="#cb66-221" data-line-number="221">        revol_bal_joint,</a>
<a class="sourceLine" id="cb66-222" href="#cb66-222" data-line-number="222">        revol_util,</a>
<a class="sourceLine" id="cb66-223" href="#cb66-223" data-line-number="223">        sec_app_revol_util,</a>
<a class="sourceLine" id="cb66-224" href="#cb66-224" data-line-number="224">        settlement_amount,</a>
<a class="sourceLine" id="cb66-225" href="#cb66-225" data-line-number="225">        settlement_percentage,</a>
<a class="sourceLine" id="cb66-226" href="#cb66-226" data-line-number="226">        tax_liens,</a>
<a class="sourceLine" id="cb66-227" href="#cb66-227" data-line-number="227">        tot_coll_amt,</a>
<a class="sourceLine" id="cb66-228" href="#cb66-228" data-line-number="228">        tot_cur_bal,</a>
<a class="sourceLine" id="cb66-229" href="#cb66-229" data-line-number="229">        tot_hi_cred_lim,</a>
<a class="sourceLine" id="cb66-230" href="#cb66-230" data-line-number="230">        total_acc,</a>
<a class="sourceLine" id="cb66-231" href="#cb66-231" data-line-number="231">        total_bal_ex_mort,</a>
<a class="sourceLine" id="cb66-232" href="#cb66-232" data-line-number="232">        total_bal_il,</a>
<a class="sourceLine" id="cb66-233" href="#cb66-233" data-line-number="233">        total_bc_limit,</a>
<a class="sourceLine" id="cb66-234" href="#cb66-234" data-line-number="234">        total_cu_tl,</a>
<a class="sourceLine" id="cb66-235" href="#cb66-235" data-line-number="235">        total_il_high_credit_limit,</a>
<a class="sourceLine" id="cb66-236" href="#cb66-236" data-line-number="236">        total_pymnt,</a>
<a class="sourceLine" id="cb66-237" href="#cb66-237" data-line-number="237">        total_pymnt_inv,</a>
<a class="sourceLine" id="cb66-238" href="#cb66-238" data-line-number="238">        total_rec_int,</a>
<a class="sourceLine" id="cb66-239" href="#cb66-239" data-line-number="239">        total_rec_late_fee,</a>
<a class="sourceLine" id="cb66-240" href="#cb66-240" data-line-number="240">        total_rec_prncp,</a>
<a class="sourceLine" id="cb66-241" href="#cb66-241" data-line-number="241">        total_rev_hi_lim</a>
<a class="sourceLine" id="cb66-242" href="#cb66-242" data-line-number="242">      )</a>
<a class="sourceLine" id="cb66-243" href="#cb66-243" data-line-number="243">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-244" href="#cb66-244" data-line-number="244"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-245" href="#cb66-245" data-line-number="245"><span class="st">    </span><span class="co"># Converts some values to 1/-1 (instead of Boolean)</span></a>
<a class="sourceLine" id="cb66-246" href="#cb66-246" data-line-number="246"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb66-247" href="#cb66-247" data-line-number="247">      <span class="dt">pymnt_plan =</span>           <span class="kw">if_else</span>(pymnt_plan <span class="op">==</span><span class="st"> &quot;y&quot;</span>,           <span class="dv">1</span>, <span class="dv">-1</span>),</a>
<a class="sourceLine" id="cb66-248" href="#cb66-248" data-line-number="248">      <span class="dt">hardship_flag =</span>        <span class="kw">if_else</span>(hardship_flag <span class="op">==</span><span class="st"> &quot;Y&quot;</span>,        <span class="dv">1</span>, <span class="dv">-1</span>),</a>
<a class="sourceLine" id="cb66-249" href="#cb66-249" data-line-number="249">      <span class="dt">debt_settlement_flag =</span> <span class="kw">if_else</span>(debt_settlement_flag <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb66-250" href="#cb66-250" data-line-number="250">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-251" href="#cb66-251" data-line-number="251"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-252" href="#cb66-252" data-line-number="252"><span class="st">    </span><span class="co"># Some values are percentages</span></a>
<a class="sourceLine" id="cb66-253" href="#cb66-253" data-line-number="253"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb66-254" href="#cb66-254" data-line-number="254">      <span class="dt">int_rate =</span> int_rate <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-255" href="#cb66-255" data-line-number="255">      <span class="dt">dti =</span> dti <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-256" href="#cb66-256" data-line-number="256">      <span class="dt">dti_joint =</span> dti_joint <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-257" href="#cb66-257" data-line-number="257">      <span class="dt">revol_util =</span> revol_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-258" href="#cb66-258" data-line-number="258">      <span class="dt">il_util =</span> il_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-259" href="#cb66-259" data-line-number="259">      <span class="dt">all_util =</span> all_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-260" href="#cb66-260" data-line-number="260">      <span class="dt">bc_open_to_buy =</span> bc_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-261" href="#cb66-261" data-line-number="261">      <span class="dt">pct_tl_nvr_dlq =</span> pct_tl_nvr_dlq <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-262" href="#cb66-262" data-line-number="262">      <span class="dt">percent_bc_gt_75 =</span> percent_bc_gt_<span class="dv">75</span> <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb66-263" href="#cb66-263" data-line-number="263">      <span class="dt">sec_app_revol_util =</span> sec_app_revol_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb66-264" href="#cb66-264" data-line-number="264">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-265" href="#cb66-265" data-line-number="265"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-266" href="#cb66-266" data-line-number="266"><span class="st">    </span><span class="co"># Create quasi-centered numerical grades out of grade factors with &quot;A&quot; = 3 down to &quot;G&quot; = -3</span></a>
<a class="sourceLine" id="cb66-267" href="#cb66-267" data-line-number="267"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">grade_num =</span> <span class="dv">4</span> <span class="op">-</span><span class="st"> </span><span class="kw">as.integer</span>(grade)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-268" href="#cb66-268" data-line-number="268"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-269" href="#cb66-269" data-line-number="269"><span class="st">    </span><span class="co"># Ditto with sub_grades. &quot;A1&quot; = +3.4, &quot;A3&quot; = +3.0, down to &quot;G3&quot; = -3.0, &quot;G5&quot; = -3.4</span></a>
<a class="sourceLine" id="cb66-270" href="#cb66-270" data-line-number="270"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sub_grade_num =</span> <span class="fl">3.6</span> <span class="op">-</span><span class="st"> </span><span class="kw">as.integer</span>(sub_grade) <span class="op">/</span><span class="st"> </span><span class="dv">5</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-271" href="#cb66-271" data-line-number="271"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-272" href="#cb66-272" data-line-number="272"><span class="st">    </span><span class="co"># Keep the first 3 digits of the zipcode as numbers</span></a>
<a class="sourceLine" id="cb66-273" href="#cb66-273" data-line-number="273"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">zip_code =</span> <span class="kw">as.integer</span>(<span class="kw">str_sub</span>(zip_code, <span class="dv">1</span>, <span class="dv">3</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-274" href="#cb66-274" data-line-number="274"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-275" href="#cb66-275" data-line-number="275"><span class="st">    </span><span class="co"># order by date</span></a>
<a class="sourceLine" id="cb66-276" href="#cb66-276" data-line-number="276"><span class="st">    </span><span class="kw">arrange</span>(issue_d) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-277" href="#cb66-277" data-line-number="277"><span class="st">    </span></a>
<a class="sourceLine" id="cb66-278" href="#cb66-278" data-line-number="278"><span class="st">    </span><span class="co"># Remove empty columns</span></a>
<a class="sourceLine" id="cb66-279" href="#cb66-279" data-line-number="279"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>id, <span class="op">-</span>member_id, <span class="op">-</span>url)</a>
<a class="sourceLine" id="cb66-280" href="#cb66-280" data-line-number="280">  </a>
<a class="sourceLine" id="cb66-281" href="#cb66-281" data-line-number="281">  <span class="kw">saveRDS</span>(lc, <span class="st">&quot;datasets/lending_club_reformatted.rds&quot;</span>)</a>
<a class="sourceLine" id="cb66-282" href="#cb66-282" data-line-number="282">  </a>
<a class="sourceLine" id="cb66-283" href="#cb66-283" data-line-number="283">  </a>
<a class="sourceLine" id="cb66-284" href="#cb66-284" data-line-number="284">  <span class="co"># Select loans which have matured or been terminated</span></a>
<a class="sourceLine" id="cb66-285" href="#cb66-285" data-line-number="285">  past_loans &lt;-<span class="st"> </span>lc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-286" href="#cb66-286" data-line-number="286"><span class="st">    </span><span class="kw">filter</span>(</a>
<a class="sourceLine" id="cb66-287" href="#cb66-287" data-line-number="287">      loan_status <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb66-288" href="#cb66-288" data-line-number="288">        <span class="st">&quot;Charged Off&quot;</span>,</a>
<a class="sourceLine" id="cb66-289" href="#cb66-289" data-line-number="289">        <span class="st">&quot;Does not meet the credit policy. Status:Charged Off&quot;</span>,</a>
<a class="sourceLine" id="cb66-290" href="#cb66-290" data-line-number="290">        <span class="st">&quot;Does not meet the credit policy. Status:Fully Paid&quot;</span>,</a>
<a class="sourceLine" id="cb66-291" href="#cb66-291" data-line-number="291">        <span class="st">&quot;Fully Paid&quot;</span></a>
<a class="sourceLine" id="cb66-292" href="#cb66-292" data-line-number="292">      )</a>
<a class="sourceLine" id="cb66-293" href="#cb66-293" data-line-number="293">    )</a>
<a class="sourceLine" id="cb66-294" href="#cb66-294" data-line-number="294">  </a>
<a class="sourceLine" id="cb66-295" href="#cb66-295" data-line-number="295">  <span class="kw">saveRDS</span>(past_loans, <span class="st">&quot;datasets/lending_club_reformatted_paid.rds&quot;</span>)</a>
<a class="sourceLine" id="cb66-296" href="#cb66-296" data-line-number="296">})</a></code></pre></div>

</div>
<div id="zip-codes-and-fips-codes" class="section level3">
<h3><span class="header-section-number">5.6.2</span> Zip codes and FIPS codes</h3>
<p>The R package <code>zipcode</code> was installed.</p>

<div class="sourceCode" id="cb67"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" href="#cb67-1" data-line-number="1"><span class="co">#</span></a>
<a class="sourceLine" id="cb67-2" href="#cb67-2" data-line-number="2"><span class="co"># ZIPCodes dataset.</span></a>
<a class="sourceLine" id="cb67-3" href="#cb67-3" data-line-number="3"><span class="co">#</span></a>
<a class="sourceLine" id="cb67-4" href="#cb67-4" data-line-number="4"></a>
<a class="sourceLine" id="cb67-5" href="#cb67-5" data-line-number="5"><span class="kw">library</span>(zipcode)</a>
<a class="sourceLine" id="cb67-6" href="#cb67-6" data-line-number="6"><span class="kw">data</span>(zipcode)</a>
<a class="sourceLine" id="cb67-7" href="#cb67-7" data-line-number="7">zips &lt;-<span class="st"> </span>zipcode <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-8" href="#cb67-8" data-line-number="8"><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-9" href="#cb67-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">zip =</span> <span class="kw">as.integer</span>(<span class="kw">str_sub</span>(zip, <span class="dv">1</span>, <span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb67-10" href="#cb67-10" data-line-number="10"></a>
<a class="sourceLine" id="cb67-11" href="#cb67-11" data-line-number="11"><span class="kw">saveRDS</span>(zips, <span class="st">&quot;datasets/zips.rds&quot;</span>)</a></code></pre></div>

<p>A csv file containing zip codes, FIPS codes and population information was downloaded from the <em>Simple Maps</em><a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a> website.</p>

<div class="sourceCode" id="cb68"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" href="#cb68-1" data-line-number="1"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb68-2" href="#cb68-2" data-line-number="2">  kaggleCodes &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/ZIP-COUNTY-FIPS_2017-06.csv&quot;</span>)</a>
<a class="sourceLine" id="cb68-3" href="#cb68-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb68-4" href="#cb68-4" data-line-number="4">  kaggleCodes &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb68-5" href="#cb68-5" data-line-number="5"><span class="st">    </span>kaggleCodes <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-6" href="#cb68-6" data-line-number="6"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-7" href="#cb68-7" data-line-number="7"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">zip =</span> <span class="kw">floor</span>(ZIP<span class="op">/</span><span class="dv">100</span>), </a>
<a class="sourceLine" id="cb68-8" href="#cb68-8" data-line-number="8">           <span class="dt">FIPS =</span> STCOUNTYFP, </a>
<a class="sourceLine" id="cb68-9" href="#cb68-9" data-line-number="9">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;County&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb68-10" href="#cb68-10" data-line-number="10">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Borough&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb68-11" href="#cb68-11" data-line-number="11">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Municipio&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb68-12" href="#cb68-12" data-line-number="12">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Parish&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb68-13" href="#cb68-13" data-line-number="13">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Census Area&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-14" href="#cb68-14" data-line-number="14"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">county =</span> COUNTYNAME) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-15" href="#cb68-15" data-line-number="15"><span class="st">    </span><span class="kw">select</span>(zip, county, FIPS) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb68-16" href="#cb68-16" data-line-number="16"><span class="st">    </span><span class="kw">arrange</span>(zip)</a>
<a class="sourceLine" id="cb68-17" href="#cb68-17" data-line-number="17"></a>
<a class="sourceLine" id="cb68-18" href="#cb68-18" data-line-number="18">  <span class="kw">saveRDS</span>(zipfips, <span class="st">&quot;datasets/kaggleCodes.rds&quot;</span>)</a>
<a class="sourceLine" id="cb68-19" href="#cb68-19" data-line-number="19">})</a></code></pre></div>

</div>
<div id="market-interest-rates" class="section level3">
<h3><span class="header-section-number">5.6.3</span> Market interest rates</h3>
<p>Market interest rates (3-year and 5-year swap rates) were download from the Saint Louis Federal Reserve Bank. Datasets are split between before and after the LIBOR fixing scandal. The datasets are merged with disctinct dates.</p>
<p>Download sources are:</p>
<ul>
<li>Pre-LIBOR 3-y swap <a href="https://fred.stlouisfed.org/series/DSWP3" class="uri">https://fred.stlouisfed.org/series/DSWP3</a></li>
<li><p>Post-LIBOR 3-y swap <a href="https://fred.stlouisfed.org/series/ICERATES1100USD3Y" class="uri">https://fred.stlouisfed.org/series/ICERATES1100USD3Y</a></p></li>
<li>Pre-LIBOR 5-y swap <a href="https://fred.stlouisfed.org/series/MSWP5" class="uri">https://fred.stlouisfed.org/series/MSWP5</a></li>
<li><p>Post-LIBOR 5-y swap <a href="https://fred.stlouisfed.org/series/ICERATES1100USD5Y" class="uri">https://fred.stlouisfed.org/series/ICERATES1100USD5Y</a></p></li>
</ul>

<div class="sourceCode" id="cb69"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" href="#cb69-1" data-line-number="1"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb69-2" href="#cb69-2" data-line-number="2">  LIBOR3Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/DSWP3.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-3" href="#cb69-3" data-line-number="3"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-4" href="#cb69-4" data-line-number="4"><span class="st">    </span><span class="kw">filter</span>(DSWP3 <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-5" href="#cb69-5" data-line-number="5"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb69-6" href="#cb69-6" data-line-number="6">           <span class="dt">RATE3Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(DSWP3)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-7" href="#cb69-7" data-line-number="7"><span class="st">    </span><span class="kw">select</span>(DATE, RATE3Y)</a>
<a class="sourceLine" id="cb69-8" href="#cb69-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb69-9" href="#cb69-9" data-line-number="9">  ICE3Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/ICERATES1100USD3Y.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-10" href="#cb69-10" data-line-number="10"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-11" href="#cb69-11" data-line-number="11"><span class="st">    </span><span class="kw">filter</span>(ICERATES1100USD3Y <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-12" href="#cb69-12" data-line-number="12"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb69-13" href="#cb69-13" data-line-number="13">           <span class="dt">RATE3Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(ICERATES1100USD3Y)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-14" href="#cb69-14" data-line-number="14"><span class="st">    </span><span class="kw">select</span>(DATE, RATE3Y)</a>
<a class="sourceLine" id="cb69-15" href="#cb69-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb69-16" href="#cb69-16" data-line-number="16">  </a>
<a class="sourceLine" id="cb69-17" href="#cb69-17" data-line-number="17">  LIBOR5Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/DSWP5.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-18" href="#cb69-18" data-line-number="18"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-19" href="#cb69-19" data-line-number="19"><span class="st">    </span><span class="kw">filter</span>(DSWP5 <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-20" href="#cb69-20" data-line-number="20"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb69-21" href="#cb69-21" data-line-number="21">           <span class="dt">RATE5Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(DSWP5)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-22" href="#cb69-22" data-line-number="22"><span class="st">    </span><span class="kw">select</span>(DATE, RATE5Y)</a>
<a class="sourceLine" id="cb69-23" href="#cb69-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb69-24" href="#cb69-24" data-line-number="24">  ICE5Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/ICERATES1100USD5Y.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-25" href="#cb69-25" data-line-number="25"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-26" href="#cb69-26" data-line-number="26"><span class="st">    </span><span class="kw">filter</span>(ICERATES1100USD5Y <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-27" href="#cb69-27" data-line-number="27"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb69-28" href="#cb69-28" data-line-number="28">           <span class="dt">RATE5Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(ICERATES1100USD5Y)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-29" href="#cb69-29" data-line-number="29"><span class="st">    </span><span class="kw">select</span>(DATE, RATE5Y)</a>
<a class="sourceLine" id="cb69-30" href="#cb69-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb69-31" href="#cb69-31" data-line-number="31">  RATES3Y &lt;-<span class="st"> </span>LIBOR3Y <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rbind</span>(ICE3Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-32" href="#cb69-32" data-line-number="32"><span class="st">    </span><span class="kw">arrange</span>(DATE) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>(DATE, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb69-33" href="#cb69-33" data-line-number="33">  </a>
<a class="sourceLine" id="cb69-34" href="#cb69-34" data-line-number="34">  RATES5Y &lt;-<span class="st"> </span>LIBOR5Y <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rbind</span>(ICE5Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-35" href="#cb69-35" data-line-number="35"><span class="st">    </span><span class="kw">arrange</span>(DATE) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>(DATE, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb69-36" href="#cb69-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb69-37" href="#cb69-37" data-line-number="37">  <span class="kw">saveRDS</span>(RATES3Y, <span class="st">&quot;datasets/rates3Y.rds&quot;</span>)</a>
<a class="sourceLine" id="cb69-38" href="#cb69-38" data-line-number="38">  <span class="kw">saveRDS</span>(RATES5Y, <span class="st">&quot;datasets/rates5Y.rds&quot;</span>)</a>
<a class="sourceLine" id="cb69-39" href="#cb69-39" data-line-number="39">  </a>
<a class="sourceLine" id="cb69-40" href="#cb69-40" data-line-number="40">  </a>
<a class="sourceLine" id="cb69-41" href="#cb69-41" data-line-number="41">  <span class="co"># Note there are 7212 days from 1 Jan 2000 to 30 Sep 2019</span></a>
<a class="sourceLine" id="cb69-42" href="#cb69-42" data-line-number="42">  <span class="co">#</span></a>
<a class="sourceLine" id="cb69-43" href="#cb69-43" data-line-number="43">  <span class="co"># (ymd(&quot;2000-01-01&quot;) %--% ymd(&quot;2019-09-30&quot;)) %/% days(1)</span></a>
<a class="sourceLine" id="cb69-44" href="#cb69-44" data-line-number="44">  RATES &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">n =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">7212</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-45" href="#cb69-45" data-line-number="45"><span class="st">    </span></a>
<a class="sourceLine" id="cb69-46" href="#cb69-46" data-line-number="46"><span class="st">    </span><span class="co"># Create a column with all dates</span></a>
<a class="sourceLine" id="cb69-47" href="#cb69-47" data-line-number="47"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">ymd</span>(<span class="st">&quot;2000-01-01&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">days</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-48" href="#cb69-48" data-line-number="48"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>n) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-49" href="#cb69-49" data-line-number="49"><span class="st">    </span></a>
<a class="sourceLine" id="cb69-50" href="#cb69-50" data-line-number="50"><span class="st">    </span><span class="co"># Add all daily 3- then 5-year rates and fill missing down</span></a>
<a class="sourceLine" id="cb69-51" href="#cb69-51" data-line-number="51"><span class="st">    </span><span class="kw">left_join</span>(RATES3Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-52" href="#cb69-52" data-line-number="52"><span class="st">    </span><span class="kw">fill</span>(RATE3Y, <span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-53" href="#cb69-53" data-line-number="53"><span class="st">    </span></a>
<a class="sourceLine" id="cb69-54" href="#cb69-54" data-line-number="54"><span class="st">    </span><span class="kw">left_join</span>(RATES5Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-55" href="#cb69-55" data-line-number="55"><span class="st">    </span><span class="kw">fill</span>(RATE5Y, <span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>)</a>
<a class="sourceLine" id="cb69-56" href="#cb69-56" data-line-number="56">  </a>
<a class="sourceLine" id="cb69-57" href="#cb69-57" data-line-number="57">  <span class="kw">saveRDS</span>(RATES, <span class="st">&quot;datasets/rates.rds&quot;</span>)</a>
<a class="sourceLine" id="cb69-58" href="#cb69-58" data-line-number="58">})</a></code></pre></div>

</div>
</div>
<div id="sec:list-model-variables" class="section level2">
<h2><span class="header-section-number">5.7</span> List of variables</h2>
<p>This table presents the list of variables provided in the original dataset. The descriptions come from a spreadsheet attached with the dataset and, unfortunately, are not extremely precise and subject to interpretation. We added comments and/or particular interpretations in <em>CAPITAL LETTERS</em>.</p>



</div>
<div id="calculations-of-the-internal-rate-of-returns-and-month-to-default" class="section level2">
<h2><span class="header-section-number">5.8</span> Calculations of the internal rate of returns and month-to-default</h2>
<p>The following shows two versions of the same code. The R version is provided because of the description of the assignment. However, the R version takes just under a full day to run. A Julia version, which is a direct translation of the R code, runs in about 150s (ca. 500x faster).</p>
<div id="r-code" class="section level3">
<h3><span class="header-section-number">5.8.1</span> R code</h3>

<div class="sourceCode" id="cb70"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" href="#cb70-1" data-line-number="1"><span class="co">###################################################################################################</span></a>
<a class="sourceLine" id="cb70-2" href="#cb70-2" data-line-number="2"><span class="co">#</span></a>
<a class="sourceLine" id="cb70-3" href="#cb70-3" data-line-number="3"><span class="co"># Given some numerical parameters describing a loan in the dataset, returns its Internal Rate</span></a>
<a class="sourceLine" id="cb70-4" href="#cb70-4" data-line-number="4"><span class="co"># of Return.</span></a>
<a class="sourceLine" id="cb70-5" href="#cb70-5" data-line-number="5"><span class="co">#</span></a>
<a class="sourceLine" id="cb70-6" href="#cb70-6" data-line-number="6"><span class="co"># In the first instance, the function creates a schedule of payments.</span></a>
<a class="sourceLine" id="cb70-7" href="#cb70-7" data-line-number="7"><span class="co"># In many cases, the schedule will be extremely simple: a series of 36 or 60 equal instalements.</span></a>
<a class="sourceLine" id="cb70-8" href="#cb70-8" data-line-number="8"><span class="co">#</span></a>
<a class="sourceLine" id="cb70-9" href="#cb70-9" data-line-number="9"><span class="co"># But in some cases, a loan repayment are accelerated. Therefore the total amount of interest will</span></a>
<a class="sourceLine" id="cb70-10" href="#cb70-10" data-line-number="10"><span class="co"># be lower than expected (but this is good for the investor because highe interest rate over</span></a>
<a class="sourceLine" id="cb70-11" href="#cb70-11" data-line-number="11"><span class="co"># shorter tenor.).</span></a>
<a class="sourceLine" id="cb70-12" href="#cb70-12" data-line-number="12"><span class="co">#</span></a>
<a class="sourceLine" id="cb70-13" href="#cb70-13" data-line-number="13"><span class="co"># In other cases, the borrower defaults. Overall payments are less than expected.</span></a>
<a class="sourceLine" id="cb70-14" href="#cb70-14" data-line-number="14"><span class="co">#</span></a>
<a class="sourceLine" id="cb70-15" href="#cb70-15" data-line-number="15"><span class="co"># Based on the limited information of the dataset, the function makes educated guesses on the exact schedule.</span></a>
<a class="sourceLine" id="cb70-16" href="#cb70-16" data-line-number="16"><span class="co">#</span></a>
<a class="sourceLine" id="cb70-17" href="#cb70-17" data-line-number="17"><span class="co"># </span><span class="al">WARNING</span><span class="co">: THIS IS NOT OPTIMISED. RUNNING THIS FOR ALL LOANS (1.3 MLN OF THEM) TAKES CA.20 HOURS !!!!</span></a>
<a class="sourceLine" id="cb70-18" href="#cb70-18" data-line-number="18"><span class="co">#</span></a>
<a class="sourceLine" id="cb70-19" href="#cb70-19" data-line-number="19">calculateIRR &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">loanNumber =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb70-20" href="#cb70-20" data-line-number="20">                         <span class="dt">loan =</span> <span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb70-21" href="#cb70-21" data-line-number="21">                         <span class="dt">intRate =</span> <span class="fl">0.02</span>,</a>
<a class="sourceLine" id="cb70-22" href="#cb70-22" data-line-number="22">                         <span class="dt">term =</span> <span class="dv">36</span>,</a>
<a class="sourceLine" id="cb70-23" href="#cb70-23" data-line-number="23">                         <span class="dt">totalPaid =</span> <span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb70-24" href="#cb70-24" data-line-number="24">                         totalPrincipalPaid,</a>
<a class="sourceLine" id="cb70-25" href="#cb70-25" data-line-number="25">                         totalInterestPaid,</a>
<a class="sourceLine" id="cb70-26" href="#cb70-26" data-line-number="26">                         <span class="dt">recoveries =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb70-27" href="#cb70-27" data-line-number="27">                         <span class="dt">lateFees =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb70-28" href="#cb70-28" data-line-number="28">                         <span class="dt">showSchedule =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb70-29" href="#cb70-29" data-line-number="29">  <span class="kw">require</span>(tidyverse)</a>
<a class="sourceLine" id="cb70-30" href="#cb70-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb70-31" href="#cb70-31" data-line-number="31">  <span class="co"># number of monthly payments.</span></a>
<a class="sourceLine" id="cb70-32" href="#cb70-32" data-line-number="32">  <span class="co"># It exceeds 60 months in case recoveries on a 60-month loan takes the schedule after 60 months.</span></a>
<a class="sourceLine" id="cb70-33" href="#cb70-33" data-line-number="33">  nMonths &lt;-<span class="st"> </span><span class="dv">90</span></a>
<a class="sourceLine" id="cb70-34" href="#cb70-34" data-line-number="34">  </a>
<a class="sourceLine" id="cb70-35" href="#cb70-35" data-line-number="35">  <span class="co"># Months after which a loan defaults (normal tenor if no default or early prepayment)</span></a>
<a class="sourceLine" id="cb70-36" href="#cb70-36" data-line-number="36">  monthDefault =<span class="st"> </span>term</a>
<a class="sourceLine" id="cb70-37" href="#cb70-37" data-line-number="37">  </a>
<a class="sourceLine" id="cb70-38" href="#cb70-38" data-line-number="38">  <span class="co"># Note: *100 /100 to calculate in cent because ceiling cannot specify significant digits.</span></a>
<a class="sourceLine" id="cb70-39" href="#cb70-39" data-line-number="39">  installment &lt;-</a>
<a class="sourceLine" id="cb70-40" href="#cb70-40" data-line-number="40"><span class="st">    </span><span class="kw">ceiling</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>loan <span class="op">*</span><span class="st"> </span>intRate <span class="op">/</span><span class="st"> </span><span class="dv">12</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>intRate <span class="op">/</span><span class="st"> </span><span class="dv">12</span>) <span class="op">^</span><span class="st"> </span>term)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb70-41" href="#cb70-41" data-line-number="41">  </a>
<a class="sourceLine" id="cb70-42" href="#cb70-42" data-line-number="42">  <span class="co"># We create a schedule</span></a>
<a class="sourceLine" id="cb70-43" href="#cb70-43" data-line-number="43">  schedule &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb70-44" href="#cb70-44" data-line-number="44">    <span class="dt">month =</span> <span class="dv">0</span><span class="op">:</span>nMonths,</a>
<a class="sourceLine" id="cb70-45" href="#cb70-45" data-line-number="45">    <span class="dt">monthlyPayment =</span> <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb70-46" href="#cb70-46" data-line-number="46">    <span class="dt">totalPandI =</span> <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb70-47" href="#cb70-47" data-line-number="47">    <span class="dt">totalI =</span> <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb70-48" href="#cb70-48" data-line-number="48">    <span class="dt">totalP =</span> <span class="fl">0.0</span></a>
<a class="sourceLine" id="cb70-49" href="#cb70-49" data-line-number="49">  )</a>
<a class="sourceLine" id="cb70-50" href="#cb70-50" data-line-number="50">  </a>
<a class="sourceLine" id="cb70-51" href="#cb70-51" data-line-number="51">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>(nMonths <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)) {</a>
<a class="sourceLine" id="cb70-52" href="#cb70-52" data-line-number="52">    <span class="co"># Get situation at the end of previous month</span></a>
<a class="sourceLine" id="cb70-53" href="#cb70-53" data-line-number="53">    previousTotalPandI &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalPandI&quot;</span>])</a>
<a class="sourceLine" id="cb70-54" href="#cb70-54" data-line-number="54">    previousTotalP     &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalP&quot;</span>])</a>
<a class="sourceLine" id="cb70-55" href="#cb70-55" data-line-number="55">    previousTotalI     &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalI&quot;</span>])</a>
<a class="sourceLine" id="cb70-56" href="#cb70-56" data-line-number="56">    </a>
<a class="sourceLine" id="cb70-57" href="#cb70-57" data-line-number="57">    <span class="co"># This is the beginning of a new month. First and foremost, the borrower is expected to pay the</span></a>
<a class="sourceLine" id="cb70-58" href="#cb70-58" data-line-number="58">    <span class="co"># accrued interest on amount of principal outstanding.</span></a>
<a class="sourceLine" id="cb70-59" href="#cb70-59" data-line-number="59">    <span class="co"># ceiling doesn&#39;t seem accept to accept significative digits.</span></a>
<a class="sourceLine" id="cb70-60" href="#cb70-60" data-line-number="60">    accruedInterest &lt;-</a>
<a class="sourceLine" id="cb70-61" href="#cb70-61" data-line-number="61"><span class="st">      </span><span class="kw">ceiling</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(loan <span class="op">-</span><span class="st"> </span>previousTotalP) <span class="op">*</span><span class="st"> </span>intRate <span class="op">/</span><span class="st"> </span><span class="dv">12</span>) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb70-62" href="#cb70-62" data-line-number="62">    </a>
<a class="sourceLine" id="cb70-63" href="#cb70-63" data-line-number="63">    <span class="co"># If that amount takes the schedule above the total amount of interest shown in the data set,</span></a>
<a class="sourceLine" id="cb70-64" href="#cb70-64" data-line-number="64">    <span class="co"># we should stop the schedule at this point</span></a>
<a class="sourceLine" id="cb70-65" href="#cb70-65" data-line-number="65">    <span class="cf">if</span> (previousTotalI <span class="op">+</span><span class="st"> </span>accruedInterest <span class="op">&gt;</span><span class="st"> </span>totalInterestPaid) {</a>
<a class="sourceLine" id="cb70-66" href="#cb70-66" data-line-number="66">      <span class="co"># We stop the normal schedule at this date.</span></a>
<a class="sourceLine" id="cb70-67" href="#cb70-67" data-line-number="67">      <span class="co"># Interest is paid (although less than scheduled)</span></a>
<a class="sourceLine" id="cb70-68" href="#cb70-68" data-line-number="68">      schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb70-69" href="#cb70-69" data-line-number="69"><span class="st">        </span>totalInterestPaid <span class="op">-</span><span class="st"> </span>previousTotalI</a>
<a class="sourceLine" id="cb70-70" href="#cb70-70" data-line-number="70">      </a>
<a class="sourceLine" id="cb70-71" href="#cb70-71" data-line-number="71">      <span class="co"># As well as whatever principal is left as per the dataset</span></a>
<a class="sourceLine" id="cb70-72" href="#cb70-72" data-line-number="72">      schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb70-73" href="#cb70-73" data-line-number="73"><span class="st">        </span>schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] <span class="op">+</span><span class="st"> </span>totalPrincipalPaid <span class="op">-</span><span class="st"> </span>previousTotalP</a>
<a class="sourceLine" id="cb70-74" href="#cb70-74" data-line-number="74">      </a>
<a class="sourceLine" id="cb70-75" href="#cb70-75" data-line-number="75">      <span class="co"># Then 3-month after the last payment date, recoveries and and late fees are paid</span></a>
<a class="sourceLine" id="cb70-76" href="#cb70-76" data-line-number="76">      schedule[i <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb70-77" href="#cb70-77" data-line-number="77"><span class="st">        </span>schedule[i <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="st">&quot;monthlyPayment&quot;</span>] <span class="op">+</span><span class="st"> </span>recoveries <span class="op">+</span><span class="st"> </span>lateFees</a>
<a class="sourceLine" id="cb70-78" href="#cb70-78" data-line-number="78">      </a>
<a class="sourceLine" id="cb70-79" href="#cb70-79" data-line-number="79">      <span class="co"># Not really useful, but for completeness</span></a>
<a class="sourceLine" id="cb70-80" href="#cb70-80" data-line-number="80">      schedule[i, <span class="st">&quot;totalPandI&quot;</span>] &lt;-<span class="st"> </span>totalPaid</a>
<a class="sourceLine" id="cb70-81" href="#cb70-81" data-line-number="81">      schedule[i, <span class="st">&quot;totalI&quot;</span>]     &lt;-<span class="st"> </span>totalInterestPaid</a>
<a class="sourceLine" id="cb70-82" href="#cb70-82" data-line-number="82">      schedule[i, <span class="st">&quot;totalP&quot;</span>]     &lt;-<span class="st"> </span>totalPrincipalPaid</a>
<a class="sourceLine" id="cb70-83" href="#cb70-83" data-line-number="83">      </a>
<a class="sourceLine" id="cb70-84" href="#cb70-84" data-line-number="84">      <span class="co"># If total principal paid is less than borrower, then it is a default, and the monthDefault</span></a>
<a class="sourceLine" id="cb70-85" href="#cb70-85" data-line-number="85">      <span class="co"># is adjusted.</span></a>
<a class="sourceLine" id="cb70-86" href="#cb70-86" data-line-number="86">      <span class="cf">if</span> (totalPrincipalPaid <span class="op">&lt;</span><span class="st"> </span>loan) {</a>
<a class="sourceLine" id="cb70-87" href="#cb70-87" data-line-number="87">        monthDefault =<span class="st"> </span>i</a>
<a class="sourceLine" id="cb70-88" href="#cb70-88" data-line-number="88">      }</a>
<a class="sourceLine" id="cb70-89" href="#cb70-89" data-line-number="89">      </a>
<a class="sourceLine" id="cb70-90" href="#cb70-90" data-line-number="90">      <span class="co"># No more payments to add to the schedule</span></a>
<a class="sourceLine" id="cb70-91" href="#cb70-91" data-line-number="91">      <span class="cf">break</span>()</a>
<a class="sourceLine" id="cb70-92" href="#cb70-92" data-line-number="92">      </a>
<a class="sourceLine" id="cb70-93" href="#cb70-93" data-line-number="93">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb70-94" href="#cb70-94" data-line-number="94">      <span class="co"># Deal with normal schedule</span></a>
<a class="sourceLine" id="cb70-95" href="#cb70-95" data-line-number="95">      schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-<span class="st"> </span>installment</a>
<a class="sourceLine" id="cb70-96" href="#cb70-96" data-line-number="96">      schedule[i, <span class="st">&quot;totalPandI&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb70-97" href="#cb70-97" data-line-number="97"><span class="st">        </span>schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalPandI&quot;</span>] <span class="op">+</span><span class="st"> </span>installment</a>
<a class="sourceLine" id="cb70-98" href="#cb70-98" data-line-number="98">      schedule[i, <span class="st">&quot;totalI&quot;</span>]     &lt;-</a>
<a class="sourceLine" id="cb70-99" href="#cb70-99" data-line-number="99"><span class="st">        </span>schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalI&quot;</span>]   <span class="op">+</span><span class="st"> </span>accruedInterest</a>
<a class="sourceLine" id="cb70-100" href="#cb70-100" data-line-number="100">      schedule[i, <span class="st">&quot;totalP&quot;</span>]     &lt;-</a>
<a class="sourceLine" id="cb70-101" href="#cb70-101" data-line-number="101"><span class="st">        </span>schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalP&quot;</span>]   <span class="op">+</span><span class="st"> </span>installment <span class="op">-</span><span class="st"> </span>accruedInterest</a>
<a class="sourceLine" id="cb70-102" href="#cb70-102" data-line-number="102">    }</a>
<a class="sourceLine" id="cb70-103" href="#cb70-103" data-line-number="103">  }</a>
<a class="sourceLine" id="cb70-104" href="#cb70-104" data-line-number="104">  </a>
<a class="sourceLine" id="cb70-105" href="#cb70-105" data-line-number="105">  <span class="co"># At this point schedule[, &quot;monthlyPayment&quot;] contains the schedule of all payments, but needs to</span></a>
<a class="sourceLine" id="cb70-106" href="#cb70-106" data-line-number="106">  <span class="co"># include the initial loan.</span></a>
<a class="sourceLine" id="cb70-107" href="#cb70-107" data-line-number="107">  schedule[<span class="dv">1</span>, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-<span class="st"> </span><span class="op">-</span>loan</a>
<a class="sourceLine" id="cb70-108" href="#cb70-108" data-line-number="108">  </a>
<a class="sourceLine" id="cb70-109" href="#cb70-109" data-line-number="109">  <span class="cf">if</span> (showSchedule) {</a>
<a class="sourceLine" id="cb70-110" href="#cb70-110" data-line-number="110">    schedule <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">view</span>()</a>
<a class="sourceLine" id="cb70-111" href="#cb70-111" data-line-number="111">  }</a>
<a class="sourceLine" id="cb70-112" href="#cb70-112" data-line-number="112">  </a>
<a class="sourceLine" id="cb70-113" href="#cb70-113" data-line-number="113">  NPV &lt;-<span class="st"> </span><span class="cf">function</span>(interest, cashFlow) {</a>
<a class="sourceLine" id="cb70-114" href="#cb70-114" data-line-number="114">    t =<span class="st"> </span><span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(cashFlow) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb70-115" href="#cb70-115" data-line-number="115">    <span class="kw">sum</span>(cashFlow <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>interest) <span class="op">^</span><span class="st"> </span>t)</a>
<a class="sourceLine" id="cb70-116" href="#cb70-116" data-line-number="116">  }</a>
<a class="sourceLine" id="cb70-117" href="#cb70-117" data-line-number="117">  </a>
<a class="sourceLine" id="cb70-118" href="#cb70-118" data-line-number="118">  IRR &lt;-<span class="st"> </span><span class="cf">function</span>(CF) {</a>
<a class="sourceLine" id="cb70-119" href="#cb70-119" data-line-number="119">    res &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb70-120" href="#cb70-120" data-line-number="120">    <span class="kw">try</span>({</a>
<a class="sourceLine" id="cb70-121" href="#cb70-121" data-line-number="121">      res &lt;-<span class="st"> </span><span class="kw">uniroot</span>(NPV, <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.9</span>, <span class="dv">1</span>), <span class="dt">cashFlow =</span> CF)<span class="op">$</span>root</a>
<a class="sourceLine" id="cb70-122" href="#cb70-122" data-line-number="122">    },</a>
<a class="sourceLine" id="cb70-123" href="#cb70-123" data-line-number="123">    <span class="dt">silent =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb70-124" href="#cb70-124" data-line-number="124">    <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb70-125" href="#cb70-125" data-line-number="125">  }</a>
<a class="sourceLine" id="cb70-126" href="#cb70-126" data-line-number="126">  </a>
<a class="sourceLine" id="cb70-127" href="#cb70-127" data-line-number="127">  <span class="kw">return</span>(<span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb70-128" href="#cb70-128" data-line-number="128">    <span class="dt">loanID =</span> loanNumber,</a>
<a class="sourceLine" id="cb70-129" href="#cb70-129" data-line-number="129">    <span class="dt">IRR =</span> <span class="kw">round</span>(<span class="kw">as.numeric</span>(<span class="kw">IRR</span>(</a>
<a class="sourceLine" id="cb70-130" href="#cb70-130" data-line-number="130">      schedule<span class="op">$</span>monthlyPayment</a>
<a class="sourceLine" id="cb70-131" href="#cb70-131" data-line-number="131">    ) <span class="op">*</span><span class="st"> </span><span class="dv">12</span>), <span class="dt">digits =</span> <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb70-132" href="#cb70-132" data-line-number="132">    <span class="dt">monthDefault =</span> monthDefault</a>
<a class="sourceLine" id="cb70-133" href="#cb70-133" data-line-number="133">  ))</a>
<a class="sourceLine" id="cb70-134" href="#cb70-134" data-line-number="134">}</a>
<a class="sourceLine" id="cb70-135" href="#cb70-135" data-line-number="135"></a>
<a class="sourceLine" id="cb70-136" href="#cb70-136" data-line-number="136">loanNumberIRR &lt;-<span class="st"> </span><span class="cf">function</span>(loanNumber) {</a>
<a class="sourceLine" id="cb70-137" href="#cb70-137" data-line-number="137">  <span class="kw">require</span>(tidyverse)</a>
<a class="sourceLine" id="cb70-138" href="#cb70-138" data-line-number="138">  </a>
<a class="sourceLine" id="cb70-139" href="#cb70-139" data-line-number="139">  l &lt;-<span class="st"> </span>loans <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(loanID <span class="op">==</span><span class="st"> </span>loanNumber)</a>
<a class="sourceLine" id="cb70-140" href="#cb70-140" data-line-number="140">  <span class="kw">calculateIRR</span>(</a>
<a class="sourceLine" id="cb70-141" href="#cb70-141" data-line-number="141">    <span class="dt">loanNumber =</span> l<span class="op">$</span>loanID,</a>
<a class="sourceLine" id="cb70-142" href="#cb70-142" data-line-number="142">    <span class="dt">loan =</span> l<span class="op">$</span>funded_amnt, <span class="dt">intRate =</span> l<span class="op">$</span>int_rate, <span class="dt">term =</span> l<span class="op">$</span>term, </a>
<a class="sourceLine" id="cb70-143" href="#cb70-143" data-line-number="143">    <span class="dt">totalPaid =</span> l<span class="op">$</span>total_pymnt, <span class="dt">totalPrincipalPaid =</span> l<span class="op">$</span>total_rec_prncp, <span class="dt">totalInterestPaid =</span> l<span class="op">$</span>total_rec_int, </a>
<a class="sourceLine" id="cb70-144" href="#cb70-144" data-line-number="144">    <span class="dt">recoveries =</span> l<span class="op">$</span>recoveries, <span class="dt">lateFees =</span> l<span class="op">$</span>total_rec_late_fee, </a>
<a class="sourceLine" id="cb70-145" href="#cb70-145" data-line-number="145">    <span class="dt">showSchedule =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb70-146" href="#cb70-146" data-line-number="146">  )</a>
<a class="sourceLine" id="cb70-147" href="#cb70-147" data-line-number="147">}</a></code></pre></div>


<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" href="#cb71-1" data-line-number="1"><span class="co"># </span></a>
<a class="sourceLine" id="cb71-2" href="#cb71-2" data-line-number="2"><span class="co"># Calculate all the IRRs and month of default for all the loans. </span></a>
<a class="sourceLine" id="cb71-3" href="#cb71-3" data-line-number="3"><span class="co"># </span><span class="al">WARNING</span><span class="co">: This takes around a full day to run!!!!</span></a>
<a class="sourceLine" id="cb71-4" href="#cb71-4" data-line-number="4"><span class="co"># </span></a>
<a class="sourceLine" id="cb71-5" href="#cb71-5" data-line-number="5"><span class="co"># The actual data was generated by the Julia version, with cross-checks.</span></a>
<a class="sourceLine" id="cb71-6" href="#cb71-6" data-line-number="6"><span class="co"># Julia version takes about 150 sec on the same unoptimised code.</span></a>
<a class="sourceLine" id="cb71-7" href="#cb71-7" data-line-number="7"><span class="co"># </span></a>
<a class="sourceLine" id="cb71-8" href="#cb71-8" data-line-number="8"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb71-9" href="#cb71-9" data-line-number="9">  loansIRR &lt;-</a>
<a class="sourceLine" id="cb71-10" href="#cb71-10" data-line-number="10"><span class="st">    </span>loans <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-11" href="#cb71-11" data-line-number="11"><span class="st">    </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-12" href="#cb71-12" data-line-number="12"><span class="st">    </span><span class="kw">do</span>(</a>
<a class="sourceLine" id="cb71-13" href="#cb71-13" data-line-number="13">      <span class="kw">calculateIRR</span>(</a>
<a class="sourceLine" id="cb71-14" href="#cb71-14" data-line-number="14">        <span class="dt">loanNumber =</span> .<span class="op">$</span>loanID,</a>
<a class="sourceLine" id="cb71-15" href="#cb71-15" data-line-number="15">        <span class="dt">loan =</span> .<span class="op">$</span>funded_amnt,</a>
<a class="sourceLine" id="cb71-16" href="#cb71-16" data-line-number="16">        <span class="dt">intRate =</span> .<span class="op">$</span>int_rate,</a>
<a class="sourceLine" id="cb71-17" href="#cb71-17" data-line-number="17">        <span class="dt">term =</span> .<span class="op">$</span>term,</a>
<a class="sourceLine" id="cb71-18" href="#cb71-18" data-line-number="18">        <span class="dt">totalPaid =</span> .<span class="op">$</span>total_pymnt,</a>
<a class="sourceLine" id="cb71-19" href="#cb71-19" data-line-number="19">        <span class="dt">totalPrincipalPaid =</span> .<span class="op">$</span>total_rec_prncp,</a>
<a class="sourceLine" id="cb71-20" href="#cb71-20" data-line-number="20">        <span class="dt">totalInterestPaid =</span> .<span class="op">$</span>total_rec_int,</a>
<a class="sourceLine" id="cb71-21" href="#cb71-21" data-line-number="21">        <span class="dt">recoveries =</span> .<span class="op">$</span>recoveries,</a>
<a class="sourceLine" id="cb71-22" href="#cb71-22" data-line-number="22">        <span class="dt">lateFees =</span> .<span class="op">$</span>total_rec_late_fee</a>
<a class="sourceLine" id="cb71-23" href="#cb71-23" data-line-number="23">      )</a>
<a class="sourceLine" id="cb71-24" href="#cb71-24" data-line-number="24">    )</a>
<a class="sourceLine" id="cb71-25" href="#cb71-25" data-line-number="25">  </a>
<a class="sourceLine" id="cb71-26" href="#cb71-26" data-line-number="26">  <span class="kw">saveRDS</span>(loansIRR, <span class="st">&quot;datasets/lending_club_IRRs.rds&quot;</span>)</a>
<a class="sourceLine" id="cb71-27" href="#cb71-27" data-line-number="27">  </a>
<a class="sourceLine" id="cb71-28" href="#cb71-28" data-line-number="28">})</a></code></pre></div>

</div>
<div id="julia-code" class="section level3">
<h3><span class="header-section-number">5.8.2</span> Julia code</h3>
<div id="internal-rate-of-return-1" class="section level4">
<h4><span class="header-section-number">5.8.2.1</span> Internal Rate of Return</h4>
<!--

 \small


```{.julia .numberLines .lineAnchors}
####################################################################################################
##
## Prepare datasets
##

## Previously saved from R with:
##     lending_club <- readRDS("lending_club.rds"); write.csv(lending_club, "lending_club.rds")
##
## WARNING: 1.7GB on disk
##
using CSV
lendingClub = CSV.read("datasets/lending_club.csv"; delim = ",")



####################################################################################################
##
## IRR calculations
##
## Given some numerical parameters describing a loan in the dataset, returns its Internal Rate
## of Return.
##
## In the first instance, the function creates a schedule of payments.
## In many cases, the schedule will be extremely simple: a series of 36 or 60 equal instalements.
##
## But in some cases, a loan repayment are accelerated. Therefore the total amount of interest will
## be lower than expected (but this is good for the investor because highe interest rate over
## shorter tenor.).
##
## In other cases, the borrower defaults. Overall payments are less than expected.
##
## Based on the limited information of the dataset, the function makes educated guesses on the exact
## schedule.
##
using DataFrames, Roots

function calculateIRR(; loanNumber = 1, loan = 0.0, intRate = 0.0, term = 36,
  totalPaid = 0.0, totalPrincipalPaid = 0.0, totalInterestPaid = 0.0,
  recoveries = 0.0, lateFees = 0.0,
  showSchedule = false)

  # number of monthly payments.
  # It exceeds 60 months in case recoveries on a 60-month loan takes the schedule after 60 months.
  nMonths = 90

  # Months after which a loan defaults (normal tenor if no default or early prepayment)
  monthDefault = term

  # Note: *100 /100 to calculate in cent because ceiling cannot specify significant digits.
  installment = ceil(loan * intRate / 12 / (1 - 1 / (1 + intRate / 12) ^ term), digits = 2)

  # We create a schedule
  schedule = DataFrame(month = 0:nMonths, monthlyPayment = 0.0,
                       totalPandI = 0.0, totalI = 0.0, totalP = 0.0)

  for i in 2:(nMonths + 1)
    # Get situation at the end of previous month
    previousTotalPandI = schedule[i - 1, :totalPandI]
    previousTotalP     = schedule[i - 1, :totalP]
    previousTotalI     = schedule[i - 1, :totalI]

    # This is the beginning of a new month. First and foremost, the borrower is expected to pay the
    # accrued interest on amount of principal outstanding.
    # The installment is expected to cover that amount of interest and the rest goes to
    # reducing the principal due outstanding.
    accruedInterest = ceil((loan - previousTotalP) * intRate / 12; digits = 2)
    decreasePrincipal = installment - accruedInterest

    # If that amount takes the schedule above the total amount of interest shown in the data set,
    # we should stop the schedule at this point
    # This is a shortcut since we could have a payment higher than the interest due, but not enough
    # to cover the expected principal repayment. However, it works well in practice.
    if previousTotalI + accruedInterest > totalInterestPaid

      # We stop the normal schedule at this date.
      # Interest is paid (although less than scheduled)
      schedule[i, :monthlyPayment] = totalInterestPaid - previousTotalI

      # As well as whatever principal is left as per the dataset
      schedule[i, :monthlyPayment] = schedule[i, :monthlyPayment] + totalPrincipalPaid - previousTotalP

      # Then 3-month after the last payment date, recoveries and and later fees are paid
      schedule[i + 3, :monthlyPayment] = schedule[i + 3, :monthlyPayment] + recoveries + lateFees

      # Not really useful, but for completeness
      schedule[i, :totalPandI] = totalPaid
      schedule[i, :totalI]     = totalInterestPaid
      schedule[i, :totalP]     = totalPrincipalPaid

      # If total principal paid is less than borrower, then it is a default, and the monthDefault
      # is adjusted.
      if (totalPrincipalPaid < loan)
        monthDefault = i
      end

      # No more payments to add to the schedule
      break

    else
      # Deal with normal schedule
      schedule[i, :monthlyPayment] = installment
      schedule[i, :totalPandI]     = schedule[i - 1, :totalPandI] + installment
      schedule[i, :totalI]         = schedule[i - 1, :totalI]     + accruedInterest
      schedule[i, :totalP]         = schedule[i - 1, :totalP]     + installment - accruedInterest
    end
  end

  # At this point schedule[, :monthlyPayment] contains the schedule of all payments, but needs to
  # include the initial loan.
  schedule[1, :monthlyPayment] = -loan

  if (showSchedule)
    print(schedule)
  end

  cashFlow = schedule[:,:monthlyPayment]

  ##
  ## Finding the IRR is equivalent to finding the root such that the NPV of the cash flow is zero.
  ## Julia has a function (see below) called `find_zero` to do that which requires a function to
  ## be zeroed. This helper function is defined as NPV.
  ##
  function NPV(interest)
    t = 0:(length(cashFlow) - 1)

    ## If you are new to Julia, note the dot before the operation. This indicates that the 
    ## operation has to be done element-wise (called `broadcasting` in Julia-ese). 
    ## Otherwise, Julia would try to divide one vector by another vector, which makes no sense. 
    ## This is also exactly the approach taken in Matlab/Octave.
    return sum(cashFlow ./ (1 + interest) .^ t)
  end

  ## Finds the root, catching any problems which would instead return the R equivalent of NA
  rootInterest = try
                  round(12 * find_zero(NPV, (-0.9, 1.0), Bisection(); xatol = 0.000001); digits = 4)
                catch e
                  NaN
                end

  return((
    loanID = loanNumber,
    IRR = rootInterest,
    monthDefault = monthDefault
  ))
end


##
## Calculate the IRR and repayment schedule of a particular loan identified by its loanID
function loanNumberIRR(loanNumber)
  l = lc[ lc[:, :Column1] .== loanNumber, :]
  global lc
  calculateIRR(loanNumber = l[1, :Column1],
               loan = l[1, :funded_amnt], intRate = l[1, :int_rate], term =l[1, :tenor],
               totalPaid = l[1, :total_pymnt], totalPrincipalPaid = l[1, :total_rec_prncp],
               totalInterestPaid = l[1, :total_rec_int],
               recoveries = l[1, :recoveries], lateFees = l[1, :total_rec_late_fee],
               showSchedule = true)
end


####################################################################################################
##
## Quick check
##
calculateIRR(loanNumber = 1, loan = 5600, intRate = 0.1299, term = 36,
             totalPaid = 6791.72, totalPrincipalPaid = 5600, totalInterestPaid = 1191.72,
             recoveries = 0, lateFees = 0,
             showSchedule = true)

calculateIRR(loanNumber = 1, loan = 35000, intRate = 0.1820, term = 60,
             totalPaid = 26600.1, totalPrincipalPaid = 3874.72, totalInterestPaid = 5225.38,
             recoveries = 17500, lateFees = 0.0,
             showSchedule = false)

calculateIRR(loanNumber = 1734666, loan = 35000, intRate = 0.0797, term = 36,
             totalPaid = 1057.04, totalPrincipalPaid = 863.83, totalInterestPaid = 193.72,
             recoveries = 0, lateFees = 0,
             showSchedule = false)




##
## Look for the loans which have gone to their end
##
indextmp = (lendingClub.loan_status .== "Fully Paid") .|
           (lendingClub.loan_status .== "Charged Off") .|
           (lendingClub.loan_status .== "Does not meet the credit policy. Status:Charged Off") .|
           (lendingClub.loan_status .== "Does not meet the credit policy. Status:Fully Paid")

## Create the dataset we will use - Should be the same as lending_club_reformatted_paid.rds
lc = lendingClub[indextmp, :]

## Select relevant variables to calculate profitability
## Column1 contains the loanID's
cols = [:Column1, :funded_amnt, :int_rate, :term,
        :total_pymnt, :total_rec_prncp, :total_rec_int,
        :recoveries, :total_rec_late_fee]

lc = select(lc, cols)

## Interest rates as percentage
lc[:, :int_rate] = lc[:, :int_rate] ./ 100

## Create a new column
lc[:tenor] = 0

## that will record the official loan tenor as a number (instead of string)
lc[startswith.( lc[:, :term], " 36"), :tenor] .= 36
lc[startswith.( lc[:, :term], " 60"), :tenor] .= 60

## New data frame to store the results
IRR_Result = DataFrame(loanID = zeros(Int64, nrow(lc)),
                       IRR = zeros(Float64, nrow(lc)),
                       monthDefault = zeros(Int64, nrow(lc)))


# ~150 sec. to do the whole dataset
@time for i in 1:nrow(lc)
  global IRR_Result

  # Use multiple-return-value
  (IRR_Result[i, :loanID], IRR_Result[i, :IRR], IRR_Result[i, :monthDefault]) =
      calculateIRR(
          loanNumber = lc[i, :Column1],
          loan = lc[i, :funded_amnt], intRate = lc[i, :int_rate], term =lc[i, :tenor],
          totalPaid = lc[i, :total_pymnt], totalPrincipalPaid = lc[i, :total_rec_prncp],
          totalInterestPaid = lc[i, :total_rec_int],
          recoveries = lc[i, :recoveries], lateFees = lc[i, :total_rec_late_fee],
          showSchedule = false)
end


IRR_Result[1:10,:]
# Check
loanNumberIRR(171)

CSV.write("datasets/loanIRR.csv", IRR_Result)

```

 \normalsize

#### Credit margins


 \small


```{.julia .numberLines .lineAnchors}
####################################################################################################
##
## Prepare datasets
##

## Previously saved from R with:
##     lending_club <- readRDS("lending_club.rds"); write.csv(lending_club, "lending_club.rds")
##
## WARNING: 1.7GB on disk
##
using CSV
lendingClub = CSV.read("datasets/lending_club.csv"; delim = ",")



####################################################################################################
##
## CREDIT MARGIN
##
## This method of approximating the credit margin is far less sophisticated than what FI's do.
##
## We need to calculate what the credit margin should be on a defaulted loan to get a nil NPV.
##
## On a risk free loan the CF will be P+I at risk-free on _both_ borrowing and lending sides.
##
##  On a defaulted loan, the CF will be:
##      borrowing unchanged = P&I at risk-free
##    and
##      lending P&I at (risk-free + credit margin) until before default, then recoveries+fees.
##
## The principal amortisation profile depends on the credit margin used. We will arbitrarily use
## 20% which is a conservative assumption.
##
## credit risk on that CF should be nil with the right margin when discounted at risk-free.
##
## The function is very similar to the IRR calculation.
##

using DataFrames, Roots

# number of monthly payments to model
# It exceeds 60 months in case recoveries on a 60-month loan takes the schedule after 60 months.
const nMonths = 90



# Sculpt credit foncier profiles over 36 and 60 months at 20% per annum.
# The profile is expressed as percentage of loan amount
function CreateCreditFoncier(;n = 36, riskFree = 0.0)

  instalment = 1 * riskFree/12 * 1 / (1 - 1 / (1 + riskFree/12) ^ n)

  # We create a schedule
  schedule = DataFrame(month = 0:nMonths, payment = 0.0)

  # Add the day 1 principal outlay
  schedule[1,       :payment] = -1
  schedule[2:(n+1), :payment] = instalment

  return(schedule)
end


# Solve for the credit margin
function CreditMargin(; loanNumber = 1, loan = 1000.0, intRate = 0.05, term = 36,
  totalPaid = 1000.0, totalPrincipalPaid = 700.0, totalInterestPaid = 50.0,
  recoveries = 0.0, lateFees = 0.0,
  riskFree = 0.01,
  showSchedule = false)

  # Months after which a loan defaults (normal tenor if no default or early prepayment)
  monthDefault = term

  # Monthly instlment
  instalment = ceil(loan * intRate/12 / (1 - 1 / (1 + intRate/12) ^ term), digits = 2)

  # Create a blank schedule
  schedule = DataFrame(month = 0:nMonths, monthlyPayment = 0.0,
                       principalPayment = 0.0,
                       totalPandI = 0.0, totalI = 0.0, totalP = 0.0)

  for i in 2:(nMonths + 1)
    # Get situation at the end of previous month
    previousTotalPandI = schedule[i - 1, :totalPandI]
    previousTotalP     = schedule[i - 1, :totalP]
    previousTotalI     = schedule[i - 1, :totalI]

    # This is the beginning of a new month. First and foremost, the borrower is expected to pay the
    # accrued interest on amount of principal outstanding.
    # The instalment is expected to cover that amount of interest and the rest goes to
    # reducing the principal due outstanding.
    accruedInterest = ceil((loan - previousTotalP) * intRate/12; digits = 2)
    decreasePrincipal = instalment - accruedInterest

    # If that amount takes the schedule above the total amount of interest shown in the data set,
    # we should stop the schedule at this point
    # This is a shortcut since we could have a payment higher than the interest due, but not enough
    # to cover the expected principal repayment. However, it works well in practice.
    if previousTotalI + accruedInterest > totalInterestPaid

      # We stop the normal schedule at this date.
      # Interest is paid (although less than scheduled)
      schedule[i, :monthlyPayment] = totalInterestPaid - previousTotalI

      # Whatever principal is left as per the dataset
      schedule[i, :monthlyPayment] += totalPrincipalPaid - previousTotalP

      # Then 3-month after the last payment date, recoveries and and later fees are paid
      schedule[i + 3, :principalPayment] += recoveries + lateFees

      # Not really useful, but for completeness
      schedule[i, :totalPandI] = totalPaid
      schedule[i, :totalI]     = totalInterestPaid
      schedule[i, :totalP]     = totalPrincipalPaid

      # If total principal paid is less than borrower, then it is a default, and the monthDefault
      # is adjusted.
      if (totalPrincipalPaid < loan)
        monthDefault = i
      end

      # No more payments to add to the schedule
      break

    else
      # Deal with normal schedule
      schedule[i, :monthlyPayment]   = instalment
      schedule[i, :principalPayment] = decreasePrincipal
      schedule[i, :totalPandI]       = schedule[i-1, :totalPandI] + instalment
      schedule[i, :totalI]           = schedule[i-1, :totalI]     + accruedInterest
      schedule[i, :totalP]           = schedule[i-1, :totalP]     + decreasePrincipal
    end
  end

  # At this point schedule[, :monthlyPayment] contains the schedule of all payments, but needs to
  # include the initial loan.
  schedule[1, :principalPayment] = -loan

  if (showSchedule)
    println("Payments")
    println(schedule)
  end

  # Principal profile on the borrowing side
  creditFoncier = round.(CreateCreditFoncier(n = term, riskFree = riskFree)[:, :payment] .* loan;
                                             digits = 2)

  # For a given margin, calculate the _net_ NPV between the what is borrowed at the risk-free rate
  # and what is earned on the loan principal profile (possibly shortned because of default)
  # carrying an interest of risk-free + credit margin
  function NetNPV(margin)
    # We need to store the calculated interest
    interestSchedule = DataFrame(month = 0:nMonths, interestPayment = 0.0)

    # For each month, calculate the amount of interest with the credit margin
    for i in 2:(monthDefault + 1)
      outstandingPrincipal = sum(schedule[1:(i - 1), :principalPayment])
      interestSchedule[i, :interestPayment] =
            -round((riskFree + margin)/12 * outstandingPrincipal; digits = 2)
    end

    # Net final cashflow is:
    #     total principal and interest cashflow on the lending side
    # less
    #     borrowing profile
    cashFlow = schedule[:, :principalPayment] .+ interestSchedule[:, :interestPayment]
    cashFlow = cashFlow .- creditFoncier

    return sum(cashFlow ./ (1 + riskFree/12) .^ (0:nMonths))
  end

  # rootInterest = round(find_zero(NetNPV, (-0.5, 10), Bisection()); digits = 6)
  rootInterest = try
                   rootInterest = round(find_zero(NetNPV, (-0.5, 10), Bisection()); digits = 6)
                 catch e
                   NaN
                 end


  return((
    loanID = loanNumber,
    creditMargin = rootInterest,
    monthDefault = monthDefault
  ))
end


####################################################################################################
##
## Quick check
##
CreditMargin(loanNumber = 1, loan = 5600, intRate = 0.1299, term = 36,
             totalPaid = 6791.72, totalPrincipalPaid = 5600, totalInterestPaid = 1191.72,
             recoveries = 0, lateFees = 0,
             riskFree = 0.02, showSchedule = false)

CreditMargin(loanNumber = 1, loan = 35000, intRate = 0.1820, term = 60,
             totalPaid = 26600.1, totalPrincipalPaid = 3874.72, totalInterestPaid = 5225.38,
             recoveries = 17500, lateFees = 0.0,
             riskFree = 0.02, showSchedule = true)

CreditMargin(loanNumber = 1734666, loan = 35000, intRate = 0.0797, term = 36,
             totalPaid = 1057.04, totalPrincipalPaid = 863.83, totalInterestPaid = 193.72,
             recoveries = 0, lateFees = 0,
             riskFree = 0.02, showSchedule = true)


##
## Look for the loans which have gone to their end
##
indextmp = (lendingClub.loan_status .== "Fully Paid") .|
           (lendingClub.loan_status .== "Charged Off") .|
           (lendingClub.loan_status .== "Does not meet the credit policy. Status:Charged Off") .|
           (lendingClub.loan_status .== "Does not meet the credit policy. Status:Fully Paid")

## Create the dataset we will use - Should be the same as lending_club_reformatted_paid.rds
lc = lendingClub[indextmp, :]

## Select relevant variables to calculate profitability
## Column1 contains the loanID's
cols = [:Column1, :funded_amnt, :int_rate, :term,
        :total_pymnt, :total_rec_prncp, :total_rec_int,
        :recoveries, :total_rec_late_fee]

lc = select(lc, cols)

## Interest rates as percentage
lc[!, :int_rate] = lc[!, :int_rate] ./ 100

## Create a new column
lc[:tenor] = 0

## that will record the official loan tenor as a number (instead of string)
lc[startswith.( lc[!, :term], " 36"), :tenor] .= 36
lc[startswith.( lc[!, :term], " 60"), :tenor] .= 60

## New data frame to store the results
creditMargin_Result = DataFrame(loanID = zeros(Int64, nrow(lc)),
                                creditMargin = zeros(Float64, nrow(lc)),
                                monthDefault = zeros(Int64, nrow(lc)))


# ~4,700 sec. to do the whole dataset
@time for i in 1:nrow(lc)
  global creditMargin_Result

  # Use multiple-return-value
  # 1h17m runtime
  (creditMargin_Result[i, :loanID],
   creditMargin_Result[i, :creditMargin],
   creditMargin_Result[i, :monthDefault]) =
      CreditMargin(
          loanNumber = lc[i, :Column1],
          loan = lc[i, :funded_amnt], intRate = lc[i, :int_rate], term =lc[i, :tenor],
          totalPaid = lc[i, :total_pymnt], totalPrincipalPaid = lc[i, :total_rec_prncp],
          totalInterestPaid = lc[i, :total_rec_int],
          recoveries = lc[i, :recoveries], lateFees = lc[i, :total_rec_late_fee],
          riskFree = 0.02,
          showSchedule = false)
end


creditMargin_Result[1:10,:]

CSV.write("datasets/CreditMargins.csv", creditMargin_Result)

```

 \normalsize
-->
</div>
</div>
<div id="maxima-derivation-of-the-cost-function" class="section level3">
<h3><span class="header-section-number">5.8.3</span> Maxima derivation of the cost function</h3>
<pre><code>PDF1(x, Q) := alpha1( Q) * sqrt( 1 / ( 2 * pi)) * 
              exp( - 1 / 2*(( log( -( x - m1( Q)) / m1( Q)) + sigma1( Q) ^ 2) / 
              sigma1( Q)) ^ 2) / ( -( x - m1(Q)) * sigma1( Q)) ;

PDF2(x, Q) := alpha2( Q) * sqrt( 1 / ( 2 * pi)) * 
              exp( - 1 / 2*(( log( -( x - m2( Q)) / m2( Q)) + sigma2( Q) ^ 2) / 
              sigma2( Q)) ^ 2) / ( -( x - m2( Q)) * sigma2( Q)) ;

PDF3(x, Q) := alpha3( Q) * sqrt( 1 / ( 2 (* pi)) * 
              exp( - 1 / 2*(( log( -( x - m3( Q)) / m3( Q)) + sigma3( Q) ^ 2) / 
              sigma3( Q)) ^ 2) / ( -( x - m3( Q)) * sigma3( Q)) ;

PDF4(x, Q) := alpha4( Q) * sqrt( 1 / ( 2 * pi)) * 
              exp( - 1 / 2*(( log( ( x - m4( Q)) / m4( Q)) + sigma4( Q) ^ 2) / 
              sigma4( Q)) ^ 2) / ( ( x - m4( Q)) * sigma4( Q)) ;


alpha1(Q) := am1* Q + an1 ;
alpha2(Q) := am2* Q + an2 ;
alpha3(Q) := am3* Q + an3 ;
alpha4(Q) := am4* Q + an4 ;

m1(Q) := mm1* Q + mn1 ;
m2(Q) := mm2* Q + mn2 ;
m3(Q) := mm3* Q + mn3 ;
m4(Q) := mm4* Q + mn4 ;

sigma1(Q) := sm1* Q + sn1 ;
sigma2(Q) := sm2* Q + sn2 ;
sigma3(Q) := sm3* Q + sn3 ;
sigma4(Q) := sm4* Q + sn4 ;

J(x, Q): = -( x - ( PDF1( x, Q) + PDF2( x, Q) + PDF3( x, Q) + PDF4( x, Q))) ^ 2 ; 

diff( PDF1(x, Q), Q) ; </code></pre>
</div>
</div>
<div id="system-version" class="section level2">
<h2><span class="header-section-number">5.9</span> System version</h2>

<div class="sourceCode" id="cb73"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb73-1" href="#cb73-1" data-line-number="1">##                                       sysname                                       release </a>
<a class="sourceLine" id="cb73-2" href="#cb73-2" data-line-number="2">##                                       &quot;Linux&quot;                            &quot;5.3.0-24-generic&quot; </a>
<a class="sourceLine" id="cb73-3" href="#cb73-3" data-line-number="3">##                                       version                                      nodename </a>
<a class="sourceLine" id="cb73-4" href="#cb73-4" data-line-number="4">## &quot;#26-Ubuntu SMP Thu Nov 14 01:33:18 UTC 2019&quot;                                        &quot;x260&quot; </a>
<a class="sourceLine" id="cb73-5" href="#cb73-5" data-line-number="5">##                                       machine                                         login </a>
<a class="sourceLine" id="cb73-6" href="#cb73-6" data-line-number="6">##                                      &quot;x86_64&quot;                                     &quot;unknown&quot; </a>
<a class="sourceLine" id="cb73-7" href="#cb73-7" data-line-number="7">##                                          user                                effective_user </a>
<a class="sourceLine" id="cb73-8" href="#cb73-8" data-line-number="8">##                                    &quot;emmanuel&quot;                                    &quot;emmanuel&quot;</a></code></pre></div>


</div>
</div>
<div class="footnotes">
<hr />
<ol start="21">
<li id="fn21"><p><a href="https://simplemaps.com/data/us-zips" class="uri">https://simplemaps.com/data/us-zips</a><a href="appendix.html#fnref21" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="errands-and-post-mortem.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Emmanuel-R8/HarvardX-LendingClub/edit/master/08-appendix.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["HarvardX Credit Scoring of the LendingClub Dataset.pdf", "HarvardX Credit Scoring of the LendingClub Dataset.epub"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
