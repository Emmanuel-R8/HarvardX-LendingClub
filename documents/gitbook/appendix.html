<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Appendix | LendingClub Loans Pricing</title>
  <meta name="description" content="HarvardX - PH125.9x Data Science Capstone" />
  <meta name="generator" content="bookdown 0.15 and GitBook 2.6.7" />

  <meta property="og:title" content="Appendix | LendingClub Loans Pricing" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="HarvardX - PH125.9x Data Science Capstone" />
  <meta name="github-repo" content="Emmanuel_R8/HarvardX-LendingClub" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Appendix | LendingClub Loans Pricing" />
  
  <meta name="twitter:description" content="HarvardX - PH125.9x Data Science Capstone" />
  

<meta name="author" content="Emmanuel Rialland - https://github.com/Emmanuel_R8" />


<meta name="date" content="2019-11-15" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="conclusion.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./introduction.html" target="blank>LendingClub Loans Pricing</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html"><i class="fa fa-check"></i><b>1</b> Internal Rate of Return, Credit Margins and Net Present Values</a><ul>
<li class="chapter" data-level="1.1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#important-warning"><i class="fa fa-check"></i><b>1.1</b> Important warning</a></li>
<li class="chapter" data-level="1.2" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#background"><i class="fa fa-check"></i><b>1.2</b> Background</a></li>
<li class="chapter" data-level="1.3" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#internal-rate-of-return"><i class="fa fa-check"></i><b>1.3</b> Internal Rate of Return</a></li>
<li class="chapter" data-level="1.4" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#dataset-calculation"><i class="fa fa-check"></i><b>1.4</b> Dataset calculation</a><ul>
<li class="chapter" data-level="1.4.1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#irr"><i class="fa fa-check"></i><b>1.4.1</b> IRR</a></li>
<li class="chapter" data-level="1.4.2" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#credit-margins"><i class="fa fa-check"></i><b>1.4.2</b> Credit Margins</a></li>
<li class="chapter" data-level="1.4.3" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#npv"><i class="fa fa-check"></i><b>1.4.3</b> NPV</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="dataset.html"><a href="dataset.html"><i class="fa fa-check"></i><b>2</b> Dataset</a><ul>
<li class="chapter" data-level="2.1" data-path="dataset.html"><a href="dataset.html#preamble"><i class="fa fa-check"></i><b>2.1</b> Preamble</a></li>
<li class="chapter" data-level="2.2" data-path="dataset.html"><a href="dataset.html#general-presentation"><i class="fa fa-check"></i><b>2.2</b> General presentation</a><ul>
<li class="chapter" data-level="2.2.1" data-path="dataset.html"><a href="dataset.html#business-volume"><i class="fa fa-check"></i><b>2.2.1</b> Business volume</a></li>
<li class="chapter" data-level="2.2.2" data-path="dataset.html"><a href="dataset.html#loan-lifecyle-and-status"><i class="fa fa-check"></i><b>2.2.2</b> Loan lifecyle and status</a></li>
<li class="chapter" data-level="2.2.3" data-path="dataset.html"><a href="dataset.html#loan-application"><i class="fa fa-check"></i><b>2.2.3</b> Loan application</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="dataset.html"><a href="dataset.html#rates"><i class="fa fa-check"></i><b>2.3</b> Rates</a><ul>
<li class="chapter" data-level="2.3.1" data-path="dataset.html"><a href="dataset.html#irr-and-required-credit-margins"><i class="fa fa-check"></i><b>2.3.1</b> IRR and required credit margins</a></li>
<li class="chapter" data-level="2.3.2" data-path="dataset.html"><a href="dataset.html#dataset-1"><i class="fa fa-check"></i><b>2.3.2</b> Dataset</a></li>
<li class="chapter" data-level="2.3.3" data-path="dataset.html"><a href="dataset.html#interest-rates"><i class="fa fa-check"></i><b>2.3.3</b> Interest rates</a></li>
<li class="chapter" data-level="2.3.4" data-path="dataset.html"><a href="dataset.html#purpose"><i class="fa fa-check"></i><b>2.3.4</b> Purpose</a></li>
<li class="chapter" data-level="2.3.5" data-path="dataset.html"><a href="dataset.html#payments"><i class="fa fa-check"></i><b>2.3.5</b> Payments</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="dataset.html"><a href="dataset.html#net-present-value"><i class="fa fa-check"></i><b>2.4</b> Net present value</a><ul>
<li class="chapter" data-level="2.4.1" data-path="dataset.html"><a href="dataset.html#average-npv-and-credit-margin-by-subgrade"><i class="fa fa-check"></i><b>2.4.1</b> Average NPV and credit margin by subgrade</a></li>
<li class="chapter" data-level="2.4.2" data-path="dataset.html"><a href="dataset.html#principal-losses"><i class="fa fa-check"></i><b>2.4.2</b> Principal losses</a></li>
<li class="chapter" data-level="2.4.3" data-path="dataset.html"><a href="dataset.html#distribution-of-principal-losses-by-rating"><i class="fa fa-check"></i><b>2.4.3</b> Distribution of principal losses by rating</a></li>
<li class="chapter" data-level="2.4.4" data-path="dataset.html"><a href="dataset.html#npv-distribution-by-rating"><i class="fa fa-check"></i><b>2.4.4</b> NPV distribution by rating</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="dataset.html"><a href="dataset.html#variables"><i class="fa fa-check"></i><b>2.5</b> Variables</a><ul>
<li class="chapter" data-level="2.5.1" data-path="dataset.html"><a href="dataset.html#identification"><i class="fa fa-check"></i><b>2.5.1</b> Identification</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="dataset.html"><a href="dataset.html#loan-decision"><i class="fa fa-check"></i><b>2.6</b> Loan decision</a></li>
<li class="chapter" data-level="2.7" data-path="dataset.html"><a href="dataset.html#payment-related-information"><i class="fa fa-check"></i><b>2.7</b> Payment-related information</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>3</b> Modeling</a><ul>
<li class="chapter" data-level="3.1" data-path="modeling.html"><a href="modeling.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a><ul>
<li class="chapter" data-level="3.1.1" data-path="modeling.html"><a href="modeling.html#split"><i class="fa fa-check"></i><b>3.1.1</b> Split</a></li>
<li class="chapter" data-level="3.1.2" data-path="modeling.html"><a href="modeling.html#the-modeling-task"><i class="fa fa-check"></i><b>3.1.2</b> The modeling task</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html"><i class="fa fa-check"></i><b>4</b> Stochastic Gradient Descent</a><ul>
<li class="chapter" data-level="4.1" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#description-of-the-model"><i class="fa fa-check"></i><b>4.1</b> Description of the model</a></li>
<li class="chapter" data-level="4.2" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#gradient-descent"><i class="fa fa-check"></i><b>4.2</b> Gradient descent</a><ul>
<li class="chapter" data-level="4.2.1" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#generalities"><i class="fa fa-check"></i><b>4.2.1</b> Generalities</a></li>
<li class="chapter" data-level="4.2.2" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#cost-function-as-a-function-of-the-q-parameter"><i class="fa fa-check"></i><b>4.2.2</b> Cost function as a function of the <span class="math inline">\(Q\)</span> parameter</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#stochastic-gradient-descent-1"><i class="fa fa-check"></i><b>4.3</b> Stochastic Gradient Descent</a><ul>
<li class="chapter" data-level="4.3.1" data-path="stochastic-gradient-descent.html"><a href="stochastic-gradient-descent.html#stochastic-gradient-descent-sgd"><i class="fa fa-check"></i><b>4.3.1</b> Stochastic Gradient Descent (SGD)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>5</b> Conclusion</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i>Appendix</a><ul>
<li class="chapter" data-level="5.1" data-path="appendix.html"><a href="appendix.html#list-assumptions"><i class="fa fa-check"></i><b>5.1</b> List of assumptions / limitations regarding the dataset</a></li>
<li class="chapter" data-level="5.2" data-path="appendix.html"><a href="appendix.html#data-preparation-and-formatting"><i class="fa fa-check"></i><b>5.2</b> Data preparation and formatting</a><ul>
<li class="chapter" data-level="5.2.1" data-path="appendix.html"><a href="appendix.html#lendinclub-dataset"><i class="fa fa-check"></i><b>5.2.1</b> LendinClub dataset</a></li>
<li class="chapter" data-level="5.2.2" data-path="appendix.html"><a href="appendix.html#zip-codes-and-fips-codes"><i class="fa fa-check"></i><b>5.2.2</b> Zip codes and FIPS codes</a></li>
<li class="chapter" data-level="5.2.3" data-path="appendix.html"><a href="appendix.html#market-interest-rates"><i class="fa fa-check"></i><b>5.2.3</b> Market interest rates</a></li>
<li class="chapter" data-level="5.2.4" data-path="appendix.html"><a href="appendix.html#macro-economical-data"><i class="fa fa-check"></i><b>5.2.4</b> Macro-economical data</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="appendix.html"><a href="appendix.html#list-of-variables"><i class="fa fa-check"></i><b>5.3</b> List of variables</a></li>
<li class="chapter" data-level="5.4" data-path="appendix.html"><a href="appendix.html#calculations-of-the-internal-rate-of-returns-and-month-to-default"><i class="fa fa-check"></i><b>5.4</b> Calculations of the internal rate of returns and month-to-default</a><ul>
<li class="chapter" data-level="5.4.1" data-path="appendix.html"><a href="appendix.html#r-code"><i class="fa fa-check"></i><b>5.4.1</b> R code</a></li>
<li class="chapter" data-level="5.4.2" data-path="appendix.html"><a href="appendix.html#julia-code"><i class="fa fa-check"></i><b>5.4.2</b> Julia code</a></li>
<li class="chapter" data-level="5.4.3" data-path="appendix.html"><a href="appendix.html#maxima-derivation-of-the-cost-function"><i class="fa fa-check"></i><b>5.4.3</b> Maxima derivation of the cost function</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="appendix.html"><a href="appendix.html#system-version"><i class="fa fa-check"></i><b>5.5</b> System version</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org/" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">LendingClub Loans Pricing</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="appendix" class="section level1 unnumbered">
<h1>Appendix</h1>
<div id="list-assumptions" class="section level2">
<h2><span class="header-section-number">5.1</span> List of assumptions / limitations regarding the dataset</h2>
<p>As mentioned during this report, we had to make numerous assumptions given the lack of clarity of the variable descriptions.</p>
<ul>
<li><p><em>Dataset quality</em>: Aside from cents rounding issues, the dataset does not contain any flagrant errors that we could see (e.g. minor error of amount or rate, zipcode). Quality of the variable description is a different matter altogether.</p></li>
<li><p><em>Ratings</em>: The day-1 rating is between A1 and (and no lower than) G5. No note is rated lower than E5 after 6 November 2017, and lower than D5 after 30 June 2019.</p></li>
<li><p><em>Credit history</em>: Credit history information for the principal borrower relates to pre-approval and not post-funding. This is clear for the joint applicants, but simply an assumption for the principal borrower.</p></li>
<li><p><em>Recoveries</em>: Recoveries (if any) are assumed to be paid 3 months after the last scheduled payment date (variable <code>last_pymnt_d</code>)</p></li>
<li><p><em>Survival effect</em>: The dataset does not include applications that were rejected by the lender (for whatever reason) or by the borrower (for example because the interest rate quote is too high). It may also be the case that some actual loans were excluded as and when the dataset changed over the years.</p></li>
<li><p>LIBOR funding rate: we use the 3-year and 5-year swap rates. In reality, we should have used average tenor-weighted swap rates (i.e. ca. 1.5 Y and 2.5 Y). This requires a full swap curve and more calculation than necessary for our purpose. The principles of this report should not be significantly affted by this approximation.</p></li>
</ul>
<p>We do hope that LendingClub investors receive information of much better quality!</p>
</div>
<div id="data-preparation-and-formatting" class="section level2">
<h2><span class="header-section-number">5.2</span> Data preparation and formatting</h2>
<p>We used different sources of information:</p>
<ul>
<li><p>The LendingClub dataset made available on Kaggle;</p></li>
<li><p>US geographical data about zip and FIPS codes;</p></li>
<li><p>Market interest rates from the Saint Louis Federal Reserve Bank; and,</p></li>
<li><p>Macro data from the same source.</p></li>
</ul>
<p>We here show the code used to prepare the data. It was automatically formatted by <em>RStudio</em>.</p>
<div id="lendinclub-dataset" class="section level3">
<h3><span class="header-section-number">5.2.1</span> LendinClub dataset</h3>
<p></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" href="#cb5-1" data-line-number="1"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb5-2" href="#cb5-2" data-line-number="2">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-3" href="#cb5-3" data-line-number="3">  <span class="co"># STEP 1: Download the dataset</span></a>
<a class="sourceLine" id="cb5-4" href="#cb5-4" data-line-number="4">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-5" href="#cb5-5" data-line-number="5">  <span class="co">#   Got to https://www.kaggle.com/wendykan/lending-club-loan-data</span></a>
<a class="sourceLine" id="cb5-6" href="#cb5-6" data-line-number="6">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-7" href="#cb5-7" data-line-number="7">  <span class="co">#   Download into the &#39;datasets&#39; subdirectory</span></a>
<a class="sourceLine" id="cb5-8" href="#cb5-8" data-line-number="8">  <span class="co">#   Unzip the file.</span></a>
<a class="sourceLine" id="cb5-9" href="#cb5-9" data-line-number="9">  <span class="co">#   </span><span class="al">WARNING</span><span class="co">: The unzipping will be about 2.4GB</span></a>
<a class="sourceLine" id="cb5-10" href="#cb5-10" data-line-number="10">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-11" href="#cb5-11" data-line-number="11">  <span class="co">#   Name the sql database &quot;datasets/lending_club.sqlite&quot;</span></a>
<a class="sourceLine" id="cb5-12" href="#cb5-12" data-line-number="12">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-13" href="#cb5-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb5-14" href="#cb5-14" data-line-number="14">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-15" href="#cb5-15" data-line-number="15">  <span class="co"># STEP 2: Prepare the dabase as a tibble</span></a>
<a class="sourceLine" id="cb5-16" href="#cb5-16" data-line-number="16">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-17" href="#cb5-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb5-18" href="#cb5-18" data-line-number="18">  <span class="co">##</span></a>
<a class="sourceLine" id="cb5-19" href="#cb5-19" data-line-number="19">  <span class="co">## </span><span class="al">WARNING</span><span class="co">: THIS ASSUMES A &#39;datasets&#39; DIRECTORY WAS CREATED</span></a>
<a class="sourceLine" id="cb5-20" href="#cb5-20" data-line-number="20">  <span class="co">## </span></a>
<a class="sourceLine" id="cb5-21" href="#cb5-21" data-line-number="21">  <span class="kw">library</span>(RSQLite)</a>
<a class="sourceLine" id="cb5-22" href="#cb5-22" data-line-number="22">  db_conn &lt;-</a>
<a class="sourceLine" id="cb5-23" href="#cb5-23" data-line-number="23"><span class="st">    </span><span class="kw">dbConnect</span>(RSQLite<span class="op">::</span><span class="kw">SQLite</span>(), <span class="st">&quot;datasets/lending_club.sqlite&quot;</span>)</a>
<a class="sourceLine" id="cb5-24" href="#cb5-24" data-line-number="24">  <span class="kw">dbListTables</span>(db_conn)</a>
<a class="sourceLine" id="cb5-25" href="#cb5-25" data-line-number="25">  </a>
<a class="sourceLine" id="cb5-26" href="#cb5-26" data-line-number="26">  <span class="co"># Returns a 2.96GB data frame</span></a>
<a class="sourceLine" id="cb5-27" href="#cb5-27" data-line-number="27">  lending_club &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(db_conn, <span class="st">&quot;SELECT * FROM loan&quot;</span>)</a>
<a class="sourceLine" id="cb5-28" href="#cb5-28" data-line-number="28">  lending_club &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(lending_club)</a>
<a class="sourceLine" id="cb5-29" href="#cb5-29" data-line-number="29">  </a>
<a class="sourceLine" id="cb5-30" href="#cb5-30" data-line-number="30">  <span class="co"># Close the database</span></a>
<a class="sourceLine" id="cb5-31" href="#cb5-31" data-line-number="31">  <span class="kw">dbDisconnect</span>(db_conn)</a>
<a class="sourceLine" id="cb5-32" href="#cb5-32" data-line-number="32">  </a>
<a class="sourceLine" id="cb5-33" href="#cb5-33" data-line-number="33">  <span class="co"># Compressed to ca.285MB on disk</span></a>
<a class="sourceLine" id="cb5-34" href="#cb5-34" data-line-number="34">  <span class="kw">saveRDS</span>(lending_club, <span class="st">&quot;datasets/lending_club.rds&quot;</span>)</a>
<a class="sourceLine" id="cb5-35" href="#cb5-35" data-line-number="35">  </a>
<a class="sourceLine" id="cb5-36" href="#cb5-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb5-37" href="#cb5-37" data-line-number="37">  <span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb5-38" href="#cb5-38" data-line-number="38">  <span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb5-39" href="#cb5-39" data-line-number="39">  <span class="kw">library</span>(hablar)</a>
<a class="sourceLine" id="cb5-40" href="#cb5-40" data-line-number="40">  </a>
<a class="sourceLine" id="cb5-41" href="#cb5-41" data-line-number="41">  <span class="co"># Before reformat in case the previous step was already done</span></a>
<a class="sourceLine" id="cb5-42" href="#cb5-42" data-line-number="42">  <span class="co"># lending_club &lt;- readRDS(&quot;datasets/lending_club.rds&quot;)</span></a>
<a class="sourceLine" id="cb5-43" href="#cb5-43" data-line-number="43">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-44" href="#cb5-44" data-line-number="44">  <span class="co"># str(lending_club)</span></a>
<a class="sourceLine" id="cb5-45" href="#cb5-45" data-line-number="45">  <span class="co">#</span></a>
<a class="sourceLine" id="cb5-46" href="#cb5-46" data-line-number="46">  </a>
<a class="sourceLine" id="cb5-47" href="#cb5-47" data-line-number="47">  <span class="co"># Leave the original dataset untouched and work with a copy.</span></a>
<a class="sourceLine" id="cb5-48" href="#cb5-48" data-line-number="48">  lc &lt;-<span class="st"> </span>lending_club</a>
<a class="sourceLine" id="cb5-49" href="#cb5-49" data-line-number="49">  </a>
<a class="sourceLine" id="cb5-50" href="#cb5-50" data-line-number="50">  lc &lt;-<span class="st"> </span>lc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-51" href="#cb5-51" data-line-number="51"></a>
<a class="sourceLine" id="cb5-52" href="#cb5-52" data-line-number="52"><span class="st">    </span><span class="co"># Add loan identification number to track the loans across calculations</span></a>
<a class="sourceLine" id="cb5-53" href="#cb5-53" data-line-number="53"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">loanID =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-54" href="#cb5-54" data-line-number="54"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-55" href="#cb5-55" data-line-number="55"><span class="st">    </span><span class="co"># Remove useless strings</span></a>
<a class="sourceLine" id="cb5-56" href="#cb5-56" data-line-number="56"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb5-57" href="#cb5-57" data-line-number="57">      <span class="dt">term       =</span> <span class="kw">str_remove</span>(term, <span class="st">&quot; months&quot;</span>),</a>
<a class="sourceLine" id="cb5-58" href="#cb5-58" data-line-number="58">      <span class="dt">emp_length =</span> <span class="kw">str_replace</span>(emp_length, <span class="st">&quot;&lt;1&quot;</span>, <span class="st">&quot;0&quot;</span>),</a>
<a class="sourceLine" id="cb5-59" href="#cb5-59" data-line-number="59">      <span class="dt">emp_length =</span> <span class="kw">str_replace</span>(emp_length, <span class="st">&quot;10+&quot;</span>, <span class="st">&quot;10&quot;</span>),</a>
<a class="sourceLine" id="cb5-60" href="#cb5-60" data-line-number="60">      <span class="dt">emp_length =</span> <span class="kw">str_remove</span>(emp_length, <span class="st">&quot;years&quot;</span>)</a>
<a class="sourceLine" id="cb5-61" href="#cb5-61" data-line-number="61">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-62" href="#cb5-62" data-line-number="62"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-63" href="#cb5-63" data-line-number="63"><span class="st">    </span><span class="co"># Creates dates out of strings - Parse errors will be raised when no dates.</span></a>
<a class="sourceLine" id="cb5-64" href="#cb5-64" data-line-number="64"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb5-65" href="#cb5-65" data-line-number="65">      <span class="dt">debt_settlement_flag_date =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(</a>
<a class="sourceLine" id="cb5-66" href="#cb5-66" data-line-number="66">        <span class="kw">str_c</span>(<span class="st">&quot;1-&quot;</span>, debt_settlement_flag_date)</a>
<a class="sourceLine" id="cb5-67" href="#cb5-67" data-line-number="67">      )),</a>
<a class="sourceLine" id="cb5-68" href="#cb5-68" data-line-number="68">      <span class="dt">earliest_cr_line          =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-69" href="#cb5-69" data-line-number="69">        <span class="st">&quot;1-&quot;</span>, earliest_cr_line</a>
<a class="sourceLine" id="cb5-70" href="#cb5-70" data-line-number="70">      ))),</a>
<a class="sourceLine" id="cb5-71" href="#cb5-71" data-line-number="71">      <span class="dt">hardship_start_date       =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-72" href="#cb5-72" data-line-number="72">        <span class="st">&quot;1-&quot;</span>, hardship_start_date</a>
<a class="sourceLine" id="cb5-73" href="#cb5-73" data-line-number="73">      ))),</a>
<a class="sourceLine" id="cb5-74" href="#cb5-74" data-line-number="74">      <span class="dt">hardship_end_date         =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-75" href="#cb5-75" data-line-number="75">        <span class="st">&quot;1-&quot;</span>, hardship_end_date</a>
<a class="sourceLine" id="cb5-76" href="#cb5-76" data-line-number="76">      ))),</a>
<a class="sourceLine" id="cb5-77" href="#cb5-77" data-line-number="77">      <span class="dt">issue_d                   =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(<span class="st">&quot;1-&quot;</span>, issue_d))),</a>
<a class="sourceLine" id="cb5-78" href="#cb5-78" data-line-number="78">      <span class="dt">last_credit_pull_d        =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-79" href="#cb5-79" data-line-number="79">        <span class="st">&quot;1-&quot;</span>, last_credit_pull_d</a>
<a class="sourceLine" id="cb5-80" href="#cb5-80" data-line-number="80">      ))),</a>
<a class="sourceLine" id="cb5-81" href="#cb5-81" data-line-number="81">      <span class="dt">last_pymnt_d              =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-82" href="#cb5-82" data-line-number="82">        <span class="st">&quot;1-&quot;</span>, last_pymnt_d</a>
<a class="sourceLine" id="cb5-83" href="#cb5-83" data-line-number="83">      ))),</a>
<a class="sourceLine" id="cb5-84" href="#cb5-84" data-line-number="84">      <span class="dt">next_pymnt_d              =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-85" href="#cb5-85" data-line-number="85">        <span class="st">&quot;1-&quot;</span>, next_pymnt_d</a>
<a class="sourceLine" id="cb5-86" href="#cb5-86" data-line-number="86">      ))),</a>
<a class="sourceLine" id="cb5-87" href="#cb5-87" data-line-number="87">      <span class="dt">payment_plan_start_date   =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-88" href="#cb5-88" data-line-number="88">        <span class="st">&quot;1-&quot;</span>, payment_plan_start_date</a>
<a class="sourceLine" id="cb5-89" href="#cb5-89" data-line-number="89">      ))),</a>
<a class="sourceLine" id="cb5-90" href="#cb5-90" data-line-number="90">      <span class="dt">sec_app_earliest_cr_line  =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-91" href="#cb5-91" data-line-number="91">        <span class="st">&quot;1-&quot;</span>, sec_app_earliest_cr_line</a>
<a class="sourceLine" id="cb5-92" href="#cb5-92" data-line-number="92">      ))),</a>
<a class="sourceLine" id="cb5-93" href="#cb5-93" data-line-number="93">      <span class="dt">settlement_date           =</span> <span class="kw">as_date</span>(<span class="kw">dmy</span>(<span class="kw">str_c</span>(</a>
<a class="sourceLine" id="cb5-94" href="#cb5-94" data-line-number="94">        <span class="st">&quot;1-&quot;</span>, settlement_date</a>
<a class="sourceLine" id="cb5-95" href="#cb5-95" data-line-number="95">      )))</a>
<a class="sourceLine" id="cb5-96" href="#cb5-96" data-line-number="96">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-97" href="#cb5-97" data-line-number="97"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-98" href="#cb5-98" data-line-number="98"><span class="st">    </span><span class="co"># Bulk type conversion with convert from the `hablar` package</span></a>
<a class="sourceLine" id="cb5-99" href="#cb5-99" data-line-number="99"><span class="st">    </span><span class="kw">convert</span>(</a>
<a class="sourceLine" id="cb5-100" href="#cb5-100" data-line-number="100">      <span class="co"># Strings</span></a>
<a class="sourceLine" id="cb5-101" href="#cb5-101" data-line-number="101">      <span class="kw">chr</span>(emp_title, title, url, zip_code),</a>
<a class="sourceLine" id="cb5-102" href="#cb5-102" data-line-number="102">      </a>
<a class="sourceLine" id="cb5-103" href="#cb5-103" data-line-number="103">      <span class="co"># Factors</span></a>
<a class="sourceLine" id="cb5-104" href="#cb5-104" data-line-number="104">      <span class="kw">fct</span>(</a>
<a class="sourceLine" id="cb5-105" href="#cb5-105" data-line-number="105">        addr_state,</a>
<a class="sourceLine" id="cb5-106" href="#cb5-106" data-line-number="106">        application_type,</a>
<a class="sourceLine" id="cb5-107" href="#cb5-107" data-line-number="107">        debt_settlement_flag,</a>
<a class="sourceLine" id="cb5-108" href="#cb5-108" data-line-number="108">        desc,</a>
<a class="sourceLine" id="cb5-109" href="#cb5-109" data-line-number="109">        disbursement_method,</a>
<a class="sourceLine" id="cb5-110" href="#cb5-110" data-line-number="110">        grade,</a>
<a class="sourceLine" id="cb5-111" href="#cb5-111" data-line-number="111">        hardship_flag,</a>
<a class="sourceLine" id="cb5-112" href="#cb5-112" data-line-number="112">        hardship_loan_status,</a>
<a class="sourceLine" id="cb5-113" href="#cb5-113" data-line-number="113">        hardship_reason,</a>
<a class="sourceLine" id="cb5-114" href="#cb5-114" data-line-number="114">        hardship_status,</a>
<a class="sourceLine" id="cb5-115" href="#cb5-115" data-line-number="115">        hardship_type,</a>
<a class="sourceLine" id="cb5-116" href="#cb5-116" data-line-number="116">        home_ownership,</a>
<a class="sourceLine" id="cb5-117" href="#cb5-117" data-line-number="117">        id,</a>
<a class="sourceLine" id="cb5-118" href="#cb5-118" data-line-number="118">        initial_list_status,</a>
<a class="sourceLine" id="cb5-119" href="#cb5-119" data-line-number="119">        loan_status,</a>
<a class="sourceLine" id="cb5-120" href="#cb5-120" data-line-number="120">        member_id,</a>
<a class="sourceLine" id="cb5-121" href="#cb5-121" data-line-number="121">        policy_code,</a>
<a class="sourceLine" id="cb5-122" href="#cb5-122" data-line-number="122">        purpose,</a>
<a class="sourceLine" id="cb5-123" href="#cb5-123" data-line-number="123">        pymnt_plan,</a>
<a class="sourceLine" id="cb5-124" href="#cb5-124" data-line-number="124">        settlement_status,</a>
<a class="sourceLine" id="cb5-125" href="#cb5-125" data-line-number="125">        sub_grade,</a>
<a class="sourceLine" id="cb5-126" href="#cb5-126" data-line-number="126">        verification_status,</a>
<a class="sourceLine" id="cb5-127" href="#cb5-127" data-line-number="127">        verification_status_joint</a>
<a class="sourceLine" id="cb5-128" href="#cb5-128" data-line-number="128">      ),</a>
<a class="sourceLine" id="cb5-129" href="#cb5-129" data-line-number="129">      </a>
<a class="sourceLine" id="cb5-130" href="#cb5-130" data-line-number="130">      <span class="co"># Integers</span></a>
<a class="sourceLine" id="cb5-131" href="#cb5-131" data-line-number="131">      <span class="kw">int</span>(</a>
<a class="sourceLine" id="cb5-132" href="#cb5-132" data-line-number="132">        acc_now_delinq,</a>
<a class="sourceLine" id="cb5-133" href="#cb5-133" data-line-number="133">        acc_open_past_24mths,</a>
<a class="sourceLine" id="cb5-134" href="#cb5-134" data-line-number="134">        chargeoff_within_<span class="dv">12</span>_mths,</a>
<a class="sourceLine" id="cb5-135" href="#cb5-135" data-line-number="135">        collections_<span class="dv">12</span>_mths_ex_med,</a>
<a class="sourceLine" id="cb5-136" href="#cb5-136" data-line-number="136">        deferral_term,</a>
<a class="sourceLine" id="cb5-137" href="#cb5-137" data-line-number="137">        delinq_2yrs,</a>
<a class="sourceLine" id="cb5-138" href="#cb5-138" data-line-number="138">        emp_length,</a>
<a class="sourceLine" id="cb5-139" href="#cb5-139" data-line-number="139">        hardship_dpd,</a>
<a class="sourceLine" id="cb5-140" href="#cb5-140" data-line-number="140">        hardship_length,</a>
<a class="sourceLine" id="cb5-141" href="#cb5-141" data-line-number="141">        inq_fi,</a>
<a class="sourceLine" id="cb5-142" href="#cb5-142" data-line-number="142">        inq_last_12m,</a>
<a class="sourceLine" id="cb5-143" href="#cb5-143" data-line-number="143">        inq_last_6mths,</a>
<a class="sourceLine" id="cb5-144" href="#cb5-144" data-line-number="144">        mo_sin_old_il_acct,</a>
<a class="sourceLine" id="cb5-145" href="#cb5-145" data-line-number="145">        mo_sin_old_rev_tl_op,</a>
<a class="sourceLine" id="cb5-146" href="#cb5-146" data-line-number="146">        mo_sin_rcnt_rev_tl_op,</a>
<a class="sourceLine" id="cb5-147" href="#cb5-147" data-line-number="147">        mo_sin_rcnt_tl,</a>
<a class="sourceLine" id="cb5-148" href="#cb5-148" data-line-number="148">        mort_acc,</a>
<a class="sourceLine" id="cb5-149" href="#cb5-149" data-line-number="149">        mths_since_last_delinq,</a>
<a class="sourceLine" id="cb5-150" href="#cb5-150" data-line-number="150">        mths_since_last_major_derog,</a>
<a class="sourceLine" id="cb5-151" href="#cb5-151" data-line-number="151">        mths_since_last_record,</a>
<a class="sourceLine" id="cb5-152" href="#cb5-152" data-line-number="152">        mths_since_rcnt_il,</a>
<a class="sourceLine" id="cb5-153" href="#cb5-153" data-line-number="153">        mths_since_recent_bc,</a>
<a class="sourceLine" id="cb5-154" href="#cb5-154" data-line-number="154">        mths_since_recent_bc_dlq,</a>
<a class="sourceLine" id="cb5-155" href="#cb5-155" data-line-number="155">        mths_since_recent_inq,</a>
<a class="sourceLine" id="cb5-156" href="#cb5-156" data-line-number="156">        mths_since_recent_revol_delinq,</a>
<a class="sourceLine" id="cb5-157" href="#cb5-157" data-line-number="157">        num_accts_ever_<span class="dv">120</span>_pd,</a>
<a class="sourceLine" id="cb5-158" href="#cb5-158" data-line-number="158">        num_actv_bc_tl,</a>
<a class="sourceLine" id="cb5-159" href="#cb5-159" data-line-number="159">        num_actv_rev_tl,</a>
<a class="sourceLine" id="cb5-160" href="#cb5-160" data-line-number="160">        num_bc_sats,</a>
<a class="sourceLine" id="cb5-161" href="#cb5-161" data-line-number="161">        num_bc_tl,</a>
<a class="sourceLine" id="cb5-162" href="#cb5-162" data-line-number="162">        num_il_tl,</a>
<a class="sourceLine" id="cb5-163" href="#cb5-163" data-line-number="163">        num_op_rev_tl,</a>
<a class="sourceLine" id="cb5-164" href="#cb5-164" data-line-number="164">        num_rev_accts,</a>
<a class="sourceLine" id="cb5-165" href="#cb5-165" data-line-number="165">        num_rev_tl_bal_gt_<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb5-166" href="#cb5-166" data-line-number="166">        num_sats,</a>
<a class="sourceLine" id="cb5-167" href="#cb5-167" data-line-number="167">        num_tl_120dpd_2m,</a>
<a class="sourceLine" id="cb5-168" href="#cb5-168" data-line-number="168">        num_tl_30dpd,</a>
<a class="sourceLine" id="cb5-169" href="#cb5-169" data-line-number="169">        num_tl_90g_dpd_24m,</a>
<a class="sourceLine" id="cb5-170" href="#cb5-170" data-line-number="170">        num_tl_op_past_12m,</a>
<a class="sourceLine" id="cb5-171" href="#cb5-171" data-line-number="171">        open_acc,</a>
<a class="sourceLine" id="cb5-172" href="#cb5-172" data-line-number="172">        open_acc_6m,</a>
<a class="sourceLine" id="cb5-173" href="#cb5-173" data-line-number="173">        open_act_il,</a>
<a class="sourceLine" id="cb5-174" href="#cb5-174" data-line-number="174">        open_il_12m,</a>
<a class="sourceLine" id="cb5-175" href="#cb5-175" data-line-number="175">        open_il_24m,</a>
<a class="sourceLine" id="cb5-176" href="#cb5-176" data-line-number="176">        open_rv_12m,</a>
<a class="sourceLine" id="cb5-177" href="#cb5-177" data-line-number="177">        open_rv_24m,</a>
<a class="sourceLine" id="cb5-178" href="#cb5-178" data-line-number="178">        sec_app_chargeoff_within_<span class="dv">12</span>_mths,</a>
<a class="sourceLine" id="cb5-179" href="#cb5-179" data-line-number="179">        sec_app_collections_<span class="dv">12</span>_mths_ex_med,</a>
<a class="sourceLine" id="cb5-180" href="#cb5-180" data-line-number="180">        sec_app_inq_last_6mths,</a>
<a class="sourceLine" id="cb5-181" href="#cb5-181" data-line-number="181">        sec_app_mort_acc,</a>
<a class="sourceLine" id="cb5-182" href="#cb5-182" data-line-number="182">        sec_app_mths_since_last_major_derog,</a>
<a class="sourceLine" id="cb5-183" href="#cb5-183" data-line-number="183">        sec_app_num_rev_accts,</a>
<a class="sourceLine" id="cb5-184" href="#cb5-184" data-line-number="184">        sec_app_open_acc,</a>
<a class="sourceLine" id="cb5-185" href="#cb5-185" data-line-number="185">        sec_app_open_act_il,</a>
<a class="sourceLine" id="cb5-186" href="#cb5-186" data-line-number="186">        term</a>
<a class="sourceLine" id="cb5-187" href="#cb5-187" data-line-number="187">      ),</a>
<a class="sourceLine" id="cb5-188" href="#cb5-188" data-line-number="188">      </a>
<a class="sourceLine" id="cb5-189" href="#cb5-189" data-line-number="189">      <span class="co"># Floating point</span></a>
<a class="sourceLine" id="cb5-190" href="#cb5-190" data-line-number="190">      <span class="kw">dbl</span>(</a>
<a class="sourceLine" id="cb5-191" href="#cb5-191" data-line-number="191">        all_util,</a>
<a class="sourceLine" id="cb5-192" href="#cb5-192" data-line-number="192">        annual_inc,</a>
<a class="sourceLine" id="cb5-193" href="#cb5-193" data-line-number="193">        annual_inc_joint,</a>
<a class="sourceLine" id="cb5-194" href="#cb5-194" data-line-number="194">        avg_cur_bal,</a>
<a class="sourceLine" id="cb5-195" href="#cb5-195" data-line-number="195">        bc_open_to_buy,</a>
<a class="sourceLine" id="cb5-196" href="#cb5-196" data-line-number="196">        bc_util,</a>
<a class="sourceLine" id="cb5-197" href="#cb5-197" data-line-number="197">        collection_recovery_fee,</a>
<a class="sourceLine" id="cb5-198" href="#cb5-198" data-line-number="198">        delinq_amnt,</a>
<a class="sourceLine" id="cb5-199" href="#cb5-199" data-line-number="199">        dti,</a>
<a class="sourceLine" id="cb5-200" href="#cb5-200" data-line-number="200">        dti_joint,</a>
<a class="sourceLine" id="cb5-201" href="#cb5-201" data-line-number="201">        funded_amnt,</a>
<a class="sourceLine" id="cb5-202" href="#cb5-202" data-line-number="202">        funded_amnt_inv,</a>
<a class="sourceLine" id="cb5-203" href="#cb5-203" data-line-number="203">        hardship_amount,</a>
<a class="sourceLine" id="cb5-204" href="#cb5-204" data-line-number="204">        hardship_last_payment_amount,</a>
<a class="sourceLine" id="cb5-205" href="#cb5-205" data-line-number="205">        hardship_payoff_balance_amount,</a>
<a class="sourceLine" id="cb5-206" href="#cb5-206" data-line-number="206">        il_util,</a>
<a class="sourceLine" id="cb5-207" href="#cb5-207" data-line-number="207">        installment,</a>
<a class="sourceLine" id="cb5-208" href="#cb5-208" data-line-number="208">        int_rate,</a>
<a class="sourceLine" id="cb5-209" href="#cb5-209" data-line-number="209">        last_pymnt_amnt,</a>
<a class="sourceLine" id="cb5-210" href="#cb5-210" data-line-number="210">        loan_amnt,</a>
<a class="sourceLine" id="cb5-211" href="#cb5-211" data-line-number="211">        max_bal_bc,</a>
<a class="sourceLine" id="cb5-212" href="#cb5-212" data-line-number="212">        orig_projected_additional_accrued_interest,</a>
<a class="sourceLine" id="cb5-213" href="#cb5-213" data-line-number="213">        out_prncp,</a>
<a class="sourceLine" id="cb5-214" href="#cb5-214" data-line-number="214">        out_prncp_inv,</a>
<a class="sourceLine" id="cb5-215" href="#cb5-215" data-line-number="215">        pct_tl_nvr_dlq,</a>
<a class="sourceLine" id="cb5-216" href="#cb5-216" data-line-number="216">        percent_bc_gt_<span class="dv">75</span>,</a>
<a class="sourceLine" id="cb5-217" href="#cb5-217" data-line-number="217">        pub_rec,</a>
<a class="sourceLine" id="cb5-218" href="#cb5-218" data-line-number="218">        pub_rec_bankruptcies,</a>
<a class="sourceLine" id="cb5-219" href="#cb5-219" data-line-number="219">        recoveries,</a>
<a class="sourceLine" id="cb5-220" href="#cb5-220" data-line-number="220">        revol_bal,</a>
<a class="sourceLine" id="cb5-221" href="#cb5-221" data-line-number="221">        revol_bal_joint,</a>
<a class="sourceLine" id="cb5-222" href="#cb5-222" data-line-number="222">        revol_util,</a>
<a class="sourceLine" id="cb5-223" href="#cb5-223" data-line-number="223">        sec_app_revol_util,</a>
<a class="sourceLine" id="cb5-224" href="#cb5-224" data-line-number="224">        settlement_amount,</a>
<a class="sourceLine" id="cb5-225" href="#cb5-225" data-line-number="225">        settlement_percentage,</a>
<a class="sourceLine" id="cb5-226" href="#cb5-226" data-line-number="226">        tax_liens,</a>
<a class="sourceLine" id="cb5-227" href="#cb5-227" data-line-number="227">        tot_coll_amt,</a>
<a class="sourceLine" id="cb5-228" href="#cb5-228" data-line-number="228">        tot_cur_bal,</a>
<a class="sourceLine" id="cb5-229" href="#cb5-229" data-line-number="229">        tot_hi_cred_lim,</a>
<a class="sourceLine" id="cb5-230" href="#cb5-230" data-line-number="230">        total_acc,</a>
<a class="sourceLine" id="cb5-231" href="#cb5-231" data-line-number="231">        total_bal_ex_mort,</a>
<a class="sourceLine" id="cb5-232" href="#cb5-232" data-line-number="232">        total_bal_il,</a>
<a class="sourceLine" id="cb5-233" href="#cb5-233" data-line-number="233">        total_bc_limit,</a>
<a class="sourceLine" id="cb5-234" href="#cb5-234" data-line-number="234">        total_cu_tl,</a>
<a class="sourceLine" id="cb5-235" href="#cb5-235" data-line-number="235">        total_il_high_credit_limit,</a>
<a class="sourceLine" id="cb5-236" href="#cb5-236" data-line-number="236">        total_pymnt,</a>
<a class="sourceLine" id="cb5-237" href="#cb5-237" data-line-number="237">        total_pymnt_inv,</a>
<a class="sourceLine" id="cb5-238" href="#cb5-238" data-line-number="238">        total_rec_int,</a>
<a class="sourceLine" id="cb5-239" href="#cb5-239" data-line-number="239">        total_rec_late_fee,</a>
<a class="sourceLine" id="cb5-240" href="#cb5-240" data-line-number="240">        total_rec_prncp,</a>
<a class="sourceLine" id="cb5-241" href="#cb5-241" data-line-number="241">        total_rev_hi_lim</a>
<a class="sourceLine" id="cb5-242" href="#cb5-242" data-line-number="242">      )</a>
<a class="sourceLine" id="cb5-243" href="#cb5-243" data-line-number="243">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-244" href="#cb5-244" data-line-number="244"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-245" href="#cb5-245" data-line-number="245"><span class="st">    </span><span class="co"># Converts some values to 1/-1 (instead of Boolean)</span></a>
<a class="sourceLine" id="cb5-246" href="#cb5-246" data-line-number="246"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb5-247" href="#cb5-247" data-line-number="247">      <span class="dt">pymnt_plan =</span>           <span class="kw">if_else</span>(pymnt_plan <span class="op">==</span><span class="st"> &quot;y&quot;</span>,           <span class="dv">1</span>, <span class="dv">-1</span>),</a>
<a class="sourceLine" id="cb5-248" href="#cb5-248" data-line-number="248">      <span class="dt">hardship_flag =</span>        <span class="kw">if_else</span>(hardship_flag <span class="op">==</span><span class="st"> &quot;Y&quot;</span>,        <span class="dv">1</span>, <span class="dv">-1</span>),</a>
<a class="sourceLine" id="cb5-249" href="#cb5-249" data-line-number="249">      <span class="dt">debt_settlement_flag =</span> <span class="kw">if_else</span>(debt_settlement_flag <span class="op">==</span><span class="st"> &quot;Y&quot;</span>, <span class="dv">1</span>, <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb5-250" href="#cb5-250" data-line-number="250">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-251" href="#cb5-251" data-line-number="251"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-252" href="#cb5-252" data-line-number="252"><span class="st">    </span><span class="co"># Some values are percentages</span></a>
<a class="sourceLine" id="cb5-253" href="#cb5-253" data-line-number="253"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb5-254" href="#cb5-254" data-line-number="254">      <span class="dt">int_rate =</span> int_rate <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-255" href="#cb5-255" data-line-number="255">      <span class="dt">dti =</span> dti <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-256" href="#cb5-256" data-line-number="256">      <span class="dt">dti_joint =</span> dti_joint <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-257" href="#cb5-257" data-line-number="257">      <span class="dt">revol_util =</span> revol_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-258" href="#cb5-258" data-line-number="258">      <span class="dt">il_util =</span> il_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-259" href="#cb5-259" data-line-number="259">      <span class="dt">all_util =</span> all_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-260" href="#cb5-260" data-line-number="260">      <span class="dt">bc_open_to_buy =</span> bc_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-261" href="#cb5-261" data-line-number="261">      <span class="dt">pct_tl_nvr_dlq =</span> pct_tl_nvr_dlq <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-262" href="#cb5-262" data-line-number="262">      <span class="dt">percent_bc_gt_75 =</span> percent_bc_gt_<span class="dv">75</span> <span class="op">/</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb5-263" href="#cb5-263" data-line-number="263">      <span class="dt">sec_app_revol_util =</span> sec_app_revol_util <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb5-264" href="#cb5-264" data-line-number="264">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-265" href="#cb5-265" data-line-number="265"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-266" href="#cb5-266" data-line-number="266"><span class="st">    </span><span class="co"># Create quasi-centered numerical grades out of grade factors with &quot;A&quot; = 3 down to &quot;G&quot; = -3</span></a>
<a class="sourceLine" id="cb5-267" href="#cb5-267" data-line-number="267"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">grade_num =</span> <span class="dv">4</span> <span class="op">-</span><span class="st"> </span><span class="kw">as.integer</span>(grade)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-268" href="#cb5-268" data-line-number="268"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-269" href="#cb5-269" data-line-number="269"><span class="st">    </span><span class="co"># Ditto with sub_grades. &quot;A1&quot; = +3.4, &quot;A3&quot; = +3.0, down to &quot;G3&quot; = -3.0, &quot;G5&quot; = -3.4</span></a>
<a class="sourceLine" id="cb5-270" href="#cb5-270" data-line-number="270"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sub_grade_num =</span> <span class="fl">3.6</span> <span class="op">-</span><span class="st"> </span><span class="kw">as.integer</span>(sub_grade) <span class="op">/</span><span class="st"> </span><span class="dv">5</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-271" href="#cb5-271" data-line-number="271"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-272" href="#cb5-272" data-line-number="272"><span class="st">    </span><span class="co"># Keep the first 3 digits of the zipcode as numbers</span></a>
<a class="sourceLine" id="cb5-273" href="#cb5-273" data-line-number="273"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">zip_code =</span> <span class="kw">as.integer</span>(<span class="kw">str_sub</span>(zip_code, <span class="dv">1</span>, <span class="dv">3</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-274" href="#cb5-274" data-line-number="274"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-275" href="#cb5-275" data-line-number="275"><span class="st">    </span><span class="co"># order by date</span></a>
<a class="sourceLine" id="cb5-276" href="#cb5-276" data-line-number="276"><span class="st">    </span><span class="kw">arrange</span>(issue_d) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-277" href="#cb5-277" data-line-number="277"><span class="st">    </span></a>
<a class="sourceLine" id="cb5-278" href="#cb5-278" data-line-number="278"><span class="st">    </span><span class="co"># Remove empty columns</span></a>
<a class="sourceLine" id="cb5-279" href="#cb5-279" data-line-number="279"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>id, <span class="op">-</span>member_id, <span class="op">-</span>url)</a>
<a class="sourceLine" id="cb5-280" href="#cb5-280" data-line-number="280">  </a>
<a class="sourceLine" id="cb5-281" href="#cb5-281" data-line-number="281">  <span class="kw">saveRDS</span>(lc, <span class="st">&quot;datasets/lending_club_reformatted.rds&quot;</span>)</a>
<a class="sourceLine" id="cb5-282" href="#cb5-282" data-line-number="282">  </a>
<a class="sourceLine" id="cb5-283" href="#cb5-283" data-line-number="283">  </a>
<a class="sourceLine" id="cb5-284" href="#cb5-284" data-line-number="284">  <span class="co"># Select loans which have matured or been terminated</span></a>
<a class="sourceLine" id="cb5-285" href="#cb5-285" data-line-number="285">  past_loans &lt;-<span class="st"> </span>lc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-286" href="#cb5-286" data-line-number="286"><span class="st">    </span><span class="kw">filter</span>(</a>
<a class="sourceLine" id="cb5-287" href="#cb5-287" data-line-number="287">      loan_status <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb5-288" href="#cb5-288" data-line-number="288">        <span class="st">&quot;Charged Off&quot;</span>,</a>
<a class="sourceLine" id="cb5-289" href="#cb5-289" data-line-number="289">        <span class="st">&quot;Does not meet the credit policy. Status:Charged Off&quot;</span>,</a>
<a class="sourceLine" id="cb5-290" href="#cb5-290" data-line-number="290">        <span class="st">&quot;Does not meet the credit policy. Status:Fully Paid&quot;</span>,</a>
<a class="sourceLine" id="cb5-291" href="#cb5-291" data-line-number="291">        <span class="st">&quot;Fully Paid&quot;</span></a>
<a class="sourceLine" id="cb5-292" href="#cb5-292" data-line-number="292">      )</a>
<a class="sourceLine" id="cb5-293" href="#cb5-293" data-line-number="293">    )</a>
<a class="sourceLine" id="cb5-294" href="#cb5-294" data-line-number="294">  </a>
<a class="sourceLine" id="cb5-295" href="#cb5-295" data-line-number="295">  <span class="kw">saveRDS</span>(past_loans, <span class="st">&quot;datasets/lending_club_reformatted_paid.rds&quot;</span>)</a>
<a class="sourceLine" id="cb5-296" href="#cb5-296" data-line-number="296">})<span class="st">```</span></a></code></pre></div>
<p></p>
</div>
<div id="zip-codes-and-fips-codes" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Zip codes and FIPS codes</h3>
<p>The R package <code>zipcode</code> was installed.</p>
<p></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" href="#cb6-1" data-line-number="1"><span class="co">#</span></a>
<a class="sourceLine" id="cb6-2" href="#cb6-2" data-line-number="2"><span class="co"># ZIPCodes dataset.</span></a>
<a class="sourceLine" id="cb6-3" href="#cb6-3" data-line-number="3"><span class="co">#</span></a>
<a class="sourceLine" id="cb6-4" href="#cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" href="#cb6-5" data-line-number="5"><span class="kw">library</span>(zipcode)</a>
<a class="sourceLine" id="cb6-6" href="#cb6-6" data-line-number="6"><span class="kw">data</span>(zipcode)</a>
<a class="sourceLine" id="cb6-7" href="#cb6-7" data-line-number="7">zips &lt;-<span class="st"> </span>zipcode <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-8" href="#cb6-8" data-line-number="8"><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-9" href="#cb6-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">zip =</span> <span class="kw">as.integer</span>(<span class="kw">str_sub</span>(zip, <span class="dv">1</span>, <span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb6-10" href="#cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" href="#cb6-11" data-line-number="11"><span class="kw">saveRDS</span>(zips, <span class="st">&quot;datasets/zips.rds&quot;</span>)</a></code></pre></div>
<p></p>
<p>A csv file containing zip codes, FIPS codes and population information was downloaded from the <em>Simple Maps</em><a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a> website.</p>
<p></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" href="#cb7-1" data-line-number="1"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb7-2" href="#cb7-2" data-line-number="2">  kaggleCodes &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/ZIP-COUNTY-FIPS_2017-06.csv&quot;</span>)</a>
<a class="sourceLine" id="cb7-3" href="#cb7-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb7-4" href="#cb7-4" data-line-number="4">  kaggleCodes &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb7-5" href="#cb7-5" data-line-number="5"><span class="st">    </span>kaggleCodes <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-6" href="#cb7-6" data-line-number="6"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-7" href="#cb7-7" data-line-number="7"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">zip =</span> <span class="kw">floor</span>(ZIP<span class="op">/</span><span class="dv">100</span>), </a>
<a class="sourceLine" id="cb7-8" href="#cb7-8" data-line-number="8">           <span class="dt">FIPS =</span> STCOUNTYFP, </a>
<a class="sourceLine" id="cb7-9" href="#cb7-9" data-line-number="9">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;County&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb7-10" href="#cb7-10" data-line-number="10">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Borough&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb7-11" href="#cb7-11" data-line-number="11">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Municipio&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb7-12" href="#cb7-12" data-line-number="12">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Parish&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb7-13" href="#cb7-13" data-line-number="13">           <span class="dt">COUNTYNAME =</span> <span class="kw">str_replace</span>(COUNTYNAME, <span class="dt">pattern =</span> <span class="st">&quot;Census Area&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-14" href="#cb7-14" data-line-number="14"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">county =</span> COUNTYNAME) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-15" href="#cb7-15" data-line-number="15"><span class="st">    </span><span class="kw">select</span>(zip, county, FIPS) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-16" href="#cb7-16" data-line-number="16"><span class="st">    </span><span class="kw">arrange</span>(zip)</a>
<a class="sourceLine" id="cb7-17" href="#cb7-17" data-line-number="17"></a>
<a class="sourceLine" id="cb7-18" href="#cb7-18" data-line-number="18">  <span class="kw">saveRDS</span>(zipfips, <span class="st">&quot;datasets/kaggleCodes.rds&quot;</span>)</a>
<a class="sourceLine" id="cb7-19" href="#cb7-19" data-line-number="19">})</a></code></pre></div>
<p></p>
</div>
<div id="market-interest-rates" class="section level3">
<h3><span class="header-section-number">5.2.3</span> Market interest rates</h3>
<p>Market interest rates (3-year and 5-year swap rates) were download from the Saint Louis Federal Reserve Bank. Datasets are split between before and after the LIBOR fixing scandal. The datasets are merged with disctinct dates.</p>
<p>Download sources are:</p>
<ul>
<li>Pre-LIBOR 3-y swap <a href="https://fred.stlouisfed.org/series/DSWP3" class="uri">https://fred.stlouisfed.org/series/DSWP3</a></li>
<li><p>Post-LIBOR 3-y swap <a href="https://fred.stlouisfed.org/series/ICERATES1100USD3Y" class="uri">https://fred.stlouisfed.org/series/ICERATES1100USD3Y</a></p></li>
<li>Pre-LIBOR 5-y swap <a href="https://fred.stlouisfed.org/series/MSWP5" class="uri">https://fred.stlouisfed.org/series/MSWP5</a></li>
<li><p>Post-LIBOR 5-y swap <a href="https://fred.stlouisfed.org/series/ICERATES1100USD5Y" class="uri">https://fred.stlouisfed.org/series/ICERATES1100USD5Y</a></p></li>
</ul>
<p></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" href="#cb8-1" data-line-number="1"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb8-2" href="#cb8-2" data-line-number="2">  LIBOR3Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/DSWP3.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" href="#cb8-3" data-line-number="3"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-4" href="#cb8-4" data-line-number="4"><span class="st">    </span><span class="kw">filter</span>(DSWP3 <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-5" href="#cb8-5" data-line-number="5"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb8-6" href="#cb8-6" data-line-number="6">           <span class="dt">RATE3Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(DSWP3)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-7" href="#cb8-7" data-line-number="7"><span class="st">    </span><span class="kw">select</span>(DATE, RATE3Y)</a>
<a class="sourceLine" id="cb8-8" href="#cb8-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb8-9" href="#cb8-9" data-line-number="9">  ICE3Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/ICERATES1100USD3Y.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-10" href="#cb8-10" data-line-number="10"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-11" href="#cb8-11" data-line-number="11"><span class="st">    </span><span class="kw">filter</span>(ICERATES1100USD3Y <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-12" href="#cb8-12" data-line-number="12"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb8-13" href="#cb8-13" data-line-number="13">           <span class="dt">RATE3Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(ICERATES1100USD3Y)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-14" href="#cb8-14" data-line-number="14"><span class="st">    </span><span class="kw">select</span>(DATE, RATE3Y)</a>
<a class="sourceLine" id="cb8-15" href="#cb8-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb8-16" href="#cb8-16" data-line-number="16">  </a>
<a class="sourceLine" id="cb8-17" href="#cb8-17" data-line-number="17">  LIBOR5Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/DSWP5.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-18" href="#cb8-18" data-line-number="18"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-19" href="#cb8-19" data-line-number="19"><span class="st">    </span><span class="kw">filter</span>(DSWP5 <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-20" href="#cb8-20" data-line-number="20"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb8-21" href="#cb8-21" data-line-number="21">           <span class="dt">RATE5Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(DSWP5)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-22" href="#cb8-22" data-line-number="22"><span class="st">    </span><span class="kw">select</span>(DATE, RATE5Y)</a>
<a class="sourceLine" id="cb8-23" href="#cb8-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb8-24" href="#cb8-24" data-line-number="24">  ICE5Y &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;datasets/csv/ICERATES1100USD5Y.csv&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-25" href="#cb8-25" data-line-number="25"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-26" href="#cb8-26" data-line-number="26"><span class="st">    </span><span class="kw">filter</span>(ICERATES1100USD5Y <span class="op">!=</span><span class="st"> &quot;.&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-27" href="#cb8-27" data-line-number="27"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">as_date</span>(DATE),</a>
<a class="sourceLine" id="cb8-28" href="#cb8-28" data-line-number="28">           <span class="dt">RATE5Y =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(ICERATES1100USD5Y)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-29" href="#cb8-29" data-line-number="29"><span class="st">    </span><span class="kw">select</span>(DATE, RATE5Y)</a>
<a class="sourceLine" id="cb8-30" href="#cb8-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb8-31" href="#cb8-31" data-line-number="31">  RATES3Y &lt;-<span class="st"> </span>LIBOR3Y <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rbind</span>(ICE3Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-32" href="#cb8-32" data-line-number="32"><span class="st">    </span><span class="kw">arrange</span>(DATE) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>(DATE, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-33" href="#cb8-33" data-line-number="33">  </a>
<a class="sourceLine" id="cb8-34" href="#cb8-34" data-line-number="34">  RATES5Y &lt;-<span class="st"> </span>LIBOR5Y <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rbind</span>(ICE5Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-35" href="#cb8-35" data-line-number="35"><span class="st">    </span><span class="kw">arrange</span>(DATE) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>(DATE, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-36" href="#cb8-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb8-37" href="#cb8-37" data-line-number="37">  <span class="kw">saveRDS</span>(RATES3Y, <span class="st">&quot;datasets/rates3Y.rds&quot;</span>)</a>
<a class="sourceLine" id="cb8-38" href="#cb8-38" data-line-number="38">  <span class="kw">saveRDS</span>(RATES5Y, <span class="st">&quot;datasets/rates5Y.rds&quot;</span>)</a>
<a class="sourceLine" id="cb8-39" href="#cb8-39" data-line-number="39">  </a>
<a class="sourceLine" id="cb8-40" href="#cb8-40" data-line-number="40">  </a>
<a class="sourceLine" id="cb8-41" href="#cb8-41" data-line-number="41">  <span class="co"># Note there are 7212 days from 1 Jan 2000 to 30 Sep 2019</span></a>
<a class="sourceLine" id="cb8-42" href="#cb8-42" data-line-number="42">  <span class="co">#</span></a>
<a class="sourceLine" id="cb8-43" href="#cb8-43" data-line-number="43">  <span class="co"># (ymd(&quot;2000-01-01&quot;) %--% ymd(&quot;2019-09-30&quot;)) %/% days(1)</span></a>
<a class="sourceLine" id="cb8-44" href="#cb8-44" data-line-number="44">  RATES &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">n =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">7212</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-45" href="#cb8-45" data-line-number="45"><span class="st">    </span></a>
<a class="sourceLine" id="cb8-46" href="#cb8-46" data-line-number="46"><span class="st">    </span><span class="co"># Create a column with all dates</span></a>
<a class="sourceLine" id="cb8-47" href="#cb8-47" data-line-number="47"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DATE =</span> <span class="kw">ymd</span>(<span class="st">&quot;2000-01-01&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">days</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-48" href="#cb8-48" data-line-number="48"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>n) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-49" href="#cb8-49" data-line-number="49"><span class="st">    </span></a>
<a class="sourceLine" id="cb8-50" href="#cb8-50" data-line-number="50"><span class="st">    </span><span class="co"># Add all daily 3- then 5-year rates and fill missing down</span></a>
<a class="sourceLine" id="cb8-51" href="#cb8-51" data-line-number="51"><span class="st">    </span><span class="kw">left_join</span>(RATES3Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-52" href="#cb8-52" data-line-number="52"><span class="st">    </span><span class="kw">fill</span>(RATE3Y, <span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-53" href="#cb8-53" data-line-number="53"><span class="st">    </span></a>
<a class="sourceLine" id="cb8-54" href="#cb8-54" data-line-number="54"><span class="st">    </span><span class="kw">left_join</span>(RATES5Y) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-55" href="#cb8-55" data-line-number="55"><span class="st">    </span><span class="kw">fill</span>(RATE5Y, <span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>)</a>
<a class="sourceLine" id="cb8-56" href="#cb8-56" data-line-number="56">  </a>
<a class="sourceLine" id="cb8-57" href="#cb8-57" data-line-number="57">  <span class="kw">saveRDS</span>(RATES, <span class="st">&quot;datasets/rates.rds&quot;</span>)</a>
<a class="sourceLine" id="cb8-58" href="#cb8-58" data-line-number="58">})</a></code></pre></div>
<p></p>
</div>
<div id="macro-economical-data" class="section level3">
<h3><span class="header-section-number">5.2.4</span> Macro-economical data</h3>
<p>Macro-economical datasets were sourced from the same website as Microsoft Excel files. They were converted as-is to tab-separated csv files with LibreOffice.</p>
<ul>
<li><p>Median income per household:
<a href="https://geofred.stlouisfed.org/map/?th=pubugn&amp;cc=5&amp;rc=false&amp;im=fractile&amp;sb&amp;lng=-112.41&amp;lat=44.31&amp;zm=4&amp;sl&amp;sv&amp;am=Average&amp;at=Not%20Seasonally%20Adjusted,%20Annual,%20Dollars&amp;sti=2022&amp;fq=Annual&amp;rt=county&amp;un=lin&amp;dt=2017-01-01">https://geofred.stlouisfed.org/map/?th=pubugn&amp;cc=5&amp;rc=false&amp;im=fractile&amp;sb&amp;lng=-112.41&amp;lat=44.31&amp;zm=4&amp;sl&amp;sv&amp;am=Average&amp;at=Not%20Seasonally%20Adjusted,%20Annual,%20Dollars&amp;sti=2022&amp;fq=Annual&amp;rt=county&amp;un=lin&amp;dt=2017-01-01</a></p></li>
<li><p>Per capita personal income:
<a href="https://geofred.stlouisfed.org/map/?th=pubugn&amp;cc=5&amp;rc=false&amp;im=fractile&amp;sb&amp;lng=-112.41&amp;lat=44.31&amp;zm=4&amp;sl&amp;sv&amp;am=Average&amp;at=Not%20Seasonally%20Adjusted,%20Annual,%20Dollars&amp;sti=882&amp;fq=Annual&amp;rt=county&amp;un=lin&amp;dt=2017-01-01">https://geofred.stlouisfed.org/map/?th=pubugn&amp;cc=5&amp;rc=false&amp;im=fractile&amp;sb&amp;lng=-112.41&amp;lat=44.31&amp;zm=4&amp;sl&amp;sv&amp;am=Average&amp;at=Not%20Seasonally%20Adjusted,%20Annual,%20Dollars&amp;sti=882&amp;fq=Annual&amp;rt=county&amp;un=lin&amp;dt=2017-01-01</a></p></li>
<li><p>Unemployment:
<a href="https://geofred.stlouisfed.org/map/?th=rdpu&amp;cc=5&amp;rc=false&amp;im=fractile&amp;sb&amp;lng=-90&amp;lat=40&amp;zm=4&amp;sl&amp;sv&amp;am=Average&amp;at=Not%20Seasonally%20Adjusted,%20Monthly,%20Percent&amp;sti=1224&amp;fq=Monthly&amp;rt=county&amp;un=lin&amp;dt=2019-08-01">https://geofred.stlouisfed.org/map/?th=rdpu&amp;cc=5&amp;rc=false&amp;im=fractile&amp;sb&amp;lng=-90&amp;lat=40&amp;zm=4&amp;sl&amp;sv&amp;am=Average&amp;at=Not%20Seasonally%20Adjusted,%20Monthly,%20Percent&amp;sti=1224&amp;fq=Monthly&amp;rt=county&amp;un=lin&amp;dt=2019-08-01</a></p></li>
</ul>
<p></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" href="#cb9-1" data-line-number="1"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb9-2" href="#cb9-2" data-line-number="2">  <span class="co">###################################################################################################</span></a>
<a class="sourceLine" id="cb9-3" href="#cb9-3" data-line-number="3">  <span class="co">##</span></a>
<a class="sourceLine" id="cb9-4" href="#cb9-4" data-line-number="4">  <span class="co">## Median income per household by FIPS from 2002 to 2017</span></a>
<a class="sourceLine" id="cb9-5" href="#cb9-5" data-line-number="5">  <span class="co">##</span></a>
<a class="sourceLine" id="cb9-6" href="#cb9-6" data-line-number="6">  <span class="co"># Prepare median income</span></a>
<a class="sourceLine" id="cb9-7" href="#cb9-7" data-line-number="7">  medianIncome &lt;-</a>
<a class="sourceLine" id="cb9-8" href="#cb9-8" data-line-number="8"><span class="st">    </span><span class="co"># Load the dataset after dropping the first line</span></a>
<a class="sourceLine" id="cb9-9" href="#cb9-9" data-line-number="9"><span class="st">    </span><span class="kw">read.csv</span>(</a>
<a class="sourceLine" id="cb9-10" href="#cb9-10" data-line-number="10">      <span class="st">&quot;datasets/csv/GeoFRED_Estimate_of_Median_Household_Income_by_County_Dollars.csv&quot;</span>,</a>
<a class="sourceLine" id="cb9-11" href="#cb9-11" data-line-number="11">      <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb9-12" href="#cb9-12" data-line-number="12">      <span class="dt">skip =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb9-13" href="#cb9-13" data-line-number="13">      <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb9-14" href="#cb9-14" data-line-number="14">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-15" href="#cb9-15" data-line-number="15"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-16" href="#cb9-16" data-line-number="16"><span class="st">    </span><span class="co"># Drops columnsn containing a unique identifier and the FIPS name</span></a>
<a class="sourceLine" id="cb9-17" href="#cb9-17" data-line-number="17"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span><span class="st">&quot;Series.ID&quot;</span>, <span class="op">-</span><span class="st">&quot;Region.Name&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-18" href="#cb9-18" data-line-number="18"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-19" href="#cb9-19" data-line-number="19"><span class="st">    </span><span class="co"># Rename the relevant column to &#39;FIPS&#39;</span></a>
<a class="sourceLine" id="cb9-20" href="#cb9-20" data-line-number="20"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">FIPS =</span> <span class="st">&quot;Region.Code&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-21" href="#cb9-21" data-line-number="21"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-22" href="#cb9-22" data-line-number="22"><span class="st">    </span><span class="co"># Order by FIPS</span></a>
<a class="sourceLine" id="cb9-23" href="#cb9-23" data-line-number="23"><span class="st">    </span><span class="kw">arrange</span>(FIPS) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-24" href="#cb9-24" data-line-number="24"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-25" href="#cb9-25" data-line-number="25"><span class="st">    </span><span class="co"># Convert to a &#39;long&#39; table, i.e. one column for FIPS, one for date, one for income</span></a>
<a class="sourceLine" id="cb9-26" href="#cb9-26" data-line-number="26"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>), </a>
<a class="sourceLine" id="cb9-27" href="#cb9-27" data-line-number="27">                 <span class="dt">names_to =</span> <span class="st">&quot;Date&quot;</span>, </a>
<a class="sourceLine" id="cb9-28" href="#cb9-28" data-line-number="28">                 <span class="dt">values_to =</span> <span class="st">&quot;medianIncome&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-29" href="#cb9-29" data-line-number="29"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-30" href="#cb9-30" data-line-number="30"><span class="st">    </span><span class="co"># Create actual dates</span></a>
<a class="sourceLine" id="cb9-31" href="#cb9-31" data-line-number="31"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Date =</span> <span class="kw">str_replace</span>(Date, <span class="st">&quot;[X]&quot;</span>, <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb9-32" href="#cb9-32" data-line-number="32">           <span class="dt">Date =</span> <span class="kw">ymd</span>(<span class="kw">str_c</span>(Date, <span class="st">&quot;-12-31&quot;</span>)))</a>
<a class="sourceLine" id="cb9-33" href="#cb9-33" data-line-number="33">  </a>
<a class="sourceLine" id="cb9-34" href="#cb9-34" data-line-number="34">  <span class="kw">saveRDS</span>(medianIncome, <span class="st">&quot;datasets/medianincome.rds&quot;</span>)</a>
<a class="sourceLine" id="cb9-35" href="#cb9-35" data-line-number="35"></a>
<a class="sourceLine" id="cb9-36" href="#cb9-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb9-37" href="#cb9-37" data-line-number="37">  </a>
<a class="sourceLine" id="cb9-38" href="#cb9-38" data-line-number="38">  <span class="co">###################################################################################################</span></a>
<a class="sourceLine" id="cb9-39" href="#cb9-39" data-line-number="39">  <span class="co">##</span></a>
<a class="sourceLine" id="cb9-40" href="#cb9-40" data-line-number="40">  <span class="co">## Per capita income by FIPS from 2002 to 2017</span></a>
<a class="sourceLine" id="cb9-41" href="#cb9-41" data-line-number="41">  <span class="co">##</span></a>
<a class="sourceLine" id="cb9-42" href="#cb9-42" data-line-number="42">  personalIncome &lt;-</a>
<a class="sourceLine" id="cb9-43" href="#cb9-43" data-line-number="43"><span class="st">    </span><span class="co"># Load the dataset after dropping the first line</span></a>
<a class="sourceLine" id="cb9-44" href="#cb9-44" data-line-number="44"><span class="st">    </span><span class="kw">read.csv</span>(</a>
<a class="sourceLine" id="cb9-45" href="#cb9-45" data-line-number="45">      <span class="st">&quot;datasets/csv/GeoFRED_Per_Capita_Personal_Income_by_County_Dollars.csv&quot;</span>,</a>
<a class="sourceLine" id="cb9-46" href="#cb9-46" data-line-number="46">      <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb9-47" href="#cb9-47" data-line-number="47">      <span class="dt">skip =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb9-48" href="#cb9-48" data-line-number="48">      <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb9-49" href="#cb9-49" data-line-number="49">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-50" href="#cb9-50" data-line-number="50"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-51" href="#cb9-51" data-line-number="51"><span class="st">    </span><span class="co"># Drops columnsn containing a unique identifier and the FIPS name</span></a>
<a class="sourceLine" id="cb9-52" href="#cb9-52" data-line-number="52"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span><span class="st">&quot;Series.ID&quot;</span>, <span class="op">-</span><span class="st">&quot;Region.Name&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-53" href="#cb9-53" data-line-number="53"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-54" href="#cb9-54" data-line-number="54"><span class="st">    </span><span class="co"># Rename the relevant column to &#39;FIPS&#39;</span></a>
<a class="sourceLine" id="cb9-55" href="#cb9-55" data-line-number="55"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">FIPS =</span> <span class="st">&quot;Region.Code&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-56" href="#cb9-56" data-line-number="56"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-57" href="#cb9-57" data-line-number="57"><span class="st">    </span><span class="co"># Order by FIPS</span></a>
<a class="sourceLine" id="cb9-58" href="#cb9-58" data-line-number="58"><span class="st">    </span><span class="kw">arrange</span>(FIPS) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-59" href="#cb9-59" data-line-number="59"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-60" href="#cb9-60" data-line-number="60"><span class="st">    </span><span class="co"># Convert to a &#39;long&#39; table, i.e. one column for FIPS, one for date, one for income</span></a>
<a class="sourceLine" id="cb9-61" href="#cb9-61" data-line-number="61"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>), </a>
<a class="sourceLine" id="cb9-62" href="#cb9-62" data-line-number="62">                 <span class="dt">names_to =</span> <span class="st">&quot;Date&quot;</span>, </a>
<a class="sourceLine" id="cb9-63" href="#cb9-63" data-line-number="63">                 <span class="dt">values_to =</span> <span class="st">&quot;personalIncome&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-64" href="#cb9-64" data-line-number="64"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-65" href="#cb9-65" data-line-number="65"><span class="st">    </span><span class="co"># Create actual dates</span></a>
<a class="sourceLine" id="cb9-66" href="#cb9-66" data-line-number="66"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Date =</span> <span class="kw">str_replace</span>(Date, <span class="st">&quot;[X]&quot;</span>, <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb9-67" href="#cb9-67" data-line-number="67">           <span class="dt">Date =</span> <span class="kw">ymd</span>(<span class="kw">str_c</span>(Date, <span class="st">&quot;-12-31&quot;</span>)))</a>
<a class="sourceLine" id="cb9-68" href="#cb9-68" data-line-number="68">  </a>
<a class="sourceLine" id="cb9-69" href="#cb9-69" data-line-number="69">  <span class="kw">saveRDS</span>(personalIncome, <span class="st">&quot;datasets/personalincome.rds&quot;</span>)</a>
<a class="sourceLine" id="cb9-70" href="#cb9-70" data-line-number="70">  </a>
<a class="sourceLine" id="cb9-71" href="#cb9-71" data-line-number="71">  </a>
<a class="sourceLine" id="cb9-72" href="#cb9-72" data-line-number="72">  <span class="co">###################################################################################################</span></a>
<a class="sourceLine" id="cb9-73" href="#cb9-73" data-line-number="73">  <span class="co">##</span></a>
<a class="sourceLine" id="cb9-74" href="#cb9-74" data-line-number="74">  <span class="co">## Unemplyment rate monthly by FIPS from January 2000 to August 2019</span></a>
<a class="sourceLine" id="cb9-75" href="#cb9-75" data-line-number="75">  <span class="co">##</span></a>
<a class="sourceLine" id="cb9-76" href="#cb9-76" data-line-number="76">  unemploymentRate &lt;-</a>
<a class="sourceLine" id="cb9-77" href="#cb9-77" data-line-number="77"><span class="st">    </span><span class="co"># Load the dataset after dropping the first line</span></a>
<a class="sourceLine" id="cb9-78" href="#cb9-78" data-line-number="78"><span class="st">    </span><span class="kw">read.csv</span>(</a>
<a class="sourceLine" id="cb9-79" href="#cb9-79" data-line-number="79">      <span class="st">&quot;datasets/csv/GeoFRED_Unemployment_Rate_by_County_Percent.csv&quot;</span>,</a>
<a class="sourceLine" id="cb9-80" href="#cb9-80" data-line-number="80">      <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb9-81" href="#cb9-81" data-line-number="81">      <span class="dt">skip =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb9-82" href="#cb9-82" data-line-number="82">      <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb9-83" href="#cb9-83" data-line-number="83">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-84" href="#cb9-84" data-line-number="84"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-85" href="#cb9-85" data-line-number="85"><span class="st">    </span><span class="co"># Drops columnsn containing a unique identifier and the FIPS name</span></a>
<a class="sourceLine" id="cb9-86" href="#cb9-86" data-line-number="86"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span><span class="st">&quot;Series.ID&quot;</span>, <span class="op">-</span><span class="st">&quot;Region.Name&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-87" href="#cb9-87" data-line-number="87"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-88" href="#cb9-88" data-line-number="88"><span class="st">    </span><span class="co"># Rename the relevant column to &#39;FIPS&#39;</span></a>
<a class="sourceLine" id="cb9-89" href="#cb9-89" data-line-number="89"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">FIPS =</span> <span class="st">&quot;Region.Code&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-90" href="#cb9-90" data-line-number="90"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-91" href="#cb9-91" data-line-number="91"><span class="st">    </span><span class="co"># Order by FIPS</span></a>
<a class="sourceLine" id="cb9-92" href="#cb9-92" data-line-number="92"><span class="st">    </span><span class="kw">arrange</span>(FIPS) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-93" href="#cb9-93" data-line-number="93"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-94" href="#cb9-94" data-line-number="94"><span class="st">    </span><span class="kw">mutate_all</span>(as.double) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-95" href="#cb9-95" data-line-number="95"><span class="st">  </span></a>
<a class="sourceLine" id="cb9-96" href="#cb9-96" data-line-number="96"><span class="st">    </span><span class="co"># Convert to a &#39;long&#39; table, i.e. one column for FIPS, one for date, one for income</span></a>
<a class="sourceLine" id="cb9-97" href="#cb9-97" data-line-number="97"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">starts_with</span>(<span class="st">&quot;X&quot;</span>), </a>
<a class="sourceLine" id="cb9-98" href="#cb9-98" data-line-number="98">                 <span class="dt">names_to =</span> <span class="st">&quot;Date&quot;</span>, </a>
<a class="sourceLine" id="cb9-99" href="#cb9-99" data-line-number="99">                 <span class="dt">values_to =</span> <span class="st">&quot;unemploymentRate&quot;</span>, </a>
<a class="sourceLine" id="cb9-100" href="#cb9-100" data-line-number="100">                 <span class="dt">values_ptypes =</span> <span class="kw">c</span>(<span class="st">&quot;unemploymentRate&quot;</span>, numeric)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-101" href="#cb9-101" data-line-number="101"><span class="st">    </span></a>
<a class="sourceLine" id="cb9-102" href="#cb9-102" data-line-number="102"><span class="st">    </span><span class="co"># Converts the content of the Year column to an actual date</span></a>
<a class="sourceLine" id="cb9-103" href="#cb9-103" data-line-number="103"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb9-104" href="#cb9-104" data-line-number="104">      <span class="dt">Date =</span> <span class="kw">str_replace</span>(Date, <span class="st">&quot;[X]&quot;</span>, <span class="st">&quot;&quot;</span>),</a>
<a class="sourceLine" id="cb9-105" href="#cb9-105" data-line-number="105">      <span class="dt">Date =</span> <span class="kw">str_replace</span>(Date, <span class="st">&quot;[.]&quot;</span>, <span class="st">&quot;-&quot;</span>),</a>
<a class="sourceLine" id="cb9-106" href="#cb9-106" data-line-number="106">      <span class="dt">Date =</span> <span class="kw">ymd</span>(<span class="kw">str_c</span>(Date, <span class="st">&quot;-1&quot;</span>))</a>
<a class="sourceLine" id="cb9-107" href="#cb9-107" data-line-number="107">    )</a>
<a class="sourceLine" id="cb9-108" href="#cb9-108" data-line-number="108">  </a>
<a class="sourceLine" id="cb9-109" href="#cb9-109" data-line-number="109">  <span class="kw">saveRDS</span>(unemploymentRate, <span class="st">&quot;datasets/unemployment.rds&quot;</span>)</a>
<a class="sourceLine" id="cb9-110" href="#cb9-110" data-line-number="110">})</a></code></pre></div>
<p></p>
</div>
</div>
<div id="list-of-variables" class="section level2">
<h2><span class="header-section-number">5.3</span> List of variables</h2>
<p>This table presents the list of variables provided in the original dataset. The descriptions come from a spreadsheet attached with the dataset and, unfortunately, are not extremely precise and subject to interpretation. We added comments and/or particular interpretations in <em>CAPITAL LETTERS</em>.</p>
<p></p>

<p></p>
</div>
<div id="calculations-of-the-internal-rate-of-returns-and-month-to-default" class="section level2">
<h2><span class="header-section-number">5.4</span> Calculations of the internal rate of returns and month-to-default</h2>
<p>The following shows two versions of the same code. The R version is provided because of the description of the assignment. However, the R version takes just under a full day to run. A Julia version, which is a direct translation of the R code, runs in about 150s (ca. 500x faster).</p>
<div id="r-code" class="section level3">
<h3><span class="header-section-number">5.4.1</span> R code</h3>
<p></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" href="#cb10-1" data-line-number="1"><span class="co">###################################################################################################</span></a>
<a class="sourceLine" id="cb10-2" href="#cb10-2" data-line-number="2"><span class="co">#</span></a>
<a class="sourceLine" id="cb10-3" href="#cb10-3" data-line-number="3"><span class="co"># Given some numerical parameters describing a loan in the dataset, returns its Internal Rate</span></a>
<a class="sourceLine" id="cb10-4" href="#cb10-4" data-line-number="4"><span class="co"># of Return.</span></a>
<a class="sourceLine" id="cb10-5" href="#cb10-5" data-line-number="5"><span class="co">#</span></a>
<a class="sourceLine" id="cb10-6" href="#cb10-6" data-line-number="6"><span class="co"># In the first instance, the function creates a schedule of payments.</span></a>
<a class="sourceLine" id="cb10-7" href="#cb10-7" data-line-number="7"><span class="co"># In many cases, the schedule will be extremely simple: a series of 36 or 60 equal instalements.</span></a>
<a class="sourceLine" id="cb10-8" href="#cb10-8" data-line-number="8"><span class="co">#</span></a>
<a class="sourceLine" id="cb10-9" href="#cb10-9" data-line-number="9"><span class="co"># But in some cases, a loan repayment are accelerated. Therefore the total amount of interest will</span></a>
<a class="sourceLine" id="cb10-10" href="#cb10-10" data-line-number="10"><span class="co"># be lower than expected (but this is good for the investor because highe interest rate over</span></a>
<a class="sourceLine" id="cb10-11" href="#cb10-11" data-line-number="11"><span class="co"># shorter tenor.).</span></a>
<a class="sourceLine" id="cb10-12" href="#cb10-12" data-line-number="12"><span class="co">#</span></a>
<a class="sourceLine" id="cb10-13" href="#cb10-13" data-line-number="13"><span class="co"># In other cases, the borrower defaults. Overall payments are less than expected.</span></a>
<a class="sourceLine" id="cb10-14" href="#cb10-14" data-line-number="14"><span class="co">#</span></a>
<a class="sourceLine" id="cb10-15" href="#cb10-15" data-line-number="15"><span class="co"># Based on the limited information of the dataset, the function makes educated guesses on the exact schedule.</span></a>
<a class="sourceLine" id="cb10-16" href="#cb10-16" data-line-number="16"><span class="co">#</span></a>
<a class="sourceLine" id="cb10-17" href="#cb10-17" data-line-number="17"><span class="co"># </span><span class="al">WARNING</span><span class="co">: THIS IS NOT OPTIMISED. RUNNING THIS FOR ALL LOANS (1.3 MLN OF THEM) TAKES CA.20 HOURS !!!!</span></a>
<a class="sourceLine" id="cb10-18" href="#cb10-18" data-line-number="18"><span class="co">#</span></a>
<a class="sourceLine" id="cb10-19" href="#cb10-19" data-line-number="19">calculateIRR &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">loanNumber =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb10-20" href="#cb10-20" data-line-number="20">                         loan,</a>
<a class="sourceLine" id="cb10-21" href="#cb10-21" data-line-number="21">                         intRate,</a>
<a class="sourceLine" id="cb10-22" href="#cb10-22" data-line-number="22">                         <span class="dt">term =</span> <span class="dv">36</span>,</a>
<a class="sourceLine" id="cb10-23" href="#cb10-23" data-line-number="23">                         totalPaid,</a>
<a class="sourceLine" id="cb10-24" href="#cb10-24" data-line-number="24">                         totalPrincipalPaid,</a>
<a class="sourceLine" id="cb10-25" href="#cb10-25" data-line-number="25">                         totalInterestPaid,</a>
<a class="sourceLine" id="cb10-26" href="#cb10-26" data-line-number="26">                         <span class="dt">recoveries =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb10-27" href="#cb10-27" data-line-number="27">                         <span class="dt">lateFees =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb10-28" href="#cb10-28" data-line-number="28">                         <span class="dt">showSchedule =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb10-29" href="#cb10-29" data-line-number="29">  <span class="kw">require</span>(tidyverse)</a>
<a class="sourceLine" id="cb10-30" href="#cb10-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb10-31" href="#cb10-31" data-line-number="31">  <span class="co"># number of monthly payments.</span></a>
<a class="sourceLine" id="cb10-32" href="#cb10-32" data-line-number="32">  <span class="co"># It exceeds 60 months in case recoveries on a 60-month loan takes the schedule after 60 months.</span></a>
<a class="sourceLine" id="cb10-33" href="#cb10-33" data-line-number="33">  nMonths &lt;-<span class="st"> </span><span class="dv">90</span></a>
<a class="sourceLine" id="cb10-34" href="#cb10-34" data-line-number="34">  </a>
<a class="sourceLine" id="cb10-35" href="#cb10-35" data-line-number="35">  <span class="co"># Months after which a loan defaults (normal tenor if no default or early prepayment)</span></a>
<a class="sourceLine" id="cb10-36" href="#cb10-36" data-line-number="36">  monthDefault =<span class="st"> </span>term</a>
<a class="sourceLine" id="cb10-37" href="#cb10-37" data-line-number="37">  </a>
<a class="sourceLine" id="cb10-38" href="#cb10-38" data-line-number="38">  <span class="co"># Note: *100 /100 to calculate in cent because ceiling cannot specify significant digits.</span></a>
<a class="sourceLine" id="cb10-39" href="#cb10-39" data-line-number="39">  installment &lt;-</a>
<a class="sourceLine" id="cb10-40" href="#cb10-40" data-line-number="40"><span class="st">    </span><span class="kw">ceiling</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>loan <span class="op">*</span><span class="st"> </span>intRate <span class="op">/</span><span class="st"> </span><span class="dv">12</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>intRate <span class="op">/</span><span class="st"> </span><span class="dv">12</span>) <span class="op">^</span><span class="st"> </span>term)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb10-41" href="#cb10-41" data-line-number="41">  </a>
<a class="sourceLine" id="cb10-42" href="#cb10-42" data-line-number="42">  <span class="co"># We create a schedule</span></a>
<a class="sourceLine" id="cb10-43" href="#cb10-43" data-line-number="43">  schedule &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb10-44" href="#cb10-44" data-line-number="44">    <span class="dt">month =</span> <span class="dv">0</span><span class="op">:</span>nMonths,</a>
<a class="sourceLine" id="cb10-45" href="#cb10-45" data-line-number="45">    <span class="dt">monthlyPayment =</span> <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb10-46" href="#cb10-46" data-line-number="46">    <span class="dt">totalPandI =</span> <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb10-47" href="#cb10-47" data-line-number="47">    <span class="dt">totalI =</span> <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb10-48" href="#cb10-48" data-line-number="48">    <span class="dt">totalP =</span> <span class="fl">0.0</span></a>
<a class="sourceLine" id="cb10-49" href="#cb10-49" data-line-number="49">  )</a>
<a class="sourceLine" id="cb10-50" href="#cb10-50" data-line-number="50">  </a>
<a class="sourceLine" id="cb10-51" href="#cb10-51" data-line-number="51">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>(nMonths <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)) {</a>
<a class="sourceLine" id="cb10-52" href="#cb10-52" data-line-number="52">    <span class="co"># Get situation at the end of previous month</span></a>
<a class="sourceLine" id="cb10-53" href="#cb10-53" data-line-number="53">    previousTotalPandI &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalPandI&quot;</span>])</a>
<a class="sourceLine" id="cb10-54" href="#cb10-54" data-line-number="54">    previousTotalP     &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalP&quot;</span>])</a>
<a class="sourceLine" id="cb10-55" href="#cb10-55" data-line-number="55">    previousTotalI     &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalI&quot;</span>])</a>
<a class="sourceLine" id="cb10-56" href="#cb10-56" data-line-number="56">    </a>
<a class="sourceLine" id="cb10-57" href="#cb10-57" data-line-number="57">    <span class="co"># This is the beginning of a new month. First and foremost, the borrower is expected to pay the</span></a>
<a class="sourceLine" id="cb10-58" href="#cb10-58" data-line-number="58">    <span class="co"># accrued interest on amount of principal outstanding.</span></a>
<a class="sourceLine" id="cb10-59" href="#cb10-59" data-line-number="59">    <span class="co"># ceiling doesn&#39;t seem accept to accept significative digits.</span></a>
<a class="sourceLine" id="cb10-60" href="#cb10-60" data-line-number="60">    accruedInterest &lt;-</a>
<a class="sourceLine" id="cb10-61" href="#cb10-61" data-line-number="61"><span class="st">      </span><span class="kw">ceiling</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(loan <span class="op">-</span><span class="st"> </span>previousTotalP) <span class="op">*</span><span class="st"> </span>intRate <span class="op">/</span><span class="st"> </span><span class="dv">12</span>) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb10-62" href="#cb10-62" data-line-number="62">    </a>
<a class="sourceLine" id="cb10-63" href="#cb10-63" data-line-number="63">    <span class="co"># If that amount takes the schedule above the total amount of interest shown in the data set,</span></a>
<a class="sourceLine" id="cb10-64" href="#cb10-64" data-line-number="64">    <span class="co"># we should stop the schedule at this point</span></a>
<a class="sourceLine" id="cb10-65" href="#cb10-65" data-line-number="65">    <span class="cf">if</span> (previousTotalI <span class="op">+</span><span class="st"> </span>accruedInterest <span class="op">&gt;</span><span class="st"> </span>totalInterestPaid) {</a>
<a class="sourceLine" id="cb10-66" href="#cb10-66" data-line-number="66">      <span class="co"># We stop the normal schedule at this date.</span></a>
<a class="sourceLine" id="cb10-67" href="#cb10-67" data-line-number="67">      <span class="co"># Interest is paid (although less than scheduled)</span></a>
<a class="sourceLine" id="cb10-68" href="#cb10-68" data-line-number="68">      schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb10-69" href="#cb10-69" data-line-number="69"><span class="st">        </span>totalInterestPaid <span class="op">-</span><span class="st"> </span>previousTotalI</a>
<a class="sourceLine" id="cb10-70" href="#cb10-70" data-line-number="70">      </a>
<a class="sourceLine" id="cb10-71" href="#cb10-71" data-line-number="71">      <span class="co"># As well as whatever principal is left as per the dataset</span></a>
<a class="sourceLine" id="cb10-72" href="#cb10-72" data-line-number="72">      schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb10-73" href="#cb10-73" data-line-number="73"><span class="st">        </span>schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] <span class="op">+</span><span class="st"> </span>totalPrincipalPaid <span class="op">-</span><span class="st"> </span>previousTotalP</a>
<a class="sourceLine" id="cb10-74" href="#cb10-74" data-line-number="74">      </a>
<a class="sourceLine" id="cb10-75" href="#cb10-75" data-line-number="75">      <span class="co"># Then 3-month after the last payment date, recoveries and and later fees are paid</span></a>
<a class="sourceLine" id="cb10-76" href="#cb10-76" data-line-number="76">      schedule[i <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb10-77" href="#cb10-77" data-line-number="77"><span class="st">        </span>schedule[i <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="st">&quot;monthlyPayment&quot;</span>] <span class="op">+</span><span class="st"> </span>recoveries <span class="op">+</span><span class="st"> </span>lateFees</a>
<a class="sourceLine" id="cb10-78" href="#cb10-78" data-line-number="78">      </a>
<a class="sourceLine" id="cb10-79" href="#cb10-79" data-line-number="79">      <span class="co"># Not really useful, but for completeness</span></a>
<a class="sourceLine" id="cb10-80" href="#cb10-80" data-line-number="80">      schedule[i, <span class="st">&quot;totalPandI&quot;</span>] &lt;-<span class="st"> </span>totalPaid</a>
<a class="sourceLine" id="cb10-81" href="#cb10-81" data-line-number="81">      schedule[i, <span class="st">&quot;totalI&quot;</span>]     &lt;-<span class="st"> </span>totalInterestPaid</a>
<a class="sourceLine" id="cb10-82" href="#cb10-82" data-line-number="82">      schedule[i, <span class="st">&quot;totalP&quot;</span>]     &lt;-<span class="st"> </span>totalPrincipalPaid</a>
<a class="sourceLine" id="cb10-83" href="#cb10-83" data-line-number="83">      </a>
<a class="sourceLine" id="cb10-84" href="#cb10-84" data-line-number="84">      <span class="co"># If total principal paid is less than borrower, then it is a default, and the monthDefault</span></a>
<a class="sourceLine" id="cb10-85" href="#cb10-85" data-line-number="85">      <span class="co"># is adjusted.</span></a>
<a class="sourceLine" id="cb10-86" href="#cb10-86" data-line-number="86">      <span class="cf">if</span> (totalPrincipalPaid <span class="op">&lt;</span><span class="st"> </span>loan) {</a>
<a class="sourceLine" id="cb10-87" href="#cb10-87" data-line-number="87">        monthDefault =<span class="st"> </span>i</a>
<a class="sourceLine" id="cb10-88" href="#cb10-88" data-line-number="88">      }</a>
<a class="sourceLine" id="cb10-89" href="#cb10-89" data-line-number="89">      </a>
<a class="sourceLine" id="cb10-90" href="#cb10-90" data-line-number="90">      <span class="co"># No more payments to add to the schedule</span></a>
<a class="sourceLine" id="cb10-91" href="#cb10-91" data-line-number="91">      <span class="cf">break</span>()</a>
<a class="sourceLine" id="cb10-92" href="#cb10-92" data-line-number="92">      </a>
<a class="sourceLine" id="cb10-93" href="#cb10-93" data-line-number="93">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb10-94" href="#cb10-94" data-line-number="94">      <span class="co"># Deal with normal schedule</span></a>
<a class="sourceLine" id="cb10-95" href="#cb10-95" data-line-number="95">      schedule[i, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-<span class="st"> </span>installment</a>
<a class="sourceLine" id="cb10-96" href="#cb10-96" data-line-number="96">      schedule[i, <span class="st">&quot;totalPandI&quot;</span>] &lt;-</a>
<a class="sourceLine" id="cb10-97" href="#cb10-97" data-line-number="97"><span class="st">        </span>schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalPandI&quot;</span>] <span class="op">+</span><span class="st"> </span>installment</a>
<a class="sourceLine" id="cb10-98" href="#cb10-98" data-line-number="98">      schedule[i, <span class="st">&quot;totalI&quot;</span>]     &lt;-</a>
<a class="sourceLine" id="cb10-99" href="#cb10-99" data-line-number="99"><span class="st">        </span>schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalI&quot;</span>]   <span class="op">+</span><span class="st"> </span>accruedInterest</a>
<a class="sourceLine" id="cb10-100" href="#cb10-100" data-line-number="100">      schedule[i, <span class="st">&quot;totalP&quot;</span>]     &lt;-</a>
<a class="sourceLine" id="cb10-101" href="#cb10-101" data-line-number="101"><span class="st">        </span>schedule[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;totalP&quot;</span>]   <span class="op">+</span><span class="st"> </span>installment <span class="op">-</span><span class="st"> </span>accruedInterest</a>
<a class="sourceLine" id="cb10-102" href="#cb10-102" data-line-number="102">    }</a>
<a class="sourceLine" id="cb10-103" href="#cb10-103" data-line-number="103">  }</a>
<a class="sourceLine" id="cb10-104" href="#cb10-104" data-line-number="104">  </a>
<a class="sourceLine" id="cb10-105" href="#cb10-105" data-line-number="105">  <span class="co"># At this point schedule[, &quot;monthlyPayment&quot;] contains the schedule of all payments, but needs to</span></a>
<a class="sourceLine" id="cb10-106" href="#cb10-106" data-line-number="106">  <span class="co"># include the initial loan.</span></a>
<a class="sourceLine" id="cb10-107" href="#cb10-107" data-line-number="107">  schedule[<span class="dv">1</span>, <span class="st">&quot;monthlyPayment&quot;</span>] &lt;-<span class="st"> </span><span class="op">-</span>loan</a>
<a class="sourceLine" id="cb10-108" href="#cb10-108" data-line-number="108">  </a>
<a class="sourceLine" id="cb10-109" href="#cb10-109" data-line-number="109">  <span class="cf">if</span> (showSchedule) {</a>
<a class="sourceLine" id="cb10-110" href="#cb10-110" data-line-number="110">    schedule <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">view</span>()</a>
<a class="sourceLine" id="cb10-111" href="#cb10-111" data-line-number="111">  }</a>
<a class="sourceLine" id="cb10-112" href="#cb10-112" data-line-number="112">  </a>
<a class="sourceLine" id="cb10-113" href="#cb10-113" data-line-number="113">  NPV &lt;-<span class="st"> </span><span class="cf">function</span>(interest, cashFlow) {</a>
<a class="sourceLine" id="cb10-114" href="#cb10-114" data-line-number="114">    t =<span class="st"> </span><span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(cashFlow) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-115" href="#cb10-115" data-line-number="115">    <span class="kw">sum</span>(cashFlow <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>interest) <span class="op">^</span><span class="st"> </span>t)</a>
<a class="sourceLine" id="cb10-116" href="#cb10-116" data-line-number="116">  }</a>
<a class="sourceLine" id="cb10-117" href="#cb10-117" data-line-number="117">  </a>
<a class="sourceLine" id="cb10-118" href="#cb10-118" data-line-number="118">  IRR &lt;-<span class="st"> </span><span class="cf">function</span>(CF) {</a>
<a class="sourceLine" id="cb10-119" href="#cb10-119" data-line-number="119">    res &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb10-120" href="#cb10-120" data-line-number="120">    <span class="kw">try</span>({</a>
<a class="sourceLine" id="cb10-121" href="#cb10-121" data-line-number="121">      res &lt;-<span class="st"> </span><span class="kw">uniroot</span>(NPV, <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.9</span>, <span class="dv">1</span>), <span class="dt">cashFlow =</span> CF)<span class="op">$</span>root</a>
<a class="sourceLine" id="cb10-122" href="#cb10-122" data-line-number="122">    },</a>
<a class="sourceLine" id="cb10-123" href="#cb10-123" data-line-number="123">    <span class="dt">silent =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-124" href="#cb10-124" data-line-number="124">    <span class="kw">return</span>(res)</a>
<a class="sourceLine" id="cb10-125" href="#cb10-125" data-line-number="125">  }</a>
<a class="sourceLine" id="cb10-126" href="#cb10-126" data-line-number="126">  </a>
<a class="sourceLine" id="cb10-127" href="#cb10-127" data-line-number="127">  <span class="kw">return</span>(<span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb10-128" href="#cb10-128" data-line-number="128">    <span class="dt">loanID =</span> loanNumber,</a>
<a class="sourceLine" id="cb10-129" href="#cb10-129" data-line-number="129">    <span class="dt">IRR =</span> <span class="kw">round</span>(<span class="kw">as.numeric</span>(<span class="kw">IRR</span>(</a>
<a class="sourceLine" id="cb10-130" href="#cb10-130" data-line-number="130">      schedule<span class="op">$</span>monthlyPayment</a>
<a class="sourceLine" id="cb10-131" href="#cb10-131" data-line-number="131">    ) <span class="op">*</span><span class="st"> </span><span class="dv">12</span>), <span class="dt">digits =</span> <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb10-132" href="#cb10-132" data-line-number="132">    <span class="dt">monthDefault =</span> monthDefault</a>
<a class="sourceLine" id="cb10-133" href="#cb10-133" data-line-number="133">  ))</a>
<a class="sourceLine" id="cb10-134" href="#cb10-134" data-line-number="134">}</a>
<a class="sourceLine" id="cb10-135" href="#cb10-135" data-line-number="135"></a>
<a class="sourceLine" id="cb10-136" href="#cb10-136" data-line-number="136">loanNumberIRR &lt;-<span class="st"> </span><span class="cf">function</span>(loanNumber) {</a>
<a class="sourceLine" id="cb10-137" href="#cb10-137" data-line-number="137">  <span class="kw">require</span>(tidyverse)</a>
<a class="sourceLine" id="cb10-138" href="#cb10-138" data-line-number="138">  </a>
<a class="sourceLine" id="cb10-139" href="#cb10-139" data-line-number="139">  l &lt;-<span class="st"> </span>loans <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(loanID <span class="op">==</span><span class="st"> </span>loanNumber)</a>
<a class="sourceLine" id="cb10-140" href="#cb10-140" data-line-number="140">  <span class="kw">calculateIRR</span>(</a>
<a class="sourceLine" id="cb10-141" href="#cb10-141" data-line-number="141">    <span class="dt">loanNumber =</span> l<span class="op">$</span>loanID,</a>
<a class="sourceLine" id="cb10-142" href="#cb10-142" data-line-number="142">    <span class="dt">loan =</span> l<span class="op">$</span>funded_amnt, <span class="dt">intRate =</span> l<span class="op">$</span>int_rate, <span class="dt">term =</span> l<span class="op">$</span>term, </a>
<a class="sourceLine" id="cb10-143" href="#cb10-143" data-line-number="143">    <span class="dt">totalPaid =</span> l<span class="op">$</span>total_pymnt, <span class="dt">totalPrincipalPaid =</span> l<span class="op">$</span>total_rec_prncp, <span class="dt">totalInterestPaid =</span> l<span class="op">$</span>total_rec_int, </a>
<a class="sourceLine" id="cb10-144" href="#cb10-144" data-line-number="144">    <span class="dt">recoveries =</span> l<span class="op">$</span>recoveries, <span class="dt">lateFees =</span> l<span class="op">$</span>total_rec_late_fee, </a>
<a class="sourceLine" id="cb10-145" href="#cb10-145" data-line-number="145">    <span class="dt">showSchedule =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb10-146" href="#cb10-146" data-line-number="146">  )</a>
<a class="sourceLine" id="cb10-147" href="#cb10-147" data-line-number="147">}</a></code></pre></div>
<p></p>
<p></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" href="#cb11-1" data-line-number="1"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-2" href="#cb11-2" data-line-number="2"><span class="co"># Calculate all the IRRs and month of default for all the loans. </span></a>
<a class="sourceLine" id="cb11-3" href="#cb11-3" data-line-number="3"><span class="co"># </span><span class="al">WARNING</span><span class="co">: This takes around a full day to run!!!!</span></a>
<a class="sourceLine" id="cb11-4" href="#cb11-4" data-line-number="4"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-5" href="#cb11-5" data-line-number="5"><span class="co"># The actual data was generated by the Julia version, with cross-checks.</span></a>
<a class="sourceLine" id="cb11-6" href="#cb11-6" data-line-number="6"><span class="co"># Julia version takes about 150 sec on the same unoptimised code.</span></a>
<a class="sourceLine" id="cb11-7" href="#cb11-7" data-line-number="7"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-8" href="#cb11-8" data-line-number="8"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb11-9" href="#cb11-9" data-line-number="9">  loansIRR &lt;-</a>
<a class="sourceLine" id="cb11-10" href="#cb11-10" data-line-number="10"><span class="st">    </span>loans <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-11" href="#cb11-11" data-line-number="11"><span class="st">    </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-12" href="#cb11-12" data-line-number="12"><span class="st">    </span><span class="kw">do</span>(<span class="kw">calculateIRR</span>(<span class="dt">loanNumber =</span> .<span class="op">$</span>loanID,</a>
<a class="sourceLine" id="cb11-13" href="#cb11-13" data-line-number="13">                    <span class="dt">loan =</span> .<span class="op">$</span>funded_amnt, <span class="dt">intRate =</span> .<span class="op">$</span>int_rate, <span class="dt">term =</span> .<span class="op">$</span>term,</a>
<a class="sourceLine" id="cb11-14" href="#cb11-14" data-line-number="14">                    <span class="dt">totalPaid =</span> .<span class="op">$</span>total_pymnt, <span class="dt">totalPrincipalPaid =</span> .<span class="op">$</span>total_rec_prncp,</a>
<a class="sourceLine" id="cb11-15" href="#cb11-15" data-line-number="15">                    <span class="dt">totalInterestPaid =</span> .<span class="op">$</span>total_rec_int,</a>
<a class="sourceLine" id="cb11-16" href="#cb11-16" data-line-number="16">                    <span class="dt">recoveries =</span> .<span class="op">$</span>recoveries, <span class="dt">lateFees =</span> .<span class="op">$</span>total_rec_late_fee))</a>
<a class="sourceLine" id="cb11-17" href="#cb11-17" data-line-number="17"></a>
<a class="sourceLine" id="cb11-18" href="#cb11-18" data-line-number="18">  <span class="kw">saveRDS</span>(loansIRR, <span class="st">&quot;datasets/lending_club_IRRs.rds&quot;</span>)</a>
<a class="sourceLine" id="cb11-19" href="#cb11-19" data-line-number="19">  </a>
<a class="sourceLine" id="cb11-20" href="#cb11-20" data-line-number="20">  })</a></code></pre></div>
<p></p>
</div>
<div id="julia-code" class="section level3">
<h3><span class="header-section-number">5.4.2</span> Julia code</h3>
<div id="internal-rate-of-return-1" class="section level4">
<h4><span class="header-section-number">5.4.2.1</span> Internal Rate of Return</h4>
<p></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource julia numberLines lineAnchors"><code class="sourceCode julia"><a class="sourceLine" id="cb12-1" href="#cb12-1" data-line-number="1"><span class="co">####################################################################################################</span></a>
<a class="sourceLine" id="cb12-2" href="#cb12-2" data-line-number="2"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-3" href="#cb12-3" data-line-number="3"><span class="co">## Prepare datasets</span></a>
<a class="sourceLine" id="cb12-4" href="#cb12-4" data-line-number="4"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-5" href="#cb12-5" data-line-number="5"></a>
<a class="sourceLine" id="cb12-6" href="#cb12-6" data-line-number="6"><span class="co">## Previously saved from R with:</span></a>
<a class="sourceLine" id="cb12-7" href="#cb12-7" data-line-number="7"><span class="co">##     lending_club &lt;- readRDS(&quot;lending_club.rds&quot;); write.csv(lending_club, &quot;lending_club.rds&quot;)</span></a>
<a class="sourceLine" id="cb12-8" href="#cb12-8" data-line-number="8"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-9" href="#cb12-9" data-line-number="9"><span class="co">## WARNING: 1.7GB on disk</span></a>
<a class="sourceLine" id="cb12-10" href="#cb12-10" data-line-number="10"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-11" href="#cb12-11" data-line-number="11">using CSV</a>
<a class="sourceLine" id="cb12-12" href="#cb12-12" data-line-number="12">lendingClub = CSV.read(<span class="st">&quot;datasets/lending_club.csv&quot;</span>; delim = <span class="st">&quot;,&quot;</span>)</a>
<a class="sourceLine" id="cb12-13" href="#cb12-13" data-line-number="13"></a>
<a class="sourceLine" id="cb12-14" href="#cb12-14" data-line-number="14"></a>
<a class="sourceLine" id="cb12-15" href="#cb12-15" data-line-number="15"></a>
<a class="sourceLine" id="cb12-16" href="#cb12-16" data-line-number="16"><span class="co">####################################################################################################</span></a>
<a class="sourceLine" id="cb12-17" href="#cb12-17" data-line-number="17"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-18" href="#cb12-18" data-line-number="18"><span class="co">## IRR calculations</span></a>
<a class="sourceLine" id="cb12-19" href="#cb12-19" data-line-number="19"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-20" href="#cb12-20" data-line-number="20"><span class="co">## Given some numerical parameters describing a loan in the dataset, returns its Internal Rate</span></a>
<a class="sourceLine" id="cb12-21" href="#cb12-21" data-line-number="21"><span class="co">## of Return.</span></a>
<a class="sourceLine" id="cb12-22" href="#cb12-22" data-line-number="22"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-23" href="#cb12-23" data-line-number="23"><span class="co">## In the first instance, the function creates a schedule of payments.</span></a>
<a class="sourceLine" id="cb12-24" href="#cb12-24" data-line-number="24"><span class="co">## In many cases, the schedule will be extremely simple: a series of 36 or 60 equal instalements.</span></a>
<a class="sourceLine" id="cb12-25" href="#cb12-25" data-line-number="25"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-26" href="#cb12-26" data-line-number="26"><span class="co">## But in some cases, a loan repayment are accelerated. Therefore the total amount of interest will</span></a>
<a class="sourceLine" id="cb12-27" href="#cb12-27" data-line-number="27"><span class="co">## be lower than expected (but this is good for the investor because highe interest rate over</span></a>
<a class="sourceLine" id="cb12-28" href="#cb12-28" data-line-number="28"><span class="co">## shorter tenor.).</span></a>
<a class="sourceLine" id="cb12-29" href="#cb12-29" data-line-number="29"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-30" href="#cb12-30" data-line-number="30"><span class="co">## In other cases, the borrower defaults. Overall payments are less than expected.</span></a>
<a class="sourceLine" id="cb12-31" href="#cb12-31" data-line-number="31"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-32" href="#cb12-32" data-line-number="32"><span class="co">## Based on the limited information of the dataset, the function makes educated guesses on the exact</span></a>
<a class="sourceLine" id="cb12-33" href="#cb12-33" data-line-number="33"><span class="co">## schedule.</span></a>
<a class="sourceLine" id="cb12-34" href="#cb12-34" data-line-number="34"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-35" href="#cb12-35" data-line-number="35">using DataFrames, Roots</a>
<a class="sourceLine" id="cb12-36" href="#cb12-36" data-line-number="36"></a>
<a class="sourceLine" id="cb12-37" href="#cb12-37" data-line-number="37"><span class="kw">function</span> calculateIRR(; loanNumber = <span class="fl">1</span>, loan = <span class="fl">0.0</span>, intRate = <span class="fl">0.0</span>, term = <span class="fl">36</span>,</a>
<a class="sourceLine" id="cb12-38" href="#cb12-38" data-line-number="38">  totalPaid = <span class="fl">0.0</span>, totalPrincipalPaid = <span class="fl">0.0</span>, totalInterestPaid = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb12-39" href="#cb12-39" data-line-number="39">  recoveries = <span class="fl">0.0</span>, lateFees = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb12-40" href="#cb12-40" data-line-number="40">  showSchedule = false)</a>
<a class="sourceLine" id="cb12-41" href="#cb12-41" data-line-number="41"></a>
<a class="sourceLine" id="cb12-42" href="#cb12-42" data-line-number="42">  <span class="co"># number of monthly payments.</span></a>
<a class="sourceLine" id="cb12-43" href="#cb12-43" data-line-number="43">  <span class="co"># It exceeds 60 months in case recoveries on a 60-month loan takes the schedule after 60 months.</span></a>
<a class="sourceLine" id="cb12-44" href="#cb12-44" data-line-number="44">  nMonths = <span class="fl">90</span></a>
<a class="sourceLine" id="cb12-45" href="#cb12-45" data-line-number="45"></a>
<a class="sourceLine" id="cb12-46" href="#cb12-46" data-line-number="46">  <span class="co"># Months after which a loan defaults (normal tenor if no default or early prepayment)</span></a>
<a class="sourceLine" id="cb12-47" href="#cb12-47" data-line-number="47">  monthDefault = term</a>
<a class="sourceLine" id="cb12-48" href="#cb12-48" data-line-number="48"></a>
<a class="sourceLine" id="cb12-49" href="#cb12-49" data-line-number="49">  <span class="co"># Note: *100 /100 to calculate in cent because ceiling cannot specify significant digits.</span></a>
<a class="sourceLine" id="cb12-50" href="#cb12-50" data-line-number="50">  installment = ceil(loan * intRate / <span class="fl">12</span> / (<span class="fl">1</span> - <span class="fl">1</span> / (<span class="fl">1</span> + intRate / <span class="fl">12</span>) ^ term), digits = <span class="fl">2</span>)</a>
<a class="sourceLine" id="cb12-51" href="#cb12-51" data-line-number="51"></a>
<a class="sourceLine" id="cb12-52" href="#cb12-52" data-line-number="52">  <span class="co"># We create a schedule</span></a>
<a class="sourceLine" id="cb12-53" href="#cb12-53" data-line-number="53">  schedule = DataFrame(month = <span class="fl">0</span>:nMonths, monthlyPayment = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb12-54" href="#cb12-54" data-line-number="54">                       totalPandI = <span class="fl">0.0</span>, totalI = <span class="fl">0.0</span>, totalP = <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb12-55" href="#cb12-55" data-line-number="55"></a>
<a class="sourceLine" id="cb12-56" href="#cb12-56" data-line-number="56">  <span class="kw">for</span> i <span class="kw">in</span> <span class="fl">2</span>:(nMonths + <span class="fl">1</span>)</a>
<a class="sourceLine" id="cb12-57" href="#cb12-57" data-line-number="57">    <span class="co"># Get situation at the end of previous month</span></a>
<a class="sourceLine" id="cb12-58" href="#cb12-58" data-line-number="58">    previousTotalPandI = schedule[i - <span class="fl">1</span>, :totalPandI]</a>
<a class="sourceLine" id="cb12-59" href="#cb12-59" data-line-number="59">    previousTotalP     = schedule[i - <span class="fl">1</span>, :totalP]</a>
<a class="sourceLine" id="cb12-60" href="#cb12-60" data-line-number="60">    previousTotalI     = schedule[i - <span class="fl">1</span>, :totalI]</a>
<a class="sourceLine" id="cb12-61" href="#cb12-61" data-line-number="61"></a>
<a class="sourceLine" id="cb12-62" href="#cb12-62" data-line-number="62">    <span class="co"># This is the beginning of a new month. First and foremost, the borrower is expected to pay the</span></a>
<a class="sourceLine" id="cb12-63" href="#cb12-63" data-line-number="63">    <span class="co"># accrued interest on amount of principal outstanding.</span></a>
<a class="sourceLine" id="cb12-64" href="#cb12-64" data-line-number="64">    <span class="co"># The installment is expected to cover that amount of interest and the rest goes to</span></a>
<a class="sourceLine" id="cb12-65" href="#cb12-65" data-line-number="65">    <span class="co"># reducing the principal due outstanding.</span></a>
<a class="sourceLine" id="cb12-66" href="#cb12-66" data-line-number="66">    accruedInterest = ceil((loan - previousTotalP) * intRate / <span class="fl">12</span>; digits = <span class="fl">2</span>)</a>
<a class="sourceLine" id="cb12-67" href="#cb12-67" data-line-number="67">    decreasePrincipal = installment - accruedInterest</a>
<a class="sourceLine" id="cb12-68" href="#cb12-68" data-line-number="68"></a>
<a class="sourceLine" id="cb12-69" href="#cb12-69" data-line-number="69">    <span class="co"># If that amount takes the schedule above the total amount of interest shown in the data set,</span></a>
<a class="sourceLine" id="cb12-70" href="#cb12-70" data-line-number="70">    <span class="co"># we should stop the schedule at this point</span></a>
<a class="sourceLine" id="cb12-71" href="#cb12-71" data-line-number="71">    <span class="co"># This is a shortcut since we could have a payment higher than the interest due, but not enough</span></a>
<a class="sourceLine" id="cb12-72" href="#cb12-72" data-line-number="72">    <span class="co"># to cover the expected principal repayment. However, it works well in practice.</span></a>
<a class="sourceLine" id="cb12-73" href="#cb12-73" data-line-number="73">    <span class="kw">if</span> previousTotalI + accruedInterest &gt; totalInterestPaid</a>
<a class="sourceLine" id="cb12-74" href="#cb12-74" data-line-number="74"></a>
<a class="sourceLine" id="cb12-75" href="#cb12-75" data-line-number="75">      <span class="co"># We stop the normal schedule at this date.</span></a>
<a class="sourceLine" id="cb12-76" href="#cb12-76" data-line-number="76">      <span class="co"># Interest is paid (although less than scheduled)</span></a>
<a class="sourceLine" id="cb12-77" href="#cb12-77" data-line-number="77">      schedule[i, :monthlyPayment] = totalInterestPaid - previousTotalI</a>
<a class="sourceLine" id="cb12-78" href="#cb12-78" data-line-number="78"></a>
<a class="sourceLine" id="cb12-79" href="#cb12-79" data-line-number="79">      <span class="co"># As well as whatever principal is left as per the dataset</span></a>
<a class="sourceLine" id="cb12-80" href="#cb12-80" data-line-number="80">      schedule[i, :monthlyPayment] = schedule[i, :monthlyPayment] + totalPrincipalPaid - previousTotalP</a>
<a class="sourceLine" id="cb12-81" href="#cb12-81" data-line-number="81"></a>
<a class="sourceLine" id="cb12-82" href="#cb12-82" data-line-number="82">      <span class="co"># Then 3-month after the last payment date, recoveries and and later fees are paid</span></a>
<a class="sourceLine" id="cb12-83" href="#cb12-83" data-line-number="83">      schedule[i + <span class="fl">3</span>, :monthlyPayment] = schedule[i + <span class="fl">3</span>, :monthlyPayment] + recoveries + lateFees</a>
<a class="sourceLine" id="cb12-84" href="#cb12-84" data-line-number="84"></a>
<a class="sourceLine" id="cb12-85" href="#cb12-85" data-line-number="85">      <span class="co"># Not really useful, but for completeness</span></a>
<a class="sourceLine" id="cb12-86" href="#cb12-86" data-line-number="86">      schedule[i, :totalPandI] = totalPaid</a>
<a class="sourceLine" id="cb12-87" href="#cb12-87" data-line-number="87">      schedule[i, :totalI]     = totalInterestPaid</a>
<a class="sourceLine" id="cb12-88" href="#cb12-88" data-line-number="88">      schedule[i, :totalP]     = totalPrincipalPaid</a>
<a class="sourceLine" id="cb12-89" href="#cb12-89" data-line-number="89"></a>
<a class="sourceLine" id="cb12-90" href="#cb12-90" data-line-number="90">      <span class="co"># If total principal paid is less than borrower, then it is a default, and the monthDefault</span></a>
<a class="sourceLine" id="cb12-91" href="#cb12-91" data-line-number="91">      <span class="co"># is adjusted.</span></a>
<a class="sourceLine" id="cb12-92" href="#cb12-92" data-line-number="92">      <span class="kw">if</span> (totalPrincipalPaid &lt; loan)</a>
<a class="sourceLine" id="cb12-93" href="#cb12-93" data-line-number="93">        monthDefault = i</a>
<a class="sourceLine" id="cb12-94" href="#cb12-94" data-line-number="94">      <span class="kw">end</span></a>
<a class="sourceLine" id="cb12-95" href="#cb12-95" data-line-number="95"></a>
<a class="sourceLine" id="cb12-96" href="#cb12-96" data-line-number="96">      <span class="co"># No more payments to add to the schedule</span></a>
<a class="sourceLine" id="cb12-97" href="#cb12-97" data-line-number="97">      <span class="kw">break</span></a>
<a class="sourceLine" id="cb12-98" href="#cb12-98" data-line-number="98"></a>
<a class="sourceLine" id="cb12-99" href="#cb12-99" data-line-number="99">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb12-100" href="#cb12-100" data-line-number="100">      <span class="co"># Deal with normal schedule</span></a>
<a class="sourceLine" id="cb12-101" href="#cb12-101" data-line-number="101">      schedule[i, :monthlyPayment] = installment</a>
<a class="sourceLine" id="cb12-102" href="#cb12-102" data-line-number="102">      schedule[i, :totalPandI]     = schedule[i - <span class="fl">1</span>, :totalPandI] + installment</a>
<a class="sourceLine" id="cb12-103" href="#cb12-103" data-line-number="103">      schedule[i, :totalI]         = schedule[i - <span class="fl">1</span>, :totalI]     + accruedInterest</a>
<a class="sourceLine" id="cb12-104" href="#cb12-104" data-line-number="104">      schedule[i, :totalP]         = schedule[i - <span class="fl">1</span>, :totalP]     + installment - accruedInterest</a>
<a class="sourceLine" id="cb12-105" href="#cb12-105" data-line-number="105">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb12-106" href="#cb12-106" data-line-number="106">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb12-107" href="#cb12-107" data-line-number="107"></a>
<a class="sourceLine" id="cb12-108" href="#cb12-108" data-line-number="108">  <span class="co"># At this point schedule[, :monthlyPayment] contains the schedule of all payments, but needs to</span></a>
<a class="sourceLine" id="cb12-109" href="#cb12-109" data-line-number="109">  <span class="co"># include the initial loan.</span></a>
<a class="sourceLine" id="cb12-110" href="#cb12-110" data-line-number="110">  schedule[<span class="fl">1</span>, :monthlyPayment] = -loan</a>
<a class="sourceLine" id="cb12-111" href="#cb12-111" data-line-number="111"></a>
<a class="sourceLine" id="cb12-112" href="#cb12-112" data-line-number="112">  <span class="kw">if</span> (showSchedule)</a>
<a class="sourceLine" id="cb12-113" href="#cb12-113" data-line-number="113">    print(schedule)</a>
<a class="sourceLine" id="cb12-114" href="#cb12-114" data-line-number="114">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb12-115" href="#cb12-115" data-line-number="115"></a>
<a class="sourceLine" id="cb12-116" href="#cb12-116" data-line-number="116">  cashFlow = schedule[:,:monthlyPayment]</a>
<a class="sourceLine" id="cb12-117" href="#cb12-117" data-line-number="117"></a>
<a class="sourceLine" id="cb12-118" href="#cb12-118" data-line-number="118">  <span class="co">##</span></a>
<a class="sourceLine" id="cb12-119" href="#cb12-119" data-line-number="119">  <span class="co">## Finding the IRR is equivalent to finding the root such that the NPV of the cash flow is zero.</span></a>
<a class="sourceLine" id="cb12-120" href="#cb12-120" data-line-number="120">  <span class="co">## Julia has a function (see below) called `find_zero` to do that which requires a function to</span></a>
<a class="sourceLine" id="cb12-121" href="#cb12-121" data-line-number="121">  <span class="co">## be zeroed. This helper function is defined as NPV.</span></a>
<a class="sourceLine" id="cb12-122" href="#cb12-122" data-line-number="122">  <span class="co">##</span></a>
<a class="sourceLine" id="cb12-123" href="#cb12-123" data-line-number="123">  <span class="kw">function</span> NPV(interest)</a>
<a class="sourceLine" id="cb12-124" href="#cb12-124" data-line-number="124">    t = <span class="fl">0</span>:(length(cashFlow) - <span class="fl">1</span>)</a>
<a class="sourceLine" id="cb12-125" href="#cb12-125" data-line-number="125"></a>
<a class="sourceLine" id="cb12-126" href="#cb12-126" data-line-number="126">    <span class="co">## If you are new to Julia, note the dot before the operation. This indicates that the </span></a>
<a class="sourceLine" id="cb12-127" href="#cb12-127" data-line-number="127">    <span class="co">## operation has to be done element-wise (called `broadcasting` in Julia-ese). </span></a>
<a class="sourceLine" id="cb12-128" href="#cb12-128" data-line-number="128">    <span class="co">## Otherwise, Julia would try to divide one vector by another vector, which makes no sense. </span></a>
<a class="sourceLine" id="cb12-129" href="#cb12-129" data-line-number="129">    <span class="co">## This is also exactly the approach taken in Matlab/Octave.</span></a>
<a class="sourceLine" id="cb12-130" href="#cb12-130" data-line-number="130">    <span class="kw">return</span> sum(cashFlow ./ (<span class="fl">1</span> + interest) .^ t)</a>
<a class="sourceLine" id="cb12-131" href="#cb12-131" data-line-number="131">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb12-132" href="#cb12-132" data-line-number="132"></a>
<a class="sourceLine" id="cb12-133" href="#cb12-133" data-line-number="133">  <span class="co">## Finds the root, catching any problems which would instead return the R equivalent of NA</span></a>
<a class="sourceLine" id="cb12-134" href="#cb12-134" data-line-number="134">  rootInterest = <span class="kw">try</span></a>
<a class="sourceLine" id="cb12-135" href="#cb12-135" data-line-number="135">                  round(<span class="fl">12</span> * find_zero(NPV, (-<span class="fl">0.9</span>, <span class="fl">1.0</span>), Bisection(); xatol = <span class="fl">0.000001</span>); digits = <span class="fl">4</span>)</a>
<a class="sourceLine" id="cb12-136" href="#cb12-136" data-line-number="136">                <span class="kw">catch</span> e</a>
<a class="sourceLine" id="cb12-137" href="#cb12-137" data-line-number="137">                  NaN</a>
<a class="sourceLine" id="cb12-138" href="#cb12-138" data-line-number="138">                <span class="kw">end</span></a>
<a class="sourceLine" id="cb12-139" href="#cb12-139" data-line-number="139"></a>
<a class="sourceLine" id="cb12-140" href="#cb12-140" data-line-number="140">  <span class="kw">return</span>((</a>
<a class="sourceLine" id="cb12-141" href="#cb12-141" data-line-number="141">    loanID = loanNumber,</a>
<a class="sourceLine" id="cb12-142" href="#cb12-142" data-line-number="142">    IRR = rootInterest,</a>
<a class="sourceLine" id="cb12-143" href="#cb12-143" data-line-number="143">    monthDefault = monthDefault</a>
<a class="sourceLine" id="cb12-144" href="#cb12-144" data-line-number="144">  ))</a>
<a class="sourceLine" id="cb12-145" href="#cb12-145" data-line-number="145"><span class="kw">end</span></a>
<a class="sourceLine" id="cb12-146" href="#cb12-146" data-line-number="146"></a>
<a class="sourceLine" id="cb12-147" href="#cb12-147" data-line-number="147"></a>
<a class="sourceLine" id="cb12-148" href="#cb12-148" data-line-number="148"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-149" href="#cb12-149" data-line-number="149"><span class="co">## Calculate the IRR and repayment schedule of a particular loan identified by its loanID</span></a>
<a class="sourceLine" id="cb12-150" href="#cb12-150" data-line-number="150"><span class="kw">function</span> loanNumberIRR(loanNumber)</a>
<a class="sourceLine" id="cb12-151" href="#cb12-151" data-line-number="151">  l = lc[ lc[:, :Column1] .== loanNumber, :]</a>
<a class="sourceLine" id="cb12-152" href="#cb12-152" data-line-number="152">  <span class="kw">global</span> lc</a>
<a class="sourceLine" id="cb12-153" href="#cb12-153" data-line-number="153">  calculateIRR(loanNumber = l[<span class="fl">1</span>, :Column1],</a>
<a class="sourceLine" id="cb12-154" href="#cb12-154" data-line-number="154">               loan = l[<span class="fl">1</span>, :funded_amnt], intRate = l[<span class="fl">1</span>, :int_rate], term =l[<span class="fl">1</span>, :tenor],</a>
<a class="sourceLine" id="cb12-155" href="#cb12-155" data-line-number="155">               totalPaid = l[<span class="fl">1</span>, :total_pymnt], totalPrincipalPaid = l[<span class="fl">1</span>, :total_rec_prncp],</a>
<a class="sourceLine" id="cb12-156" href="#cb12-156" data-line-number="156">               totalInterestPaid = l[<span class="fl">1</span>, :total_rec_int],</a>
<a class="sourceLine" id="cb12-157" href="#cb12-157" data-line-number="157">               recoveries = l[<span class="fl">1</span>, :recoveries], lateFees = l[<span class="fl">1</span>, :total_rec_late_fee],</a>
<a class="sourceLine" id="cb12-158" href="#cb12-158" data-line-number="158">               showSchedule = true)</a>
<a class="sourceLine" id="cb12-159" href="#cb12-159" data-line-number="159"><span class="kw">end</span></a>
<a class="sourceLine" id="cb12-160" href="#cb12-160" data-line-number="160"></a>
<a class="sourceLine" id="cb12-161" href="#cb12-161" data-line-number="161"></a>
<a class="sourceLine" id="cb12-162" href="#cb12-162" data-line-number="162"><span class="co">####################################################################################################</span></a>
<a class="sourceLine" id="cb12-163" href="#cb12-163" data-line-number="163"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-164" href="#cb12-164" data-line-number="164"><span class="co">## Quick check</span></a>
<a class="sourceLine" id="cb12-165" href="#cb12-165" data-line-number="165"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-166" href="#cb12-166" data-line-number="166">calculateIRR(loanNumber = <span class="fl">1</span>, loan = <span class="fl">5600</span>, intRate = <span class="fl">0.1299</span>, term = <span class="fl">36</span>,</a>
<a class="sourceLine" id="cb12-167" href="#cb12-167" data-line-number="167">             totalPaid = <span class="fl">6791.72</span>, totalPrincipalPaid = <span class="fl">5600</span>, totalInterestPaid = <span class="fl">1191.72</span>,</a>
<a class="sourceLine" id="cb12-168" href="#cb12-168" data-line-number="168">             recoveries = <span class="fl">0</span>, lateFees = <span class="fl">0</span>,</a>
<a class="sourceLine" id="cb12-169" href="#cb12-169" data-line-number="169">             showSchedule = true)</a>
<a class="sourceLine" id="cb12-170" href="#cb12-170" data-line-number="170"></a>
<a class="sourceLine" id="cb12-171" href="#cb12-171" data-line-number="171">calculateIRR(loanNumber = <span class="fl">1</span>, loan = <span class="fl">35000</span>, intRate = <span class="fl">0.1820</span>, term = <span class="fl">60</span>,</a>
<a class="sourceLine" id="cb12-172" href="#cb12-172" data-line-number="172">             totalPaid = <span class="fl">26600.1</span>, totalPrincipalPaid = <span class="fl">3874.72</span>, totalInterestPaid = <span class="fl">5225.38</span>,</a>
<a class="sourceLine" id="cb12-173" href="#cb12-173" data-line-number="173">             recoveries = <span class="fl">17500</span>, lateFees = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb12-174" href="#cb12-174" data-line-number="174">             showSchedule = false)</a>
<a class="sourceLine" id="cb12-175" href="#cb12-175" data-line-number="175"></a>
<a class="sourceLine" id="cb12-176" href="#cb12-176" data-line-number="176">calculateIRR(loanNumber = <span class="fl">1734666</span>, loan = <span class="fl">35000</span>, intRate = <span class="fl">0.0797</span>, term = <span class="fl">36</span>,</a>
<a class="sourceLine" id="cb12-177" href="#cb12-177" data-line-number="177">             totalPaid = <span class="fl">1057.04</span>, totalPrincipalPaid = <span class="fl">863.83</span>, totalInterestPaid = <span class="fl">193.72</span>,</a>
<a class="sourceLine" id="cb12-178" href="#cb12-178" data-line-number="178">             recoveries = <span class="fl">0</span>, lateFees = <span class="fl">0</span>,</a>
<a class="sourceLine" id="cb12-179" href="#cb12-179" data-line-number="179">             showSchedule = false)</a>
<a class="sourceLine" id="cb12-180" href="#cb12-180" data-line-number="180"></a>
<a class="sourceLine" id="cb12-181" href="#cb12-181" data-line-number="181"></a>
<a class="sourceLine" id="cb12-182" href="#cb12-182" data-line-number="182"></a>
<a class="sourceLine" id="cb12-183" href="#cb12-183" data-line-number="183"></a>
<a class="sourceLine" id="cb12-184" href="#cb12-184" data-line-number="184"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-185" href="#cb12-185" data-line-number="185"><span class="co">## Look for the loans which have gone to their end</span></a>
<a class="sourceLine" id="cb12-186" href="#cb12-186" data-line-number="186"><span class="co">##</span></a>
<a class="sourceLine" id="cb12-187" href="#cb12-187" data-line-number="187">indextmp = (lendingClub.loan_status .== <span class="st">&quot;Fully Paid&quot;</span>) .|</a>
<a class="sourceLine" id="cb12-188" href="#cb12-188" data-line-number="188">           (lendingClub.loan_status .== <span class="st">&quot;Charged Off&quot;</span>) .|</a>
<a class="sourceLine" id="cb12-189" href="#cb12-189" data-line-number="189">           (lendingClub.loan_status .== <span class="st">&quot;Does not meet the credit policy. Status:Charged Off&quot;</span>) .|</a>
<a class="sourceLine" id="cb12-190" href="#cb12-190" data-line-number="190">           (lendingClub.loan_status .== <span class="st">&quot;Does not meet the credit policy. Status:Fully Paid&quot;</span>)</a>
<a class="sourceLine" id="cb12-191" href="#cb12-191" data-line-number="191"></a>
<a class="sourceLine" id="cb12-192" href="#cb12-192" data-line-number="192"><span class="co">## Create the dataset we will use - Should be the same as lending_club_reformatted_paid.rds</span></a>
<a class="sourceLine" id="cb12-193" href="#cb12-193" data-line-number="193">lc = lendingClub[indextmp, :]</a>
<a class="sourceLine" id="cb12-194" href="#cb12-194" data-line-number="194"></a>
<a class="sourceLine" id="cb12-195" href="#cb12-195" data-line-number="195"><span class="co">## Select relevant variables to calculate profitability</span></a>
<a class="sourceLine" id="cb12-196" href="#cb12-196" data-line-number="196"><span class="co">## Column1 contains the loanID&#39;s</span></a>
<a class="sourceLine" id="cb12-197" href="#cb12-197" data-line-number="197">cols = [:Column1, :funded_amnt, :int_rate, :term,</a>
<a class="sourceLine" id="cb12-198" href="#cb12-198" data-line-number="198">        :total_pymnt, :total_rec_prncp, :total_rec_int,</a>
<a class="sourceLine" id="cb12-199" href="#cb12-199" data-line-number="199">        :recoveries, :total_rec_late_fee]</a>
<a class="sourceLine" id="cb12-200" href="#cb12-200" data-line-number="200"></a>
<a class="sourceLine" id="cb12-201" href="#cb12-201" data-line-number="201">lc = select(lc, cols)</a>
<a class="sourceLine" id="cb12-202" href="#cb12-202" data-line-number="202"></a>
<a class="sourceLine" id="cb12-203" href="#cb12-203" data-line-number="203"><span class="co">## Interest rates as percentage</span></a>
<a class="sourceLine" id="cb12-204" href="#cb12-204" data-line-number="204">lc[:, :int_rate] = lc[:, :int_rate] ./ <span class="fl">100</span></a>
<a class="sourceLine" id="cb12-205" href="#cb12-205" data-line-number="205"></a>
<a class="sourceLine" id="cb12-206" href="#cb12-206" data-line-number="206"><span class="co">## Create a new column</span></a>
<a class="sourceLine" id="cb12-207" href="#cb12-207" data-line-number="207">lc[:tenor] = <span class="fl">0</span></a>
<a class="sourceLine" id="cb12-208" href="#cb12-208" data-line-number="208"></a>
<a class="sourceLine" id="cb12-209" href="#cb12-209" data-line-number="209"><span class="co">## that will record the official loan tenor as a number (instead of string)</span></a>
<a class="sourceLine" id="cb12-210" href="#cb12-210" data-line-number="210">lc[startswith.( lc[:, :term], <span class="st">&quot; 36&quot;</span>), :tenor] .= <span class="fl">36</span></a>
<a class="sourceLine" id="cb12-211" href="#cb12-211" data-line-number="211">lc[startswith.( lc[:, :term], <span class="st">&quot; 60&quot;</span>), :tenor] .= <span class="fl">60</span></a>
<a class="sourceLine" id="cb12-212" href="#cb12-212" data-line-number="212"></a>
<a class="sourceLine" id="cb12-213" href="#cb12-213" data-line-number="213"><span class="co">## New data frame to store the results</span></a>
<a class="sourceLine" id="cb12-214" href="#cb12-214" data-line-number="214">IRR_Result = DataFrame(loanID = zeros(<span class="dt">Int64</span>, nrow(lc)),</a>
<a class="sourceLine" id="cb12-215" href="#cb12-215" data-line-number="215">                       IRR = zeros(<span class="dt">Float64</span>, nrow(lc)),</a>
<a class="sourceLine" id="cb12-216" href="#cb12-216" data-line-number="216">                       monthDefault = zeros(<span class="dt">Int64</span>, nrow(lc)))</a>
<a class="sourceLine" id="cb12-217" href="#cb12-217" data-line-number="217"></a>
<a class="sourceLine" id="cb12-218" href="#cb12-218" data-line-number="218"></a>
<a class="sourceLine" id="cb12-219" href="#cb12-219" data-line-number="219"><span class="co"># ~150 sec. to do the whole dataset</span></a>
<a class="sourceLine" id="cb12-220" href="#cb12-220" data-line-number="220">@time <span class="kw">for</span> i <span class="kw">in</span> <span class="fl">1</span>:nrow(lc)</a>
<a class="sourceLine" id="cb12-221" href="#cb12-221" data-line-number="221">  <span class="kw">global</span> IRR_Result</a>
<a class="sourceLine" id="cb12-222" href="#cb12-222" data-line-number="222"></a>
<a class="sourceLine" id="cb12-223" href="#cb12-223" data-line-number="223">  <span class="co"># Use multiple-return-value</span></a>
<a class="sourceLine" id="cb12-224" href="#cb12-224" data-line-number="224">  (IRR_Result[i, :loanID], IRR_Result[i, :IRR], IRR_Result[i, :monthDefault]) =</a>
<a class="sourceLine" id="cb12-225" href="#cb12-225" data-line-number="225">      calculateIRR(</a>
<a class="sourceLine" id="cb12-226" href="#cb12-226" data-line-number="226">          loanNumber = lc[i, :Column1],</a>
<a class="sourceLine" id="cb12-227" href="#cb12-227" data-line-number="227">          loan = lc[i, :funded_amnt], intRate = lc[i, :int_rate], term =lc[i, :tenor],</a>
<a class="sourceLine" id="cb12-228" href="#cb12-228" data-line-number="228">          totalPaid = lc[i, :total_pymnt], totalPrincipalPaid = lc[i, :total_rec_prncp],</a>
<a class="sourceLine" id="cb12-229" href="#cb12-229" data-line-number="229">          totalInterestPaid = lc[i, :total_rec_int],</a>
<a class="sourceLine" id="cb12-230" href="#cb12-230" data-line-number="230">          recoveries = lc[i, :recoveries], lateFees = lc[i, :total_rec_late_fee],</a>
<a class="sourceLine" id="cb12-231" href="#cb12-231" data-line-number="231">          showSchedule = false)</a>
<a class="sourceLine" id="cb12-232" href="#cb12-232" data-line-number="232"><span class="kw">end</span></a>
<a class="sourceLine" id="cb12-233" href="#cb12-233" data-line-number="233"></a>
<a class="sourceLine" id="cb12-234" href="#cb12-234" data-line-number="234"></a>
<a class="sourceLine" id="cb12-235" href="#cb12-235" data-line-number="235">IRR_Result[<span class="fl">1</span>:<span class="fl">10</span>,:]</a>
<a class="sourceLine" id="cb12-236" href="#cb12-236" data-line-number="236"><span class="co"># Check</span></a>
<a class="sourceLine" id="cb12-237" href="#cb12-237" data-line-number="237">loanNumberIRR(<span class="fl">171</span>)</a>
<a class="sourceLine" id="cb12-238" href="#cb12-238" data-line-number="238"></a>
<a class="sourceLine" id="cb12-239" href="#cb12-239" data-line-number="239">CSV.write(<span class="st">&quot;datasets/loanIRR.csv&quot;</span>, IRR_Result)</a></code></pre></div>
<p></p>
</div>
<div id="credit-margins-1" class="section level4">
<h4><span class="header-section-number">5.4.2.2</span> Credit margins</h4>
<p></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource julia numberLines lineAnchors"><code class="sourceCode julia"><a class="sourceLine" id="cb13-1" href="#cb13-1" data-line-number="1"><span class="co">####################################################################################################</span></a>
<a class="sourceLine" id="cb13-2" href="#cb13-2" data-line-number="2"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-3" href="#cb13-3" data-line-number="3"><span class="co">## Prepare datasets</span></a>
<a class="sourceLine" id="cb13-4" href="#cb13-4" data-line-number="4"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-5" href="#cb13-5" data-line-number="5"></a>
<a class="sourceLine" id="cb13-6" href="#cb13-6" data-line-number="6"><span class="co">## Previously saved from R with:</span></a>
<a class="sourceLine" id="cb13-7" href="#cb13-7" data-line-number="7"><span class="co">##     lending_club &lt;- readRDS(&quot;lending_club.rds&quot;); write.csv(lending_club, &quot;lending_club.rds&quot;)</span></a>
<a class="sourceLine" id="cb13-8" href="#cb13-8" data-line-number="8"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-9" href="#cb13-9" data-line-number="9"><span class="co">## WARNING: 1.7GB on disk</span></a>
<a class="sourceLine" id="cb13-10" href="#cb13-10" data-line-number="10"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-11" href="#cb13-11" data-line-number="11">using CSV</a>
<a class="sourceLine" id="cb13-12" href="#cb13-12" data-line-number="12">lendingClub = CSV.read(<span class="st">&quot;datasets/lending_club.csv&quot;</span>; delim = <span class="st">&quot;,&quot;</span>)</a>
<a class="sourceLine" id="cb13-13" href="#cb13-13" data-line-number="13"></a>
<a class="sourceLine" id="cb13-14" href="#cb13-14" data-line-number="14"></a>
<a class="sourceLine" id="cb13-15" href="#cb13-15" data-line-number="15"></a>
<a class="sourceLine" id="cb13-16" href="#cb13-16" data-line-number="16"><span class="co">####################################################################################################</span></a>
<a class="sourceLine" id="cb13-17" href="#cb13-17" data-line-number="17"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-18" href="#cb13-18" data-line-number="18"><span class="co">## CREDIT MARGIN</span></a>
<a class="sourceLine" id="cb13-19" href="#cb13-19" data-line-number="19"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-20" href="#cb13-20" data-line-number="20"><span class="co">## This method of approximating the credit margin is far less sophisticated than what FI&#39;s do.</span></a>
<a class="sourceLine" id="cb13-21" href="#cb13-21" data-line-number="21"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-22" href="#cb13-22" data-line-number="22"><span class="co">## We need to calculate what the credit margin should be on a defaulted loan to get a nil NPV.</span></a>
<a class="sourceLine" id="cb13-23" href="#cb13-23" data-line-number="23"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-24" href="#cb13-24" data-line-number="24"><span class="co">## On a risk free loan the CF will be P+I at risk-free on _both_ borrowing and lending sides.</span></a>
<a class="sourceLine" id="cb13-25" href="#cb13-25" data-line-number="25"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-26" href="#cb13-26" data-line-number="26"><span class="co">##  On a defaulted loan, the CF will be:</span></a>
<a class="sourceLine" id="cb13-27" href="#cb13-27" data-line-number="27"><span class="co">##      borrowing unchanged = P&amp;I at risk-free</span></a>
<a class="sourceLine" id="cb13-28" href="#cb13-28" data-line-number="28"><span class="co">##    and</span></a>
<a class="sourceLine" id="cb13-29" href="#cb13-29" data-line-number="29"><span class="co">##      lending P&amp;I at (risk-free + credit margin) until before default, then recoveries+fees.</span></a>
<a class="sourceLine" id="cb13-30" href="#cb13-30" data-line-number="30"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-31" href="#cb13-31" data-line-number="31"><span class="co">## The principal amortisation profile depends on the credit margin used. We will arbitrarily use</span></a>
<a class="sourceLine" id="cb13-32" href="#cb13-32" data-line-number="32"><span class="co">## 20% which is a conservative assumption.</span></a>
<a class="sourceLine" id="cb13-33" href="#cb13-33" data-line-number="33"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-34" href="#cb13-34" data-line-number="34"><span class="co">## credit risk on that CF should be nil with the right margin when discounted at risk-free.</span></a>
<a class="sourceLine" id="cb13-35" href="#cb13-35" data-line-number="35"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-36" href="#cb13-36" data-line-number="36"><span class="co">## The function is very similar to the IRR calculation.</span></a>
<a class="sourceLine" id="cb13-37" href="#cb13-37" data-line-number="37"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-38" href="#cb13-38" data-line-number="38"></a>
<a class="sourceLine" id="cb13-39" href="#cb13-39" data-line-number="39">using DataFrames, Roots</a>
<a class="sourceLine" id="cb13-40" href="#cb13-40" data-line-number="40"></a>
<a class="sourceLine" id="cb13-41" href="#cb13-41" data-line-number="41"><span class="co"># number of monthly payments to model</span></a>
<a class="sourceLine" id="cb13-42" href="#cb13-42" data-line-number="42"><span class="co"># It exceeds 60 months in case recoveries on a 60-month loan takes the schedule after 60 months.</span></a>
<a class="sourceLine" id="cb13-43" href="#cb13-43" data-line-number="43"><span class="kw">const</span> nMonths = <span class="fl">90</span></a>
<a class="sourceLine" id="cb13-44" href="#cb13-44" data-line-number="44"></a>
<a class="sourceLine" id="cb13-45" href="#cb13-45" data-line-number="45"></a>
<a class="sourceLine" id="cb13-46" href="#cb13-46" data-line-number="46"></a>
<a class="sourceLine" id="cb13-47" href="#cb13-47" data-line-number="47"><span class="co"># Sculpt credit foncier profiles over 36 and 60 months at 20% per annum.</span></a>
<a class="sourceLine" id="cb13-48" href="#cb13-48" data-line-number="48"><span class="co"># The profile is expressed as percentage of loan amount</span></a>
<a class="sourceLine" id="cb13-49" href="#cb13-49" data-line-number="49"><span class="kw">function</span> CreateCreditFoncier(;n = <span class="fl">36</span>, riskFree = <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb13-50" href="#cb13-50" data-line-number="50"></a>
<a class="sourceLine" id="cb13-51" href="#cb13-51" data-line-number="51">  instalment = <span class="fl">1</span> * riskFree/<span class="fl">12</span> * <span class="fl">1</span> / (<span class="fl">1</span> - <span class="fl">1</span> / (<span class="fl">1</span> + riskFree/<span class="fl">12</span>) ^ n)</a>
<a class="sourceLine" id="cb13-52" href="#cb13-52" data-line-number="52"></a>
<a class="sourceLine" id="cb13-53" href="#cb13-53" data-line-number="53">  <span class="co"># We create a schedule</span></a>
<a class="sourceLine" id="cb13-54" href="#cb13-54" data-line-number="54">  schedule = DataFrame(month = <span class="fl">0</span>:nMonths, payment = <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb13-55" href="#cb13-55" data-line-number="55"></a>
<a class="sourceLine" id="cb13-56" href="#cb13-56" data-line-number="56">  <span class="co"># Add the day 1 principal outlay</span></a>
<a class="sourceLine" id="cb13-57" href="#cb13-57" data-line-number="57">  schedule[<span class="fl">1</span>,       :payment] = -<span class="fl">1</span></a>
<a class="sourceLine" id="cb13-58" href="#cb13-58" data-line-number="58">  schedule[<span class="fl">2</span>:(n+<span class="fl">1</span>), :payment] = instalment</a>
<a class="sourceLine" id="cb13-59" href="#cb13-59" data-line-number="59"></a>
<a class="sourceLine" id="cb13-60" href="#cb13-60" data-line-number="60">  <span class="kw">return</span>(schedule)</a>
<a class="sourceLine" id="cb13-61" href="#cb13-61" data-line-number="61"><span class="kw">end</span></a>
<a class="sourceLine" id="cb13-62" href="#cb13-62" data-line-number="62"></a>
<a class="sourceLine" id="cb13-63" href="#cb13-63" data-line-number="63"></a>
<a class="sourceLine" id="cb13-64" href="#cb13-64" data-line-number="64"><span class="co"># Solve for the credit margin</span></a>
<a class="sourceLine" id="cb13-65" href="#cb13-65" data-line-number="65"><span class="kw">function</span> CreditMargin(; loanNumber = <span class="fl">1</span>, loan = <span class="fl">1000.0</span>, intRate = <span class="fl">0.05</span>, term = <span class="fl">36</span>,</a>
<a class="sourceLine" id="cb13-66" href="#cb13-66" data-line-number="66">  totalPaid = <span class="fl">1000.0</span>, totalPrincipalPaid = <span class="fl">700.0</span>, totalInterestPaid = <span class="fl">50.0</span>,</a>
<a class="sourceLine" id="cb13-67" href="#cb13-67" data-line-number="67">  recoveries = <span class="fl">0.0</span>, lateFees = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb13-68" href="#cb13-68" data-line-number="68">  riskFree = <span class="fl">0.01</span>,</a>
<a class="sourceLine" id="cb13-69" href="#cb13-69" data-line-number="69">  showSchedule = false)</a>
<a class="sourceLine" id="cb13-70" href="#cb13-70" data-line-number="70"></a>
<a class="sourceLine" id="cb13-71" href="#cb13-71" data-line-number="71">  <span class="co"># Months after which a loan defaults (normal tenor if no default or early prepayment)</span></a>
<a class="sourceLine" id="cb13-72" href="#cb13-72" data-line-number="72">  monthDefault = term</a>
<a class="sourceLine" id="cb13-73" href="#cb13-73" data-line-number="73"></a>
<a class="sourceLine" id="cb13-74" href="#cb13-74" data-line-number="74">  <span class="co"># Monthly instlment</span></a>
<a class="sourceLine" id="cb13-75" href="#cb13-75" data-line-number="75">  instalment = ceil(loan * intRate/<span class="fl">12</span> / (<span class="fl">1</span> - <span class="fl">1</span> / (<span class="fl">1</span> + intRate/<span class="fl">12</span>) ^ term), digits = <span class="fl">2</span>)</a>
<a class="sourceLine" id="cb13-76" href="#cb13-76" data-line-number="76"></a>
<a class="sourceLine" id="cb13-77" href="#cb13-77" data-line-number="77">  <span class="co"># Create a blank schedule</span></a>
<a class="sourceLine" id="cb13-78" href="#cb13-78" data-line-number="78">  schedule = DataFrame(month = <span class="fl">0</span>:nMonths, monthlyPayment = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb13-79" href="#cb13-79" data-line-number="79">                       principalPayment = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb13-80" href="#cb13-80" data-line-number="80">                       totalPandI = <span class="fl">0.0</span>, totalI = <span class="fl">0.0</span>, totalP = <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb13-81" href="#cb13-81" data-line-number="81"></a>
<a class="sourceLine" id="cb13-82" href="#cb13-82" data-line-number="82">  <span class="kw">for</span> i <span class="kw">in</span> <span class="fl">2</span>:(nMonths + <span class="fl">1</span>)</a>
<a class="sourceLine" id="cb13-83" href="#cb13-83" data-line-number="83">    <span class="co"># Get situation at the end of previous month</span></a>
<a class="sourceLine" id="cb13-84" href="#cb13-84" data-line-number="84">    previousTotalPandI = schedule[i - <span class="fl">1</span>, :totalPandI]</a>
<a class="sourceLine" id="cb13-85" href="#cb13-85" data-line-number="85">    previousTotalP     = schedule[i - <span class="fl">1</span>, :totalP]</a>
<a class="sourceLine" id="cb13-86" href="#cb13-86" data-line-number="86">    previousTotalI     = schedule[i - <span class="fl">1</span>, :totalI]</a>
<a class="sourceLine" id="cb13-87" href="#cb13-87" data-line-number="87"></a>
<a class="sourceLine" id="cb13-88" href="#cb13-88" data-line-number="88">    <span class="co"># This is the beginning of a new month. First and foremost, the borrower is expected to pay the</span></a>
<a class="sourceLine" id="cb13-89" href="#cb13-89" data-line-number="89">    <span class="co"># accrued interest on amount of principal outstanding.</span></a>
<a class="sourceLine" id="cb13-90" href="#cb13-90" data-line-number="90">    <span class="co"># The instalment is expected to cover that amount of interest and the rest goes to</span></a>
<a class="sourceLine" id="cb13-91" href="#cb13-91" data-line-number="91">    <span class="co"># reducing the principal due outstanding.</span></a>
<a class="sourceLine" id="cb13-92" href="#cb13-92" data-line-number="92">    accruedInterest = ceil((loan - previousTotalP) * intRate/<span class="fl">12</span>; digits = <span class="fl">2</span>)</a>
<a class="sourceLine" id="cb13-93" href="#cb13-93" data-line-number="93">    decreasePrincipal = instalment - accruedInterest</a>
<a class="sourceLine" id="cb13-94" href="#cb13-94" data-line-number="94"></a>
<a class="sourceLine" id="cb13-95" href="#cb13-95" data-line-number="95">    <span class="co"># If that amount takes the schedule above the total amount of interest shown in the data set,</span></a>
<a class="sourceLine" id="cb13-96" href="#cb13-96" data-line-number="96">    <span class="co"># we should stop the schedule at this point</span></a>
<a class="sourceLine" id="cb13-97" href="#cb13-97" data-line-number="97">    <span class="co"># This is a shortcut since we could have a payment higher than the interest due, but not enough</span></a>
<a class="sourceLine" id="cb13-98" href="#cb13-98" data-line-number="98">    <span class="co"># to cover the expected principal repayment. However, it works well in practice.</span></a>
<a class="sourceLine" id="cb13-99" href="#cb13-99" data-line-number="99">    <span class="kw">if</span> previousTotalI + accruedInterest &gt; totalInterestPaid</a>
<a class="sourceLine" id="cb13-100" href="#cb13-100" data-line-number="100"></a>
<a class="sourceLine" id="cb13-101" href="#cb13-101" data-line-number="101">      <span class="co"># We stop the normal schedule at this date.</span></a>
<a class="sourceLine" id="cb13-102" href="#cb13-102" data-line-number="102">      <span class="co"># Interest is paid (although less than scheduled)</span></a>
<a class="sourceLine" id="cb13-103" href="#cb13-103" data-line-number="103">      schedule[i, :monthlyPayment] = totalInterestPaid - previousTotalI</a>
<a class="sourceLine" id="cb13-104" href="#cb13-104" data-line-number="104"></a>
<a class="sourceLine" id="cb13-105" href="#cb13-105" data-line-number="105">      <span class="co"># Whatever principal is left as per the dataset</span></a>
<a class="sourceLine" id="cb13-106" href="#cb13-106" data-line-number="106">      schedule[i, :monthlyPayment] += totalPrincipalPaid - previousTotalP</a>
<a class="sourceLine" id="cb13-107" href="#cb13-107" data-line-number="107"></a>
<a class="sourceLine" id="cb13-108" href="#cb13-108" data-line-number="108">      <span class="co"># Then 3-month after the last payment date, recoveries and and later fees are paid</span></a>
<a class="sourceLine" id="cb13-109" href="#cb13-109" data-line-number="109">      schedule[i + <span class="fl">3</span>, :principalPayment] += recoveries + lateFees</a>
<a class="sourceLine" id="cb13-110" href="#cb13-110" data-line-number="110"></a>
<a class="sourceLine" id="cb13-111" href="#cb13-111" data-line-number="111">      <span class="co"># Not really useful, but for completeness</span></a>
<a class="sourceLine" id="cb13-112" href="#cb13-112" data-line-number="112">      schedule[i, :totalPandI] = totalPaid</a>
<a class="sourceLine" id="cb13-113" href="#cb13-113" data-line-number="113">      schedule[i, :totalI]     = totalInterestPaid</a>
<a class="sourceLine" id="cb13-114" href="#cb13-114" data-line-number="114">      schedule[i, :totalP]     = totalPrincipalPaid</a>
<a class="sourceLine" id="cb13-115" href="#cb13-115" data-line-number="115"></a>
<a class="sourceLine" id="cb13-116" href="#cb13-116" data-line-number="116">      <span class="co"># If total principal paid is less than borrower, then it is a default, and the monthDefault</span></a>
<a class="sourceLine" id="cb13-117" href="#cb13-117" data-line-number="117">      <span class="co"># is adjusted.</span></a>
<a class="sourceLine" id="cb13-118" href="#cb13-118" data-line-number="118">      <span class="kw">if</span> (totalPrincipalPaid &lt; loan)</a>
<a class="sourceLine" id="cb13-119" href="#cb13-119" data-line-number="119">        monthDefault = i</a>
<a class="sourceLine" id="cb13-120" href="#cb13-120" data-line-number="120">      <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-121" href="#cb13-121" data-line-number="121"></a>
<a class="sourceLine" id="cb13-122" href="#cb13-122" data-line-number="122">      <span class="co"># No more payments to add to the schedule</span></a>
<a class="sourceLine" id="cb13-123" href="#cb13-123" data-line-number="123">      <span class="kw">break</span></a>
<a class="sourceLine" id="cb13-124" href="#cb13-124" data-line-number="124"></a>
<a class="sourceLine" id="cb13-125" href="#cb13-125" data-line-number="125">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb13-126" href="#cb13-126" data-line-number="126">      <span class="co"># Deal with normal schedule</span></a>
<a class="sourceLine" id="cb13-127" href="#cb13-127" data-line-number="127">      schedule[i, :monthlyPayment]   = instalment</a>
<a class="sourceLine" id="cb13-128" href="#cb13-128" data-line-number="128">      schedule[i, :principalPayment] = decreasePrincipal</a>
<a class="sourceLine" id="cb13-129" href="#cb13-129" data-line-number="129">      schedule[i, :totalPandI]       = schedule[i-<span class="fl">1</span>, :totalPandI] + instalment</a>
<a class="sourceLine" id="cb13-130" href="#cb13-130" data-line-number="130">      schedule[i, :totalI]           = schedule[i-<span class="fl">1</span>, :totalI]     + accruedInterest</a>
<a class="sourceLine" id="cb13-131" href="#cb13-131" data-line-number="131">      schedule[i, :totalP]           = schedule[i-<span class="fl">1</span>, :totalP]     + decreasePrincipal</a>
<a class="sourceLine" id="cb13-132" href="#cb13-132" data-line-number="132">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-133" href="#cb13-133" data-line-number="133">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-134" href="#cb13-134" data-line-number="134"></a>
<a class="sourceLine" id="cb13-135" href="#cb13-135" data-line-number="135">  <span class="co"># At this point schedule[, :monthlyPayment] contains the schedule of all payments, but needs to</span></a>
<a class="sourceLine" id="cb13-136" href="#cb13-136" data-line-number="136">  <span class="co"># include the initial loan.</span></a>
<a class="sourceLine" id="cb13-137" href="#cb13-137" data-line-number="137">  schedule[<span class="fl">1</span>, :principalPayment] = -loan</a>
<a class="sourceLine" id="cb13-138" href="#cb13-138" data-line-number="138"></a>
<a class="sourceLine" id="cb13-139" href="#cb13-139" data-line-number="139">  <span class="kw">if</span> (showSchedule)</a>
<a class="sourceLine" id="cb13-140" href="#cb13-140" data-line-number="140">    println(<span class="st">&quot;Payments&quot;</span>)</a>
<a class="sourceLine" id="cb13-141" href="#cb13-141" data-line-number="141">    println(schedule)</a>
<a class="sourceLine" id="cb13-142" href="#cb13-142" data-line-number="142">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-143" href="#cb13-143" data-line-number="143"></a>
<a class="sourceLine" id="cb13-144" href="#cb13-144" data-line-number="144">  <span class="co"># Principal profile on the borrowing side</span></a>
<a class="sourceLine" id="cb13-145" href="#cb13-145" data-line-number="145">  creditFoncier = round.(CreateCreditFoncier(n = term, riskFree = riskFree)[:, :payment] .* loan;</a>
<a class="sourceLine" id="cb13-146" href="#cb13-146" data-line-number="146">                                             digits = <span class="fl">2</span>)</a>
<a class="sourceLine" id="cb13-147" href="#cb13-147" data-line-number="147"></a>
<a class="sourceLine" id="cb13-148" href="#cb13-148" data-line-number="148">  <span class="co"># For a given margin, calculate the _net_ NPV between the what is borrowed at the risk-free rate</span></a>
<a class="sourceLine" id="cb13-149" href="#cb13-149" data-line-number="149">  <span class="co"># and what is earned on the loan principal profile (possibly shortned because of default)</span></a>
<a class="sourceLine" id="cb13-150" href="#cb13-150" data-line-number="150">  <span class="co"># carrying an interest of risk-free + credit margin</span></a>
<a class="sourceLine" id="cb13-151" href="#cb13-151" data-line-number="151">  <span class="kw">function</span> NetNPV(margin)</a>
<a class="sourceLine" id="cb13-152" href="#cb13-152" data-line-number="152">    <span class="co"># We need to store the calculated interest</span></a>
<a class="sourceLine" id="cb13-153" href="#cb13-153" data-line-number="153">    interestSchedule = DataFrame(month = <span class="fl">0</span>:nMonths, interestPayment = <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb13-154" href="#cb13-154" data-line-number="154"></a>
<a class="sourceLine" id="cb13-155" href="#cb13-155" data-line-number="155">    <span class="co"># For each month, calculate the amount of interest with the credit margin</span></a>
<a class="sourceLine" id="cb13-156" href="#cb13-156" data-line-number="156">    <span class="kw">for</span> i <span class="kw">in</span> <span class="fl">2</span>:(monthDefault + <span class="fl">1</span>)</a>
<a class="sourceLine" id="cb13-157" href="#cb13-157" data-line-number="157">      outstandingPrincipal = sum(schedule[<span class="fl">1</span>:(i - <span class="fl">1</span>), :principalPayment])</a>
<a class="sourceLine" id="cb13-158" href="#cb13-158" data-line-number="158">      interestSchedule[i, :interestPayment] =</a>
<a class="sourceLine" id="cb13-159" href="#cb13-159" data-line-number="159">            -round((riskFree + margin)/<span class="fl">12</span> * outstandingPrincipal; digits = <span class="fl">2</span>)</a>
<a class="sourceLine" id="cb13-160" href="#cb13-160" data-line-number="160">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-161" href="#cb13-161" data-line-number="161"></a>
<a class="sourceLine" id="cb13-162" href="#cb13-162" data-line-number="162">    <span class="co"># Net final cashflow is:</span></a>
<a class="sourceLine" id="cb13-163" href="#cb13-163" data-line-number="163">    <span class="co">#     total principal and interest cashflow on the lending side</span></a>
<a class="sourceLine" id="cb13-164" href="#cb13-164" data-line-number="164">    <span class="co"># less</span></a>
<a class="sourceLine" id="cb13-165" href="#cb13-165" data-line-number="165">    <span class="co">#     borrowing profile</span></a>
<a class="sourceLine" id="cb13-166" href="#cb13-166" data-line-number="166">    cashFlow = schedule[:, :principalPayment] .+ interestSchedule[:, :interestPayment]</a>
<a class="sourceLine" id="cb13-167" href="#cb13-167" data-line-number="167">    cashFlow = cashFlow .- creditFoncier</a>
<a class="sourceLine" id="cb13-168" href="#cb13-168" data-line-number="168"></a>
<a class="sourceLine" id="cb13-169" href="#cb13-169" data-line-number="169">    <span class="kw">return</span> sum(cashFlow ./ (<span class="fl">1</span> + riskFree/<span class="fl">12</span>) .^ (<span class="fl">0</span>:nMonths))</a>
<a class="sourceLine" id="cb13-170" href="#cb13-170" data-line-number="170">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-171" href="#cb13-171" data-line-number="171"></a>
<a class="sourceLine" id="cb13-172" href="#cb13-172" data-line-number="172">  <span class="co"># rootInterest = round(find_zero(NetNPV, (-0.5, 10), Bisection()); digits = 6)</span></a>
<a class="sourceLine" id="cb13-173" href="#cb13-173" data-line-number="173">  rootInterest = <span class="kw">try</span></a>
<a class="sourceLine" id="cb13-174" href="#cb13-174" data-line-number="174">                   rootInterest = round(find_zero(NetNPV, (-<span class="fl">0.5</span>, <span class="fl">10</span>), Bisection()); digits = <span class="fl">6</span>)</a>
<a class="sourceLine" id="cb13-175" href="#cb13-175" data-line-number="175">                 <span class="kw">catch</span> e</a>
<a class="sourceLine" id="cb13-176" href="#cb13-176" data-line-number="176">                   NaN</a>
<a class="sourceLine" id="cb13-177" href="#cb13-177" data-line-number="177">                 <span class="kw">end</span></a>
<a class="sourceLine" id="cb13-178" href="#cb13-178" data-line-number="178"></a>
<a class="sourceLine" id="cb13-179" href="#cb13-179" data-line-number="179"></a>
<a class="sourceLine" id="cb13-180" href="#cb13-180" data-line-number="180">  <span class="kw">return</span>((</a>
<a class="sourceLine" id="cb13-181" href="#cb13-181" data-line-number="181">    loanID = loanNumber,</a>
<a class="sourceLine" id="cb13-182" href="#cb13-182" data-line-number="182">    creditMargin = rootInterest,</a>
<a class="sourceLine" id="cb13-183" href="#cb13-183" data-line-number="183">    monthDefault = monthDefault</a>
<a class="sourceLine" id="cb13-184" href="#cb13-184" data-line-number="184">  ))</a>
<a class="sourceLine" id="cb13-185" href="#cb13-185" data-line-number="185"><span class="kw">end</span></a>
<a class="sourceLine" id="cb13-186" href="#cb13-186" data-line-number="186"></a>
<a class="sourceLine" id="cb13-187" href="#cb13-187" data-line-number="187"></a>
<a class="sourceLine" id="cb13-188" href="#cb13-188" data-line-number="188"><span class="co">####################################################################################################</span></a>
<a class="sourceLine" id="cb13-189" href="#cb13-189" data-line-number="189"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-190" href="#cb13-190" data-line-number="190"><span class="co">## Quick check</span></a>
<a class="sourceLine" id="cb13-191" href="#cb13-191" data-line-number="191"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-192" href="#cb13-192" data-line-number="192">CreditMargin(loanNumber = <span class="fl">1</span>, loan = <span class="fl">5600</span>, intRate = <span class="fl">0.1299</span>, term = <span class="fl">36</span>,</a>
<a class="sourceLine" id="cb13-193" href="#cb13-193" data-line-number="193">             totalPaid = <span class="fl">6791.72</span>, totalPrincipalPaid = <span class="fl">5600</span>, totalInterestPaid = <span class="fl">1191.72</span>,</a>
<a class="sourceLine" id="cb13-194" href="#cb13-194" data-line-number="194">             recoveries = <span class="fl">0</span>, lateFees = <span class="fl">0</span>,</a>
<a class="sourceLine" id="cb13-195" href="#cb13-195" data-line-number="195">             riskFree = <span class="fl">0.02</span>, showSchedule = false)</a>
<a class="sourceLine" id="cb13-196" href="#cb13-196" data-line-number="196"></a>
<a class="sourceLine" id="cb13-197" href="#cb13-197" data-line-number="197">CreditMargin(loanNumber = <span class="fl">1</span>, loan = <span class="fl">35000</span>, intRate = <span class="fl">0.1820</span>, term = <span class="fl">60</span>,</a>
<a class="sourceLine" id="cb13-198" href="#cb13-198" data-line-number="198">             totalPaid = <span class="fl">26600.1</span>, totalPrincipalPaid = <span class="fl">3874.72</span>, totalInterestPaid = <span class="fl">5225.38</span>,</a>
<a class="sourceLine" id="cb13-199" href="#cb13-199" data-line-number="199">             recoveries = <span class="fl">17500</span>, lateFees = <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb13-200" href="#cb13-200" data-line-number="200">             riskFree = <span class="fl">0.02</span>, showSchedule = true)</a>
<a class="sourceLine" id="cb13-201" href="#cb13-201" data-line-number="201"></a>
<a class="sourceLine" id="cb13-202" href="#cb13-202" data-line-number="202">CreditMargin(loanNumber = <span class="fl">1734666</span>, loan = <span class="fl">35000</span>, intRate = <span class="fl">0.0797</span>, term = <span class="fl">36</span>,</a>
<a class="sourceLine" id="cb13-203" href="#cb13-203" data-line-number="203">             totalPaid = <span class="fl">1057.04</span>, totalPrincipalPaid = <span class="fl">863.83</span>, totalInterestPaid = <span class="fl">193.72</span>,</a>
<a class="sourceLine" id="cb13-204" href="#cb13-204" data-line-number="204">             recoveries = <span class="fl">0</span>, lateFees = <span class="fl">0</span>,</a>
<a class="sourceLine" id="cb13-205" href="#cb13-205" data-line-number="205">             riskFree = <span class="fl">0.02</span>, showSchedule = true)</a>
<a class="sourceLine" id="cb13-206" href="#cb13-206" data-line-number="206"></a>
<a class="sourceLine" id="cb13-207" href="#cb13-207" data-line-number="207"></a>
<a class="sourceLine" id="cb13-208" href="#cb13-208" data-line-number="208"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-209" href="#cb13-209" data-line-number="209"><span class="co">## Look for the loans which have gone to their end</span></a>
<a class="sourceLine" id="cb13-210" href="#cb13-210" data-line-number="210"><span class="co">##</span></a>
<a class="sourceLine" id="cb13-211" href="#cb13-211" data-line-number="211">indextmp = (lendingClub.loan_status .== <span class="st">&quot;Fully Paid&quot;</span>) .|</a>
<a class="sourceLine" id="cb13-212" href="#cb13-212" data-line-number="212">           (lendingClub.loan_status .== <span class="st">&quot;Charged Off&quot;</span>) .|</a>
<a class="sourceLine" id="cb13-213" href="#cb13-213" data-line-number="213">           (lendingClub.loan_status .== <span class="st">&quot;Does not meet the credit policy. Status:Charged Off&quot;</span>) .|</a>
<a class="sourceLine" id="cb13-214" href="#cb13-214" data-line-number="214">           (lendingClub.loan_status .== <span class="st">&quot;Does not meet the credit policy. Status:Fully Paid&quot;</span>)</a>
<a class="sourceLine" id="cb13-215" href="#cb13-215" data-line-number="215"></a>
<a class="sourceLine" id="cb13-216" href="#cb13-216" data-line-number="216"><span class="co">## Create the dataset we will use - Should be the same as lending_club_reformatted_paid.rds</span></a>
<a class="sourceLine" id="cb13-217" href="#cb13-217" data-line-number="217">lc = lendingClub[indextmp, :]</a>
<a class="sourceLine" id="cb13-218" href="#cb13-218" data-line-number="218"></a>
<a class="sourceLine" id="cb13-219" href="#cb13-219" data-line-number="219"><span class="co">## Select relevant variables to calculate profitability</span></a>
<a class="sourceLine" id="cb13-220" href="#cb13-220" data-line-number="220"><span class="co">## Column1 contains the loanID&#39;s</span></a>
<a class="sourceLine" id="cb13-221" href="#cb13-221" data-line-number="221">cols = [:Column1, :funded_amnt, :int_rate, :term,</a>
<a class="sourceLine" id="cb13-222" href="#cb13-222" data-line-number="222">        :total_pymnt, :total_rec_prncp, :total_rec_int,</a>
<a class="sourceLine" id="cb13-223" href="#cb13-223" data-line-number="223">        :recoveries, :total_rec_late_fee]</a>
<a class="sourceLine" id="cb13-224" href="#cb13-224" data-line-number="224"></a>
<a class="sourceLine" id="cb13-225" href="#cb13-225" data-line-number="225">lc = select(lc, cols)</a>
<a class="sourceLine" id="cb13-226" href="#cb13-226" data-line-number="226"></a>
<a class="sourceLine" id="cb13-227" href="#cb13-227" data-line-number="227"><span class="co">## Interest rates as percentage</span></a>
<a class="sourceLine" id="cb13-228" href="#cb13-228" data-line-number="228">lc[!, :int_rate] = lc[!, :int_rate] ./ <span class="fl">100</span></a>
<a class="sourceLine" id="cb13-229" href="#cb13-229" data-line-number="229"></a>
<a class="sourceLine" id="cb13-230" href="#cb13-230" data-line-number="230"><span class="co">## Create a new column</span></a>
<a class="sourceLine" id="cb13-231" href="#cb13-231" data-line-number="231">lc[:tenor] = <span class="fl">0</span></a>
<a class="sourceLine" id="cb13-232" href="#cb13-232" data-line-number="232"></a>
<a class="sourceLine" id="cb13-233" href="#cb13-233" data-line-number="233"><span class="co">## that will record the official loan tenor as a number (instead of string)</span></a>
<a class="sourceLine" id="cb13-234" href="#cb13-234" data-line-number="234">lc[startswith.( lc[!, :term], <span class="st">&quot; 36&quot;</span>), :tenor] .= <span class="fl">36</span></a>
<a class="sourceLine" id="cb13-235" href="#cb13-235" data-line-number="235">lc[startswith.( lc[!, :term], <span class="st">&quot; 60&quot;</span>), :tenor] .= <span class="fl">60</span></a>
<a class="sourceLine" id="cb13-236" href="#cb13-236" data-line-number="236"></a>
<a class="sourceLine" id="cb13-237" href="#cb13-237" data-line-number="237"><span class="co">## New data frame to store the results</span></a>
<a class="sourceLine" id="cb13-238" href="#cb13-238" data-line-number="238">creditMargin_Result = DataFrame(loanID = zeros(<span class="dt">Int64</span>, nrow(lc)),</a>
<a class="sourceLine" id="cb13-239" href="#cb13-239" data-line-number="239">                                creditMargin = zeros(<span class="dt">Float64</span>, nrow(lc)),</a>
<a class="sourceLine" id="cb13-240" href="#cb13-240" data-line-number="240">                                monthDefault = zeros(<span class="dt">Int64</span>, nrow(lc)))</a>
<a class="sourceLine" id="cb13-241" href="#cb13-241" data-line-number="241"></a>
<a class="sourceLine" id="cb13-242" href="#cb13-242" data-line-number="242"></a>
<a class="sourceLine" id="cb13-243" href="#cb13-243" data-line-number="243"><span class="co"># ~4,700 sec. to do the whole dataset</span></a>
<a class="sourceLine" id="cb13-244" href="#cb13-244" data-line-number="244">@time <span class="kw">for</span> i <span class="kw">in</span> <span class="fl">1</span>:nrow(lc)</a>
<a class="sourceLine" id="cb13-245" href="#cb13-245" data-line-number="245">  <span class="kw">global</span> creditMargin_Result</a>
<a class="sourceLine" id="cb13-246" href="#cb13-246" data-line-number="246"></a>
<a class="sourceLine" id="cb13-247" href="#cb13-247" data-line-number="247">  <span class="co"># Use multiple-return-value</span></a>
<a class="sourceLine" id="cb13-248" href="#cb13-248" data-line-number="248">  <span class="co"># 1h17m runtime</span></a>
<a class="sourceLine" id="cb13-249" href="#cb13-249" data-line-number="249">  (creditMargin_Result[i, :loanID],</a>
<a class="sourceLine" id="cb13-250" href="#cb13-250" data-line-number="250">   creditMargin_Result[i, :creditMargin],</a>
<a class="sourceLine" id="cb13-251" href="#cb13-251" data-line-number="251">   creditMargin_Result[i, :monthDefault]) =</a>
<a class="sourceLine" id="cb13-252" href="#cb13-252" data-line-number="252">      CreditMargin(</a>
<a class="sourceLine" id="cb13-253" href="#cb13-253" data-line-number="253">          loanNumber = lc[i, :Column1],</a>
<a class="sourceLine" id="cb13-254" href="#cb13-254" data-line-number="254">          loan = lc[i, :funded_amnt], intRate = lc[i, :int_rate], term =lc[i, :tenor],</a>
<a class="sourceLine" id="cb13-255" href="#cb13-255" data-line-number="255">          totalPaid = lc[i, :total_pymnt], totalPrincipalPaid = lc[i, :total_rec_prncp],</a>
<a class="sourceLine" id="cb13-256" href="#cb13-256" data-line-number="256">          totalInterestPaid = lc[i, :total_rec_int],</a>
<a class="sourceLine" id="cb13-257" href="#cb13-257" data-line-number="257">          recoveries = lc[i, :recoveries], lateFees = lc[i, :total_rec_late_fee],</a>
<a class="sourceLine" id="cb13-258" href="#cb13-258" data-line-number="258">          riskFree = <span class="fl">0.02</span>,</a>
<a class="sourceLine" id="cb13-259" href="#cb13-259" data-line-number="259">          showSchedule = false)</a>
<a class="sourceLine" id="cb13-260" href="#cb13-260" data-line-number="260"><span class="kw">end</span></a>
<a class="sourceLine" id="cb13-261" href="#cb13-261" data-line-number="261"></a>
<a class="sourceLine" id="cb13-262" href="#cb13-262" data-line-number="262"></a>
<a class="sourceLine" id="cb13-263" href="#cb13-263" data-line-number="263">creditMargin_Result[<span class="fl">1</span>:<span class="fl">10</span>,:]</a>
<a class="sourceLine" id="cb13-264" href="#cb13-264" data-line-number="264"></a>
<a class="sourceLine" id="cb13-265" href="#cb13-265" data-line-number="265">CSV.write(<span class="st">&quot;datasets/CreditMargins.csv&quot;</span>, creditMargin_Result)</a></code></pre></div>
<p></p>
</div>
</div>
<div id="maxima-derivation-of-the-cost-function" class="section level3">
<h3><span class="header-section-number">5.4.3</span> Maxima derivation of the cost function</h3>
<pre><code>PDF1(x, Q) := alpha1( Q) * sqrt( 1 / ( 2 * pi)) * 
              exp( - 1 / 2*(( log( -( x - m1( Q)) / m1( Q)) + sigma1( Q) ^ 2) / sigma1( Q)) ^ 2) / 
              ( -( x - m1(Q)) * sigma1( Q)) ;

PDF2(x, Q) := alpha2( Q) * sqrt( 1 / ( 2 * pi)) * 
              exp( - 1 / 2*(( log( -( x - m2( Q)) / m2( Q)) + sigma2( Q) ^ 2) / sigma2( Q)) ^ 2) / 
              ( -( x - m2( Q)) * sigma2( Q)) ;

PDF3(x, Q) := alpha3( Q) * sqrt( 1 / ( 2 (* pi)) * 
              exp( - 1 / 2*(( log( -( x - m3( Q)) / m3( Q)) + sigma3( Q) ^ 2) / sigma3( Q)) ^ 2) / 
              ( -( x - m3( Q)) * sigma3( Q)) ;

PDF4(x, Q) := alpha4( Q) * sqrt( 1 / ( 2 * pi)) * 
              exp( - 1 / 2*(( log( ( x - m4( Q)) / m4( Q)) + sigma4( Q) ^ 2) / sigma4( Q)) ^ 2) / ( 
              ( x - m4( Q)) * sigma4( Q)) ;


alpha1(Q) := am1* Q + an1 ;
alpha2(Q) := am2* Q + an2 ;
alpha3(Q) := am3* Q + an3 ;
alpha4(Q) := am4* Q + an4 ;

m1(Q) := mm1* Q + mn1 ;
m2(Q) := mm2* Q + mn2 ;
m3(Q) := mm3* Q + mn3 ;
m4(Q) := mm4* Q + mn4 ;

sigma1(Q) := sm1* Q + sn1 ;
sigma2(Q) := sm2* Q + sn2 ;
sigma3(Q) := sm3* Q + sn3 ;
sigma4(Q) := sm4* Q + sn4 ;

J(x, Q): = -( x - ( PDF1( x, Q) + PDF2( x, Q) + PDF3( x, Q) + PDF4( x, Q))) ^ 2 ; 

diff( PDF1(x, Q), Q) ; </code></pre>
</div>
</div>
<div id="system-version" class="section level2">
<h2><span class="header-section-number">5.5</span> System version</h2>
<p></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb15-1" href="#cb15-1" data-line-number="1">##                                       sysname                                       release </a>
<a class="sourceLine" id="cb15-2" href="#cb15-2" data-line-number="2">##                                       &quot;Linux&quot;                            &quot;5.3.0-21-generic&quot; </a>
<a class="sourceLine" id="cb15-3" href="#cb15-3" data-line-number="3">##                                       version                                      nodename </a>
<a class="sourceLine" id="cb15-4" href="#cb15-4" data-line-number="4">## &quot;#22-Ubuntu SMP Tue Oct 29 22:55:51 UTC 2019&quot;                                        &quot;x260&quot; </a>
<a class="sourceLine" id="cb15-5" href="#cb15-5" data-line-number="5">##                                       machine                                         login </a>
<a class="sourceLine" id="cb15-6" href="#cb15-6" data-line-number="6">##                                      &quot;x86_64&quot;                                     &quot;unknown&quot; </a>
<a class="sourceLine" id="cb15-7" href="#cb15-7" data-line-number="7">##                                          user                                effective_user </a>
<a class="sourceLine" id="cb15-8" href="#cb15-8" data-line-number="8">##                                    &quot;emmanuel&quot;                                    &quot;emmanuel&quot;</a></code></pre></div>
<p></p>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="18">
<li id="fn18"><p><a href="https://simplemaps.com/data/us-zips" class="uri">https://simplemaps.com/data/us-zips</a><a href="appendix.html#fnref18" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="conclusion.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Emmanuel-R8/HarvardX-LendingClub/edit/master/08-appendix.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["HarvardX-LendingClub.pdf", "HarvardX-LendingClub.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
