<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Logistic Regression Model and Credit Scorecard | LendingClub Loans Pricing</title>
  <meta name="description" content="HarvardX - PH125.9x Data Science Capstone" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Logistic Regression Model and Credit Scorecard | LendingClub Loans Pricing" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="HarvardX - PH125.9x Data Science Capstone" />
  <meta name="github-repo" content="Emmanuel_R8/HarvardX-LendingClub" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Logistic Regression Model and Credit Scorecard | LendingClub Loans Pricing" />
  
  <meta name="twitter:description" content="HarvardX - PH125.9x Data Science Capstone" />
  

<meta name="author" content="Emmanuel Rialland - https://github.com/Emmanuel_R8" />


<meta name="date" content="2019-12-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="dataset.html"/>
<link rel="next" href="conclusion.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./introduction.html" target="blank>LendingClub Loans Pricing</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html"><i class="fa fa-check"></i><b>1</b> Internal Rate of Return, Credit Margins and Net Present Values</a><ul>
<li class="chapter" data-level="1.1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#background"><i class="fa fa-check"></i><b>1.1</b> Background</a></li>
<li class="chapter" data-level="1.2" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#internal-rate-of-return"><i class="fa fa-check"></i><b>1.2</b> Internal Rate of Return</a></li>
<li class="chapter" data-level="1.3" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#dataset-calculation"><i class="fa fa-check"></i><b>1.3</b> Dataset calculation</a><ul>
<li class="chapter" data-level="1.3.1" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#irr"><i class="fa fa-check"></i><b>1.3.1</b> IRR</a></li>
<li class="chapter" data-level="1.3.2" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#credit-margins"><i class="fa fa-check"></i><b>1.3.2</b> Credit Margins</a></li>
<li class="chapter" data-level="1.3.3" data-path="internal-rate-of-return-credit-margins-and-net-present-values.html"><a href="internal-rate-of-return-credit-margins-and-net-present-values.html#npv"><i class="fa fa-check"></i><b>1.3.3</b> NPV</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="dataset.html"><a href="dataset.html"><i class="fa fa-check"></i><b>2</b> Dataset</a><ul>
<li class="chapter" data-level="2.1" data-path="dataset.html"><a href="dataset.html#preamble"><i class="fa fa-check"></i><b>2.1</b> Preamble</a></li>
<li class="chapter" data-level="2.2" data-path="dataset.html"><a href="dataset.html#general-presentation"><i class="fa fa-check"></i><b>2.2</b> General presentation</a><ul>
<li class="chapter" data-level="2.2.1" data-path="dataset.html"><a href="dataset.html#business-volume"><i class="fa fa-check"></i><b>2.2.1</b> Business volume</a></li>
<li class="chapter" data-level="2.2.2" data-path="dataset.html"><a href="dataset.html#loan-lifecyle-and-status"><i class="fa fa-check"></i><b>2.2.2</b> Loan lifecyle and status</a></li>
<li class="chapter" data-level="2.2.3" data-path="dataset.html"><a href="dataset.html#loan-application"><i class="fa fa-check"></i><b>2.2.3</b> Loan application</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="dataset.html"><a href="dataset.html#rates"><i class="fa fa-check"></i><b>2.3</b> Rates</a><ul>
<li class="chapter" data-level="2.3.1" data-path="dataset.html"><a href="dataset.html#sec:feature-engineering"><i class="fa fa-check"></i><b>2.3.1</b> IRR and required credit margins</a></li>
<li class="chapter" data-level="2.3.2" data-path="dataset.html"><a href="dataset.html#choice-of-predictors"><i class="fa fa-check"></i><b>2.3.2</b> Choice of predictors</a></li>
<li class="chapter" data-level="2.3.3" data-path="dataset.html"><a href="dataset.html#interest-rates"><i class="fa fa-check"></i><b>2.3.3</b> Interest rates</a></li>
<li class="chapter" data-level="2.3.4" data-path="dataset.html"><a href="dataset.html#purpose"><i class="fa fa-check"></i><b>2.3.4</b> Purpose</a></li>
<li class="chapter" data-level="2.3.5" data-path="dataset.html"><a href="dataset.html#payments"><i class="fa fa-check"></i><b>2.3.5</b> Payments</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="dataset.html"><a href="dataset.html#net-present-value"><i class="fa fa-check"></i><b>2.4</b> Net present value</a><ul>
<li class="chapter" data-level="2.4.1" data-path="dataset.html"><a href="dataset.html#average-npv-and-credit-margin-by-subgrade"><i class="fa fa-check"></i><b>2.4.1</b> Average NPV and credit margin by subgrade</a></li>
<li class="chapter" data-level="2.4.2" data-path="dataset.html"><a href="dataset.html#distribution-of-principal-losses-by-rating"><i class="fa fa-check"></i><b>2.4.2</b> Distribution of principal losses by rating</a></li>
<li class="chapter" data-level="2.4.3" data-path="dataset.html"><a href="dataset.html#npv-distribution-by-rating"><i class="fa fa-check"></i><b>2.4.3</b> NPV distribution by rating</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="dataset.html"><a href="dataset.html#loan-decision"><i class="fa fa-check"></i><b>2.5</b> Loan decision</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html"><i class="fa fa-check"></i><b>3</b> Logistic Regression Model and Credit Scorecard</a><ul>
<li class="chapter" data-level="3.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#logistic-regression"><i class="fa fa-check"></i><b>3.1</b> Logistic Regression</a><ul>
<li class="chapter" data-level="3.1.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#data-preparation"><i class="fa fa-check"></i><b>3.1.1</b> Data preparation</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#binning-and-weight-of-evidence"><i class="fa fa-check"></i><b>3.2</b> Binning and Weight of Evidence</a><ul>
<li class="chapter" data-level="3.2.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#background-1"><i class="fa fa-check"></i><b>3.2.1</b> Background</a></li>
<li class="chapter" data-level="3.2.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#binning"><i class="fa fa-check"></i><b>3.2.2</b> Binning</a></li>
<li class="chapter" data-level="3.2.3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#woe-and-iv-definitions"><i class="fa fa-check"></i><b>3.2.3</b> WOE and IV definitions</a></li>
<li class="chapter" data-level="3.2.4" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#calculating-woe-and-iv"><i class="fa fa-check"></i><b>3.2.4</b> Calculating WoE and IV</a></li>
<li class="chapter" data-level="3.2.5" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#loop-through-all-variables"><i class="fa fa-check"></i><b>3.2.5</b> Loop through all variables</a></li>
<li class="chapter" data-level="3.2.6" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#select-relevant-variables"><i class="fa fa-check"></i><b>3.2.6</b> Select relevant variables</a></li>
<li class="chapter" data-level="3.2.7" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#create-data-table-with-one-hot-encoding"><i class="fa fa-check"></i><b>3.2.7</b> Create data table with one-hot encoding</a></li>
<li class="chapter" data-level="3.2.8" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#comparison-of-individual-characteristics"><i class="fa fa-check"></i><b>3.2.8</b> Comparison of individual characteristics</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#logistic-regression-1"><i class="fa fa-check"></i><b>3.3</b> Logistic Regression</a><ul>
<li class="chapter" data-level="3.3.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#remove-identical-bins"><i class="fa fa-check"></i><b>3.3.1</b> Remove identical bins</a></li>
<li class="chapter" data-level="3.3.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#first-model---complete-dataset"><i class="fa fa-check"></i><b>3.3.2</b> First model - complete dataset</a></li>
<li class="chapter" data-level="3.3.3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#second-training---fitted-model-less-colinear-bins"><i class="fa fa-check"></i><b>3.3.3</b> Second training - fitted model less colinear bins</a></li>
<li class="chapter" data-level="3.3.4" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#third-training---second-fitted-model-less-non-significant-bins"><i class="fa fa-check"></i><b>3.3.4</b> Third training - second fitted model less non-significant bins</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#model-results"><i class="fa fa-check"></i><b>3.4</b> Model results</a><ul>
<li class="chapter" data-level="3.4.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#final-list-of-variables"><i class="fa fa-check"></i><b>3.4.1</b> Final list of variables</a></li>
<li class="chapter" data-level="3.4.2" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#scoring"><i class="fa fa-check"></i><b>3.4.2</b> Scoring</a></li>
<li class="chapter" data-level="3.4.3" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#model-scorecard"><i class="fa fa-check"></i><b>3.4.3</b> Model scorecard</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#training-set"><i class="fa fa-check"></i><b>3.5</b> Training set</a><ul>
<li class="chapter" data-level="3.5.1" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#densities-of-the-training-results"><i class="fa fa-check"></i><b>3.5.1</b> Densities of the training results</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#test-set"><i class="fa fa-check"></i><b>3.6</b> Test set</a></li>
<li class="chapter" data-level="3.7" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#confusion-matrix"><i class="fa fa-check"></i><b>3.7</b> Confusion matrix</a></li>
<li class="chapter" data-level="3.8" data-path="logistic-regression-model-and-credit-scorecard.html"><a href="logistic-regression-model-and-credit-scorecard.html#roc-curve"><i class="fa fa-check"></i><b>3.8</b> ROC Curve</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>4</b> Conclusion</a></li>
<li class="chapter" data-level="5" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html"><i class="fa fa-check"></i><b>5</b> Errands and post-mortem</a><ul>
<li class="chapter" data-level="5.1" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#modeling"><i class="fa fa-check"></i><b>5.1</b> Modeling</a></li>
<li class="chapter" data-level="5.2" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#geographical-data"><i class="fa fa-check"></i><b>5.2</b> Geographical data</a></li>
<li class="chapter" data-level="5.3" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#stochastic-gradient-descent"><i class="fa fa-check"></i><b>5.3</b> Stochastic Gradient Descent</a><ul>
<li class="chapter" data-level="5.3.1" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#conclusions"><i class="fa fa-check"></i><b>5.3.1</b> Conclusions</a></li>
<li class="chapter" data-level="5.3.2" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#gradient-descent"><i class="fa fa-check"></i><b>5.3.2</b> Gradient descent</a></li>
<li class="chapter" data-level="5.3.3" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#stochastic-gradient-descent-1"><i class="fa fa-check"></i><b>5.3.3</b> Stochastic Gradient Descent</a></li>
<li class="chapter" data-level="5.3.4" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#cost-function-for-multi-modal-npv"><i class="fa fa-check"></i><b>5.3.4</b> Cost function for multi-modal NPV</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="errands-and-post-mortem.html"><a href="errands-and-post-mortem.html#final-final-conclusion"><i class="fa fa-check"></i><b>5.4</b> Final final Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>6</b> Appendix</a><ul>
<li class="chapter" data-level="6.1" data-path="appendix.html"><a href="appendix.html#sec:list-assumptions"><i class="fa fa-check"></i><b>6.1</b> List of assumptions / limitations regarding the dataset</a></li>
<li class="chapter" data-level="6.2" data-path="appendix.html"><a href="appendix.html#data-preparation-and-formatting"><i class="fa fa-check"></i><b>6.2</b> Data preparation and formatting</a><ul>
<li class="chapter" data-level="6.2.1" data-path="appendix.html"><a href="appendix.html#sec:lendingclub-dataset"><i class="fa fa-check"></i><b>6.2.1</b> LendingClub dataset</a></li>
<li class="chapter" data-level="6.2.2" data-path="appendix.html"><a href="appendix.html#zip-codes-and-fips-codes"><i class="fa fa-check"></i><b>6.2.2</b> Zip codes and FIPS codes</a></li>
<li class="chapter" data-level="6.2.3" data-path="appendix.html"><a href="appendix.html#market-interest-rates"><i class="fa fa-check"></i><b>6.2.3</b> Market interest rates</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="appendix.html"><a href="appendix.html#sec:list-model-variables"><i class="fa fa-check"></i><b>6.3</b> List of variables</a></li>
<li class="chapter" data-level="6.4" data-path="appendix.html"><a href="appendix.html#maxima-derivation-of-the-cost-function"><i class="fa fa-check"></i><b>6.4</b> Maxima derivation of the cost function</a></li>
<li class="chapter" data-level="6.5" data-path="appendix.html"><a href="appendix.html#system-version"><i class="fa fa-check"></i><b>6.5</b> System version</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org/" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">LendingClub Loans Pricing</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="logistic-regression-model-and-credit-scorecard" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Logistic Regression Model and Credit Scorecard</h1>


<p>At the outset, the dataset presents a number of challenges:</p>
<ul>
<li><p>There is a mix of continuous and categorical data.</p></li>
<li><p>The number of observations is very large.</p></li>
<li><p>The number of predictors is potential large, in particular if we perform one-hot encoding of categorical values.</p></li>
<li><p>The dataset has no context or reference point to interpret dollar amounts. We all intuitively understands that owing $10 or $1,000,000 are very different matters. Owing $1,000 when living in New York is different from owing $1,000 if living on $2 per day in a developing country (surrounding economic environment matter). That intuition is shared economic knowledge, but that intuition is nowhere represented in the dataset. As readers, we automatically attribute that implicit knowledge to the data we read in the dataset. However, any model based on that data will never reflect that implicit knowledge if we do not supplement with external data. As shown in the previous section, credit margins have changed over time. This is clearly related to the wider US economic environment. Financial hardship is a key driver for some of the loans. Availability of disposable income is important to assess the ability to repay. Therefore, the cost of living, which varies from state to state, seems relevant.</p></li>
</ul>
<p><span class="math display">\[\text{ }\]</span></p>

<table>
<thead>
<tr>
<th style="text-align:left;">
WARNING:
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;width: 15cm; ">
IF YOU RUN THE MODELING SECTION, YOU WILL NEED UP TO 32GB OF MEMORY, AND EXPECT A LOT OF DISK SWAPPING WHEN DATASETS ARE JUGGLED IN AND OUT OF MEMORY TO DISK TO MINIMISE MEMORY USAGE. CALCULATION TIMES ARE BY BATCHES UP TO 10 MINUTES (DEPENDING ON HARDWARE). THIS EXCLUDES TIME NECESSARY TO PREPARE THE DATASET AS EXPLAINED ON THE PREVIOUS SECTIONS (THAT IS HOURS).
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<div id="logistic-regression" class="section level2">
<h2><span class="header-section-number">3.1</span> Logistic Regression</h2>
<p><em>Logistic models</em> (also called <em>logit model</em>) are used to model binary events. Examples would be passing or failing an exam, a newborn being a boy or a girl, a voter choosing one of two political parties, or – relevant to us – a borrower defaulting or not on a loan. If the binary variable is modeled as a 0/1 outcome, the model will yield a value between 0 and 1 which can be used as a probabilty.</p>
<p>We are interested in using a number of variables (being continuous and/or categorical) to model the binary response. A first port-of-call model is a linear combination of the variables. Since the predicted value would be continuous and not be bounded by 0/1, the outcome is transformed. A commonly used transformation of the logodds (logarithm of the odds given a particular probability) <span class="math inline">\(\log \left( \frac{p}{1 - p} \right)\)</span>. This expression has a few advantages: it converts any value (between <span class="math inline">\(- \infty\)</span> and <span class="math inline">\(+\infty\)</span> produced by the linear regression), and it is symmetrical around <span class="math inline">\(x = 0\)</span> and <span class="math inline">\(y = 1/2\)</span>. That is, using the odds instead of the probability avoids infinity; it behaves identically when p approaches 0 or 1. The reciprocal of the logodds is <span class="math inline">\(p = \frac{1}{1 - e^{-x}}\)</span>.</p>
<p>For a number of <span class="math inline">\(X_i\)</span> variables, the model to fit is then:</p>
<p><span class="math display">\[ \text{logodds}(p) = \sum_i{\alpha_i X_i} \space \space \space \equiv \space \space \space p =  \frac{1}{1 - e^{-\sum_i{\alpha_i X_i}}}\]</span></p>
<p>A commonly used format to evaluate the creditworthiness of a borrower is to create scorecards whereby particular characteristics are segmented into intervals and attributed discrete scores. In plain English, a continuous variable (say the age of the applicant) is segmented into intervals, called <em>bins</em>, (e.g. 0-18 year-olds, 18-26 year-olds,…), and then given a score. Those different segments become categorical variables. The task of the model is to:</p>
<ul>
<li><p>identify the best way to segment a continuous variable to maximise the information value of the different bins. Intuitively, empty or quasi-empty bins (either no or few applicants in the bin) are not very informative; bins for which the response is completely random are not informative, whereas a bin where the response always has the same response is informative (i.e. anybody with income of 0 and 10 dolars per year will default, anybody with a salary of $1 million per month will repay).</p></li>
<li><p>use a generalised linear model using the new categorical variables;</p></li>
<li><p>transforms the linear coefficients estimated for each category into numerical scores.</p></li>
</ul>
<div id="data-preparation" class="section level3">
<h3><span class="header-section-number">3.1.1</span> Data preparation</h3>
<p>The initial preparation of the dataset takes place in the <code>CleanLoan.Rmd</code> file where we bind:</p>
<ul>
<li><p>the raw LendingClub dataset (see file <code>Scripts/R-data-preparation.Rmd</code> for how it was prepared);</p></li>
<li><p>from that raw set, only retain the variables that we selected to be used in the model (see column “Used in model?” in subsection <a href="appendix.html#sec:list-model-variables">6.3</a>);</p></li>
<li><p>the NPV, IRR and credit margins calculated; and,</p></li>
<li><p>the percentage of principal lost.</p></li>
</ul>
<p>Some variables (such as relating to financial outcomes) are used for visualisations, not predictions.</p>




















<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" href="#cb3-1" data-line-number="1"><span class="co"># Quirk in bookdown?...</span></a>
<a class="sourceLine" id="cb3-2" href="#cb3-2" data-line-number="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb3-3" href="#cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" href="#cb3-4" data-line-number="4"><span class="co">#########################################################################################</span></a>
<a class="sourceLine" id="cb3-5" href="#cb3-5" data-line-number="5"><span class="co">##</span></a>
<a class="sourceLine" id="cb3-6" href="#cb3-6" data-line-number="6"><span class="co">## select the variables that might be used to create the training+test set</span></a>
<a class="sourceLine" id="cb3-7" href="#cb3-7" data-line-number="7"><span class="co">## </span></a>
<a class="sourceLine" id="cb3-8" href="#cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" href="#cb3-9" data-line-number="9">modelVarsIn &lt;-<span class="st"> </span><span class="kw">c</span>(LC_variable[LC_variable<span class="op">$</span>inModel <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>, <span class="st">&quot;variable_name&quot;</span>])<span class="op">$</span>variable_name</a>
<a class="sourceLine" id="cb3-10" href="#cb3-10" data-line-number="10">modelVarsIn &lt;-<span class="st"> </span><span class="kw">c</span>(modelVarsIn, </a>
<a class="sourceLine" id="cb3-11" href="#cb3-11" data-line-number="11">                 <span class="st">&quot;grade_num&quot;</span>, <span class="st">&quot;sub_grade_num&quot;</span>, </a>
<a class="sourceLine" id="cb3-12" href="#cb3-12" data-line-number="12">                 <span class="st">&quot;principal_loss_pct&quot;</span>, <span class="st">&quot;creditMargin&quot;</span>, <span class="st">&quot;monthDefault&quot;</span>)</a>
<a class="sourceLine" id="cb3-13" href="#cb3-13" data-line-number="13"></a>
<a class="sourceLine" id="cb3-14" href="#cb3-14" data-line-number="14"><span class="co"># Make sure that some variables are NOT in included in the final training set</span></a>
<a class="sourceLine" id="cb3-15" href="#cb3-15" data-line-number="15">modelVarsOut &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;grade_num&quot;</span>, <span class="st">&quot;sub_grade_num&quot;</span>, </a>
<a class="sourceLine" id="cb3-16" href="#cb3-16" data-line-number="16">                  <span class="st">&quot;principal_loss_pct&quot;</span>, <span class="st">&quot;creditMargin&quot;</span>, <span class="st">&quot;monthDefault&quot;</span>, </a>
<a class="sourceLine" id="cb3-17" href="#cb3-17" data-line-number="17">                  <span class="st">&quot;zip_code&quot;</span>)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We prepare a dataset with ONLY the predictors NOT removing NA’s.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" href="#cb4-1" data-line-number="1"><span class="co">## ######################################################################################</span></a>
<a class="sourceLine" id="cb4-2" href="#cb4-2" data-line-number="2"><span class="co">##</span></a>
<a class="sourceLine" id="cb4-3" href="#cb4-3" data-line-number="3"><span class="co">## Prepare a dataset with ONLY the predictors NOT removing NA&#39;s</span></a>
<a class="sourceLine" id="cb4-4" href="#cb4-4" data-line-number="4"><span class="co">## </span></a>
<a class="sourceLine" id="cb4-5" href="#cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" href="#cb4-6" data-line-number="6">loansPredictors &lt;-</a>
<a class="sourceLine" id="cb4-7" href="#cb4-7" data-line-number="7"><span class="st">  </span>loansWorkingSet <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-8" href="#cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" href="#cb4-9" data-line-number="9"><span class="st">  </span><span class="co"># Keep the chosen predictors</span></a>
<a class="sourceLine" id="cb4-10" href="#cb4-10" data-line-number="10"><span class="st">  </span><span class="co"># Use tidyselect::one_of() to avoid errors if column does not exist</span></a>
<a class="sourceLine" id="cb4-11" href="#cb4-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="kw">one_of</span>(modelVarsIn)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-12" href="#cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" href="#cb4-13" data-line-number="13"><span class="st">  </span><span class="co">##</span></a>
<a class="sourceLine" id="cb4-14" href="#cb4-14" data-line-number="14"><span class="st">  </span><span class="co">## Dates to numeric, in &#39;decimal&#39; years since 2000</span></a>
<a class="sourceLine" id="cb4-15" href="#cb4-15" data-line-number="15"><span class="st">  </span><span class="co">##</span></a>
<a class="sourceLine" id="cb4-16" href="#cb4-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">c</span>(<span class="st">&quot;issue_d&quot;</span>, <span class="st">&quot;earliest_cr_line&quot;</span>), <span class="cf">function</span>(d) {</a>
<a class="sourceLine" id="cb4-17" href="#cb4-17" data-line-number="17">    <span class="kw">return</span>(<span class="kw">year</span>(d) <span class="op">-</span><span class="st"> </span><span class="dv">2000</span> <span class="op">+</span><span class="st"> </span>(<span class="kw">month</span>(d) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="dv">12</span>)</a>
<a class="sourceLine" id="cb4-18" href="#cb4-18" data-line-number="18">  }) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-19" href="#cb4-19" data-line-number="19"></a>
<a class="sourceLine" id="cb4-20" href="#cb4-20" data-line-number="20"><span class="st">  </span><span class="co">## Add polynomials of the dates to model the time-trend shape</span></a>
<a class="sourceLine" id="cb4-21" href="#cb4-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb4-22" href="#cb4-22" data-line-number="22">    <span class="dt">issue_d2 =</span> issue_d<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb4-23" href="#cb4-23" data-line-number="23">    <span class="dt">issue_d3 =</span> issue_d<span class="op">^</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb4-24" href="#cb4-24" data-line-number="24">    <span class="dt">earliest_cr_line2 =</span> earliest_cr_line<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb4-25" href="#cb4-25" data-line-number="25">    <span class="dt">earliest_cr_line3 =</span> earliest_cr_line<span class="op">^</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb4-26" href="#cb4-26" data-line-number="26">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-27" href="#cb4-27" data-line-number="27"></a>
<a class="sourceLine" id="cb4-28" href="#cb4-28" data-line-number="28"><span class="st">  </span><span class="co">## Create a logical flag TRUE for non-defaulted (good) loans</span></a>
<a class="sourceLine" id="cb4-29" href="#cb4-29" data-line-number="29"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">isGoodLoan =</span> (principal_loss_pct <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.001</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-30" href="#cb4-30" data-line-number="30"></a>
<a class="sourceLine" id="cb4-31" href="#cb4-31" data-line-number="31"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>tidyselect<span class="op">::</span><span class="kw">one_of</span>(modelVarsOut))</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We split the dataset into a training (80%) and test set (20%).</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" href="#cb5-1" data-line-number="1"><span class="co">## ######################################################################################</span></a>
<a class="sourceLine" id="cb5-2" href="#cb5-2" data-line-number="2"><span class="co">##</span></a>
<a class="sourceLine" id="cb5-3" href="#cb5-3" data-line-number="3"><span class="co">## Create training / test sets 80%/20%</span></a>
<a class="sourceLine" id="cb5-4" href="#cb5-4" data-line-number="4"><span class="co">##</span></a>
<a class="sourceLine" id="cb5-5" href="#cb5-5" data-line-number="5">proportionTraining &lt;-<span class="st"> </span><span class="fl">0.8</span></a>
<a class="sourceLine" id="cb5-6" href="#cb5-6" data-line-number="6"><span class="kw">set.seed</span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb5-7" href="#cb5-7" data-line-number="7"></a>
<a class="sourceLine" id="cb5-8" href="#cb5-8" data-line-number="8">nSamples &lt;-<span class="st"> </span><span class="kw">nrow</span>(loansPredictors)</a>
<a class="sourceLine" id="cb5-9" href="#cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" href="#cb5-10" data-line-number="10">sampleTraining &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span>nSamples, <span class="kw">floor</span>(nSamples <span class="op">*</span><span class="st"> </span>proportionTraining), </a>
<a class="sourceLine" id="cb5-11" href="#cb5-11" data-line-number="11">                         <span class="dt">replace =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb5-12" href="#cb5-12" data-line-number="12">loansTraining &lt;-<span class="st"> </span>loansPredictors <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(sampleTraining)</a>
<a class="sourceLine" id="cb5-13" href="#cb5-13" data-line-number="13">loansTest &lt;-<span class="st"> </span>loansPredictors <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="op">-</span>sampleTraining)</a>
<a class="sourceLine" id="cb5-14" href="#cb5-14" data-line-number="14"></a>
<a class="sourceLine" id="cb5-15" href="#cb5-15" data-line-number="15"><span class="co"># Subsets of the training set</span></a>
<a class="sourceLine" id="cb5-16" href="#cb5-16" data-line-number="16"><span class="kw">set.seed</span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb5-17" href="#cb5-17" data-line-number="17">nSamplesTraining &lt;-<span class="st"> </span><span class="kw">nrow</span>(loansTraining)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We also create subsamples of the training set (20% thereof) for when quick calculation need making.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" href="#cb6-1" data-line-number="1"><span class="co"># 20%</span></a>
<a class="sourceLine" id="cb6-2" href="#cb6-2" data-line-number="2">sample20 &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span>nSamplesTraining, <span class="kw">floor</span>(nSamplesTraining <span class="op">*</span><span class="st"> </span><span class="fl">0.20</span>), </a>
<a class="sourceLine" id="cb6-3" href="#cb6-3" data-line-number="3">                   <span class="dt">replace =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb6-4" href="#cb6-4" data-line-number="4">loans20 &lt;-<span class="st"> </span>loansTraining <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(sample20)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>


</div>
</div>
<div id="binning-and-weight-of-evidence" class="section level2">
<h2><span class="header-section-number">3.2</span> Binning and Weight of Evidence</h2>
<p>This subsection owes a debt to the source code of the <code>smbinning</code> package from which we reimplemented some aspects using the <code>tidyverse</code> style (the original source code uses SQL statements to access dataframes), and the documentation vignette of the <code>Information</code> package.<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a> Our code is provided and imported as a package located on github.<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a></p>
<div id="background-1" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Background</h3>
<p>Binning, Weight of Evidence (<em>WoE</em>) and Information Value (<em>IV</em>) have been widely used since the 1950’s to convert continuous values to factors in a way that attempts to maximise the information content of the factors. This is achieved by adjusting the number and location of cut-off points to optimally partition the range of the continuous value.</p>
<p>After coninuous variables are binned, all variables are categorical. Therefore WoE and IV measures then apply to either types of variables. They have some very important features:</p>
<p>WOE and IV enable to:</p>
<ul>
<li><p>Consider each variable’s independent contribution to the outcome. This is <span class="math inline">\(\mathcal{O}(n)\)</span> for <span class="math inline">\(n\)</span> variables instead of <span class="math inline">\(\mathcal{O}(n^2)\)</span> or <span class="math inline">\(\mathcal{O}(n \log(n))\)</span> of many algorithms;</p>
<ul>
<li><p>The WoE is a <strong>factor-related</strong> measure which assesses the relevance of each factor for a given variable;</p></li>
<li><p>The IV is a <strong>variable-related</strong> measure which enables ranking variables between each other;</p></li>
<li><p>The theoretical background to the measures lies in information theory. It cannot be over-emphasized that the measures <strong>do not</strong> use the values of the factors: it is measure only calculated using the number of GOOD/BAD outcomes (see definitions below);</p></li>
<li><p>Any NA values can be given their own factor: NAs are easily handle without filling values considerations. Given the previous point: the fact that NAs are present has no impact on the measures calculations! Sparse, incomplete or badly filled dataset are easily handled!</p></li>
<li><p>The calculation is simple and quick (size of the dataset is not an issue in our case);</p></li>
<li><p>The interpretation and visualisation of those measures is easy and intuitive;</p></li>
</ul></li>
</ul>
</div>
<div id="binning" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Binning</h3>
<p>The binning of a continuous variable is handled by the <code>partykit</code> package which produces <em>Conditional Inference Trees</em>. We will not describe the algorithm and the R package. See <span class="citation">(Hothorn, Hornik, and Zeileis <a href="#ref-doi:10.1198/106186006X133933">2006</a>)</span> for the theoretical background on Conditional Inference Trees, and <span class="citation">(Hothorn and Zeileis <a href="#ref-JMLR:v16:hothorn15a">2015</a>)</span> for a description of <code>partykit</code> implementation.</p>
</div>
<div id="woe-and-iv-definitions" class="section level3">
<h3><span class="header-section-number">3.2.3</span> WOE and IV definitions</h3>
<p>(This subsections is a modified copy for the <code>Information</code> R package vignette).</p>
<p>Let us have a binary dependent variable <span class="math inline">\(Y\)</span> and a predictive variable <span class="math inline">\(X\)</span> taking a discrete set of values <span class="math inline">\(x_1\)</span> to <span class="math inline">\(x_p\)</span> (the factors). <span class="math inline">\(Y\)</span> captures the loan defaults. Basically, the <span class="math inline">\(x_i\)</span> represent one-hot encoding of the variable <span class="math inline">\(X\)</span>.</p>
<p>In this situation, Naive Bayes can be formulated in a logarithmic form as:</p>
<p><span class="math display">\[\log \frac{P(Y=1| x_1, \ldots, x_p)}{P(Y=0 | x_1, \ldots, x_p)} = \log \frac{P(Y=1)}{P(Y=0)} + \sum_{j=1}^p \log \frac{f(x_j | Y=1)}{f(x_j | Y=0)}\]</span></p>
<p>The naive Bayes model essentially says that the conditional log odds is equal to the sum of the individual factors (which will be the WoE). The word “naive” comes from the fact that this model relies on the assumption that all predictors are conditionally independent given Y, which is a highly optimistic (i.e. unrealistic) assumption.</p>
<div id="weight-of-evidence" class="section level4">
<h4><span class="header-section-number">3.2.3.1</span> Weight of Evidence</h4>
<p>This can be remormulated in terms with <span class="math inline">\(P(Y=1 | X = x_j)\)</span> replaced by <span class="math inline">\(GOOD_j\)</span> being the proportion of good loans when only looking at bin j (how many good loans in that bin divided by the total number of loans in that bin), and similarly <span class="math inline">\(P(Y=0 | X = x_j)\)</span> replaced by <span class="math inline">\(BAD_j\)</span>. We also define <span class="math inline">\(GOOD\)</span> as the proportion of good loans for the <em>entire variable</em> <span class="math inline">\(X\)</span>. Here, proportion is interchangeable with probability.</p>
<p>We then have:</p>
<p><span class="math display">\[\log \frac{GOOD_j}{BAD_j} = \underbrace{\log \frac{GOOD}{BAD}}_{\text{sample log-odds}} + \underbrace{\log \frac{f(x_j | GOOD)}{f(x_j | BAD)}}_{\text{WOE}}\]</span></p>
<p>This relationship says that the conditional logit of <span class="math inline">\(GOOD_j\)</span> (odds of a good loan in a bin <span class="math inline">\(j\)</span>), given <span class="math inline">\(x_j\)</span>, can be written as the overall log-odds (total odds, i.e., the <em>intercept</em>) plus the log-density ratio – also known as the <em>Weight of Evidence</em>.</p>
<p>Note that the WoE and the conditional log odds of <span class="math inline">\(Y=1\)</span> are perfectly correlated since the <em>ntercept</em> is constant. Hence, the greater the value of WoE, the higher the chance of observing <span class="math inline">\(Y=1\)</span>. In fact, when WoE is positive the chance of of observing <span class="math inline">\(Y=1\)</span> is above average (for the sample), and vice versa when WoE is negative. When WoE equals 0 the odds are simply equal to the sample average.</p>
</div>
<div id="ties-to-naive-bayes-and-logistic-regression" class="section level4">
<h4><span class="header-section-number">3.2.3.2</span> Ties to Naive Bayes and Logistic Regression</h4>
<p>Notice that the left-hand-side of the equation above – i.e., the conditional log odds of the variable – is exactly what we are trying to predict in a logistic regression model. Hence, when building a logistic regression model – which is perhaps the most widely used technique for building binary classifiers – we are actually trying to estimate the weight of evidence.</p>
<p>In our credit scoring situation, a “semi-naive” version of this model is quite popular. The idea is to transform the data into WoE vectors and then use logistic regression to fit the model</p>
<p><span class="math display">\[\log \frac{GOOD_j}{BAD_j} = \log \frac{GOOD}{BAD} + \sum_{j=1}^p \beta_j \log \frac{f(x_j | Y=1)}{f(x_j | Y=0)}\]</span></p>
<p>thus partly relaxing the assumption that all predictors in the model are independent (but not colinear). It should be noted that the underlying WoE vectors are still estimated univariately and that the coefficients merely function as scalars. For a more general model, GAM is a great choice.</p>
<p>As mentioned above, this relationship <em>does not</em> depend on the actual values of the bins; only the number of good and bad loans is used. If a bin represents NAs, the NAs have no impact on the calculation.</p>
</div>
<div id="the-information-value" class="section level4">
<h4><span class="header-section-number">3.2.3.3</span> The Information Value</h4>
<p>We can leverage WoE to measure the predictive strength of <span class="math inline">\(X\)</span> – i.e., how well it helps us separate cases when <span class="math inline">\(Y=1\)</span> from cases when <span class="math inline">\(Y=0\)</span>. This is done through the information value (IV) which is defined for continuous variables as:</p>
<p><span class="math display">\[\text{IV}_j = \int \log \frac{f(X_j | Y=1)}{f(X_j | Y=0)} \, (f(X_j | Y=1) - f(X_j | Y=0)) \, dx\]</span></p>
<p>Note that the IV is essentially a weighted “sum” of all the individual WoE values where the weights incorporate the absolute difference between the numerator and the denominator (WoE captures the relative difference).</p>
</div>
<div id="summary" class="section level4">
<h4><span class="header-section-number">3.2.3.4</span> Summary</h4>
<p>More generally, now considering <span class="math inline">\(k\)</span> variables, the most common approach to estimating the conditional densities needed to calculate WoE is to bin a variable <span class="math inline">\(X_k\)</span> into individual bins <span class="math inline">\(x_{k,j}\)</span> and then use a histogram-type estimate.</p>
<p><span class="math display">\[\text{WoE}_{k,j} = \log \frac{GOOD_{k,j}}{BAD_{k,j}}\]</span></p>
<p>and the IV for variable <span class="math inline">\(X_k\)</span> can be calculated as</p>
<p><span class="math display">\[\text{IV}_k =  \sum_{j} (GOOD_{k,j} - BAD_{k,j}) \times \text{WoE}_{k,j}\]</span></p>
</div>
</div>
<div id="calculating-woe-and-iv" class="section level3">
<h3><span class="header-section-number">3.2.4</span> Calculating WoE and IV</h3>
<p>We took insipration of the <code>smbinning</code> R package to optimally partition continuous variables into factors/bins. We however could not directly use this package as it does not interact with the tidyverse functions and uses SQL statements to access the content of dataframes. This solution enables to easily access SQL databases. But we note the the tiyverse takes the opposite approach of converting R statements into SQL statements.</p>
<p>We decided to implement a few functions that we will require (far from the entire <code>smbinning</code> package) as a new package called <code>binner</code> separately available on GitHub.</p>
<p>Let’s install that package:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" href="#cb7-1" data-line-number="1"><span class="co"># Ensure that `binner` is here and available</span></a>
<a class="sourceLine" id="cb7-2" href="#cb7-2" data-line-number="2"><span class="cf">if</span> (<span class="st">&quot;package:binner&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">search</span>()) { </a>
<a class="sourceLine" id="cb7-3" href="#cb7-3" data-line-number="3">  <span class="kw">detach</span>(<span class="st">&quot;package:binner&quot;</span>, <span class="dt">unload =</span> <span class="ot">TRUE</span>, <span class="dt">force =</span> <span class="ot">TRUE</span>) </a>
<a class="sourceLine" id="cb7-4" href="#cb7-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb7-5" href="#cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" href="#cb7-6" data-line-number="6"><span class="cf">if</span> (<span class="op">!</span>(<span class="st">&quot;binner&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">installed.packages</span>()[,<span class="dv">1</span>])) {</a>
<a class="sourceLine" id="cb7-7" href="#cb7-7" data-line-number="7">  devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;Emmanuel-R8/SMBinning&quot;</span>)</a>
<a class="sourceLine" id="cb7-8" href="#cb7-8" data-line-number="8">}</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>and attach it to the environment.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" href="#cb8-1" data-line-number="1"><span class="kw">library</span>(binner)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
</div>
<div id="loop-through-all-variables" class="section level3">
<h3><span class="header-section-number">3.2.5</span> Loop through all variables</h3>
<p>Before creating the bins, we create a new dataframe and transform some string values to factors.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" href="#cb9-1" data-line-number="1">loansBinning &lt;-<span class="st"> </span>loansTraining <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" href="#cb9-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb9-3" href="#cb9-3" data-line-number="3">    <span class="dt">home_ownership =</span> <span class="kw">as_factor</span>(home_ownership),</a>
<a class="sourceLine" id="cb9-4" href="#cb9-4" data-line-number="4">    <span class="dt">emp_length =</span> <span class="kw">as_factor</span>(emp_length),</a>
<a class="sourceLine" id="cb9-5" href="#cb9-5" data-line-number="5">    <span class="dt">grade =</span> <span class="kw">as_factor</span>(grade)</a>
<a class="sourceLine" id="cb9-6" href="#cb9-6" data-line-number="6">  )</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>For each variable we will create a new entry in a new tibble.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" href="#cb10-1" data-line-number="1"><span class="co">#########################################################################################</span></a>
<a class="sourceLine" id="cb10-2" href="#cb10-2" data-line-number="2"><span class="co">##</span></a>
<a class="sourceLine" id="cb10-3" href="#cb10-3" data-line-number="3"><span class="co">## New tibble to store the list of bins + Weight of Evidences factors</span></a>
<a class="sourceLine" id="cb10-4" href="#cb10-4" data-line-number="4"><span class="co">##</span></a>
<a class="sourceLine" id="cb10-5" href="#cb10-5" data-line-number="5">listBins &lt;-</a>
<a class="sourceLine" id="cb10-6" href="#cb10-6" data-line-number="6"><span class="st">  </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb10-7" href="#cb10-7" data-line-number="7">    <span class="dt">variable =</span> <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb10-8" href="#cb10-8" data-line-number="8">    <span class="dt">type =</span> <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb10-9" href="#cb10-9" data-line-number="9">    <span class="dt">IV =</span> <span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb10-10" href="#cb10-10" data-line-number="10">    <span class="dt">WoE =</span> <span class="kw">list</span>(), </a>
<a class="sourceLine" id="cb10-11" href="#cb10-11" data-line-number="11">    <span class="dt">.rows =</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb10-12" href="#cb10-12" data-line-number="12">  )</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We then loop through each variable to create factors (for continuous variables) and calculate a table with the Weights of Evidence. We then calculate the Information Value.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" href="#cb11-1" data-line-number="1"><span class="co"># About 500 sec wall-time</span></a>
<a class="sourceLine" id="cb11-2" href="#cb11-2" data-line-number="2">startTime &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb11-3" href="#cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" href="#cb11-4" data-line-number="4"><span class="cf">for</span> (n <span class="cf">in</span> <span class="kw">names</span>(loansBinning)) {</a>
<a class="sourceLine" id="cb11-5" href="#cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" href="#cb11-6" data-line-number="6">  <span class="co"># We don&#39;t test the response with itself</span></a>
<a class="sourceLine" id="cb11-7" href="#cb11-7" data-line-number="7">  <span class="cf">if</span> (n <span class="op">!=</span><span class="st"> &quot;isGoodLoan&quot;</span>) {</a>
<a class="sourceLine" id="cb11-8" href="#cb11-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb11-9" href="#cb11-9" data-line-number="9">    <span class="co"># For categorical variable</span></a>
<a class="sourceLine" id="cb11-10" href="#cb11-10" data-line-number="10">    <span class="cf">if</span> (<span class="kw">class</span>(loansBinning[[<span class="dv">1</span>, n]]) <span class="op">==</span><span class="st"> &quot;factor&quot;</span>) {</a>
<a class="sourceLine" id="cb11-11" href="#cb11-11" data-line-number="11">      <span class="co"># cat(&quot; is a factor, &quot;)</span></a>
<a class="sourceLine" id="cb11-12" href="#cb11-12" data-line-number="12">      result &lt;-<span class="st"> </span><span class="kw">WoETableCategorical</span>(</a>
<a class="sourceLine" id="cb11-13" href="#cb11-13" data-line-number="13">        <span class="dt">df =</span> loansBinning,</a>
<a class="sourceLine" id="cb11-14" href="#cb11-14" data-line-number="14">        <span class="dt">x =</span> n,</a>
<a class="sourceLine" id="cb11-15" href="#cb11-15" data-line-number="15">        <span class="dt">y =</span> <span class="st">&quot;isGoodLoan&quot;</span>,</a>
<a class="sourceLine" id="cb11-16" href="#cb11-16" data-line-number="16">        <span class="dt">maxCategories =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb11-17" href="#cb11-17" data-line-number="17"></a>
<a class="sourceLine" id="cb11-18" href="#cb11-18" data-line-number="18">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb11-19" href="#cb11-19" data-line-number="19">    <span class="co"># For continuous variable</span></a>
<a class="sourceLine" id="cb11-20" href="#cb11-20" data-line-number="20">      result &lt;-<span class="st"> </span><span class="kw">WoETableContinuous</span>(<span class="dt">df =</span> loansBinning,</a>
<a class="sourceLine" id="cb11-21" href="#cb11-21" data-line-number="21">                                   <span class="dt">x =</span> n,</a>
<a class="sourceLine" id="cb11-22" href="#cb11-22" data-line-number="22">                                   <span class="dt">y =</span> <span class="st">&quot;isGoodLoan&quot;</span>,</a>
<a class="sourceLine" id="cb11-23" href="#cb11-23" data-line-number="23">                                   <span class="dt">p =</span> <span class="fl">0.05</span>)</a>
<a class="sourceLine" id="cb11-24" href="#cb11-24" data-line-number="24">    }</a>
<a class="sourceLine" id="cb11-25" href="#cb11-25" data-line-number="25"></a>
<a class="sourceLine" id="cb11-26" href="#cb11-26" data-line-number="26">    <span class="kw">tryCatch</span>({</a>
<a class="sourceLine" id="cb11-27" href="#cb11-27" data-line-number="27">      <span class="cf">if</span> (<span class="kw">is.na</span>(result)) {</a>
<a class="sourceLine" id="cb11-28" href="#cb11-28" data-line-number="28">        <span class="co"># In case no WoE table is create (of not enough bins)</span></a>
<a class="sourceLine" id="cb11-29" href="#cb11-29" data-line-number="29">        <span class="kw">add_row</span>(</a>
<a class="sourceLine" id="cb11-30" href="#cb11-30" data-line-number="30">          listBins,</a>
<a class="sourceLine" id="cb11-31" href="#cb11-31" data-line-number="31">          <span class="dt">variable =</span> n,</a>
<a class="sourceLine" id="cb11-32" href="#cb11-32" data-line-number="32">          <span class="dt">type =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb11-33" href="#cb11-33" data-line-number="33">          <span class="dt">IV =</span> <span class="ot">NA</span></a>
<a class="sourceLine" id="cb11-34" href="#cb11-34" data-line-number="34">        )</a>
<a class="sourceLine" id="cb11-35" href="#cb11-35" data-line-number="35">      } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb11-36" href="#cb11-36" data-line-number="36"></a>
<a class="sourceLine" id="cb11-37" href="#cb11-37" data-line-number="37">        listBins &lt;-<span class="st"> </span>listBins <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-38" href="#cb11-38" data-line-number="38"><span class="st">          </span><span class="kw">add_row</span>(</a>
<a class="sourceLine" id="cb11-39" href="#cb11-39" data-line-number="39">            <span class="dt">variable =</span> n,</a>
<a class="sourceLine" id="cb11-40" href="#cb11-40" data-line-number="40">            <span class="dt">type =</span> result<span class="op">$</span>type,</a>
<a class="sourceLine" id="cb11-41" href="#cb11-41" data-line-number="41">            <span class="dt">IV =</span> result<span class="op">$</span>IV,</a>
<a class="sourceLine" id="cb11-42" href="#cb11-42" data-line-number="42">            <span class="dt">WoE =</span> <span class="kw">list</span>(result<span class="op">$</span>table)</a>
<a class="sourceLine" id="cb11-43" href="#cb11-43" data-line-number="43">          )</a>
<a class="sourceLine" id="cb11-44" href="#cb11-44" data-line-number="44">        </a>
<a class="sourceLine" id="cb11-45" href="#cb11-45" data-line-number="45">        }</a>
<a class="sourceLine" id="cb11-46" href="#cb11-46" data-line-number="46">    },</a>
<a class="sourceLine" id="cb11-47" href="#cb11-47" data-line-number="47">    <span class="dt">finally =</span> {})</a>
<a class="sourceLine" id="cb11-48" href="#cb11-48" data-line-number="48">  }</a>
<a class="sourceLine" id="cb11-49" href="#cb11-49" data-line-number="49">}</a>
<a class="sourceLine" id="cb11-50" href="#cb11-50" data-line-number="50"><span class="kw">cat</span>(<span class="st">&quot;-- Lapsed time: &quot;</span>, <span class="kw">proc.time</span>() <span class="op">-</span><span class="st"> </span>startTime)</a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb12-1" href="#cb12-1" data-line-number="1">## -- Lapsed time:  422.055 2.746 434.719 0 0</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>


</div>
<div id="select-relevant-variables" class="section level3">
<h3><span class="header-section-number">3.2.6</span> Select relevant variables</h3>
<p>Table <a href="logistic-regression-model-and-credit-scorecard.html#tab:05-01-information-value-table">3.1</a> guidelines are recommended to the relevance of variables given their Information Value <span class="citation">(Bokhari <a href="#ref-bokhari2019credit">2019</a>)</span>.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<table>
<caption>
<span id="tab:05-01-information-value-table">Table 3.1: </span>Variable relevance by Information Value
</caption>
<thead>
<tr>
<th style="text-align:left;">
Information Value
</th>
<th style="text-align:left;">
Relevance
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
IV &lt; 2%
</td>
<td style="text-align:left;">
useless
</td>
</tr>
<tr>
<td style="text-align:left;">
2% &lt; IV &lt; 10%
</td>
<td style="text-align:left;">
weak
</td>
</tr>
<tr>
<td style="text-align:left;">
10% &lt; IV &lt; 30%
</td>
<td style="text-align:left;">
medium
</td>
</tr>
<tr>
<td style="text-align:left;">
30% &lt; IV &lt; 50%
</td>
<td style="text-align:left;">
strong
</td>
</tr>
<tr>
<td style="text-align:left;">
50% &lt; IV
</td>
<td style="text-align:left;">
warning: something is probably wrong!
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p>The 15 best variables (in terms of Information Value in excess of 2%) are in Table <a href="logistic-regression-model-and-credit-scorecard.html#tab:05-01-create-bestbins-10best">3.2</a>:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" href="#cb13-1" data-line-number="1">bestBins &lt;-<span class="st"> </span>listBins <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(IV <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.02</span>)</a>
<a class="sourceLine" id="cb13-2" href="#cb13-2" data-line-number="2"></a>
<a class="sourceLine" id="cb13-3" href="#cb13-3" data-line-number="3">bestBins <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-4" href="#cb13-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(variable, IV) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-5" href="#cb13-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">IV =</span> <span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>IV, <span class="dt">digits =</span> <span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-6" href="#cb13-6" data-line-number="6"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(IV)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-7" href="#cb13-7" data-line-number="7"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-8" href="#cb13-8" data-line-number="8"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;15 top variables by IV&quot;</span>, <span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<table>
<caption>
<span id="tab:05-01-create-bestbins-10best">Table 3.2: </span>15 top variables by IV
</caption>
<thead>
<tr>
<th style="text-align:left;">
variable
</th>
<th style="text-align:right;">
IV
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
sub_grade
</td>
<td style="text-align:right;">
49.39
</td>
</tr>
<tr>
<td style="text-align:left;">
int_rate
</td>
<td style="text-align:right;">
46.53
</td>
</tr>
<tr>
<td style="text-align:left;">
grade
</td>
<td style="text-align:right;">
46.02
</td>
</tr>
<tr>
<td style="text-align:left;">
term
</td>
<td style="text-align:right;">
17.33
</td>
</tr>
<tr>
<td style="text-align:left;">
dti
</td>
<td style="text-align:right;">
7.45
</td>
</tr>
<tr>
<td style="text-align:left;">
verification_status
</td>
<td style="text-align:right;">
5.68
</td>
</tr>
<tr>
<td style="text-align:left;">
avg_cur_bal
</td>
<td style="text-align:right;">
5.43
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_hi_cred_lim
</td>
<td style="text-align:right;">
5.00
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_op_past_12m
</td>
<td style="text-align:right;">
4.85
</td>
</tr>
<tr>
<td style="text-align:left;">
mort_acc
</td>
<td style="text-align:right;">
4.38
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bc_limit
</td>
<td style="text-align:right;">
4.12
</td>
</tr>
<tr>
<td style="text-align:left;">
issue_d2
</td>
<td style="text-align:right;">
4.09
</td>
</tr>
<tr>
<td style="text-align:left;">
issue_d3
</td>
<td style="text-align:right;">
4.09
</td>
</tr>
<tr>
<td style="text-align:left;">
issue_d
</td>
<td style="text-align:right;">
4.08
</td>
</tr>
<tr>
<td style="text-align:left;">
loan_amnt
</td>
<td style="text-align:right;">
3.62
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p>However, we notice that this list includes variables that would not be available at the time the credit scoring is performed.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" href="#cb14-1" data-line-number="1">bestBins &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb14-2" href="#cb14-2" data-line-number="2"><span class="st">  </span>bestBins <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" href="#cb14-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>(variable <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb14-4" href="#cb14-4" data-line-number="4">    <span class="st">&quot;loanID&quot;</span>, <span class="st">&quot;term&quot;</span>, <span class="st">&quot;int_rate&quot;</span>, <span class="st">&quot;creditMargin&quot;</span>, <span class="st">&quot;loan_status&quot;</span>,</a>
<a class="sourceLine" id="cb14-5" href="#cb14-5" data-line-number="5">    <span class="st">&quot;grade&quot;</span>, <span class="st">&quot;sub_grade&quot;</span>, <span class="st">&quot;grade_num&quot;</span>, <span class="st">&quot;sub_grade_num&quot;</span>,</a>
<a class="sourceLine" id="cb14-6" href="#cb14-6" data-line-number="6">    <span class="st">&quot;emp_length&quot;</span>, <span class="st">&quot;home_ownership&quot;</span>, <span class="st">&quot;monthDefault&quot;</span>,</a>
<a class="sourceLine" id="cb14-7" href="#cb14-7" data-line-number="7">    <span class="st">&quot;principal_loss_pct&quot;</span>, <span class="st">&quot;creditMargin&quot;</span>, <span class="st">&quot;monthDefault&quot;</span>,</a>
<a class="sourceLine" id="cb14-8" href="#cb14-8" data-line-number="8">    <span class="st">&quot;isGoodLoan&quot;</span>)))</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>


<p>The 15 most informative variables that will retain are in the following table. Interestingly, the square and cubic powers of the issue date are retained. (Recall subsebtion <a href="dataset.html#sec:feature-engineering">2.3.1</a> on this being the only feature engineering.)</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" href="#cb15-1" data-line-number="1">bestBins <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-2" href="#cb15-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(variable, IV) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-3" href="#cb15-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">IV =</span> <span class="kw">round</span>(IV, <span class="dt">digits =</span> <span class="dv">5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-4" href="#cb15-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(IV)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-5" href="#cb15-5" data-line-number="5"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-6" href="#cb15-6" data-line-number="6"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;15 used top informative variables by IV&quot;</span>, <span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<table>
<caption>
<span id="tab:05-01-create-bestbins-10bestavailable">Table 3.3: </span>15 used top informative variables by IV
</caption>
<thead>
<tr>
<th style="text-align:left;">
variable
</th>
<th style="text-align:right;">
IV
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
dti
</td>
<td style="text-align:right;">
0.074
</td>
</tr>
<tr>
<td style="text-align:left;">
verification_status
</td>
<td style="text-align:right;">
0.057
</td>
</tr>
<tr>
<td style="text-align:left;">
avg_cur_bal
</td>
<td style="text-align:right;">
0.054
</td>
</tr>
<tr>
<td style="text-align:left;">
tot_hi_cred_lim
</td>
<td style="text-align:right;">
0.050
</td>
</tr>
<tr>
<td style="text-align:left;">
num_tl_op_past_12m
</td>
<td style="text-align:right;">
0.049
</td>
</tr>
<tr>
<td style="text-align:left;">
mort_acc
</td>
<td style="text-align:right;">
0.044
</td>
</tr>
<tr>
<td style="text-align:left;">
total_bc_limit
</td>
<td style="text-align:right;">
0.041
</td>
</tr>
<tr>
<td style="text-align:left;">
issue_d2
</td>
<td style="text-align:right;">
0.041
</td>
</tr>
<tr>
<td style="text-align:left;">
issue_d3
</td>
<td style="text-align:right;">
0.041
</td>
</tr>
<tr>
<td style="text-align:left;">
issue_d
</td>
<td style="text-align:right;">
0.041
</td>
</tr>
<tr>
<td style="text-align:left;">
loan_amnt
</td>
<td style="text-align:right;">
0.036
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_inq
</td>
<td style="text-align:right;">
0.035
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_rcnt_tl
</td>
<td style="text-align:right;">
0.034
</td>
</tr>
<tr>
<td style="text-align:left;">
num_actv_rev_tl
</td>
<td style="text-align:right;">
0.034
</td>
</tr>
<tr>
<td style="text-align:left;">
open_rv_24m
</td>
<td style="text-align:right;">
0.033
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p>And the 15 least informative (but retained) variables are:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" href="#cb16-1" data-line-number="1">bestBins <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-2" href="#cb16-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(variable, IV) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-3" href="#cb16-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">IV =</span> <span class="kw">round</span>(IV, <span class="dt">digits =</span> <span class="dv">5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-4" href="#cb16-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(IV) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-5" href="#cb16-5" data-line-number="5"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-6" href="#cb16-6" data-line-number="6"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;15 least informative variables by IV&quot;</span>, <span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<table>
<caption>
<span id="tab:05-01-create-bestbins-10worst">Table 3.4: </span>15 least informative variables by IV
</caption>
<thead>
<tr>
<th style="text-align:left;">
variable
</th>
<th style="text-align:right;">
IV
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
max_bal_bc
</td>
<td style="text-align:right;">
0.021
</td>
</tr>
<tr>
<td style="text-align:left;">
revol_util
</td>
<td style="text-align:right;">
0.025
</td>
</tr>
<tr>
<td style="text-align:left;">
open_rv_12m
</td>
<td style="text-align:right;">
0.026
</td>
</tr>
<tr>
<td style="text-align:left;">
inq_last_6mths
</td>
<td style="text-align:right;">
0.027
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_old_rev_tl_op
</td>
<td style="text-align:right;">
0.027
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_bc
</td>
<td style="text-align:right;">
0.027
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_rcnt_rev_tl_op
</td>
<td style="text-align:right;">
0.030
</td>
</tr>
<tr>
<td style="text-align:left;">
bc_open_to_buy
</td>
<td style="text-align:right;">
0.030
</td>
</tr>
<tr>
<td style="text-align:left;">
bc_util
</td>
<td style="text-align:right;">
0.030
</td>
</tr>
<tr>
<td style="text-align:left;">
num_rev_tl_bal_gt_0
</td>
<td style="text-align:right;">
0.032
</td>
</tr>
<tr>
<td style="text-align:left;">
percent_bc_gt_75
</td>
<td style="text-align:right;">
0.033
</td>
</tr>
<tr>
<td style="text-align:left;">
open_rv_24m
</td>
<td style="text-align:right;">
0.033
</td>
</tr>
<tr>
<td style="text-align:left;">
num_actv_rev_tl
</td>
<td style="text-align:right;">
0.034
</td>
</tr>
<tr>
<td style="text-align:left;">
mo_sin_rcnt_tl
</td>
<td style="text-align:right;">
0.034
</td>
</tr>
<tr>
<td style="text-align:left;">
mths_since_recent_inq
</td>
<td style="text-align:right;">
0.035
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
</div>
<div id="create-data-table-with-one-hot-encoding" class="section level3">
<h3><span class="header-section-number">3.2.7</span> Create data table with one-hot encoding</h3>
<p>Those variable will contain all the best characteristics. Every continuous variable is reformatted into factors reflecting the appropriate bins.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" href="#cb17-1" data-line-number="1"><span class="co"># Those variable will contain all the best characteristics. Every continuous variable is</span></a>
<a class="sourceLine" id="cb17-2" href="#cb17-2" data-line-number="2"><span class="co"># reformatted into factors reflecting the appropriate bins.</span></a>
<a class="sourceLine" id="cb17-3" href="#cb17-3" data-line-number="3">allFactorsAsCharacteristics &lt;-<span class="st"> </span>loansTraining[,<span class="st">&quot;loanID&quot;</span>]</a>
<a class="sourceLine" id="cb17-4" href="#cb17-4" data-line-number="4">allFactorsAsBins &lt;-<span class="st"> </span>loansTraining[,<span class="st">&quot;loanID&quot;</span>]</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>For each variable, we create new variables for each bin in the WoE table of that variable. Strictly speaking, this is not necessary for the generalised model algorithms. They are able to model using categories containing the factors. However, as we will see, the model will generate a number of NAs for variable (factors) which are co-linear. (This is the case for any linear model.) This will require removing those individual factors, which we found easier to do when each factor is given an individual variable (column).</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" href="#cb18-1" data-line-number="1"><span class="cf">for</span> (index <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(bestBins)) {</a>
<a class="sourceLine" id="cb18-2" href="#cb18-2" data-line-number="2"><span class="co">#for (index in 1:27) {</span></a>
<a class="sourceLine" id="cb18-3" href="#cb18-3" data-line-number="3">  name &lt;-<span class="st"> </span>bestBins<span class="op">$</span>variable[index][[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb18-4" href="#cb18-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb18-5" href="#cb18-5" data-line-number="5">  <span class="kw">cat</span>(<span class="st">&quot;--- Variable No. &quot;</span>,</a>
<a class="sourceLine" id="cb18-6" href="#cb18-6" data-line-number="6">      index,</a>
<a class="sourceLine" id="cb18-7" href="#cb18-7" data-line-number="7">      <span class="st">&quot;-- Name: &quot;</span>,</a>
<a class="sourceLine" id="cb18-8" href="#cb18-8" data-line-number="8">      name, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb18-9" href="#cb18-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb18-10" href="#cb18-10" data-line-number="10">  ltIndex &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">names</span>(loansTraining) <span class="op">==</span><span class="st"> </span>name)</a>
<a class="sourceLine" id="cb18-11" href="#cb18-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb18-12" href="#cb18-12" data-line-number="12">  characteristic &lt;-<span class="st"> </span><span class="kw">categoriseFromWoE</span>(<span class="dt">df =</span> loansTraining[, ltIndex],</a>
<a class="sourceLine" id="cb18-13" href="#cb18-13" data-line-number="13">                                      <span class="dt">varName =</span>  name,</a>
<a class="sourceLine" id="cb18-14" href="#cb18-14" data-line-number="14">                                      <span class="dt">woeTable =</span> bestBins<span class="op">$</span>WoE[index][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb18-15" href="#cb18-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb18-16" href="#cb18-16" data-line-number="16">  bins &lt;-<span class="st"> </span><span class="kw">categoriseFromWoE.Wide</span>(<span class="dt">df =</span> loansTraining[, ltIndex],</a>
<a class="sourceLine" id="cb18-17" href="#cb18-17" data-line-number="17">                                 <span class="dt">varName =</span>  name,</a>
<a class="sourceLine" id="cb18-18" href="#cb18-18" data-line-number="18">                                 <span class="dt">woeTable =</span> bestBins<span class="op">$</span>WoE[index][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb18-19" href="#cb18-19" data-line-number="19">  </a>
<a class="sourceLine" id="cb18-20" href="#cb18-20" data-line-number="20">  allFactorsAsCharacteristics &lt;-</a>
<a class="sourceLine" id="cb18-21" href="#cb18-21" data-line-number="21"><span class="st">    </span>allFactorsAsCharacteristics <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-22" href="#cb18-22" data-line-number="22"><span class="st">    </span><span class="kw">cbind</span>(characteristic)</a>
<a class="sourceLine" id="cb18-23" href="#cb18-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb18-24" href="#cb18-24" data-line-number="24">  </a>
<a class="sourceLine" id="cb18-25" href="#cb18-25" data-line-number="25">  allFactorsAsBins &lt;-</a>
<a class="sourceLine" id="cb18-26" href="#cb18-26" data-line-number="26"><span class="st">    </span>allFactorsAsBins <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-27" href="#cb18-27" data-line-number="27"><span class="st">    </span><span class="kw">cbind</span>(bins)</a>
<a class="sourceLine" id="cb18-28" href="#cb18-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb18-29" href="#cb18-29" data-line-number="29">}</a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb19-1" href="#cb19-1" data-line-number="1">## --- Variable No.  1 -- Name:  loan_amnt </a>
<a class="sourceLine" id="cb19-2" href="#cb19-2" data-line-number="2">## --- Variable No.  2 -- Name:  verification_status </a>
<a class="sourceLine" id="cb19-3" href="#cb19-3" data-line-number="3">## --- Variable No.  3 -- Name:  issue_d </a>
<a class="sourceLine" id="cb19-4" href="#cb19-4" data-line-number="4">## --- Variable No.  4 -- Name:  dti </a>
<a class="sourceLine" id="cb19-5" href="#cb19-5" data-line-number="5">## --- Variable No.  5 -- Name:  inq_last_6mths </a>
<a class="sourceLine" id="cb19-6" href="#cb19-6" data-line-number="6">## --- Variable No.  6 -- Name:  revol_util </a>
<a class="sourceLine" id="cb19-7" href="#cb19-7" data-line-number="7">## --- Variable No.  7 -- Name:  open_rv_12m </a>
<a class="sourceLine" id="cb19-8" href="#cb19-8" data-line-number="8">## --- Variable No.  8 -- Name:  open_rv_24m </a>
<a class="sourceLine" id="cb19-9" href="#cb19-9" data-line-number="9">## --- Variable No.  9 -- Name:  max_bal_bc </a>
<a class="sourceLine" id="cb19-10" href="#cb19-10" data-line-number="10">## --- Variable No.  10 -- Name:  avg_cur_bal </a>
<a class="sourceLine" id="cb19-11" href="#cb19-11" data-line-number="11">## --- Variable No.  11 -- Name:  bc_open_to_buy </a>
<a class="sourceLine" id="cb19-12" href="#cb19-12" data-line-number="12">## --- Variable No.  12 -- Name:  bc_util </a>
<a class="sourceLine" id="cb19-13" href="#cb19-13" data-line-number="13">## --- Variable No.  13 -- Name:  mo_sin_old_rev_tl_op </a>
<a class="sourceLine" id="cb19-14" href="#cb19-14" data-line-number="14">## --- Variable No.  14 -- Name:  mo_sin_rcnt_rev_tl_op </a>
<a class="sourceLine" id="cb19-15" href="#cb19-15" data-line-number="15">## --- Variable No.  15 -- Name:  mo_sin_rcnt_tl </a>
<a class="sourceLine" id="cb19-16" href="#cb19-16" data-line-number="16">## --- Variable No.  16 -- Name:  mort_acc </a>
<a class="sourceLine" id="cb19-17" href="#cb19-17" data-line-number="17">## --- Variable No.  17 -- Name:  mths_since_recent_bc </a>
<a class="sourceLine" id="cb19-18" href="#cb19-18" data-line-number="18">## --- Variable No.  18 -- Name:  mths_since_recent_inq </a>
<a class="sourceLine" id="cb19-19" href="#cb19-19" data-line-number="19">## --- Variable No.  19 -- Name:  num_actv_rev_tl </a>
<a class="sourceLine" id="cb19-20" href="#cb19-20" data-line-number="20">## --- Variable No.  20 -- Name:  num_rev_tl_bal_gt_0 </a>
<a class="sourceLine" id="cb19-21" href="#cb19-21" data-line-number="21">## --- Variable No.  21 -- Name:  num_tl_op_past_12m </a>
<a class="sourceLine" id="cb19-22" href="#cb19-22" data-line-number="22">## --- Variable No.  22 -- Name:  percent_bc_gt_75 </a>
<a class="sourceLine" id="cb19-23" href="#cb19-23" data-line-number="23">## --- Variable No.  23 -- Name:  tot_hi_cred_lim </a>
<a class="sourceLine" id="cb19-24" href="#cb19-24" data-line-number="24">## --- Variable No.  24 -- Name:  total_bc_limit </a>
<a class="sourceLine" id="cb19-25" href="#cb19-25" data-line-number="25">## --- Variable No.  25 -- Name:  issue_d2 </a>
<a class="sourceLine" id="cb19-26" href="#cb19-26" data-line-number="26">## --- Variable No.  26 -- Name:  issue_d3</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>Note that only 26 variables have been evetually retained out of the 145 of the inital dataset.</p>


</div>
<div id="comparison-of-individual-characteristics" class="section level3">
<h3><span class="header-section-number">3.2.8</span> Comparison of individual characteristics</h3>
<p>The following plots the 10 top variables weight of evidence plots. They show for those variables the weght of evidence of each individual factor. A positive WoE shows that the factor is positive to explain a positive outcome (that is that a loan is good).</p>
<p>The description of each variable is in the Appendix.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" href="#cb20-1" data-line-number="1">best10 &lt;-<span class="st"> </span>bestBins <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(IV)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb20-2" href="#cb20-2" data-line-number="2"></a>
<a class="sourceLine" id="cb20-3" href="#cb20-3" data-line-number="3">plotBinWoE &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb20-4" href="#cb20-4" data-line-number="4">  vName &lt;-<span class="st"> </span>best10[n,]<span class="op">$</span>variable</a>
<a class="sourceLine" id="cb20-5" href="#cb20-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb20-6" href="#cb20-6" data-line-number="6">  <span class="cf">if</span> (best10[n,]<span class="op">$</span>type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) {</a>
<a class="sourceLine" id="cb20-7" href="#cb20-7" data-line-number="7">    best10[n,]<span class="op">$</span>WoE[[<span class="dv">1</span>]] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-8" href="#cb20-8" data-line-number="8"><span class="st">      </span><span class="kw">arrange</span>(WoE) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-9" href="#cb20-9" data-line-number="9"><span class="st">      </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(Name, WoE)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-10" href="#cb20-10" data-line-number="10"><span class="st">      </span><span class="kw">geom_col</span>(<span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;lightblue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-11" href="#cb20-11" data-line-number="11"><span class="st">      </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-12" href="#cb20-12" data-line-number="12"><span class="st">      </span><span class="kw">ggtitle</span>(vName)</a>
<a class="sourceLine" id="cb20-13" href="#cb20-13" data-line-number="13">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb20-14" href="#cb20-14" data-line-number="14">    best10[n,]<span class="op">$</span>WoE[[<span class="dv">1</span>]] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-15" href="#cb20-15" data-line-number="15"><span class="st">      </span><span class="kw">arrange</span>(WoE) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-16" href="#cb20-16" data-line-number="16"><span class="st">      </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(Name, WoE)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-17" href="#cb20-17" data-line-number="17"><span class="st">      </span><span class="kw">geom_col</span>(<span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;lightblue&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-18" href="#cb20-18" data-line-number="18"><span class="st">      </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-19" href="#cb20-19" data-line-number="19"><span class="st">      </span><span class="kw">ggtitle</span>(vName)</a>
<a class="sourceLine" id="cb20-20" href="#cb20-20" data-line-number="20">    </a>
<a class="sourceLine" id="cb20-21" href="#cb20-21" data-line-number="21">  }</a>
<a class="sourceLine" id="cb20-22" href="#cb20-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb20-23" href="#cb20-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb20-24" href="#cb20-24" data-line-number="24"></a>
<a class="sourceLine" id="cb20-25" href="#cb20-25" data-line-number="25">listPlots &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="cf">function</span>(n) { <span class="kw">plotBinWoE</span>(n) })</a>
<a class="sourceLine" id="cb20-26" href="#cb20-26" data-line-number="26"></a>
<a class="sourceLine" id="cb20-27" href="#cb20-27" data-line-number="27">listPlots[[<span class="dv">1</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" href="#cb21-1" data-line-number="1">listPlots[[<span class="dv">2</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-2.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" href="#cb22-1" data-line-number="1">listPlots[[<span class="dv">3</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-3.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" href="#cb23-1" data-line-number="1">listPlots[[<span class="dv">4</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-4.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" href="#cb24-1" data-line-number="1">listPlots[[<span class="dv">5</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-5.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" href="#cb25-1" data-line-number="1">listPlots[[<span class="dv">6</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-6.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" href="#cb26-1" data-line-number="1">listPlots[[<span class="dv">7</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-7.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" href="#cb27-1" data-line-number="1">listPlots[[<span class="dv">8</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-8.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" href="#cb28-1" data-line-number="1">listPlots[[<span class="dv">9</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-9.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" href="#cb29-1" data-line-number="1">listPlots[[<span class="dv">10</span>]]</a></code></pre></div>
<p><img src="build/figure/graphics-unnamed-chunk-11-10.png" width="70%" style="display: block; margin: auto;" /></p>

<p><span class="math display">\[\text{ }\]</span></p>



</div>
</div>
<div id="logistic-regression-1" class="section level2">
<h2><span class="header-section-number">3.3</span> Logistic Regression</h2>
<p>In this section, we fit a linear regression model using the fully binned dataset.</p>
<p>We tested several R linear regression packages. <code>glm</code> crashed on even small extracts of the dataset. <code>glmnet</code> returns errors that were not understandable nor documented on the internet. Although it does not include a <code>predict</code> function, we settled on the <code>speedglm</code> package which is designed to handled very large datatsets. Note that it includes has a <code>select()</code> function which would shadow or conflict with <code>dplyr::select()</code>, so it is only used fully qualified to avoid any collision.</p>
<!------------------------------------------------------------------------------------>
<!-- THIS IS A COPY OF PREVIOUS TO RELOAD DATASETS                                  -->






<!-- END OF COPY                                                                     -->
<!------------------------------------------------------------------------------------->
<div id="remove-identical-bins" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Remove identical bins</h3>
<p>All linear regression algorithms require the variables to not have any linear relationship. Any colinearity prevents fitting a coefficient to such variables.</p>
<p>Although the original dataset may not contain such variables, binning variables into discrete factors will create such situations. The original variables were not identical, but when split into categories, some bins can become identical. For example, if a loan application does not provide income information (<code>income=NA</code> is TRUE for that loan), no debt-to-income ratio can be calculated (<code>dti=NA</code> will also be true for that loan). The <code>income</code> and <code>dti</code> variables were not colinear, but some of their bins can be.</p>
<p>To identify such bins, we use a “trick” to speed up comparison: we run a hash digest on each column and spot identical hashes.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" href="#cb30-1" data-line-number="1">namesCharacteristics &lt;-<span class="st"> </span><span class="kw">names</span>(loanSampleCharacteristics)</a>
<a class="sourceLine" id="cb30-2" href="#cb30-2" data-line-number="2">namesBins &lt;-<span class="st"> </span><span class="kw">names</span>(loanSampleBins)</a>
<a class="sourceLine" id="cb30-3" href="#cb30-3" data-line-number="3"></a>
<a class="sourceLine" id="cb30-4" href="#cb30-4" data-line-number="4"><span class="co"># Starting list of names, calculate a hash value for each column with that name and</span></a>
<a class="sourceLine" id="cb30-5" href="#cb30-5" data-line-number="5"><span class="co"># identify duplicates.</span></a>
<a class="sourceLine" id="cb30-6" href="#cb30-6" data-line-number="6">duplicateNames &lt;-<span class="st"> </span><span class="kw">names</span>(</a>
<a class="sourceLine" id="cb30-7" href="#cb30-7" data-line-number="7">                    loanSampleBins[</a>
<a class="sourceLine" id="cb30-8" href="#cb30-8" data-line-number="8">                      <span class="kw">duplicated</span>(</a>
<a class="sourceLine" id="cb30-9" href="#cb30-9" data-line-number="9">                        <span class="kw">lapply</span>(loanSampleBins, digest<span class="op">::</span>digest))])</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We also identify any empty bin (this has only been useful when working on extremely small extracts of the original dataset).</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" href="#cb31-1" data-line-number="1"><span class="co"># Remove any categories uniformaly constant (only 0)</span></a>
<a class="sourceLine" id="cb31-2" href="#cb31-2" data-line-number="2"><span class="co">#</span></a>
<a class="sourceLine" id="cb31-3" href="#cb31-3" data-line-number="3"><span class="co"># This is important when working on a small extract of the dataset for variables that are</span></a>
<a class="sourceLine" id="cb31-4" href="#cb31-4" data-line-number="4"><span class="co"># seldom used (e.g. customers from certain states).</span></a>
<a class="sourceLine" id="cb31-5" href="#cb31-5" data-line-number="5">zeroColumnsNames &lt;-<span class="st"> </span>loanSampleBins[, <span class="kw">colSums</span>(loanSampleBins) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">names</span>()</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We start with the binned dataset created in the previous subsection, removing variables with IV under 2%. All variables are one-hot encoded. Fitting the model will be done in four consecutive steps:</p>
<ol style="list-style-type: decimal">
<li><p>We fit a model on the binned dataset.</p></li>
<li><p>Next, we refit after removing any variable identified as colinear (i.e. NA coefficient).</p></li>
<li><p>Next, we refit after removing any variable whose significance is not at least p-value &gt; 95%.</p></li>
</ol>
<p>Finally, we will select a model.</p>
</div>
<div id="first-model---complete-dataset" class="section level3">
<h3><span class="header-section-number">3.3.2</span> First model - complete dataset</h3>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" href="#cb32-1" data-line-number="1"><span class="co"># About 700 sec wall-time to complete training dataset</span></a>
<a class="sourceLine" id="cb32-2" href="#cb32-2" data-line-number="2"><span class="co"># The dataset is the sample less duplicate, less zero-ed columns</span></a>
<a class="sourceLine" id="cb32-3" href="#cb32-3" data-line-number="3">{</a>
<a class="sourceLine" id="cb32-4" href="#cb32-4" data-line-number="4">  doMC<span class="op">::</span><span class="kw">registerDoMC</span>(<span class="dt">cores =</span> <span class="dv">1</span>) <span class="co"># Too many processes push over 32GB</span></a>
<a class="sourceLine" id="cb32-5" href="#cb32-5" data-line-number="5">  startTime &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb32-6" href="#cb32-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb32-7" href="#cb32-7" data-line-number="7">  loansData &lt;-<span class="st"> </span>loanSampleBins</a>
<a class="sourceLine" id="cb32-8" href="#cb32-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb32-9" href="#cb32-9" data-line-number="9">  SGLM_B_train &lt;-<span class="st"> </span>speedglm<span class="op">::</span><span class="kw">speedglm</span>(isGoodLoan <span class="op">~</span><span class="st"> </span>.,</a>
<a class="sourceLine" id="cb32-10" href="#cb32-10" data-line-number="10">                                     <span class="dt">data =</span> loansData,</a>
<a class="sourceLine" id="cb32-11" href="#cb32-11" data-line-number="11">                                     <span class="dt">family =</span> <span class="kw">binomial</span>())</a>
<a class="sourceLine" id="cb32-12" href="#cb32-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb32-13" href="#cb32-13" data-line-number="13">  doMC<span class="op">::</span><span class="kw">registerDoMC</span>(<span class="dt">cores =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb32-14" href="#cb32-14" data-line-number="14">  <span class="kw">cat</span>(<span class="st">&quot;-- Lapsed time: &quot;</span>, <span class="kw">proc.time</span>() <span class="op">-</span><span class="st"> </span>startTime)</a>
<a class="sourceLine" id="cb32-15" href="#cb32-15" data-line-number="15">}</a></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb33-1" href="#cb33-1" data-line-number="1">## -- Lapsed time:  161.581 11.317 201.084 0 0</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>


<p>There are a number of NA coefficients. The first 10 are:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" href="#cb34-1" data-line-number="1">speedglm<span class="op">:::</span><span class="kw">summary.speedglm</span>(SGLM_B_train)<span class="op">$</span>coefficients <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-2" href="#cb34-2" data-line-number="2"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-3" href="#cb34-3" data-line-number="3"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;Bin name&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-4" href="#cb34-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(Estimate)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-5" href="#cb34-5" data-line-number="5"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-6" href="#cb34-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="st">&quot;Bin name&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-7" href="#cb34-7" data-line-number="7"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;First model. Example of NA coefficients.&quot;</span>, <span class="dt">digits =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-8" href="#cb34-8" data-line-number="8"><span class="st">  </span>kableExtra<span class="op">::</span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;HOLD_position&quot;</span>)</a></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:05-02-first-training-B-NA">Table 3.5: </span>First model. Example of NA coefficients.
</caption>
<thead>
<tr>
<th style="text-align:left;">
Bin name
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 28000&amp;lt;loan_amnt&amp;lt;=40000</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(verification_status) verification_status=Verified</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(issue_d) 17.75&amp;lt;issue_d&amp;lt;=18.917</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(dti) dti=NA</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(inq_last_6mths) inq_last_6mths=NA</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(revol_util) revol_util=NA</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(open_rv_12m) open_rv_12m=NA</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(open_rv_24m) 5&amp;lt;open_rv_24m&amp;lt;=53</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(open_rv_24m) open_rv_24m=NA</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(max_bal_bc) 7905&amp;lt;max_bal_bc&amp;lt;=776843</code>
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p>The most significant bins are:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" href="#cb35-1" data-line-number="1">speedglm<span class="op">:::</span><span class="kw">summary.speedglm</span>(SGLM_B_train)<span class="op">$</span>coefficients <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-2" href="#cb35-2" data-line-number="2"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-3" href="#cb35-3" data-line-number="3"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;Bin_name&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-4" href="#cb35-4" data-line-number="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">z_value =</span> <span class="st">&quot;z value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-5" href="#cb35-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(z_value)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-6" href="#cb35-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(Bin_name, Estimate, z_value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-7" href="#cb35-7" data-line-number="7"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-8" href="#cb35-8" data-line-number="8"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;First training. 15 best bins&quot;</span>, <span class="dt">digits =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-9" href="#cb35-9" data-line-number="9"><span class="st">  </span>kableExtra<span class="op">::</span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;HOLD_position&quot;</span>)</a></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:05-02-first-training-B-best10">Table 3.6: </span>First training. 15 best bins
</caption>
<thead>
<tr>
<th style="text-align:left;">
Bin_name
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
z_value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 3500&amp;lt;loan_amnt&amp;lt;=9000</code>
</td>
<td style="text-align:right;">
0.985
</td>
<td style="text-align:right;">
90.923
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) -Inf&amp;lt;loan_amnt&amp;lt;=3500</code>
</td>
<td style="text-align:right;">
1.162
</td>
<td style="text-align:right;">
76.317
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 9000&amp;lt;loan_amnt&amp;lt;=10000</code>
</td>
<td style="text-align:right;">
0.738
</td>
<td style="text-align:right;">
59.375
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 10000&amp;lt;loan_amnt&amp;lt;=12000</code>
</td>
<td style="text-align:right;">
0.600
</td>
<td style="text-align:right;">
49.365
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(verification_status) verification_status=Not Verified</code>
</td>
<td style="text-align:right;">
0.284
</td>
<td style="text-align:right;">
40.127
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 14975&amp;lt;loan_amnt&amp;lt;=15000</code>
</td>
<td style="text-align:right;">
0.550
</td>
<td style="text-align:right;">
38.577
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 12000&amp;lt;loan_amnt&amp;lt;=14975</code>
</td>
<td style="text-align:right;">
0.504
</td>
<td style="text-align:right;">
38.228
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_tl_op_past_12m) 0&amp;lt;num_tl_op_past_12m&amp;lt;=1</code>
</td>
<td style="text-align:right;">
0.347
</td>
<td style="text-align:right;">
28.470
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 15000&amp;lt;loan_amnt&amp;lt;=17000</code>
</td>
<td style="text-align:right;">
0.376
</td>
<td style="text-align:right;">
27.665
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 5&amp;lt;mort_acc&amp;lt;=47</code>
</td>
<td style="text-align:right;">
1.062
</td>
<td style="text-align:right;">
25.086
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 3&amp;lt;mort_acc&amp;lt;=5</code>
</td>
<td style="text-align:right;">
1.013
</td>
<td style="text-align:right;">
24.616
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 2&amp;lt;mort_acc&amp;lt;=3</code>
</td>
<td style="text-align:right;">
0.981
</td>
<td style="text-align:right;">
23.813
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 19950&amp;lt;loan_amnt&amp;lt;=28000</code>
</td>
<td style="text-align:right;">
0.239
</td>
<td style="text-align:right;">
23.742
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 1&amp;lt;mort_acc&amp;lt;=2</code>
</td>
<td style="text-align:right;">
0.949
</td>
<td style="text-align:right;">
23.199
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_tl_op_past_12m) 1&amp;lt;num_tl_op_past_12m&amp;lt;=2</code>
</td>
<td style="text-align:right;">
0.252
</td>
<td style="text-align:right;">
22.480
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We store the list of bins identified as colinear for later use.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" href="#cb36-1" data-line-number="1">NAsFirstTraining &lt;-</a>
<a class="sourceLine" id="cb36-2" href="#cb36-2" data-line-number="2"><span class="st">  </span></a>
<a class="sourceLine" id="cb36-3" href="#cb36-3" data-line-number="3"><span class="st">  </span><span class="co"># Take the results (just the estimated coefficients) from the model</span></a>
<a class="sourceLine" id="cb36-4" href="#cb36-4" data-line-number="4"><span class="st">  </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb36-5" href="#cb36-5" data-line-number="5">    <span class="dt">name =</span> <span class="kw">rownames</span>(<span class="kw">summary</span>(SGLM_B_train)<span class="op">$</span>coefficient),</a>
<a class="sourceLine" id="cb36-6" href="#cb36-6" data-line-number="6">    <span class="dt">estimate =</span> <span class="kw">summary</span>(SGLM_B_train)<span class="op">$</span>coefficient<span class="op">$</span>Estimate</a>
<a class="sourceLine" id="cb36-7" href="#cb36-7" data-line-number="7">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-8" href="#cb36-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb36-9" href="#cb36-9" data-line-number="9"><span class="st">  </span><span class="co"># Reformat the names to be the same as in the bins</span></a>
<a class="sourceLine" id="cb36-10" href="#cb36-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> stringr<span class="op">::</span><span class="kw">str_remove_all</span>(name, <span class="st">&quot;\`&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb36-11" href="#cb36-11" data-line-number="11"><span class="st">  </span></a>
<a class="sourceLine" id="cb36-12" href="#cb36-12" data-line-number="12"><span class="st">  </span><span class="co"># Make sure that repsonse is not deleted by mistake and list all NAs</span></a>
<a class="sourceLine" id="cb36-13" href="#cb36-13" data-line-number="13"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;isGoodLoan&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(estimate)) </a>
<a class="sourceLine" id="cb36-14" href="#cb36-14" data-line-number="14"></a>
<a class="sourceLine" id="cb36-15" href="#cb36-15" data-line-number="15">NAsFirstTraining &lt;-<span class="st"> </span>NAsFirstTraining<span class="op">$</span>name</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
</div>
<div id="second-training---fitted-model-less-colinear-bins" class="section level3">
<h3><span class="header-section-number">3.3.3</span> Second training - fitted model less colinear bins</h3>
<p>For the second training, we use the complete dataset with duplicate and colinear bins removed.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" href="#cb37-1" data-line-number="1"><span class="co"># Start the model training again</span></a>
<a class="sourceLine" id="cb37-2" href="#cb37-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb37-3" href="#cb37-3" data-line-number="3">  startTime &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb37-4" href="#cb37-4" data-line-number="4">  doMC<span class="op">::</span><span class="kw">registerDoMC</span>(<span class="dt">cores =</span> <span class="dv">2</span>) <span class="co"># Too many processes push over 32GB if more than 2</span></a>
<a class="sourceLine" id="cb37-5" href="#cb37-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb37-6" href="#cb37-6" data-line-number="6">  loansData &lt;-<span class="st"> </span>loanSampleBins <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-7" href="#cb37-7" data-line-number="7"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">one_of</span>( <span class="kw">c</span>(duplicateNames, </a>
<a class="sourceLine" id="cb37-8" href="#cb37-8" data-line-number="8">                      zeroColumnsNames, </a>
<a class="sourceLine" id="cb37-9" href="#cb37-9" data-line-number="9">                      NAsFirstTraining)))</a>
<a class="sourceLine" id="cb37-10" href="#cb37-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb37-11" href="#cb37-11" data-line-number="11">  SGLM_B_retrain &lt;-<span class="st"> </span>speedglm<span class="op">::</span><span class="kw">speedglm</span>(isGoodLoan <span class="op">~</span><span class="st"> </span>.,</a>
<a class="sourceLine" id="cb37-12" href="#cb37-12" data-line-number="12">                                       <span class="dt">data =</span> loansData,</a>
<a class="sourceLine" id="cb37-13" href="#cb37-13" data-line-number="13">                                       <span class="dt">family =</span> <span class="kw">binomial</span>())</a>
<a class="sourceLine" id="cb37-14" href="#cb37-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb37-15" href="#cb37-15" data-line-number="15">  doMC<span class="op">::</span><span class="kw">registerDoMC</span>(<span class="dt">cores =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb37-16" href="#cb37-16" data-line-number="16">  <span class="kw">cat</span>(<span class="st">&quot;-- Lapsed time: &quot;</span>, <span class="kw">proc.time</span>() <span class="op">-</span><span class="st"> </span>startTime)</a>
<a class="sourceLine" id="cb37-17" href="#cb37-17" data-line-number="17">}</a></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb38-1" href="#cb38-1" data-line-number="1">## -- Lapsed time:  153.391 11.851 203.943 0 0</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>


<p>The most significant bins are:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" href="#cb39-1" data-line-number="1">speedglm<span class="op">:::</span><span class="kw">summary.speedglm</span>(SGLM_B_retrain)<span class="op">$</span>coefficients <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-2" href="#cb39-2" data-line-number="2"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-3" href="#cb39-3" data-line-number="3"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;Bin_name&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-4" href="#cb39-4" data-line-number="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">z_value =</span> <span class="st">&quot;z value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-5" href="#cb39-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(z_value)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-6" href="#cb39-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(Bin_name, Estimate, z_value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-7" href="#cb39-7" data-line-number="7"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-8" href="#cb39-8" data-line-number="8"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;Second training. 15 best bins&quot;</span>, <span class="dt">digits =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-9" href="#cb39-9" data-line-number="9"><span class="st">  </span>kableExtra<span class="op">::</span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;HOLD_position&quot;</span>)</a></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:05-02-second-training-B-best10">Table 3.7: </span>Second training. 15 best bins
</caption>
<thead>
<tr>
<th style="text-align:left;">
Bin_name
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
z_value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 3500&amp;lt;loan_amnt&amp;lt;=9000</code>
</td>
<td style="text-align:right;">
0.985
</td>
<td style="text-align:right;">
90.923
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) -Inf&amp;lt;loan_amnt&amp;lt;=3500</code>
</td>
<td style="text-align:right;">
1.162
</td>
<td style="text-align:right;">
76.317
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 9000&amp;lt;loan_amnt&amp;lt;=10000</code>
</td>
<td style="text-align:right;">
0.738
</td>
<td style="text-align:right;">
59.375
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 10000&amp;lt;loan_amnt&amp;lt;=12000</code>
</td>
<td style="text-align:right;">
0.600
</td>
<td style="text-align:right;">
49.365
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(verification_status) verification_status=Not Verified</code>
</td>
<td style="text-align:right;">
0.284
</td>
<td style="text-align:right;">
40.127
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 14975&amp;lt;loan_amnt&amp;lt;=15000</code>
</td>
<td style="text-align:right;">
0.550
</td>
<td style="text-align:right;">
38.577
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 12000&amp;lt;loan_amnt&amp;lt;=14975</code>
</td>
<td style="text-align:right;">
0.504
</td>
<td style="text-align:right;">
38.228
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_tl_op_past_12m) 0&amp;lt;num_tl_op_past_12m&amp;lt;=1</code>
</td>
<td style="text-align:right;">
0.347
</td>
<td style="text-align:right;">
28.470
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 15000&amp;lt;loan_amnt&amp;lt;=17000</code>
</td>
<td style="text-align:right;">
0.376
</td>
<td style="text-align:right;">
27.665
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 5&amp;lt;mort_acc&amp;lt;=47</code>
</td>
<td style="text-align:right;">
1.062
</td>
<td style="text-align:right;">
25.086
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 3&amp;lt;mort_acc&amp;lt;=5</code>
</td>
<td style="text-align:right;">
1.013
</td>
<td style="text-align:right;">
24.616
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 2&amp;lt;mort_acc&amp;lt;=3</code>
</td>
<td style="text-align:right;">
0.981
</td>
<td style="text-align:right;">
23.813
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 19950&amp;lt;loan_amnt&amp;lt;=28000</code>
</td>
<td style="text-align:right;">
0.239
</td>
<td style="text-align:right;">
23.742
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 1&amp;lt;mort_acc&amp;lt;=2</code>
</td>
<td style="text-align:right;">
0.949
</td>
<td style="text-align:right;">
23.199
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_tl_op_past_12m) 1&amp;lt;num_tl_op_past_12m&amp;lt;=2</code>
</td>
<td style="text-align:right;">
0.252
</td>
<td style="text-align:right;">
22.480
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We can now select any bins whose significance value is under 2 <span class="math inline">\(\sigma\)</span>.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" href="#cb40-1" data-line-number="1">NAsSecondTraining &lt;-</a>
<a class="sourceLine" id="cb40-2" href="#cb40-2" data-line-number="2"><span class="st">  </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb40-3" href="#cb40-3" data-line-number="3">    <span class="dt">name =</span> <span class="kw">rownames</span>(<span class="kw">summary</span>(SGLM_B_retrain)<span class="op">$</span>coefficient),</a>
<a class="sourceLine" id="cb40-4" href="#cb40-4" data-line-number="4">    <span class="dt">estimate =</span> <span class="kw">summary</span>(SGLM_B_retrain)<span class="op">$</span>coefficient<span class="op">$</span>Estimate, </a>
<a class="sourceLine" id="cb40-5" href="#cb40-5" data-line-number="5">    <span class="dt">zValue =</span> <span class="kw">abs</span>(<span class="kw">summary</span>(SGLM_B_retrain)<span class="op">$</span>coefficient<span class="op">$</span><span class="st">&quot;z value&quot;</span>)</a>
<a class="sourceLine" id="cb40-6" href="#cb40-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-7" href="#cb40-7" data-line-number="7"><span class="st">  </span></a>
<a class="sourceLine" id="cb40-8" href="#cb40-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> stringr<span class="op">::</span><span class="kw">str_remove_all</span>(name, <span class="st">&quot;\`&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb40-9" href="#cb40-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;isGoodLoan&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-10" href="#cb40-10" data-line-number="10"><span class="st">  </span></a>
<a class="sourceLine" id="cb40-11" href="#cb40-11" data-line-number="11"><span class="st">  </span><span class="co"># Remove stray NAs or anything less than 2 sigmas</span></a>
<a class="sourceLine" id="cb40-12" href="#cb40-12" data-line-number="12"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(estimate) <span class="op">|</span><span class="st"> </span>zValue <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb40-13" href="#cb40-13" data-line-number="13"></a>
<a class="sourceLine" id="cb40-14" href="#cb40-14" data-line-number="14">NAsSecondTraining &lt;-<span class="st"> </span>NAsSecondTraining<span class="op">$</span>name</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
</div>
<div id="third-training---second-fitted-model-less-non-significant-bins" class="section level3">
<h3><span class="header-section-number">3.3.4</span> Third training - second fitted model less non-significant bins</h3>
<p>For the third training, we use the complete dataset with duplicate, colinear and non-significant bins removed.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" href="#cb41-1" data-line-number="1"><span class="co"># Start the model training again. About 350 sec.</span></a>
<a class="sourceLine" id="cb41-2" href="#cb41-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb41-3" href="#cb41-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb41-4" href="#cb41-4" data-line-number="4">  startTime &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb41-5" href="#cb41-5" data-line-number="5">  doMC<span class="op">::</span><span class="kw">registerDoMC</span>(<span class="dt">cores =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb41-6" href="#cb41-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb41-7" href="#cb41-7" data-line-number="7">  loansData &lt;-<span class="st"> </span>loanSampleBins <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-8" href="#cb41-8" data-line-number="8"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">one_of</span>( <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb41-9" href="#cb41-9" data-line-number="9">      duplicateNames,</a>
<a class="sourceLine" id="cb41-10" href="#cb41-10" data-line-number="10">      zeroColumnsNames,</a>
<a class="sourceLine" id="cb41-11" href="#cb41-11" data-line-number="11">      NAsFirstTraining,</a>
<a class="sourceLine" id="cb41-12" href="#cb41-12" data-line-number="12">      NAsSecondTraining</a>
<a class="sourceLine" id="cb41-13" href="#cb41-13" data-line-number="13">    )))</a>
<a class="sourceLine" id="cb41-14" href="#cb41-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb41-15" href="#cb41-15" data-line-number="15">  SGLM_B_reretrain &lt;-<span class="st"> </span>speedglm<span class="op">::</span><span class="kw">speedglm</span>(isGoodLoan <span class="op">~</span><span class="st"> </span>.,</a>
<a class="sourceLine" id="cb41-16" href="#cb41-16" data-line-number="16">                                         <span class="dt">data =</span> loansData,</a>
<a class="sourceLine" id="cb41-17" href="#cb41-17" data-line-number="17">                                         <span class="dt">family =</span> <span class="kw">binomial</span>())</a>
<a class="sourceLine" id="cb41-18" href="#cb41-18" data-line-number="18">  </a>
<a class="sourceLine" id="cb41-19" href="#cb41-19" data-line-number="19">  doMC<span class="op">::</span><span class="kw">registerDoMC</span>(<span class="dt">cores =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb41-20" href="#cb41-20" data-line-number="20">  <span class="kw">cat</span>(<span class="st">&quot;-- Lapsed time: &quot;</span>, <span class="kw">proc.time</span>() <span class="op">-</span><span class="st"> </span>startTime)</a>
<a class="sourceLine" id="cb41-21" href="#cb41-21" data-line-number="21">}</a></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb42-1" href="#cb42-1" data-line-number="1">## -- Lapsed time:  52.765 4.96 74.546 0 0</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>


<p>The most significant bins are:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" href="#cb43-1" data-line-number="1">speedglm<span class="op">:::</span><span class="kw">summary.speedglm</span>(SGLM_B_reretrain)<span class="op">$</span>coefficients <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-2" href="#cb43-2" data-line-number="2"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-3" href="#cb43-3" data-line-number="3"><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="dt">var =</span> <span class="st">&quot;Bin_name&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-4" href="#cb43-4" data-line-number="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">z_value =</span> <span class="st">&quot;z value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-5" href="#cb43-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(z_value)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-6" href="#cb43-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(Bin_name, Estimate, z_value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-7" href="#cb43-7" data-line-number="7"><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-8" href="#cb43-8" data-line-number="8"><span class="st">  </span><span class="kw">kable</span>(<span class="dt">caption =</span> <span class="st">&quot;Third training: 15 best bins&quot;</span>, <span class="dt">digits =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-9" href="#cb43-9" data-line-number="9"><span class="st">  </span>kableExtra<span class="op">::</span><span class="kw">kable_styling</span>(<span class="dt">latex_options =</span> <span class="st">&quot;HOLD_position&quot;</span>)</a></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:05-02-third-training-B-best10">Table 3.8: </span>Third training: 15 best bins
</caption>
<thead>
<tr>
<th style="text-align:left;">
Bin_name
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
z_value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 3500&amp;lt;loan_amnt&amp;lt;=9000</code>
</td>
<td style="text-align:right;">
0.938
</td>
<td style="text-align:right;">
87.483
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) -Inf&amp;lt;loan_amnt&amp;lt;=3500</code>
</td>
<td style="text-align:right;">
1.108
</td>
<td style="text-align:right;">
73.272
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 9000&amp;lt;loan_amnt&amp;lt;=10000</code>
</td>
<td style="text-align:right;">
0.703
</td>
<td style="text-align:right;">
56.953
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 10000&amp;lt;loan_amnt&amp;lt;=12000</code>
</td>
<td style="text-align:right;">
0.562
</td>
<td style="text-align:right;">
46.561
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(verification_status) verification_status=Not Verified</code>
</td>
<td style="text-align:right;">
0.323
</td>
<td style="text-align:right;">
45.961
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_tl_op_past_12m) -Inf&amp;lt;num_tl_op_past_12m&amp;lt;=0</code>
</td>
<td style="text-align:right;">
0.570
</td>
<td style="text-align:right;">
42.824
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_tl_op_past_12m) 0&amp;lt;num_tl_op_past_12m&amp;lt;=1</code>
</td>
<td style="text-align:right;">
0.462
</td>
<td style="text-align:right;">
41.164
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 14975&amp;lt;loan_amnt&amp;lt;=15000</code>
</td>
<td style="text-align:right;">
0.530
</td>
<td style="text-align:right;">
37.341
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_rev_tl_bal_gt_0) -Inf&amp;lt;num_rev_tl_bal_gt_0&amp;lt;=2</code>
</td>
<td style="text-align:right;">
0.481
</td>
<td style="text-align:right;">
37.093
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(loan_amnt) 12000&amp;lt;loan_amnt&amp;lt;=14975</code>
</td>
<td style="text-align:right;">
0.458
</td>
<td style="text-align:right;">
35.041
</td>
</tr>
<tr>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
0.640
</td>
<td style="text-align:right;">
32.243
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 5&amp;lt;mort_acc&amp;lt;=47</code>
</td>
<td style="text-align:right;">
1.169
</td>
<td style="text-align:right;">
31.135
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_tl_op_past_12m) 1&amp;lt;num_tl_op_past_12m&amp;lt;=2</code>
</td>
<td style="text-align:right;">
0.329
</td>
<td style="text-align:right;">
31.083
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(mort_acc) 3&amp;lt;mort_acc&amp;lt;=5</code>
</td>
<td style="text-align:right;">
1.106
</td>
<td style="text-align:right;">
30.336
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>(num_rev_tl_bal_gt_0) 4&amp;lt;num_rev_tl_bal_gt_0&amp;lt;=5</code>
</td>
<td style="text-align:right;">
0.328
</td>
<td style="text-align:right;">
29.163
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>


<p><span class="math display">\[\text{ }\]</span></p>
<p>Table <a href="logistic-regression-model-and-credit-scorecard.html#tab:05-02-training-criteria">3.9</a> shows the Akaike Information Criterion and Log-likelihood for each of the 3 training results. Two points to note:</p>
<ul>
<li><p>The results did not change from first to second training. This is normal since we only removed non-informative categorical bins for which the regression could not determine a coefficient (i.e. colinearity with other variables). We did not remove any information;</p>
<ul>
<li>Removing seemingly non-significant bins makes the model worse (at least by those measures). This would suggest that bins should not be individually considered, but only the entire variable to which they belong.</li>
</ul></li>
</ul>
<p><span class="math display">\[\text{ }\]</span></p>

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:05-02-training-criteria">Table 3.9: </span>Training AIC and Log-likelihood
</caption>
<thead>
<tr>
<th style="text-align:left;">
Criteria
</th>
<th style="text-align:right;">
Training #1
</th>
<th style="text-align:right;">
Training #2
</th>
<th style="text-align:right;">
Training #3
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
AIC
</td>
<td style="text-align:right;">
977037.2
</td>
<td style="text-align:right;">
977037.2
</td>
<td style="text-align:right;">
982957.0
</td>
</tr>
<tr>
<td style="text-align:left;">
Log likelihood
</td>
<td style="text-align:right;">
-488350.6
</td>
<td style="text-align:right;">
-488350.6
</td>
<td style="text-align:right;">
-491370.5
</td>
</tr>
</tbody>
</table>

<p><span class="math display">\[\text{ }\]</span></p>
<p>In the next section we will only work with the second model since it is the best (by those measures).</p>



<!------------------------------------------------------------------------------------>
<!-- CLEANUP AND RELOAD DATASETS                                                    -->




<!-- END                                                                             -->
<!------------------------------------------------------------------------------------->
</div>
</div>
<div id="model-results" class="section level2">
<h2><span class="header-section-number">3.4</span> Model results</h2>
<div id="final-list-of-variables" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Final list of variables</h3>
<p>We selected the model fitted during the second training.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" href="#cb44-1" data-line-number="1"><span class="co"># Model to use</span></a>
<a class="sourceLine" id="cb44-2" href="#cb44-2" data-line-number="2">GLModel &lt;-<span class="st"> </span>SGLM_B_retrain</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We collect the list of selected bins.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" href="#cb45-1" data-line-number="1"><span class="co"># List of model variables</span></a>
<a class="sourceLine" id="cb45-2" href="#cb45-2" data-line-number="2">modelNames &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb45-3" href="#cb45-3" data-line-number="3"><span class="st">  </span><span class="kw">attr</span>(GLModel<span class="op">$</span>coefficients, <span class="st">&quot;names&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-4" href="#cb45-4" data-line-number="4"><span class="st">  </span><span class="kw">enframe</span>(<span class="dt">x =</span> .) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-5" href="#cb45-5" data-line-number="5"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">variableName =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-6" href="#cb45-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(variableName) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-7" href="#cb45-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">variableName =</span> <span class="kw">str_remove_all</span>(variableName, <span class="st">&quot;\`&quot;</span>))</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>And we collect the model summary (coefficients, significance, etc.).</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb46"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" href="#cb46-1" data-line-number="1"><span class="co"># and their coefficients in the model (the summary function for speedglm objects is not exported and</span></a>
<a class="sourceLine" id="cb46-2" href="#cb46-2" data-line-number="2"><span class="co"># bookdown seems to have a problem with that).</span></a>
<a class="sourceLine" id="cb46-3" href="#cb46-3" data-line-number="3"></a>
<a class="sourceLine" id="cb46-4" href="#cb46-4" data-line-number="4">GLMCoefficients &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb46-5" href="#cb46-5" data-line-number="5"><span class="st">  </span>speedglm<span class="op">:::</span><span class="kw">summary.speedglm</span>(GLModel)<span class="op">$</span>coefficients <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-6" href="#cb46-6" data-line-number="6"><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-7" href="#cb46-7" data-line-number="7"><span class="st">  </span><span class="kw">cbind</span>(modelNames) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-8" href="#cb46-8" data-line-number="8"><span class="st">  </span><span class="kw">rename</span>(</a>
<a class="sourceLine" id="cb46-9" href="#cb46-9" data-line-number="9">    <span class="dt">zValue =</span> <span class="st">&quot;z value&quot;</span>,</a>
<a class="sourceLine" id="cb46-10" href="#cb46-10" data-line-number="10">    <span class="dt">pValue =</span> <span class="st">&quot;Pr(&gt;|z|)&quot;</span>,</a>
<a class="sourceLine" id="cb46-11" href="#cb46-11" data-line-number="11">    <span class="dt">stdErr =</span> <span class="st">&quot;Std. Error&quot;</span></a>
<a class="sourceLine" id="cb46-12" href="#cb46-12" data-line-number="12">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-13" href="#cb46-13" data-line-number="13"></a>
<a class="sourceLine" id="cb46-14" href="#cb46-14" data-line-number="14"><span class="st">  </span><span class="co"># reorder columns to have names first</span></a>
<a class="sourceLine" id="cb46-15" href="#cb46-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(variableName, <span class="kw">everything</span>())</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
</div>
<div id="scoring" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Scoring</h3>
<p>Scoring expresses the coefficients that were estimated during the logistic regression into points on a scale. The model estimates the log-odds that a loan will not default. We will provide a detailed
description of the calculations to, hopefully, provide guidance to others. (The references we have found in the course of our research have been surprisingly limited.)</p>
<p>Let us recall that our model will be in the form of a linear regression to model the logodds of the probability of default. That is:</p>
<p><span class="math display">\[\text{logodds} (p) = \text{intercept} + \sum_{\text{Variable} = k} \sum_{\text{bin} = i} \alpha_{k, i} x_{k, i}\]</span></p>
<p>where:</p>
<p><span class="math display">\[\text{logodds} (p) = \log \frac{p}{1-p}\]</span></p>
<p>Thanks to the properties of the logodds transformation, the model can take any value between <span class="math inline">\(-\infty\)</span> and <span class="math inline">\(+\infty\)</span> and yield valid probability values.</p>
<p>The idea of scoring is to replace this linear relationship with a points system: if an applicant ticks a box on a particular question/variable, he/she gets so many points. For example, asked for an age band, an applicant would receive 10 points if between 18 and 25 year-old, and 25 points if between 25 and 32. The age bands (the variable bins) were calculated above.</p>
<p>Basic convenience and marketing common sense dictates that:</p>
<ul>
<li><p>points should be rounded (who wants to see 14.99432529875 on an application form?)</p>
<ul>
<li><p>those points should not be negative.</p></li>
<li><p>Scorecards do not start with an initial piggybank of points. In terms of modeling, that means no intercept.</p></li>
</ul></li>
</ul>
<p>The idea of scorecard applies to model similar to this one. Marketing consideration might be relevant to our context. They would be completely irrelevant to scorecard for a disease risk assessment or probability of failure of a mechanical part.</p>
<p>Scoring will replace the <span class="math inline">\(\alpha_{k, i}\)</span> coefficients with scores <span class="math inline">\(S_{k, i}\)</span>. In addition, we will get rid of the intercept. To remove the intercept, we will apportion it equally across all variables:</p>
<p><span class="math display">\[\text{logodds} (p) = \sum_{\text{Variable} = k} { \left( \frac{\text{intercept}}{K} + \sum_{\text{bin} = i} \alpha_{k, i} x_{k, i} \right) }\]</span>
where <span class="math inline">\(K\)</span> is the number of variables. And if <span class="math inline">\(I_k\)</span> is the number of bins for variable <span class="math inline">\(k\)</span>:</p>
<p><span class="math display">\[\text{logodds} (p) = \sum_{\text{Variable k} = 1}^K { \sum_{\text{bin i} = 1}^{I_k} \left( \frac{\text{intercept}}{K . I_k} + \alpha_{k, i} x_{k, i} \right) }\]</span></p>
<p>Then we select a factor <span class="math inline">\(F\)</span> that will dilate/contract the coefficients such that:</p>
<p><span class="math display">\[\text{logodds} (p) = \sum_{\text{Variable} = k} { \left( \frac{\text{intercept}}{K} + \sum_{\text{bin} = i} \alpha_{k, i} x_{k, i} \right) }\]</span></p>
</div>
<div id="model-scorecard" class="section level3">
<h3><span class="header-section-number">3.4.3</span> Model scorecard</h3>
<p>The conversion is done using three parameters that are chosen somewhat arbitrarily and which define a line:</p>
<ul>
<li><p>the number of points increase / decrease that would reflect halving / doubling the odds of defaulting;</p></li>
<li><p>an <em>anchoring</em> score reflecting a particular odd.</p></li>
</ul>
<p>For our purpose, we will choose 5,000 points (<span class="math inline">\(\text{Score}_{anchor}\)</span>) being equivalent to 1 in a 20 to default (<span class="math inline">\(\text{Odds}_{anchor}\)</span>), i.e. <span class="math inline">\(\text{Score}_{anchor}\)</span> 5,000 points &lt;=&gt; <span class="math inline">\(\text{Odds}_{Anchor} = \frac{1 / 20}{1 - 1/20}\)</span>. We will also choose 100 to reflect <em>times 2</em> change in odds (<span class="math inline">\(DoubleOdds\)</span>). Those choices are completely arbitrary. Basically, the score is a linear representation of the odds. The score is defined by a point (the anchor) and the slope of the line going through that point.</p>
<p>Those values will reflect the total estimated score for a borrower (i.e. loan sample). The number of characteristics (information points gathered in a credit application), or number of bins, have to be irrelevant in calculating this score. In other words, if LendingClub were to gather 5 more information points, the score should, <strong>mutatis mutandis</strong>, be unchanged. (However, we would hope that the quality of the estimated score would improve.)</p>
<p>The score per variable needs to be adjusted using the number of information points, that is the number of characteristics. Here, the model has been trained on the number of bins. We first need to determine how many characteristics are used in the model.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" href="#cb47-1" data-line-number="1"><span class="co"># The list of characteristics is extracted from the list of bins names.</span></a>
<a class="sourceLine" id="cb47-2" href="#cb47-2" data-line-number="2">numberOfCharacteristics &lt;-</a>
<a class="sourceLine" id="cb47-3" href="#cb47-3" data-line-number="3"></a>
<a class="sourceLine" id="cb47-4" href="#cb47-4" data-line-number="4"><span class="st">  </span>modelNames <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-5" href="#cb47-5" data-line-number="5"></a>
<a class="sourceLine" id="cb47-6" href="#cb47-6" data-line-number="6"><span class="st">  </span><span class="co"># List of all names excluding the intercept which is not part of the scoring calculations (it</span></a>
<a class="sourceLine" id="cb47-7" href="#cb47-7" data-line-number="7"><span class="st">  </span><span class="co"># would mean giving points for free as a base line)</span></a>
<a class="sourceLine" id="cb47-8" href="#cb47-8" data-line-number="8"><span class="st">  </span><span class="kw">filter</span>(variableName <span class="op">!=</span><span class="st"> &quot;(Intercept)&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-9" href="#cb47-9" data-line-number="9"></a>
<a class="sourceLine" id="cb47-10" href="#cb47-10" data-line-number="10"><span class="st">  </span><span class="co"># Extract strings (&quot;[a-zA-Z0-9-_]*&quot;) preceded by an opening bracket (&quot;(?&lt;=\\()&quot;) and followed by a</span></a>
<a class="sourceLine" id="cb47-11" href="#cb47-11" data-line-number="11"><span class="st">  </span><span class="co"># closing bracket (&quot;(?=\\))&quot;). (The column names were formatted this way for that purpose.) See</span></a>
<a class="sourceLine" id="cb47-12" href="#cb47-12" data-line-number="12"><span class="st">  </span><span class="co"># &quot;https://github.com/rstudio/cheatsheets/blob/master/strings.pdf&quot; for details on the regex.</span></a>
<a class="sourceLine" id="cb47-13" href="#cb47-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">characteristic =</span> <span class="kw">str_match</span>(variableName, <span class="st">&quot;(?&lt;=</span><span class="ch">\\</span><span class="st">()[a-zA-Z0-9-_]*(?=</span><span class="ch">\\</span><span class="st">))&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-14" href="#cb47-14" data-line-number="14"></a>
<a class="sourceLine" id="cb47-15" href="#cb47-15" data-line-number="15"><span class="st">  </span><span class="co"># We are only interested in how many distinct characteristic there are.</span></a>
<a class="sourceLine" id="cb47-16" href="#cb47-16" data-line-number="16"><span class="st">  </span><span class="kw">distinct</span>(characteristic) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-17" href="#cb47-17" data-line-number="17"><span class="st">  </span><span class="kw">nrow</span>()</a>
<a class="sourceLine" id="cb47-18" href="#cb47-18" data-line-number="18"></a>
<a class="sourceLine" id="cb47-19" href="#cb47-19" data-line-number="19">numberOfCharacteristics</a></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb48-1" href="#cb48-1" data-line-number="1">## [1] 24</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We can now perform the scoring calculation.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" href="#cb49-1" data-line-number="1">ProbDefaultAtAnchor &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span><span class="dv">20</span></a>
<a class="sourceLine" id="cb49-2" href="#cb49-2" data-line-number="2"></a>
<a class="sourceLine" id="cb49-3" href="#cb49-3" data-line-number="3"><span class="co"># The model is trained so that the &#39;Good&#39; outcome is that a loan does not default. The odds that</span></a>
<a class="sourceLine" id="cb49-4" href="#cb49-4" data-line-number="4"><span class="co"># therefore calculated on the probability of no default.</span></a>
<a class="sourceLine" id="cb49-5" href="#cb49-5" data-line-number="5">ProbAtAnchor &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>ProbDefaultAtAnchor</a>
<a class="sourceLine" id="cb49-6" href="#cb49-6" data-line-number="6">OddsAnchor &lt;-<span class="st"> </span>ProbAtAnchor <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>ProbAtAnchor)</a>
<a class="sourceLine" id="cb49-7" href="#cb49-7" data-line-number="7">ScoreAnchor &lt;-<span class="st"> </span><span class="dv">2000</span></a>
<a class="sourceLine" id="cb49-8" href="#cb49-8" data-line-number="8"></a>
<a class="sourceLine" id="cb49-9" href="#cb49-9" data-line-number="9"><span class="co"># Doubling odds = 100 points</span></a>
<a class="sourceLine" id="cb49-10" href="#cb49-10" data-line-number="10">DoubleOdds &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb49-11" href="#cb49-11" data-line-number="11"></a>
<a class="sourceLine" id="cb49-12" href="#cb49-12" data-line-number="12">ScoreFactor &lt;-<span class="st"> </span>OddsAnchor <span class="op">/</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb49-13" href="#cb49-13" data-line-number="13"></a>
<a class="sourceLine" id="cb49-14" href="#cb49-14" data-line-number="14"><span class="co"># 5,000 points is 20:1 odds of default</span></a>
<a class="sourceLine" id="cb49-15" href="#cb49-15" data-line-number="15">ScoreOffset &lt;-<span class="st"> </span>ScoreAnchor <span class="op">-</span><span class="st"> </span>ScoreFactor <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(OddsAnchor)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>Then we apportion across characteristics.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" href="#cb50-1" data-line-number="1"><span class="co"># Score at the intercept</span></a>
<a class="sourceLine" id="cb50-2" href="#cb50-2" data-line-number="2">Intercept &lt;-<span class="st"> </span><span class="kw">summary</span>(GLModel)<span class="op">$</span>coefficients[<span class="st">&quot;(Intercept)&quot;</span>, <span class="st">&quot;Estimate&quot;</span>]</a>
<a class="sourceLine" id="cb50-3" href="#cb50-3" data-line-number="3"></a>
<a class="sourceLine" id="cb50-4" href="#cb50-4" data-line-number="4">ScorePerVariable &lt;-<span class="st"> </span>(ScoreFactor <span class="op">*</span><span class="st"> </span>Intercept <span class="op">+</span><span class="st"> </span>ScoreOffset) <span class="op">/</span><span class="st"> </span>numberOfCharacteristics </a>
<a class="sourceLine" id="cb50-5" href="#cb50-5" data-line-number="5">InterceptPerVariable &lt;-<span class="st"> </span>Intercept <span class="op">*</span><span class="st"> </span>ScoreFactor <span class="op">/</span><span class="st"> </span>numberOfCharacteristics</a>
<a class="sourceLine" id="cb50-6" href="#cb50-6" data-line-number="6"></a>
<a class="sourceLine" id="cb50-7" href="#cb50-7" data-line-number="7">GLMScores &lt;-</a>
<a class="sourceLine" id="cb50-8" href="#cb50-8" data-line-number="8"><span class="st">  </span>GLMCoefficients <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-9" href="#cb50-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb50-10" href="#cb50-10" data-line-number="10">    <span class="dt">weight =</span> Estimate <span class="op">*</span><span class="st"> </span>ScoreFactor,</a>
<a class="sourceLine" id="cb50-11" href="#cb50-11" data-line-number="11">    <span class="dt">weightScaled =</span> weight <span class="op">+</span><span class="st"> </span>ScorePerVariable,</a>
<a class="sourceLine" id="cb50-12" href="#cb50-12" data-line-number="12">    <span class="dt">points =</span> <span class="kw">round</span>(weightScaled)</a>
<a class="sourceLine" id="cb50-13" href="#cb50-13" data-line-number="13">  )</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><strong>Very important</strong>: The intercept points have been allocated across all characteristics. Therefore the regression coefficient estimated for the intercept becomes redundant and needs removing.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" href="#cb51-1" data-line-number="1">GLMScores[<span class="dv">1</span>, <span class="st">&quot;points&quot;</span>] &lt;-<span class="st">  </span><span class="dv">0</span></a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>The <code>speedglm</code> package does not have a <code>predict</code> function once models have been trained. However, using the model is a simple matrix multiplication: <span class="math inline">\(\text{Loan matrix} \times \text{Scorecard weights}\)</span></p>
</div>
</div>
<div id="training-set" class="section level2">
<h2><span class="header-section-number">3.5</span> Training set</h2>


<p>We first review how the fitted model performed on the training set.</p>
<p>We remove every variable that is not in the list of variables in the model then convert into a matrix.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb52"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" href="#cb52-1" data-line-number="1"><span class="co"># Remove every variable that is not in the list of variables in the model then convert</span></a>
<a class="sourceLine" id="cb52-2" href="#cb52-2" data-line-number="2"><span class="co"># into a matrix</span></a>
<a class="sourceLine" id="cb52-3" href="#cb52-3" data-line-number="3">allMatrix &lt;-</a>
<a class="sourceLine" id="cb52-4" href="#cb52-4" data-line-number="4"><span class="st">  </span>allFactorsAsBins[, <span class="op">!</span><span class="kw">is.na</span>(<span class="kw">match</span>(</a>
<a class="sourceLine" id="cb52-5" href="#cb52-5" data-line-number="5">    <span class="kw">names</span>(allFactorsAsBins),</a>
<a class="sourceLine" id="cb52-6" href="#cb52-6" data-line-number="6">    <span class="kw">str_remove_all</span>(GLMCoefficients<span class="op">$</span>variableName, <span class="st">&quot;\`&quot;</span>)</a>
<a class="sourceLine" id="cb52-7" href="#cb52-7" data-line-number="7">  ))] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-8" href="#cb52-8" data-line-number="8"><span class="st">  </span><span class="kw">as.matrix</span>()</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>The coefficients of the model also include the interept (set at zero in the scores). We add a column of 1’s to the training data.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb53"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" href="#cb53-1" data-line-number="1"><span class="co"># Add a column of 1s for the intercept</span></a>
<a class="sourceLine" id="cb53-2" href="#cb53-2" data-line-number="2">allMatrix &lt;-</a>
<a class="sourceLine" id="cb53-3" href="#cb53-3" data-line-number="3"><span class="st">  </span><span class="kw">cbind</span>(<span class="kw">as.vector</span>(<span class="kw">rep.int</span>(</a>
<a class="sourceLine" id="cb53-4" href="#cb53-4" data-line-number="4">    <span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">times =</span> <span class="kw">dim</span>(allMatrix)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb53-5" href="#cb53-5" data-line-number="5">  )), allMatrix)</a>
<a class="sourceLine" id="cb53-6" href="#cb53-6" data-line-number="6"><span class="kw">dim</span>(allMatrix)</a></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb54-1" href="#cb54-1" data-line-number="1">## [1] 1045084     168</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>


<p>The coefficients of the model, then the scores, are converted to a vector format.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" href="#cb55-1" data-line-number="1">CoefficientsVector &lt;-<span class="st"> </span>GLMCoefficients<span class="op">$</span>Estimate <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.matrix</span>()</a>
<a class="sourceLine" id="cb55-2" href="#cb55-2" data-line-number="2"></a>
<a class="sourceLine" id="cb55-3" href="#cb55-3" data-line-number="3"><span class="co"># Score per variable</span></a>
<a class="sourceLine" id="cb55-4" href="#cb55-4" data-line-number="4">TrainingScorecard &lt;-<span class="st"> </span>allMatrix <span class="op">%*%</span><span class="st"> </span>( GLMScores<span class="op">$</span>points <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.matrix</span>() ) </a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We can now multiply the matrix of sample with the vector of coefficients.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb56"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" href="#cb56-1" data-line-number="1">TrainingLogit &lt;-<span class="st"> </span>allMatrix <span class="op">%*%</span><span class="st"> </span>CoefficientsVector</a>
<a class="sourceLine" id="cb56-2" href="#cb56-2" data-line-number="2">TrainingLogit &lt;-</a>
<a class="sourceLine" id="cb56-3" href="#cb56-3" data-line-number="3"><span class="st">  </span><span class="kw">enframe</span>(TrainingLogit[, <span class="dv">1</span>]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb56-4" href="#cb56-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">oddsGood =</span> <span class="kw">exp</span>(value),</a>
<a class="sourceLine" id="cb56-5" href="#cb56-5" data-line-number="5">         <span class="dt">p =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>oddsGood)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-6" href="#cb56-6" data-line-number="6"><span class="st">  </span><span class="kw">cbind</span>(TrainingScorecard)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<div id="densities-of-the-training-results" class="section level3">
<h3><span class="header-section-number">3.5.1</span> Densities of the training results</h3>
<p>We plot the results of the training model and group the results by rating (“A” to “G”) in Figure <a href="logistic-regression-model-and-credit-scorecard.html#fig:05-03-training-hists-value">3.1</a>.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb57"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" href="#cb57-1" data-line-number="1">gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(</a>
<a class="sourceLine" id="cb57-2" href="#cb57-2" data-line-number="2">  loansTraining <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-3" href="#cb57-3" data-line-number="3"><span class="st">    </span><span class="kw">cbind</span>(TrainingLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-4" href="#cb57-4" data-line-number="4"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">between</span>(value, <span class="dv">-2</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-5" href="#cb57-5" data-line-number="5"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(value, <span class="dt">col =</span> grade)) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-6" href="#cb57-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-7" href="#cb57-7" data-line-number="7"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Logit value&quot;</span>),</a>
<a class="sourceLine" id="cb57-8" href="#cb57-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb57-9" href="#cb57-9" data-line-number="9">  loansTraining <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-10" href="#cb57-10" data-line-number="10"><span class="st">    </span><span class="kw">cbind</span>(TrainingLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-11" href="#cb57-11" data-line-number="11"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(p, <span class="dt">col =</span> grade)) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-12" href="#cb57-12" data-line-number="12"><span class="st">    </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-13" href="#cb57-13" data-line-number="13"><span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb57-14" href="#cb57-14" data-line-number="14"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Probability of being GOOD&quot;</span>),</a>
<a class="sourceLine" id="cb57-15" href="#cb57-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb57-16" href="#cb57-16" data-line-number="16">  loansTraining <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-17" href="#cb57-17" data-line-number="17"><span class="st">    </span><span class="kw">cbind</span>(TrainingLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-18" href="#cb57-18" data-line-number="18"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">between</span>(oddsGood, <span class="fl">0.1</span>, <span class="dv">100</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-19" href="#cb57-19" data-line-number="19"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(oddsGood, <span class="dt">col =</span> grade)) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-20" href="#cb57-20" data-line-number="20"><span class="st">    </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-21" href="#cb57-21" data-line-number="21"><span class="st">    </span><span class="kw">scale_x_log10</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb57-22" href="#cb57-22" data-line-number="22"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Odds of being GOOD&quot;</span>),</a>
<a class="sourceLine" id="cb57-23" href="#cb57-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb57-24" href="#cb57-24" data-line-number="24">  loansTraining <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-25" href="#cb57-25" data-line-number="25"><span class="st">    </span><span class="kw">cbind</span>(TrainingLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-26" href="#cb57-26" data-line-number="26"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(TrainingScorecard, <span class="dt">col =</span> grade)) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-27" href="#cb57-27" data-line-number="27"><span class="st">    </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb57-28" href="#cb57-28" data-line-number="28"><span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;Scorecards&quot;</span>),</a>
<a class="sourceLine" id="cb57-29" href="#cb57-29" data-line-number="29"></a>
<a class="sourceLine" id="cb57-30" href="#cb57-30" data-line-number="30">  <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">nrow =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb57-31" href="#cb57-31" data-line-number="31">)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-training-hists-value"></span>
<img src="build/figure/graphics-05-03-training-hists-value-1.png" alt="Model results on the training set" width="70%" />
<p class="caption">
Figure 3.1: Model results on the training set
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>
</div>
</div>
<div id="test-set" class="section level2">
<h2><span class="header-section-number">3.6</span> Test set</h2>
<p>We replicate the exact same steps on the test set loans, also converted into a matrix.</p>


<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb58"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" href="#cb58-1" data-line-number="1">predictionCategories &lt;-<span class="st"> </span>loansTest[, <span class="st">&quot;loanID&quot;</span>]</a>
<a class="sourceLine" id="cb58-2" href="#cb58-2" data-line-number="2"></a>
<a class="sourceLine" id="cb58-3" href="#cb58-3" data-line-number="3"><span class="cf">for</span> (index <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(bestBins<span class="op">$</span>variable)) {</a>
<a class="sourceLine" id="cb58-4" href="#cb58-4" data-line-number="4">  binned &lt;-</a>
<a class="sourceLine" id="cb58-5" href="#cb58-5" data-line-number="5"><span class="st">    </span>binner<span class="op">::</span><span class="kw">categoriseFromWoE.Wide</span>(</a>
<a class="sourceLine" id="cb58-6" href="#cb58-6" data-line-number="6">      <span class="dt">df =</span> loansTest,</a>
<a class="sourceLine" id="cb58-7" href="#cb58-7" data-line-number="7">      <span class="dt">varName =</span> bestBins<span class="op">$</span>variable[index],</a>
<a class="sourceLine" id="cb58-8" href="#cb58-8" data-line-number="8">      <span class="dt">woeTable =</span> bestBins<span class="op">$</span>WoE[[index]]</a>
<a class="sourceLine" id="cb58-9" href="#cb58-9" data-line-number="9">    )</a>
<a class="sourceLine" id="cb58-10" href="#cb58-10" data-line-number="10"></a>
<a class="sourceLine" id="cb58-11" href="#cb58-11" data-line-number="11">  predictionCategories &lt;-<span class="st"> </span><span class="kw">cbind</span>(predictionCategories, binned)</a>
<a class="sourceLine" id="cb58-12" href="#cb58-12" data-line-number="12">}</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb59"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" href="#cb59-1" data-line-number="1"><span class="co"># Retain only the relevant scorecard categories</span></a>
<a class="sourceLine" id="cb59-2" href="#cb59-2" data-line-number="2">predictionMatrix &lt;-</a>
<a class="sourceLine" id="cb59-3" href="#cb59-3" data-line-number="3"><span class="st">  </span>predictionCategories[, <span class="op">!</span><span class="kw">is.na</span>(<span class="kw">match</span>(</a>
<a class="sourceLine" id="cb59-4" href="#cb59-4" data-line-number="4">    <span class="kw">names</span>(predictionCategories),</a>
<a class="sourceLine" id="cb59-5" href="#cb59-5" data-line-number="5">    <span class="kw">str_remove_all</span>(GLMCoefficients<span class="op">$</span>variableName, <span class="st">&quot;\`&quot;</span>)</a>
<a class="sourceLine" id="cb59-6" href="#cb59-6" data-line-number="6">  ))] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-7" href="#cb59-7" data-line-number="7"><span class="st">  </span><span class="kw">as.matrix</span>()</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb60"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" href="#cb60-1" data-line-number="1">predictionMatrix &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">as.vector</span>(<span class="kw">rep.int</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">times =</span> <span class="kw">dim</span>(predictionMatrix)[<span class="dv">1</span>])), </a>
<a class="sourceLine" id="cb60-2" href="#cb60-2" data-line-number="2">                          predictionMatrix)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb61"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" href="#cb61-1" data-line-number="1">TestLogit &lt;-<span class="st"> </span>predictionMatrix <span class="op">%*%</span><span class="st"> </span>CoefficientsVector</a>
<a class="sourceLine" id="cb61-2" href="#cb61-2" data-line-number="2">TestLogit &lt;-</a>
<a class="sourceLine" id="cb61-3" href="#cb61-3" data-line-number="3"><span class="st">  </span>tibble<span class="op">::</span><span class="kw">enframe</span>(TestLogit[, <span class="dv">1</span>]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-4" href="#cb61-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb61-5" href="#cb61-5" data-line-number="5">    <span class="dt">p =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>value)),</a>
<a class="sourceLine" id="cb61-6" href="#cb61-6" data-line-number="6">    <span class="dt">oddsGood =</span> <span class="kw">if_else</span>(<span class="kw">is.infinite</span>(p <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p)), <span class="fl">1e10</span>, p <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>p)))</a>
<a class="sourceLine" id="cb61-7" href="#cb61-7" data-line-number="7"></a>
<a class="sourceLine" id="cb61-8" href="#cb61-8" data-line-number="8">predictionScorecard &lt;-<span class="st"> </span>predictionMatrix <span class="op">%*%</span><span class="st"> </span>( GLMScores<span class="op">$</span>points <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.matrix</span>() ) </a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb62"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" href="#cb62-1" data-line-number="1">loansTest <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-2" href="#cb62-2" data-line-number="2"><span class="st">  </span><span class="kw">cbind</span>(TestLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-3" href="#cb62-3" data-line-number="3"><span class="st">  </span><span class="kw">cbind</span>(predictionScorecard) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-4" href="#cb62-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(predictionScorecard <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-5" href="#cb62-5" data-line-number="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(predictionScorecard)) <span class="op">+</span></a>
<a class="sourceLine" id="cb62-6" href="#cb62-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;lightblue&quot;</span>, <span class="dt">adjust =</span> <span class="dv">3</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-test-estimates"></span>
<img src="build/figure/graphics-05-03-test-estimates-1.png" alt="Density of loans by scorecard" width="70%" />
<p class="caption">
Figure 3.2: Density of loans by scorecard
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>We can now see the same downward dynamics as training set</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb63"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" href="#cb63-1" data-line-number="1">loansTest <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-2" href="#cb63-2" data-line-number="2"><span class="st">  </span><span class="kw">cbind</span>(TestLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-3" href="#cb63-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">between</span>(value, <span class="dv">-2</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb63-4" href="#cb63-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(value, <span class="dt">col =</span> grade)) <span class="op">+</span></a>
<a class="sourceLine" id="cb63-5" href="#cb63-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="dv">2</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-test-viz-value"></span>
<img src="build/figure/graphics-05-03-test-viz-value-1.png" alt="Logit value predicted by the model" width="70%" />
<p class="caption">
Figure 3.3: Logit value predicted by the model
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb64"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" href="#cb64-1" data-line-number="1">loansTest <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-2" href="#cb64-2" data-line-number="2"><span class="st">  </span><span class="kw">cbind</span>(TestLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-3" href="#cb64-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(p, <span class="dt">col =</span> grade)) <span class="op">+</span></a>
<a class="sourceLine" id="cb64-4" href="#cb64-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb64-5" href="#cb64-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_x_log10</span>()</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-test-viz-p"></span>
<img src="build/figure/graphics-05-03-test-viz-p-1.png" alt="Probability of a loan being GOOD predicted by the model" width="70%" />
<p class="caption">
Figure 3.4: Probability of a loan being GOOD predicted by the model
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb65"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" href="#cb65-1" data-line-number="1">loansTest <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-2" href="#cb65-2" data-line-number="2"><span class="st">  </span><span class="kw">cbind</span>(TestLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-3" href="#cb65-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">between</span>(oddsGood, <span class="fl">0.1</span>, <span class="dv">100</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-4" href="#cb65-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(oddsGood, <span class="dt">col =</span> grade)) <span class="op">+</span></a>
<a class="sourceLine" id="cb65-5" href="#cb65-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">adjust =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-6" href="#cb65-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_x_log10</span>()</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-test-viz-odds"></span>
<img src="build/figure/graphics-05-03-test-viz-odds-1.png" alt="Odds of a loan being GOOD predicted by the model" width="70%" />
<p class="caption">
Figure 3.5: Odds of a loan being GOOD predicted by the model
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>
</div>
<div id="confusion-matrix" class="section level2">
<h2><span class="header-section-number">3.7</span> Confusion matrix</h2>
<p>Given a probability <span class="math inline">\(p\)</span> from the model, we use a <span class="math inline">\(p = 0.50\)</span> cut-off point to decide whether a loan is Good or Bad. The Confusion Matrix results are:</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb66"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" href="#cb66-1" data-line-number="1">tCM &lt;-<span class="st"> </span>loansTest <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-2" href="#cb66-2" data-line-number="2"><span class="st">  </span><span class="kw">cbind</span>(TestLogit) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-3" href="#cb66-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(p, isGoodLoan) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-4" href="#cb66-4" data-line-number="4"><span class="st">  </span></a>
<a class="sourceLine" id="cb66-5" href="#cb66-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">p =</span> <span class="kw">if_else</span>(p <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.50</span>, <span class="st">&quot;GOOD&quot;</span>, <span class="st">&quot;BAD&quot;</span>), </a>
<a class="sourceLine" id="cb66-6" href="#cb66-6" data-line-number="6">         <span class="dt">isGoodLoan =</span> <span class="kw">if_else</span>(isGoodLoan, <span class="st">&quot;GOOD&quot;</span>, <span class="st">&quot;BAD&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-7" href="#cb66-7" data-line-number="7"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Predicted =</span> p, </a>
<a class="sourceLine" id="cb66-8" href="#cb66-8" data-line-number="8">         <span class="dt">Actual =</span> isGoodLoan) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-9" href="#cb66-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb66-10" href="#cb66-10" data-line-number="10"><span class="st">  </span><span class="kw">table</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-11" href="#cb66-11" data-line-number="11"><span class="st">  </span>caret<span class="op">::</span><span class="kw">confusionMatrix</span>(<span class="dt">positive =</span> <span class="st">&quot;GOOD&quot;</span>)</a>
<a class="sourceLine" id="cb66-12" href="#cb66-12" data-line-number="12"></a>
<a class="sourceLine" id="cb66-13" href="#cb66-13" data-line-number="13">tCM</a></code></pre></div>
<div class="sourceCode" id="cb67"><pre class="sourceCode numberSource numberLines lineAnchors chunkout"><code class="sourceCode"><a class="sourceLine" id="cb67-1" href="#cb67-1" data-line-number="1">## Confusion Matrix and Statistics</a>
<a class="sourceLine" id="cb67-2" href="#cb67-2" data-line-number="2">## </a>
<a class="sourceLine" id="cb67-3" href="#cb67-3" data-line-number="3">##          Actual</a>
<a class="sourceLine" id="cb67-4" href="#cb67-4" data-line-number="4">## Predicted    BAD   GOOD</a>
<a class="sourceLine" id="cb67-5" href="#cb67-5" data-line-number="5">##      BAD    1864   1512</a>
<a class="sourceLine" id="cb67-6" href="#cb67-6" data-line-number="6">##      GOOD  50657 207239</a>
<a class="sourceLine" id="cb67-7" href="#cb67-7" data-line-number="7">##                                           </a>
<a class="sourceLine" id="cb67-8" href="#cb67-8" data-line-number="8">##                Accuracy : 0.8003          </a>
<a class="sourceLine" id="cb67-9" href="#cb67-9" data-line-number="9">##                  95% CI : (0.7988, 0.8019)</a>
<a class="sourceLine" id="cb67-10" href="#cb67-10" data-line-number="10">##     No Information Rate : 0.799           </a>
<a class="sourceLine" id="cb67-11" href="#cb67-11" data-line-number="11">##     P-Value [Acc &gt; NIR] : 0.043           </a>
<a class="sourceLine" id="cb67-12" href="#cb67-12" data-line-number="12">##                                           </a>
<a class="sourceLine" id="cb67-13" href="#cb67-13" data-line-number="13">##                   Kappa : 0.0435          </a>
<a class="sourceLine" id="cb67-14" href="#cb67-14" data-line-number="14">##                                           </a>
<a class="sourceLine" id="cb67-15" href="#cb67-15" data-line-number="15">##  Mcnemar&#39;s Test P-Value : &lt;2e-16          </a>
<a class="sourceLine" id="cb67-16" href="#cb67-16" data-line-number="16">##                                           </a>
<a class="sourceLine" id="cb67-17" href="#cb67-17" data-line-number="17">##             Sensitivity : 0.99276         </a>
<a class="sourceLine" id="cb67-18" href="#cb67-18" data-line-number="18">##             Specificity : 0.03549         </a>
<a class="sourceLine" id="cb67-19" href="#cb67-19" data-line-number="19">##          Pos Pred Value : 0.80358         </a>
<a class="sourceLine" id="cb67-20" href="#cb67-20" data-line-number="20">##          Neg Pred Value : 0.55213         </a>
<a class="sourceLine" id="cb67-21" href="#cb67-21" data-line-number="21">##              Prevalence : 0.79898         </a>
<a class="sourceLine" id="cb67-22" href="#cb67-22" data-line-number="22">##          Detection Rate : 0.79319         </a>
<a class="sourceLine" id="cb67-23" href="#cb67-23" data-line-number="23">##    Detection Prevalence : 0.98708         </a>
<a class="sourceLine" id="cb67-24" href="#cb67-24" data-line-number="24">##       Balanced Accuracy : 0.51412         </a>
<a class="sourceLine" id="cb67-25" href="#cb67-25" data-line-number="25">##                                           </a>
<a class="sourceLine" id="cb67-26" href="#cb67-26" data-line-number="26">##        &#39;Positive&#39; Class : GOOD            </a>
<a class="sourceLine" id="cb67-27" href="#cb67-27" data-line-number="27">## </a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>The results suggest that the model is effrective at predicting good loans (measured by the sensitivity = <span class="math inline">\(\frac{TP}{TP + FN}\)</span> = 99.28%). However, this is deceptive since the dataset is unbalanced. The model is performing poorly at detecting bad loans (measured by the specificity = <span class="math inline">\(\frac{TN}{TN + FP}\)</span> = 3.55%) The dataset is unbalanced and measuring the model’s performance with a confusion matrix is imprecise. A much better approach would be to train many models on balanced datasets (by sampling a reduced ‘good loans’ dataset) and study the distribution of that resulting models and their parameters.</p>
<p>More critically, the confusion matrix does not (and cannot) reflect the consequence of getting predictions wrong. At the end of the day, the only relevant consequence is estimating the number of dollars lost on a loan. A misqualified loan might lead to a loss of a single dollar, or a million. Predicting a probability of default is not enough. We need to subsequently predict the expected loss when a particular loan defaults. In the conclusion, we suggest one possible avenue.</p>
</div>
<div id="roc-curve" class="section level2">
<h2><span class="header-section-number">3.8</span> ROC Curve</h2>
<p>A popular measure for the performance of such a logistic regression model is to consider its <em>Receiver Operating Characteristic</em> curve (<em>ROC</em>) and calculate its area under curve (<em>AUC</em>). We use the <code>ROCR</code> package (<span class="citation">(Sing et al. <a href="#ref-10.1093/bioinformatics/bti623">2005</a>)</span>). We recommend @fawcett2004roc for a very good overview of Receiver Operating Characteristics graphs.</p>
<p>We first create a prediction object that will be used for plotting.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb68"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" href="#cb68-1" data-line-number="1">ROCRPrediction &lt;-<span class="st"> </span>ROCR<span class="op">::</span><span class="kw">prediction</span>(TestLogit<span class="op">$</span>p, loansTest<span class="op">$</span>isGoodLoan)</a></code></pre></div>

<p><span class="math display">\[\text{ }\]</span></p>
<p>Figure <a href="logistic-regression-model-and-credit-scorecard.html#fig:05-03-ROC-curve">3.6</a> plots the Receiver Operating Characteristic curve of the regression. The area under the ROC curve is 68.23%.</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb69"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" href="#cb69-1" data-line-number="1">ROCR<span class="op">::</span><span class="kw">performance</span>(ROCRPrediction, </a>
<a class="sourceLine" id="cb69-2" href="#cb69-2" data-line-number="2">                  <span class="dt">measure =</span> <span class="st">&quot;tpr&quot;</span>, </a>
<a class="sourceLine" id="cb69-3" href="#cb69-3" data-line-number="3">                  <span class="dt">x.measure =</span> <span class="st">&quot;fpr&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb69-4" href="#cb69-4" data-line-number="4"><span class="st">  </span>ROCR<span class="op">::</span><span class="kw">plot</span>(<span class="dt">colorize =</span> <span class="ot">TRUE</span>) </a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-ROC-curve"></span>
<img src="build/figure/graphics-05-03-ROC-curve-1.png" alt="Receiver Operating Characteristic" width="70%" />
<p class="caption">
Figure 3.6: Receiver Operating Characteristic
</p>
</div>

<p><span class="math display">\[\text{ }\]</span>
The AUC has an important statistical property: the AUC of a classifer is equivalent to the probability that the classifer will rank a randomly chosen positive instance higher than a randomly chosen negative instance. This is equivalent to the Wilcoxon test of ranks.The AUC is also closely related to the Gini index, which is twice the area between the diagonal and the ROC curve (<span class="math inline">\(\text{Gini} + 1 = 2 \times \text{AUC}\)</span>).</p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb70"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" href="#cb70-1" data-line-number="1">ROCR<span class="op">::</span><span class="kw">performance</span>(ROCRPrediction, </a>
<a class="sourceLine" id="cb70-2" href="#cb70-2" data-line-number="2">                  <span class="dt">measure =</span> <span class="st">&quot;prec&quot;</span>,</a>
<a class="sourceLine" id="cb70-3" href="#cb70-3" data-line-number="3">                  <span class="dt">x.measure =</span> <span class="st">&quot;rec&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-4" href="#cb70-4" data-line-number="4"><span class="st">  </span>ROCR<span class="op">::</span><span class="kw">plot</span>(<span class="dt">colorize =</span> <span class="ot">TRUE</span>) </a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-precision-recall-curve"></span>
<img src="build/figure/graphics-05-03-precision-recall-curve-1.png" alt="Precision/Recall curve" width="70%" />
<p class="caption">
Figure 3.7: Precision/Recall curve
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" href="#cb71-1" data-line-number="1">ROCR<span class="op">::</span><span class="kw">performance</span>(ROCRPrediction, </a>
<a class="sourceLine" id="cb71-2" href="#cb71-2" data-line-number="2">                  <span class="dt">measure =</span> <span class="st">&quot;sens&quot;</span>, </a>
<a class="sourceLine" id="cb71-3" href="#cb71-3" data-line-number="3">                  <span class="dt">x.measure =</span> <span class="st">&quot;spec&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-4" href="#cb71-4" data-line-number="4"><span class="st">  </span>ROCR<span class="op">::</span><span class="kw">plot</span>(<span class="dt">colorize =</span> <span class="ot">TRUE</span>) </a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-sens-spec-curve"></span>
<img src="build/figure/graphics-05-03-sens-spec-curve-1.png" alt="Sensitivity/Specificity curve" width="70%" />
<p class="caption">
Figure 3.8: Sensitivity/Specificity curve
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>
<p><span class="math display">\[\text{ }\]</span></p>

<div class="sourceCode" id="cb72"><pre class="sourceCode numberSource r numberLines lineAnchors"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" href="#cb72-1" data-line-number="1">ROCRPerformance &lt;-<span class="st"> </span>ROCR<span class="op">::</span><span class="kw">performance</span>(ROCRPrediction, </a>
<a class="sourceLine" id="cb72-2" href="#cb72-2" data-line-number="2">                  <span class="dt">measure =</span> <span class="st">&quot;lift&quot;</span>, </a>
<a class="sourceLine" id="cb72-3" href="#cb72-3" data-line-number="3">                  <span class="dt">x.measure =</span> <span class="st">&quot;rpp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb72-4" href="#cb72-4" data-line-number="4"><span class="st">  </span>ROCR<span class="op">::</span><span class="kw">plot</span>(<span class="dt">colorize =</span> <span class="ot">TRUE</span>) </a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:05-03-lift-chart"></span>
<img src="build/figure/graphics-05-03-lift-chart-1.png" alt="Lift Chart" width="70%" />
<p class="caption">
Figure 3.9: Lift Chart
</p>
</div>

<p><span class="math display">\[\text{ }\]</span></p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-bokhari2019credit">
<p>Bokhari, Mohammad Mubasil. 2019. “Credit Risk Analysis in Peer to Peer Lending Data Set: Lending Club.”</p>
</div>
<div id="ref-doi:10.1198/106186006X133933">
<p>Hothorn, Torsten, Kurt Hornik, and Achim Zeileis. 2006. “Unbiased Recursive Partitioning: A Conditional Inference Framework.” <em>Journal of Computational and Graphical Statistics</em> 15 (3). Taylor &amp; Francis: 651–74. <a href="https://doi.org/10.1198/106186006X133933" class="uri">https://doi.org/10.1198/106186006X133933</a>.</p>
</div>
<div id="ref-JMLR:v16:hothorn15a">
<p>Hothorn, Torsten, and Achim Zeileis. 2015. “Partykit: A Modular Toolkit for Recursive Partytioning in R.” <em>Journal of Machine Learning Research</em> 16 (118): 3905–9. <a href="http://jmlr.org/papers/v16/hothorn15a.html" class="uri">http://jmlr.org/papers/v16/hothorn15a.html</a>.</p>
</div>
<div id="ref-10.1093/bioinformatics/bti623">
<p>Sing, Tobias, Oliver Sander, Niko Beerenwinkel, and Thomas Lengauer. 2005. “ROCR: visualizing classifier performance in R.” <em>Bioinformatics</em> 21 (20): 3940–1. <a href="https://doi.org/10.1093/bioinformatics/bti623" class="uri">https://doi.org/10.1093/bioinformatics/bti623</a>.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="17">
<li id="fn17"><p><a href="https://cran.r-project.org/web/packages/Information/vignettes/Information-vignette.html" class="uri">https://cran.r-project.org/web/packages/Information/vignettes/Information-vignette.html</a><a href="logistic-regression-model-and-credit-scorecard.html#fnref17" class="footnote-back">↩</a></p></li>
<li id="fn18"><p><a href="https://github.com/Emmanuel-R8/SMBinning" class="uri">https://github.com/Emmanuel-R8/SMBinning</a><a href="logistic-regression-model-and-credit-scorecard.html#fnref18" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="dataset.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="conclusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Emmanuel-R8/HarvardX-LendingClub/edit/master/05-1-Model-Preparation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["HarvardX Credit Scoring of the LendingClub Dataset.pdf", "HarvardX Credit Scoring of the LendingClub Dataset.epub"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
